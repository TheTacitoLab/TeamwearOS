<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TeamwearOS</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.39.0/dist/umd/supabase.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background: #0a0a0a; color: #fff; }
        .glass { background: rgba(20,20,20,0.8); backdrop-filter: blur(20px); border: 1px solid rgba(255,255,255,0.08); }
        .hide { display: none !important; }
        input, select, textarea { background: #111; border: 1px solid #222; color: #fff; transition: all 0.2s ease; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #14b8a6; box-shadow: 0 0 0 3px rgba(20,184,166,0.15); }
        input::placeholder { color: #555; }
        
        /* Brand colors */
        .text-brand-400 { color: #2dd4bf; }
        .text-brand-500 { color: #14b8a6; }
        .text-brand-600 { color: #0d9488; }
        .bg-brand-400 { background-color: #2dd4bf; }
        .bg-brand-500 { background-color: #14b8a6; }
        .bg-brand-600 { background-color: #0d9488; }
        .bg-brand-500\/20 { background-color: rgba(20,184,166,0.2); }
        .hover\:bg-brand-600:hover { background-color: #0d9488; }
        .hover\:text-brand-300:hover { color: #5eead4; }
        .hover\:text-brand-400:hover { color: #2dd4bf; }
        .hover\:border-brand-500:hover { border-color: #14b8a6; }
        .border-brand-500 { border-color: #14b8a6; }
        
        /* Modern button styles */
        .btn-primary {
            background: linear-gradient(135deg, #14b8a6 0%, #0d9488 100%);
            color: white;
            font-weight: 600;
            padding: 12px 24px;
            border-radius: 10px;
            transition: all 0.2s ease;
            border: none;
            cursor: pointer;
        }
        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 20px rgba(20,184,166,0.4);
        }
        .btn-primary:active {
            transform: translateY(0);
        }
        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn-secondary {
            background: rgba(255,255,255,0.05);
            color: #999;
            font-weight: 500;
            padding: 10px 20px;
            border-radius: 8px;
            transition: all 0.2s ease;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .btn-secondary:hover {
            background: rgba(255,255,255,0.1);
            color: #fff;
            border-color: rgba(255,255,255,0.2);
        }
        
        /* Card styles */
        .card {
            background: rgba(20,20,20,0.6);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 16px;
            padding: 24px;
            transition: all 0.3s ease;
        }
        .card:hover {
            border-color: rgba(20,184,166,0.3);
        }
        .card-interactive {
            cursor: pointer;
        }
        .card-interactive:hover {
            background: rgba(20,184,166,0.05);
            transform: translateY(-2px);
        }
        
        /* Dropzone */
        .dropzone {
            border: 2px dashed rgba(255,255,255,0.15);
            border-radius: 12px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.02);
        }
        .dropzone:hover {
            border-color: #14b8a6;
            background: rgba(20,184,166,0.08);
        }
        .dropzone.drag-over {
            border-color: #14b8a6;
            background: rgba(20,184,166,0.15);
            transform: scale(1.01);
        }
        
        /* Loading spinner */
        .spinner {
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.2);
            border-top-color: #14b8a6;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Progress bar */
        .progress-bar {
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            overflow: hidden;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #14b8a6, #2dd4bf);
            border-radius: 2px;
            transition: width 0.3s ease;
        }
        
        /* Tooltip / Help popup */
        .help-trigger {
            color: #666;
            cursor: help;
            transition: color 0.2s;
        }
        .help-trigger:hover {
            color: #14b8a6;
        }
        .tooltip {
            position: absolute;
            background: #1a1a1a;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 16px;
            z-index: 100;
            max-width: 320px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.5);
            animation: fadeIn 0.2s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Club card */
        .club-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all 0.2s ease;
        }
        .club-card:hover {
            background: rgba(20,184,166,0.08);
            border-color: rgba(20,184,166,0.3);
        }
        
        /* Status badges */
        .badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        .badge-success {
            background: rgba(34,197,94,0.15);
            color: #22c55e;
        }
        .badge-warning {
            background: rgba(234,179,8,0.15);
            color: #eab308;
        }
        .badge-info {
            background: rgba(20,184,166,0.15);
            color: #14b8a6;
        }
        
        /* Image grid item */
        .image-item {
            position: relative;
            aspect-ratio: 1;
            border-radius: 10px;
            overflow: hidden;
            background: #111;
            transition: all 0.2s ease;
        }
        .image-item:hover {
            transform: scale(1.03);
        }
        .image-item img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .image-item .overlay {
            position: absolute;
            inset: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
        }
        .image-item:hover .overlay {
            opacity: 1;
        }
        
        /* Section divider */
        .section-title {
            font-size: 13px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 16px;
        }
        
        /* Pulse animation for active states */
        .pulse-border {
            animation: pulseBorder 2s infinite;
        }
        @keyframes pulseBorder {
            0%, 100% { border-color: rgba(20,184,166,0.3); }
            50% { border-color: rgba(20,184,166,0.6); }
        }

        /* =============================================
           NEW STYLES: Club Dashboard, Order Forms etc.
           ============================================= */

        /* Tab navigation */
        .tab-nav {
            display: flex;
            gap: 4px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 24px;
        }
        .tab-nav button {
            padding: 10px 18px;
            border-radius: 8px 8px 0 0;
            font-size: 13px;
            font-weight: 500;
            color: #666;
            background: transparent;
            border: none;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }
        .tab-nav button:hover {
            color: #ccc;
            background: rgba(255,255,255,0.04);
        }
        .tab-nav button.active {
            color: #14b8a6;
            background: rgba(20,184,166,0.1);
            border-bottom: 2px solid #14b8a6;
        }

        /* Club list card (enhanced) */
        .club-list-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            padding: 16px 20px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .club-list-card:hover {
            background: rgba(20,184,166,0.05);
            border-color: rgba(20,184,166,0.3);
        }

        /* Partner / Non-partner badge */
        .badge-partner {
            background: rgba(20,184,166,0.15);
            color: #14b8a6;
        }
        .badge-nonpartner {
            background: rgba(100,100,100,0.15);
            color: #888;
        }
        .badge-danger {
            background: rgba(239,68,68,0.15);
            color: #f87171;
        }

        /* Price tier card */
        .price-tier-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 10px;
            padding: 14px;
        }

        /* Club product card */
        .club-product-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }
        .club-product-card:hover {
            border-color: rgba(20,184,166,0.2);
        }

        /* Shopify sync status */
        .sync-status-synced {
            color: #22c55e;
        }
        .sync-status-pending {
            color: #eab308;
        }
        .sync-status-none {
            color: #555;
        }

        /* Order form card */
        .order-form-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 18px 20px;
            transition: all 0.2s ease;
        }
        .order-form-card:hover {
            border-color: rgba(20,184,166,0.2);
        }

        /* Submission card */
        .submission-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
        }

        /* Public order form styles */
        #public-form-view {
            min-height: 100vh;
            background: #0a0a0a;
        }
        .public-form-header {
            background: rgba(20,20,20,0.9);
            border-bottom: 1px solid rgba(255,255,255,0.08);
            padding: 20px 24px;
        }
        .player-row {
            display: grid;
            grid-template-columns: 2fr 1fr 60px 1fr 80px auto;
            gap: 8px;
            align-items: center;
        }
        @media (max-width: 768px) {
            .player-row {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Submission items table */
        .items-table th {
            font-size: 11px;
            font-weight: 600;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 8px 10px;
        }
        .items-table td {
            padding: 10px;
            border-top: 1px solid rgba(255,255,255,0.04);
            font-size: 13px;
        }

        /* Section header with action */
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }

        /* Info row */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-size: 14px;
        }
        .info-row:last-child {
            border-bottom: none;
        }
        .info-label { color: #666; }
        .info-value { color: #ddd; }

        /* =============================================
           ENHANCED LAUNCHPAD
           ============================================= */
        .feature-card {
            position: relative;
            background: rgba(15,15,15,0.8);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 20px;
            padding: 28px;
            cursor: pointer;
            transition: all 0.3s ease;
            overflow: hidden;
        }
        .feature-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0;
            height: 2px;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .feature-card:hover::before { opacity: 1; }
        .feature-card:hover {
            transform: translateY(-3px);
            border-color: rgba(255,255,255,0.15);
            box-shadow: 0 12px 40px rgba(0,0,0,0.4);
        }
        .feature-card.disabled-card {
            opacity: 0.45;
            cursor: not-allowed;
            pointer-events: none;
        }
        .feature-card.coming-soon {
            opacity: 0.5;
            cursor: default;
        }
        .feature-card .card-icon {
            width: 52px; height: 52px;
            border-radius: 14px;
            display: flex; align-items: center; justify-content: center;
            font-size: 24px;
            margin-bottom: 16px;
        }
        .feature-card h3 { font-size: 17px; font-weight: 700; margin-bottom: 6px; }
        .feature-card p { font-size: 13px; color: #666; line-height: 1.5; }
        .feature-card .card-badge {
            position: absolute;
            top: 16px; right: 16px;
            font-size: 10px; font-weight: 600;
            padding: 3px 8px; border-radius: 20px;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .badge-soon { background: rgba(255,255,255,0.07); color: #666; }
        .badge-off { background: rgba(239,68,68,0.15); color: #f87171; }
        .badge-new { background: rgba(20,184,166,0.15); color: #2dd4bf; }

        /* Card accent gradients */
        .accent-teal::before { background: linear-gradient(90deg, #14b8a6, #06b6d4); }
        .accent-purple::before { background: linear-gradient(90deg, #8b5cf6, #a78bfa); }
        .accent-blue::before { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
        .accent-orange::before { background: linear-gradient(90deg, #f97316, #fb923c); }
        .accent-pink::before { background: linear-gradient(90deg, #ec4899, #f472b6); }
        .accent-green::before { background: linear-gradient(90deg, #22c55e, #4ade80); }

        /* Stats bar */
        .stat-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px 20px;
        }

        /* =============================================
           PROSPECTING MODULE
           ============================================= */
        .prospect-card {
            background: rgba(15,15,15,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 16px;
            padding: 24px 28px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        .prospect-card:hover {
            border-color: rgba(20,184,166,0.4);
            background: rgba(20,184,166,0.04);
            transform: translateY(-2px);
            box-shadow: 0 8px 30px rgba(0,0,0,0.3);
        }

        /* Lead list */
        .lead-row {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 10px;
            padding: 14px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .lead-row:hover {
            background: rgba(20,184,166,0.05);
            border-color: rgba(20,184,166,0.2);
        }
        .lead-sport-badge {
            font-size: 11px; font-weight: 600;
            padding: 3px 8px; border-radius: 6px;
            background: rgba(20,184,166,0.12);
            color: #2dd4bf;
            white-space: nowrap;
        }
        .lead-county-badge {
            font-size: 11px; font-weight: 500;
            padding: 3px 8px; border-radius: 6px;
            background: rgba(255,255,255,0.06);
            color: #999;
            white-space: nowrap;
        }

        /* Kanban board */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding-bottom: 16px;
            min-height: 500px;
            align-items: flex-start;
        }
        .kanban-board::-webkit-scrollbar { height: 4px; }
        .kanban-board::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
        .kanban-board::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }

        .kanban-column {
            flex: 0 0 300px;
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px;
            padding: 16px;
            min-height: 400px;
        }
        .kanban-column.drag-over {
            border-color: rgba(20,184,166,0.4);
            background: rgba(20,184,166,0.04);
        }
        .kanban-col-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 14px;
            padding-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .kanban-col-title {
            font-size: 13px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.5px;
            color: #aaa;
        }
        .kanban-count {
            font-size: 12px; font-weight: 600;
            padding: 2px 8px; border-radius: 10px;
            background: rgba(255,255,255,0.07);
            color: #777;
        }

        .kanban-card {
            background: rgba(20,20,20,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            draggable: true;
        }
        .kanban-card:hover {
            border-color: rgba(20,184,166,0.3);
            background: rgba(20,184,166,0.04);
            transform: translateY(-1px);
            box-shadow: 0 4px 16px rgba(0,0,0,0.3);
        }
        .kanban-card.dragging {
            opacity: 0.5;
            transform: rotate(2deg);
        }
        .kanban-card-title { font-size: 14px; font-weight: 600; margin-bottom: 4px; }
        .kanban-card-club { font-size: 12px; color: #888; margin-bottom: 8px; }
        .kanban-card-meta { display: flex; gap: 6px; flex-wrap: wrap; }

        /* Feature toggle toggle switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.1);
            transition: .3s;
            border-radius: 24px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 16px; width: 16px;
            left: 3px; bottom: 3px;
            background: #666;
            transition: .3s;
            border-radius: 50%;
        }
        input:checked + .toggle-slider { background: rgba(20,184,166,0.3); border-color: #14b8a6; }
        input:checked + .toggle-slider:before { transform: translateX(20px); background: #14b8a6; }

        /* Search & filter bar */
        .filter-bar {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }
        .filter-bar input, .filter-bar select {
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            color: #ddd;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
        }
        .filter-bar input:focus, .filter-bar select:focus {
            border-color: #14b8a6;
            outline: none;
        }

        /* Lead modal sections */
        .modal-section {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 16px;
        }
        .modal-section-title {
            font-size: 11px; font-weight: 700;
            text-transform: uppercase; letter-spacing: 0.8px;
            color: #555;
            margin-bottom: 12px;
        }

        /* Contact card in modal */
        .contact-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 10px;
            padding: 12px 14px;
            margin-bottom: 8px;
            position: relative;
        }
        .contact-card .contact-name { font-size: 14px; font-weight: 600; }
        .contact-card .contact-details { font-size: 12px; color: #777; margin-top: 4px; }

        /* Empty state */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #555;
        }
        .empty-state .empty-icon { font-size: 48px; margin-bottom: 12px; opacity: 0.5; }
        .empty-state p { font-size: 14px; }

        /* =============================================
           SALES MODULE
           ============================================= */
        .stage-pill {
            display: inline-flex; align-items: center; gap: 6px;
            font-size: 11px; font-weight: 700;
            padding: 4px 12px; border-radius: 20px;
            text-transform: uppercase; letter-spacing: 0.5px;
            cursor: pointer; transition: all 0.2s ease;
        }
        .stage-pill.active { box-shadow: 0 0 0 1px currentColor; }
        .stage-discovery   { background:rgba(107,114,128,0.12); color:#9ca3af; }
        .stage-concepts    { background:rgba(59,130,246,0.12);  color:#60a5fa; }
        .stage-awaiting    { background:rgba(234,179,8,0.12);   color:#facc15; }
        .stage-quote       { background:rgba(20,184,166,0.12);  color:#2dd4bf; }
        .stage-paid        { background:rgba(34,197,94,0.12);   color:#4ade80; }
        .stage-onboarding  { background:rgba(168,85,247,0.12);  color:#c084fc; }
        .stage-completed   { background:rgba(255,255,255,0.06); color:#6b7280; }

        .job-card {
            background: rgba(15,15,15,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 14px;
            padding: 18px 20px;
            cursor: pointer;
            transition: all 0.25s ease;
        }
        .job-card:hover {
            border-color: rgba(255,255,255,0.14);
            background: rgba(25,25,25,0.95);
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.35);
        }
        .job-card .job-number { font-size: 11px; color: #555; font-family: monospace; }
        .job-card .job-name   { font-size: 15px; font-weight: 700; margin: 4px 0; }
        .job-card .job-meta   { font-size: 12px; color: #666; }

        /* Stage grid header (Live Jobs) */
        .stage-nav-grid {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-bottom: 24px;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .stage-nav-btn {
            display: flex; flex-direction: column; align-items: center; gap: 4px;
            padding: 12px 16px; border-radius: 12px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.06);
            background: rgba(255,255,255,0.02);
            transition: all 0.2s ease;
            min-width: 90px; text-align: center;
        }
        .stage-nav-btn:hover, .stage-nav-btn.active {
            background: rgba(255,255,255,0.06);
            border-color: rgba(255,255,255,0.12);
        }
        .stage-nav-btn .sn-count { font-size: 20px; font-weight: 800; }
        .stage-nav-btn .sn-label { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #666; }
        .stage-nav-btn.active .sn-label { color: inherit; }

        /* Job record tabs */
        .job-tab-nav { display: flex; gap: 2px; margin-bottom: 20px; flex-wrap: wrap; }
        .job-tab-btn {
            padding: 8px 16px; border-radius: 8px; font-size: 13px; font-weight: 600;
            color: #666; cursor: pointer; transition: all 0.2s ease; border: 1px solid transparent;
        }
        .job-tab-btn:hover { color: #ccc; background: rgba(255,255,255,0.04); }
        .job-tab-btn.active { color: #fff; background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.1); }

        /* Design Studio pipeline cards */
        .design-stage-card {
            background: rgba(15,15,15,0.9);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 16px;
            padding: 16px;
            transition: all 0.2s ease;
        }
        .design-stage-card:hover {
            border-color: rgba(236,72,153,0.3);
            background: rgba(236,72,153,0.03);
        }
        .design-stage-active {
            border-color: rgba(236,72,153,0.4) !important;
            background: rgba(236,72,153,0.06) !important;
        }
        .design-job-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 14px;
            padding: 16px;
            transition: all 0.2s ease;
            cursor: pointer;
        }
        .design-job-card:hover {
            border-color: rgba(236,72,153,0.3);
            background: rgba(236,72,153,0.03);
        }
        /* Design status action buttons */
        .ds-status-btn {
            flex: 1;
            padding: 10px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 700;
            text-align: center;
            cursor: pointer;
            border: 1px solid transparent;
            transition: all 0.2s ease;
        }
        .ds-status-btn.active { box-shadow: 0 0 0 2px currentColor; }
        /* Activity log */
        .activity-entry {
            display: flex;
            gap: 12px;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
        }
        .activity-entry:last-child { border-bottom: none; }
        .activity-avatar {
            width: 32px; height: 32px;
            border-radius: 50%;
            background: rgba(20,184,166,0.12);
            display: flex; align-items: center; justify-content: center;
            font-size: 12px; font-weight: 700; color: #2dd4bf;
            flex-shrink: 0;
        }
        /* Club team card */
        .club-team-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 12px;
            padding: 14px 16px;
        }

        /* Design version cards */
        .version-card {
            background: rgba(255,255,255,0.02);
            border: 1px solid rgba(255,255,255,0.07);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.2s ease;
        }
        .version-card.approved { border-color: rgba(34,197,94,0.3); background: rgba(34,197,94,0.04); }
        .version-card.rejected { border-color: rgba(239,68,68,0.2); background: rgba(239,68,68,0.03); opacity: 0.7; }
        .version-label { font-size: 13px; font-weight: 800; letter-spacing: 0.5px; }

        /* Design status badge */
        .design-status-new           { background:rgba(107,114,128,0.12); color:#9ca3af; }
        .design-status-in_progress   { background:rgba(59,130,246,0.12);  color:#60a5fa; }
        .design-status-revisions     { background:rgba(234,179,8,0.12);   color:#facc15; }
        .design-status-in_review     { background:rgba(168,85,247,0.12);  color:#c084fc; }
        .design-status-awaiting_approval { background:rgba(249,115,22,0.12); color:#fb923c; }
        .design-status-complete      { background:rgba(34,197,94,0.12);   color:#4ade80; }

        /* Pantone swatch */
        .pantone-swatch {
            width: 32px; height: 32px; border-radius: 8px;
            border: 1px solid rgba(255,255,255,0.1);
            display: inline-block; cursor: pointer; flex-shrink: 0;
        }

        /* ── Design stage filter row (single-line) ── */
        #ds-stage-nav { display:flex; gap:8px; overflow-x:auto; padding-bottom:4px; margin-bottom:24px; }
        #ds-stage-nav::-webkit-scrollbar { height:3px; }
        #ds-stage-nav::-webkit-scrollbar-track { background:transparent; }
        #ds-stage-nav::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.1); border-radius:2px; }
        .ds-filter-chip {
            display:flex; align-items:center; gap:8px; padding:8px 16px;
            border-radius:40px; border:1px solid rgba(255,255,255,0.08);
            background:rgba(255,255,255,0.03); cursor:pointer;
            transition:all 0.2s; white-space:nowrap; flex-shrink:0;
        }
        .ds-filter-chip:hover { border-color:rgba(236,72,153,0.3); }
        .ds-filter-chip.active { background:rgba(236,72,153,0.08); border-color:rgba(236,72,153,0.35); }
        .ds-filter-chip .chip-count { font-size:13px; font-weight:700; }
        .ds-filter-chip .chip-label { font-size:12px; font-weight:600; color:#aaa; }
        .ds-filter-chip.active .chip-label { color:#f472b6; }

        /* ── Job stage pills ── */
        .stage-pill-selector { display:flex; gap:4px; flex-wrap:wrap; }
        .stage-pill-btn {
            padding:5px 13px; border-radius:20px; font-size:12px; font-weight:700;
            cursor:pointer; transition:all 0.18s; border:1px solid rgba(255,255,255,0.08);
            background:rgba(255,255,255,0.04); color:#555; letter-spacing:0.2px;
        }
        .stage-pill-btn:hover { color:#ccc; background:rgba(255,255,255,0.07); }
        .stage-pill-btn.active { color:#fff; box-shadow:0 0 0 1.5px currentColor; }
        .design-stage-row { display:flex; gap:4px; flex-wrap:wrap; align-items:center; }

        /* ── Bulk product selector ── */
        .product-select-item {
            display:flex; align-items:center; gap-3; padding:10px 12px;
            border-radius:10px; border:1px solid rgba(255,255,255,0.06);
            background:rgba(255,255,255,0.02); cursor:pointer; transition:all 0.15s;
            gap:10px;
        }
        .product-select-item:hover { border-color:rgba(20,184,166,0.3); background:rgba(20,184,166,0.04); }
        .product-select-item.selected { border-color:rgba(20,184,166,0.4); background:rgba(20,184,166,0.07); }
        .product-select-item input[type=checkbox] { accent-color:#14b8a6; width:15px; height:15px; flex-shrink:0; cursor:pointer; }

        /* ── Annotation pin ── */
        .ann-pin {
            position:absolute; transform:translate(-50%,-100%);
            display:flex; flex-direction:column; align-items:center;
            pointer-events:none; z-index:10;
        }
        .ann-pin-bubble {
            width:24px; height:24px; border-radius:50%;
            display:flex; align-items:center; justify-content:center;
            font-size:11px; font-weight:800; color:#fff;
            box-shadow:0 2px 8px rgba(0,0,0,0.6);
        }
        .ann-pin-arrow {
            width:0; height:0;
            border-left:5px solid transparent;
            border-right:5px solid transparent;
            margin-top:-1px;
        }

        /* ── Design activity feed ── */
        .feed-item {
            padding:12px 14px; border-radius:12px;
            background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.06);
            transition:all 0.15s;
        }
        .feed-item:hover { border-color:rgba(255,255,255,0.1); }

        /* ── Annotation overlay ── */
        #ann-img-container { position:relative; display:inline-block; max-width:100%; }
        #ann-img-container img { display:block; max-width:100%; border-radius:10px; user-select:none; }
        #ann-overlay { position:absolute; inset:0; cursor:crosshair; border-radius:10px; }

        /* Club status badges */
        .status-retail       { background:rgba(107,114,128,0.12); color:#9ca3af; }
        .status-partner      { background:rgba(20,184,166,0.12);  color:#2dd4bf; }
        .status-partner-plus { background:rgba(168,85,247,0.12);  color:#c084fc; }

        /* Split grid (clubs portal) */
        .split-action-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-bottom: 32px; }
        @media (max-width: 640px) { .split-action-grid { grid-template-columns: 1fr; } }
        .split-action-card {
            padding: 28px; border-radius: 18px; cursor: pointer;
            border: 1px solid rgba(255,255,255,0.07);
            background: rgba(255,255,255,0.02);
            transition: all 0.25s ease; text-align: center;
        }
        .split-action-card:hover {
            background: rgba(255,255,255,0.05);
            border-color: rgba(255,255,255,0.12);
            transform: translateY(-2px);
        }

        /* ── Record page layout: side nav + content ── */
        .record-layout { display: grid; grid-template-columns: 192px 1fr; gap: 16px; align-items: start; }
        @media (max-width: 767px) { .record-layout { grid-template-columns: 1fr; } }
        .record-side-nav {
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px; padding: 6px; position: sticky; top: 74px;
            display: flex; flex-direction: column; gap: 1px;
        }
        @media (max-width: 767px) { .record-side-nav { flex-direction: row; flex-wrap: wrap; position: static; } }
        .record-nav-item {
            display: flex; align-items: center; gap: 9px; padding: 9px 12px;
            border-radius: 9px; font-size: 13px; font-weight: 600; color: #555;
            cursor: pointer; transition: all 0.18s; width: 100%; text-align: left;
            border: none; background: none; white-space: nowrap;
        }
        .record-nav-item:hover { color: #ccc; background: rgba(255,255,255,0.05); }
        .record-nav-item.active { color: #fff; background: rgba(255,255,255,0.08); }
        .record-nav-item svg { flex-shrink: 0; color: #444; transition: color 0.18s; }
        .record-nav-item.active svg { color: #2dd4bf; }
        .record-nav-divider { height: 1px; background: rgba(255,255,255,0.05); margin: 4px 6px; }

        /* ── Record timeline bar across the top ── */
        .record-timeline {
            display: flex; align-items: center; gap: 0;
            background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.06);
            border-radius: 14px; padding: 12px 20px; overflow-x: auto; margin-bottom: 16px;
        }
        .record-timeline::-webkit-scrollbar { height: 3px; }
        .record-timeline::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 2px; }
        .tl-step {
            display: flex; flex-direction: column; align-items: center; gap: 6px;
            flex: 1; min-width: 68px; position: relative; cursor: pointer;
        }
        .tl-step:not(:last-child)::after {
            content: ''; position: absolute; top: 8px;
            left: calc(50% + 12px); right: calc(-50% + 12px);
            height: 2px; background: rgba(255,255,255,0.07); pointer-events: none;
        }
        .tl-step.done:not(:last-child)::after { background: rgba(20,184,166,0.2); }
        .tl-dot {
            width: 18px; height: 18px; border-radius: 50%;
            background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.08);
            position: relative; z-index: 1; transition: all 0.2s; flex-shrink: 0;
        }
        .tl-dot.done { background: rgba(20,184,166,0.15); border-color: rgba(20,184,166,0.3); }
        .tl-dot.active { background: #14b8a6; border-color: #0d9488; box-shadow: 0 0 0 4px rgba(20,184,166,0.12); }
        .tl-label {
            font-size: 10px; font-weight: 600; text-transform: uppercase;
            letter-spacing: 0.35px; color: #444; text-align: center; white-space: nowrap;
        }
        .tl-step.done .tl-label { color: rgba(20,184,166,0.55); }
        .tl-step.active .tl-label { color: #2dd4bf; }
        .record-content { min-width: 0; }
    </style>
</head>
<body class="min-h-screen">
    <!-- TOAST -->
    <div id="toast" class="fixed top-4 right-4 z-50 hide">
        <div class="glass rounded-lg px-4 py-3 text-sm"></div>
    </div>

    <!-- AUTH SCREEN -->
    <div id="auth-screen" class="min-h-screen flex items-center justify-center p-4">
        <div class="glass rounded-2xl p-8 w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-2 text-brand-400">TeamwearOS</h1>
            <p class="text-gray-400 text-center mb-8">Sign in to continue</p>
            
            <div id="login-form">
                <input type="email" id="login-email" placeholder="Email" class="w-full px-4 py-3 rounded-lg mb-3">
                <input type="password" id="login-password" placeholder="Password" class="w-full px-4 py-3 rounded-lg mb-4">
                <button onclick="handleLogin()" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-semibold py-3 rounded-lg transition">
                    Sign In
                </button>
                <p class="text-center text-gray-500 mt-4 text-sm">
                    Don't have an account? <a href="#" onclick="showSignup()" class="text-brand-400 hover:underline">Sign up</a>
                </p>
            </div>

            <div id="signup-form" class="hide">
                <input type="email" id="signup-email" placeholder="Email" class="w-full px-4 py-3 rounded-lg mb-3">
                <input type="password" id="signup-password" placeholder="Password" class="w-full px-4 py-3 rounded-lg mb-3">
                <input type="password" id="signup-confirm" placeholder="Confirm Password" class="w-full px-4 py-3 rounded-lg mb-4">
                <button onclick="handleSignup()" class="w-full bg-brand-500 hover:bg-brand-600 text-white font-semibold py-3 rounded-lg transition">
                    Create Account
                </button>
                <p class="text-center text-gray-500 mt-4 text-sm">
                    Already have an account? <a href="#" onclick="showLogin()" class="text-brand-400 hover:underline">Sign in</a>
                </p>
            </div>
        </div>
    </div>

    <!-- MAIN APP -->
    <div id="main-app" class="hide">
        <!-- Header -->
        <header class="glass sticky top-0 z-40 px-6 py-4 flex items-center justify-between">
            <div class="flex items-center gap-3">
                <button onclick="showLaunchpad()" class="text-2xl font-bold text-brand-400 hover:text-brand-300">TeamwearOS</button>
                <div id="brand-selector" class="hide flex items-center gap-2">
                    <select id="brand-select" onchange="switchBrand(this.value)" class="bg-gray-900 border border-gray-700 text-brand-400 text-sm px-3 py-1 rounded-lg">
                    </select>
                    <button onclick="showCreateBrand()" class="text-brand-400 hover:text-brand-300 text-sm px-2">+ New</button>
                </div>
                <span id="brand-badge" class="bg-brand-500/20 text-brand-400 text-xs px-2 py-1 rounded-full"></span>
            </div>
            <div class="flex items-center gap-4">
                <span id="user-role" class="text-purple-400 text-xs hide">SUPER ADMIN</span>
                <span id="user-email" class="text-gray-400 text-sm"></span>
                <button onclick="showProfileSettings()" class="text-gray-400 hover:text-white text-sm px-2 py-1 rounded-lg hover:bg-white/5 transition">⚙ Settings</button>
                <button onclick="handleLogout()" class="text-gray-400 hover:text-white text-sm">Logout</button>
            </div>
        </header>

        <!-- Create Brand Modal -->
        <div id="create-brand-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-md">
                <h3 class="text-xl font-bold mb-4">Create New Brand</h3>
                <input type="text" id="new-brand-name" placeholder="Brand name (e.g. ROKOR Teamwear)" class="w-full px-4 py-3 rounded-lg mb-3">
                <input type="text" id="new-brand-slug" placeholder="Slug (e.g. rokor-teamwear)" class="w-full px-4 py-3 rounded-lg mb-4">
                <div class="flex gap-3">
                    <button onclick="hideCreateBrand()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg">Cancel</button>
                    <button onclick="createBrand()" class="flex-1 bg-brand-500 hover:bg-brand-600 py-3 rounded-lg font-semibold">Create Brand</button>
                </div>
            </div>
        </div>

        <!-- Profile Settings Modal -->
        <div id="profile-settings-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-sm mx-4">
                <div class="flex items-center justify-between mb-5">
                    <h3 class="text-lg font-bold">Profile &amp; Settings</h3>
                    <button onclick="hideProfileSettings()" class="text-gray-400 hover:text-white text-xl leading-none">&times;</button>
                </div>
                <div class="mb-5 pb-4 border-b border-gray-800">
                    <p class="text-xs text-gray-500 mb-1">Signed in as</p>
                    <p id="profile-email-display" class="font-semibold text-white text-sm"></p>
                </div>
                <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
                    <p class="text-xs text-gray-500 mb-3 font-medium uppercase tracking-wider">Record Visibility</p>
                    <label class="flex items-start gap-3 cursor-pointer mb-3 p-2 rounded-lg hover:bg-white/5 transition">
                        <input type="radio" name="view-scope" value="all" id="scope-all" onchange="updateViewScope('all')" class="mt-0.5 accent-brand-500 flex-shrink-0">
                        <div>
                            <p class="text-sm font-medium">All Records</p>
                            <p class="text-xs text-gray-500">See all clubs and jobs for this brand</p>
                        </div>
                    </label>
                    <label class="flex items-start gap-3 cursor-pointer p-2 rounded-lg hover:bg-white/5 transition">
                        <input type="radio" name="view-scope" value="mine" id="scope-mine" onchange="updateViewScope('mine')" class="mt-0.5 accent-brand-500 flex-shrink-0">
                        <div>
                            <p class="text-sm font-medium">My Records Only</p>
                            <p class="text-xs text-gray-500">Only show clubs and jobs you created</p>
                        </div>
                    </label>
                </div>
                <button onclick="hideProfileSettings()" class="w-full btn-primary py-2.5">Done</button>
            </div>
        </div>

        <!-- Launchpad -->
        <div id="launchpad" class="p-8 max-w-6xl mx-auto">
            <!-- Welcome header -->
            <div class="flex items-end justify-between mb-10">
                <div>
                    <p class="text-sm text-gray-500 mb-1 uppercase tracking-widest font-medium">Home</p>
                    <h2 class="text-3xl font-bold">TeamwearOS</h2>
                    <p class="text-gray-500 text-sm mt-1">Your teamwear operations platform</p>
                </div>
                <div class="text-right hide" id="launchpad-brand-display">
                    <p class="text-xs text-gray-600 uppercase tracking-wider">Active Brand</p>
                    <p id="launchpad-brand-name" class="text-brand-400 font-semibold"></p>
                </div>
            </div>

            <!-- No-brand notice (shown when user has no brand assigned) -->
            <div id="no-brand-notice" class="hide glass rounded-2xl p-6 mb-8 border border-yellow-500/20">
                <div class="flex items-start gap-4">
                    <div class="text-yellow-400 text-2xl flex-shrink-0">⚠</div>
                    <div>
                        <p class="font-semibold text-yellow-300 mb-1">Account not yet set up</p>
                        <p class="text-gray-400 text-sm">Your account has been created but hasn't been assigned to a brand yet. Please contact your administrator to be set up with access.</p>
                    </div>
                </div>
            </div>

            <!-- Main Feature Grid -->
            <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5" id="feature-grid">

                <!-- Prospecting -->
                <div id="fc-prospecting" onclick="showTool('prospecting')" class="feature-card accent-teal">
                    <span class="card-badge badge-new" id="badge-prospecting" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(20,184,166,0.12)"><svg class="w-7 h-7" fill="none" stroke="#2dd4bf" viewBox="0 0 24 24" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2" fill="#2dd4bf"/></svg></div>
                    <h3>Prospecting</h3>
                    <p>Track leads, manage early conversations and monitor conversion pipeline</p>
                    <div class="mt-4 flex items-center gap-2">
                        <span id="stat-leads-nc" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(20,184,166,0.1);color:#2dd4bf">0 new leads</span>
                        <span id="stat-leads-id" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(255,255,255,0.05);color:#888">0 in discussion</span>
                    </div>
                </div>

                <!-- Sales -->
                <div id="fc-sales" onclick="showTool('sales')" class="feature-card accent-purple">
                    <span class="card-badge badge-new" id="badge-sales" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(139,92,246,0.12)"><svg class="w-7 h-7" fill="none" stroke="#a78bfa" viewBox="0 0 24 24" stroke-width="1.5"><rect x="2" y="7" width="20" height="14" rx="2"/><path stroke-linecap="round" stroke-linejoin="round" d="M16 7V5a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6v4m-3-2h6"/></svg></div>
                    <h3>Sales</h3>
                    <p>Manage jobs, design briefs, club products and order pipeline</p>
                    <div class="mt-4 flex items-center gap-2">
                        <span id="stat-jobs-live" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(139,92,246,0.1);color:#a78bfa">0 live jobs</span>
                        <span id="stat-jobs-done" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(255,255,255,0.04);color:#666">0 completed</span>
                    </div>
                </div>

                <!-- Clubs -->
                <div id="fc-clubs" onclick="showTool('clubs')" class="feature-card accent-purple">
                    <span class="card-badge badge-new" id="badge-clubs" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(139,92,246,0.12)"><svg class="w-7 h-7" fill="none" stroke="#a78bfa" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M9 21V5.25A2.25 2.25 0 0111.25 3h1.5A2.25 2.25 0 0115 5.25V21m-6 0h6M3.75 21V10.5A2.25 2.25 0 016 8.25h.75M20.25 21V10.5a2.25 2.25 0 00-2.25-2.25H17.25"/></svg></div>
                    <h3>Clubs</h3>
                    <p>Manage clubs, custom products, order forms and Shopify collections</p>
                    <div class="mt-4">
                        <span id="stat-clubs-lp" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(139,92,246,0.1);color:#a78bfa">0 clubs</span>
                    </div>
                </div>

                <!-- Production -->
                <div id="fc-production" onclick="showTool('po-tracker')" class="feature-card accent-orange">
                    <span class="card-badge badge-new" id="badge-production" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(249,115,22,0.12)"><svg class="w-7 h-7" fill="none" stroke="#fb923c" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M8.25 18.75a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h6m-9 0H3.375a1.125 1.125 0 01-1.125-1.125V14.25m17.25 4.5a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m3 0h1.125c.621 0 1.129-.504 1.09-1.124a17.902 17.902 0 00-3.213-9.193 2.056 2.056 0 00-1.58-.86H14.25M16.5 18.75h-2.25m0-11.177v-.958c0-.568-.422-1.048-.987-1.106a48.554 48.554 0 00-10.026 0 1.106 1.106 0 00-.987 1.106v7.635m12-6.677v6.677m0 4.5v-4.5m0 0h-12"/></svg></div>
                    <h3>Production</h3>
                    <p>Purchase orders, factory tracking and delivery management</p>
                    <div class="mt-4">
                        <span id="stat-pos-lp" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(249,115,22,0.1);color:#fb923c">0 active POs</span>
                    </div>
                </div>

                <!-- Design Studio -->
                <div id="fc-design" onclick="showTool('design-studio')" class="feature-card accent-pink">
                    <span class="card-badge badge-new" id="badge-design" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(236,72,153,0.12)"><svg class="w-7 h-7" fill="none" stroke="#f472b6" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.53 16.122a3 3 0 00-5.78 1.128 2.25 2.25 0 01-2.4 2.245 4.5 4.5 0 008.4-2.245c0-.399-.078-.78-.22-1.128zm0 0a15.998 15.998 0 003.388-1.62m-5.043-.025a15.994 15.994 0 011.622-3.395m3.42 3.42a15.995 15.995 0 004.764-4.648l3.876-5.814a1.151 1.151 0 00-1.597-1.597L14.146 6.32a15.996 15.996 0 00-4.649 4.763m3.42 3.42a6.776 6.776 0 00-3.42-3.42"/></svg></div>
                    <h3>Design Studio</h3>
                    <p>Design pipeline — track briefs by stage from working to approved</p>
                    <div class="mt-4 flex items-center gap-2">
                        <span id="stat-design-active" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(236,72,153,0.1);color:#f472b6">0 active</span>
                        <span id="stat-design-review" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(255,255,255,0.04);color:#666">0 in review</span>
                    </div>
                </div>

                <!-- Store Generator -->
                <div id="fc-store" onclick="showTool('generator')" class="feature-card accent-blue">
                    <span class="card-badge badge-new" id="badge-store" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(59,130,246,0.12)"><svg class="w-7 h-7" fill="none" stroke="#60a5fa" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M13.5 21v-7.5a.75.75 0 01.75-.75h3a.75.75 0 01.75.75V21m-4.5 0H2.36m11.14 0H18m0 0h3.64m-1.39 0V9.349m-16.5 11.65V9.35m0 0a3.001 3.001 0 003.75-.615A2.993 2.993 0 009.75 9.75c.896 0 1.7-.393 2.25-1.016a2.993 2.993 0 002.25 1.016c.896 0 1.7-.393 2.25-1.016a3.001 3.001 0 003.75.614m-16.5 0a3.004 3.004 0 01-.621-4.72L4.318 3.44A1.5 1.5 0 015.378 3h13.243a1.5 1.5 0 011.06.44l1.19 1.189a3 3 0 01-.621 4.72m-13.5 8.65h3.75a.75.75 0 00.75-.75V13.5a.75.75 0 00-.75-.75H6.75a.75.75 0 00-.75.75v3.75c0 .415.336.75.75.75z"/></svg></div>
                    <h3>Store Generator</h3>
                    <p>Generate Shopify CSV imports and sync products to your store</p>
                    <div class="mt-4">
                        <span id="stat-products-lp" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(59,130,246,0.1);color:#60a5fa">0 products</span>
                    </div>
                </div>

                <!-- Product Database -->
                <div id="fc-products" onclick="showTool('products')" class="feature-card accent-teal">
                    <span class="card-badge badge-new" id="badge-products" style="display:none">Off</span>
                    <div class="card-icon" style="background:rgba(20,184,166,0.12)"><svg class="w-7 h-7" fill="none" stroke="#2dd4bf" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z"/></svg></div>
                    <h3>Product Database</h3>
                    <p>Master catalogue — product codes, pricing and size structure for all ranges</p>
                    <div class="mt-4">
                        <span id="stat-products-db" class="text-xs font-semibold px-2 py-1 rounded-md" style="background:rgba(20,184,166,0.1);color:#2dd4bf">0 products</span>
                    </div>
                </div>

            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-8">
                <div class="stat-card">
                    <p class="text-xs text-gray-500 mb-1">Products</p>
                    <p id="stat-products" class="text-2xl font-bold text-brand-400">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs text-gray-500 mb-1">Clubs</p>
                    <p id="stat-clubs" class="text-2xl font-bold" style="color:#a78bfa">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs text-gray-500 mb-1">Active POs</p>
                    <p id="stat-orders" class="text-2xl font-bold" style="color:#60a5fa">0</p>
                </div>
                <div class="stat-card">
                    <p class="text-xs text-gray-500 mb-1">Leads</p>
                    <p id="stat-salespeople" class="text-2xl font-bold" style="color:#fb923c">0</p>
                </div>
            </div>

            <!-- Super Admin Section -->
            <div id="admin-section" class="hide mt-10">
                <div class="flex items-center gap-3 mb-5">
                    <div class="h-px flex-1" style="background:rgba(139,92,246,0.2)"></div>
                    <span class="text-xs font-semibold text-purple-400 uppercase tracking-wider">Admin Tools</span>
                    <div class="h-px flex-1" style="background:rgba(139,92,246,0.2)"></div>
                </div>
                <div class="grid md:grid-cols-2 lg:grid-cols-3 gap-5">
                    <div onclick="showTool('settings')" class="feature-card" style="border-color:rgba(139,92,246,0.15)">
                        <div class="card-icon" style="background:rgba(139,92,246,0.12)"><svg class="w-7 h-7" fill="none" stroke="#a78bfa" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg></div>
                        <h3>Brand Settings</h3>
                        <p>Manage brand config, salespeople and feature toggles</p>
                    </div>
                    <div onclick="showTool('users')" class="feature-card" style="border-color:rgba(139,92,246,0.15)">
                        <div class="card-icon" style="background:rgba(139,92,246,0.12)"><svg class="w-7 h-7" fill="none" stroke="#a78bfa" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z"/></svg></div>
                        <h3>User Management</h3>
                        <p>Assign users to brands and manage access</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- TOOL: Product Database -->
        <div id="tool-products" class="hide p-8 max-w-7xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                ← Back to Launchpad
            </button>
            <div class="flex items-start justify-between mb-4">
                <div>
                    <h2 class="text-2xl font-bold">Master Product Catalogue</h2>
                    <p class="text-gray-500 text-sm mt-1">The definitive source of truth — all ranges, pricing tiers and size structures for this brand</p>
                </div>
            </div>

            <!-- Uniform Structure Guide -->
            <div class="glass rounded-2xl p-4 mb-6 border" style="border-color:rgba(20,184,166,0.2)">
                <div class="flex items-start gap-3">
                    <svg class="w-5 h-5 mt-0.5 flex-shrink-0 text-brand-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M11.25 11.25l.041-.02a.75.75 0 011.063.852l-.708 2.836a.75.75 0 001.063.853l.041-.021M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9-3.75h.008v.008H12V8.25z"/></svg>
                    <div class="flex-1">
                        <p class="text-sm font-semibold text-brand-400 mb-1">Uniform Product Code Structure</p>
                        <p class="text-xs text-gray-400 mb-2">All products must follow the format: <code class="bg-gray-900 px-1 py-0.5 rounded text-brand-300">BRAND/RANGE/NNN</code> — e.g. <code class="bg-gray-900 px-1 py-0.5 rounded text-brand-300">RKR/ATL/001</code></p>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-3 text-xs text-gray-500">
                            <div><span class="text-gray-300 font-medium">BRAND</span> — short brand prefix for this brand</div>
                            <div><span class="text-gray-300 font-medium">RANGE</span> — 3-letter range code (e.g. ATL = Atlas)</div>
                            <div><span class="text-gray-300 font-medium">NNN</span> — 3-digit item number (001, 002…)</div>
                            <div><span class="text-gray-300 font-medium">Club SKU</span> — appended automatically: <code class="bg-gray-900 px-1 py-0.5 rounded text-brand-300">/WFC-S</code></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Action Bar -->
            <div class="flex flex-wrap gap-4 mb-6">
                <button onclick="showAddProductModal()" class="bg-brand-500 hover:bg-brand-600 px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    + Add Product
                </button>
                <button onclick="document.getElementById('csv-upload').click()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/></svg>
                    Import CSV
                </button>
                <input type="file" id="csv-upload" accept=".csv" class="hide" onchange="handleCSVUpload(event)">
                <button onclick="exportProductsCSV()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5"/><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v13.5M7.5 13.5L12 18l4.5-4.5"/></svg>
                    Export CSV
                </button>
                <button onclick="showCatalogueSettings()" class="bg-gray-700 hover:bg-gray-600 px-4 py-2 rounded-lg font-semibold flex items-center gap-2">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.594 3.94c.09-.542.56-.94 1.11-.94h2.593c.55 0 1.02.398 1.11.94l.213 1.281c.063.374.313.686.645.87.074.04.147.083.22.127.324.196.72.257 1.075.124l1.217-.456a1.125 1.125 0 011.37.49l1.296 2.247a1.125 1.125 0 01-.26 1.431l-1.003.827c-.293.24-.438.613-.431.992a6.759 6.759 0 010 .255c-.007.378.138.75.43.99l1.005.828c.424.35.534.954.26 1.43l-1.298 2.247a1.125 1.125 0 01-1.369.491l-1.217-.456c-.355-.133-.75-.072-1.076.124a6.57 6.57 0 01-.22.128c-.331.183-.581.495-.644.869l-.213 1.28c-.09.543-.56.941-1.11.941h-2.594c-.55 0-1.02-.398-1.11-.94l-.213-1.281c-.062-.374-.312-.686-.644-.87a6.52 6.52 0 01-.22-.127c-.325-.196-.72-.257-1.076-.124l-1.217.456a1.125 1.125 0 01-1.369-.49l-1.297-2.247a1.125 1.125 0 01.26-1.431l1.004-.827c.292-.24.437-.613.43-.992a6.932 6.932 0 010-.255c.007-.378-.138-.75-.43-.99l-1.004-.828a1.125 1.125 0 01-.26-1.43l1.297-2.247a1.125 1.125 0 011.37-.491l1.216.456c.356.133.751.072 1.076-.124.072-.044.146-.087.22-.128.332-.183.582-.495.644-.869l.214-1.281z"/><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                    Catalogue Settings
                </button>
                <div class="flex-1"></div>
                <button onclick="showBulkDeleteModal()" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-4 py-2 rounded-lg font-semibold flex items-center gap-2 border border-red-500/50">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0"/></svg>
                    Delete All Products
                </button>
            </div>

            <!-- Import Status -->
            <div id="import-status" class="mb-6 hide">
                <div class="bg-brand-500/20 rounded-lg p-4">
                    <p id="import-message" class="text-brand-400"></p>
                </div>
            </div>

            <!-- Filters -->
            <div class="glass rounded-2xl p-4 mb-6">
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4">
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Search</label>
                        <input type="text" id="product-search" placeholder="Code or name..." class="w-full px-3 py-2 rounded-lg text-sm" oninput="filterProducts()">
                    </div>
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Category</label>
                        <select id="filter-category" class="w-full px-3 py-2 rounded-lg text-sm" onchange="filterProducts()">
                            <option value="">All Categories</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Range</label>
                        <select id="filter-range" class="w-full px-3 py-2 rounded-lg text-sm" onchange="filterProducts()">
                            <option value="">All Ranges</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Fit Type</label>
                        <select id="filter-fit" class="w-full px-3 py-2 rounded-lg text-sm" onchange="filterProducts()">
                            <option value="">All</option>
                            <option value="Adult / Youth">Adult / Youth</option>
                            <option value="One Size Only">One Size Only</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Tag</label>
                        <input type="text" id="filter-tag" placeholder="Filter by tag..." class="w-full px-3 py-2 rounded-lg text-sm" oninput="filterProducts()">
                    </div>
                </div>
                <div class="flex justify-between items-center mt-3">
                    <span class="text-gray-400 text-sm">Showing <span id="filtered-count">0</span> of <span id="product-count">0</span> products</span>
                    <button onclick="clearFilters()" class="text-brand-400 hover:text-brand-300 text-sm">Clear Filters</button>
                </div>
            </div>

            <!-- Products Table -->
            <div class="glass rounded-2xl p-6 overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead>
                            <tr id="products-table-header" class="text-left text-gray-400 border-b border-gray-800">
                                <th class="pb-3 pr-3 whitespace-nowrap">Code</th>
                                <th class="pb-3 pr-3">Name</th>
                                <th class="pb-3 pr-3">Category</th>
                                <th class="pb-3 pr-3">Range</th>
                                <th class="pb-3 pr-3 text-right" id="th-youth-price">Youth Price</th>
                                <th class="pb-3 pr-3 text-right" id="th-adult-price">Adult Price</th>
                                <th class="pb-3 pr-3">Tags</th>
                                <th class="pb-3 text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="products-table"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Add/Edit Product Modal -->
        <div id="product-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl p-6 w-full max-w-4xl mx-4 my-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="product-modal-title" class="text-xl font-bold">Add Product</h3>
                    <button onclick="hideProductModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                
                <input type="hidden" id="edit-product-id">
                
                <!-- Basic Info -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Product Code *</label>
                        <input type="text" id="prod-code" placeholder="BRAND/RANGE/001" class="w-full px-3 py-2 rounded-lg font-mono">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Item Name *</label>
                        <input type="text" id="prod-name" placeholder="e.g. Zipped Hoodie" class="w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Category *</label>
                        <input type="text" id="prod-category" list="prod-categories-list" placeholder="e.g. Football Match Kit" class="w-full px-3 py-2 rounded-lg">
                        <datalist id="prod-categories-list"></datalist>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Range *</label>
                        <input type="text" id="prod-range" list="prod-ranges-list" placeholder="e.g. Atlas, Warrior" class="w-full px-3 py-2 rounded-lg">
                        <datalist id="prod-ranges-list"></datalist>
                    </div>
                </div>

                <!-- Pricing -->
                <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
                    <div class="flex items-center justify-between mb-3">
                        <h4 class="font-semibold text-brand-400">Pricing</h4>
                        <button type="button" onclick="showManagePricingTiersModal()" class="text-xs text-gray-400 hover:text-brand-400 flex items-center gap-1 transition">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4"/></svg>
                            Manage Tiers
                        </button>
                    </div>
                    <div id="product-pricing-fields" class="space-y-3">
                        <!-- Rendered dynamically by renderPricingFields() based on brand tiers -->
                    </div>
                    <!-- Legacy hidden fields for backward compatibility -->
                    <input type="hidden" id="prod-youth-retail">
                    <input type="hidden" id="prod-youth-partner">
                    <input type="hidden" id="prod-adult-retail">
                    <input type="hidden" id="prod-adult-partner">
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <label class="flex items-center gap-2 text-sm cursor-pointer">
                            <input type="checkbox" id="prod-single-price" onchange="toggleSinglePrice()" class="rounded">
                            <span class="text-gray-300">Single price item (one size / accessories)</span>
                        </label>
                    </div>
                </div>

                <!-- Product Details -->
                <div class="bg-gray-800/50 rounded-xl p-4 mb-4">
                    <h4 class="font-semibold mb-3 text-brand-400">Product Details</h4>
                    <div class="grid grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">Weight (grams)</label>
                            <input type="number" id="prod-weight" placeholder="450" class="w-full px-3 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">COGS (£)</label>
                            <input type="number" step="0.01" id="prod-cogs" placeholder="18.00" class="w-full px-3 py-2 rounded-lg">
                        </div>
                    </div>
                    <!-- Hidden legacy fit_type for backward compat -->
                    <input type="hidden" id="prod-fit-type" value="Adult">
                    <!-- Size Categories — tick all that apply -->
                    <p class="text-gray-400 text-xs mb-2 font-medium">Size Categories <span class="text-gray-600">(tick all that apply — sizes can be edited below)</span></p>
                    <div class="space-y-2">
                        <!-- Adult -->
                        <div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                            <label class="flex items-center gap-3 cursor-pointer select-none">
                                <input type="checkbox" id="prod-fit-adult" onchange="onFitsChanged()" class="w-4 h-4 accent-brand-500">
                                <span class="text-sm font-medium">Adult <span class="text-gray-500 font-normal text-xs ml-1">S, M, L, XL, 2XL, 3XL, 4XL, 5XL, 6XL</span></span>
                            </label>
                            <div id="prod-adult-sizes-row" class="mt-2 ml-7 hide">
                                <label class="text-xs text-gray-500 mb-1 block">Sizes (comma-separated)</label>
                                <input type="text" id="prod-sizes" class="w-full px-3 py-1.5 rounded-lg text-xs font-mono" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1)">
                            </div>
                        </div>
                        <!-- Youth Unisex -->
                        <div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                            <label class="flex items-center gap-3 cursor-pointer select-none">
                                <input type="checkbox" id="prod-fit-youth" onchange="onFitsChanged()" class="w-4 h-4 accent-brand-500">
                                <span class="text-sm font-medium">Youth Unisex <span class="text-gray-500 font-normal text-xs ml-1">YXXS, YXS, YS, YM, YL, YXL</span></span>
                            </label>
                            <div id="prod-youth-sizes-row" class="mt-2 ml-7 hide">
                                <label class="text-xs text-gray-500 mb-1 block">Sizes (comma-separated)</label>
                                <input type="text" id="prod-youth-sizes" class="w-full px-3 py-1.5 rounded-lg text-xs font-mono" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1)">
                            </div>
                        </div>
                        <!-- Women's -->
                        <div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                            <label class="flex items-center gap-3 cursor-pointer select-none">
                                <input type="checkbox" id="prod-fit-women" onchange="onFitsChanged()" class="w-4 h-4 accent-brand-500">
                                <span class="text-sm font-medium">Women's <span class="text-gray-500 font-normal text-xs ml-1">6, 8, 10, 12, 14, 16, 18, 20, 22, 24, 26</span></span>
                            </label>
                            <div id="prod-women-sizes-row" class="mt-2 ml-7 hide">
                                <label class="text-xs text-gray-500 mb-1 block">Sizes (comma-separated)</label>
                                <input type="text" id="prod-women-sizes" class="w-full px-3 py-1.5 rounded-lg text-xs font-mono" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.1)">
                            </div>
                        </div>
                    </div>

                    <!-- Shopify Tags (replaces has_addons) -->
                    <div class="mt-3 pt-3 border-t border-gray-700">
                        <label class="text-gray-400 text-sm mb-2 block">Shopify Tags <span class="text-gray-600 text-xs ml-1">(saved per brand — reusable)</span></label>
                        <div class="flex gap-2 mb-2">
                            <input type="text" id="prod-tag-input" placeholder="Type a tag and press Enter..." class="flex-1 px-3 py-2 rounded-lg text-sm" onkeydown="handleProductTagInput(event)">
                            <button type="button" onclick="addProductTag()" class="btn-secondary text-sm px-3">Add</button>
                        </div>
                        <div id="brand-saved-tags" class="flex flex-wrap gap-1 mb-2 empty:hidden"></div>
                        <div id="product-tags-chips" class="flex flex-wrap gap-1 min-h-5"></div>
                    </div>
                </div>

                <!-- Description -->
                <div class="mb-6">
                    <label class="text-gray-400 text-sm mb-1 block">Product Description (for Shopify)</label>
                    <textarea id="prod-description" rows="4" placeholder="Use *ADD CLUB NAME + RANGE* or *ADD CLUB NAME* as placeholders — these are replaced automatically when generating the Shopify CSV for each club." class="w-full px-3 py-2 rounded-lg"></textarea>
                    <p class="text-gray-500 text-xs mt-1">Placeholders: <code class="bg-gray-900 px-1 rounded">*ADD CLUB NAME*</code> and <code class="bg-gray-900 px-1 rounded">*ADD CLUB NAME + RANGE*</code></p>
                </div>

                <!-- Actions -->
                <div class="flex gap-3">
                    <button onclick="hideProductModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg">Cancel</button>
                    <button onclick="saveProduct()" class="flex-1 bg-brand-500 hover:bg-brand-600 py-3 rounded-lg font-semibold">Save Product</button>
                </div>
            </div>
        </div>

        <!-- Delete Confirmation Modal -->
        <div id="delete-product-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
                <h3 class="text-xl font-bold mb-4">Delete Product</h3>
                <p class="text-gray-400 mb-6">Are you sure you want to delete <span id="delete-product-name" class="text-white font-semibold"></span>? This cannot be undone.</p>
                <input type="hidden" id="delete-product-id">
                <div class="flex gap-3">
                    <button onclick="hideDeleteModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg">Cancel</button>
                    <button onclick="confirmDeleteProduct()" class="flex-1 bg-red-500 hover:bg-red-600 py-3 rounded-lg font-semibold">Delete</button>
                </div>
            </div>
        </div>

        <!-- Bulk Delete Modal -->
        <div id="bulk-delete-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
                <h3 class="text-xl font-bold mb-4 text-red-400">⚠️ Delete All Products</h3>
                <p class="text-gray-400 mb-4">This will permanently delete <span id="bulk-delete-count" class="text-white font-semibold">0</span> products from <span id="bulk-delete-brand" class="text-brand-400 font-semibold"></span>.</p>
                <p class="text-gray-400 mb-4">This action <span class="text-red-400 font-semibold">cannot be undone</span>.</p>
                <div class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 mb-6">
                    <p class="text-sm text-gray-300 mb-2">Type <span class="text-red-400 font-mono">DELETE ALL</span> to confirm:</p>
                    <input type="text" id="bulk-delete-confirm" placeholder="DELETE ALL" class="w-full px-3 py-2 rounded-lg bg-gray-900 border border-red-500/50">
                </div>
                <div class="flex gap-3">
                    <button onclick="hideBulkDeleteModal()" class="flex-1 bg-gray-700 hover:bg-gray-600 py-3 rounded-lg">Cancel</button>
                    <button onclick="confirmBulkDelete()" class="flex-1 bg-red-500 hover:bg-red-600 py-3 rounded-lg font-semibold">Delete All</button>
                </div>
            </div>
        </div>

        <!-- TOOL: Club Mock-Ups -->
        <!-- TOOL: Design Studio Pipeline Launchpad -->
        <div id="tool-design-studio" class="hide p-6 md:p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>

            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold">Design Studio</h2>
                    <p class="text-gray-500 text-sm mt-1">All design briefs across the pipeline</p>
                </div>
                <div class="flex gap-3 items-center">
                    <span class="text-xs text-gray-500">Filter:</span>
                    <button id="ds-filter-mine" onclick="setDesignFilter('mine')" class="text-xs px-3 py-1.5 rounded-lg font-medium" style="background:rgba(236,72,153,0.15);color:#f472b6;border:1px solid rgba(236,72,153,0.3)">My Jobs</button>
                    <button id="ds-filter-all" onclick="setDesignFilter('all')" class="text-xs px-3 py-1.5 rounded-lg font-medium" style="background:rgba(255,255,255,0.05);color:#888;border:1px solid rgba(255,255,255,0.08)">All Jobs</button>
                </div>
            </div>

            <!-- Stage Pipeline — single-line filter chips -->
            <div id="ds-stage-nav">
                <div onclick="filterDesignByStage('all')" id="ds-stage-all" class="ds-filter-chip active">
                    <span class="chip-count text-white" id="ds-count-all">0</span>
                    <span class="chip-label">All</span>
                </div>
                <div onclick="filterDesignByStage('new')" id="ds-stage-new" class="ds-filter-chip">
                    <span class="chip-count text-brand-400" id="ds-count-new">0</span>
                    <span class="chip-label">New</span>
                </div>
                <div onclick="filterDesignByStage('in_progress')" id="ds-stage-in_progress" class="ds-filter-chip">
                    <span class="chip-count" style="color:#fbbf24" id="ds-count-in_progress">0</span>
                    <span class="chip-label">Working</span>
                </div>
                <div onclick="filterDesignByStage('in_review')" id="ds-stage-in_review" class="ds-filter-chip">
                    <span class="chip-count" style="color:#60a5fa" id="ds-count-in_review">0</span>
                    <span class="chip-label">In Review</span>
                </div>
                <div onclick="filterDesignByStage('revisions')" id="ds-stage-revisions" class="ds-filter-chip">
                    <span class="chip-count" style="color:#fb7185" id="ds-count-revisions">0</span>
                    <span class="chip-label">Revisions</span>
                </div>
                <div onclick="filterDesignByStage('awaiting_approval')" id="ds-stage-awaiting_approval" class="ds-filter-chip">
                    <span class="chip-count" style="color:#a78bfa" id="ds-count-awaiting_approval">0</span>
                    <span class="chip-label">Awaiting Approval</span>
                </div>
                <div onclick="filterDesignByStage('complete')" id="ds-stage-complete" class="ds-filter-chip">
                    <span class="chip-count" style="color:#4ade80" id="ds-count-complete">0</span>
                    <span class="chip-label">Approved</span>
                </div>
            </div>

            <!-- Design Jobs + Activity Feed side-by-side -->
            <div class="flex gap-6 items-start">
                <!-- Briefs list (left, wider) -->
                <div class="flex-1 min-w-0">
                    <div id="ds-jobs-list" class="space-y-3">
                        <!-- Populated by JS -->
                    </div>
                    <div id="ds-jobs-empty" class="hide text-center py-16">
                        <div class="empty-icon text-5xl mb-3">🎨</div>
                        <p class="text-gray-400 font-medium">No design briefs found</p>
                        <p class="text-gray-600 text-sm mt-1">Design briefs are created from within job records</p>
                    </div>
                </div>

                <!-- Activity Feed (right, fixed width) -->
                <div class="w-80 flex-shrink-0" style="min-width:280px">
                    <div class="glass rounded-2xl p-5 sticky top-6">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="font-semibold text-sm">Activity Feed</h4>
                            <button onclick="refreshDesignFeed()" class="text-xs text-gray-500 hover:text-brand-400 transition">Refresh</button>
                        </div>
                        <div id="ds-feed-list" class="space-y-3 max-h-96 overflow-y-auto">
                            <p class="text-xs text-gray-600 text-center py-4">Loading feed…</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tool-mockups" class="hide p-6 md:p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>
            
            <div class="flex items-center justify-between mb-8">
                <div>
                    <h2 class="text-2xl font-bold">Club Mock-Ups</h2>
                    <p class="text-gray-500 text-sm mt-1">Create clubs and upload product images</p>
                </div>
            </div>

            <!-- Step 1: Create or Select Club -->
            <div class="card mb-6">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-brand-500 flex items-center justify-center text-sm font-bold">1</div>
                        <h3 class="font-semibold text-lg">Create or Select Club</h3>
                    </div>
                </div>
                
                <!-- Create New Club - Inline Form -->
                <div class="flex flex-col md:flex-row gap-3 mb-6">
                    <div class="flex-1">
                        <input type="text" id="new-club-name" placeholder="Enter club name (e.g. Liphook United FC)" 
                            class="w-full px-4 py-3 rounded-xl text-sm" oninput="generateSuffix()">
                    </div>
                    <div class="w-full md:w-32">
                        <input type="text" id="generated-suffix" placeholder="SUFFIX" 
                            class="w-full px-4 py-3 rounded-xl text-sm font-mono text-center text-brand-400 uppercase" maxlength="6">
                    </div>
                    <button id="create-club-btn" onclick="createClub()" class="btn-primary whitespace-nowrap flex items-center justify-center gap-2">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Create Club
                    </button>
                </div>
                
                <!-- Clubs List -->
                <div id="clubs-loading" class="flex items-center justify-center py-8 hide">
                    <div class="spinner"></div>
                    <span class="ml-3 text-gray-500 text-sm">Loading clubs...</span>
                </div>
                
                <div id="clubs-empty" class="text-center py-8 hide">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center">
                        <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                    </div>
                    <p class="text-gray-500">No clubs yet. Create your first club above.</p>
                </div>
                
                <div id="clubs-list" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Step 2: Upload Images (shown when club selected) -->
            <div id="upload-section" class="card mb-6 hide">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-brand-500 flex items-center justify-center text-sm font-bold">2</div>
                        <div>
                            <h3 class="font-semibold text-lg">Upload Images</h3>
                            <p class="text-gray-500 text-sm">for <span id="selected-club-name" class="text-brand-400 font-medium"></span> <span id="selected-club-suffix" class="text-gray-600 font-mono text-xs"></span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="showNamingHelp(event)" class="help-trigger flex items-center gap-1 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Naming Help
                        </button>
                        <button onclick="closeUploadSection()" class="text-gray-500 hover:text-white p-1 rounded transition">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                        </button>
                    </div>
                </div>
                
                <!-- Upload Area -->
                <div id="dropzone" class="dropzone p-8 text-center cursor-pointer" 
                    onclick="document.getElementById('image-upload').click()"
                    ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleDrop(event)">
                    <input type="file" id="image-upload" accept="image/*" multiple class="hide" onchange="handleImageUpload(event)">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-brand-500/10 flex items-center justify-center">
                        <svg class="w-8 h-8 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                    </div>
                    <p class="text-white font-medium mb-1">Drop images here or click to browse</p>
                    <p class="text-gray-500 text-sm">PNG, JPG, WEBP • Product images + collection image</p>
                </div>
                
                <!-- Upload Progress -->
                <div id="upload-progress" class="mt-4 hide">
                    <div class="flex items-center justify-between mb-2">
                        <span id="upload-status-text" class="text-sm text-gray-400">Uploading...</span>
                        <span id="upload-count-text" class="text-sm text-brand-400 font-medium">0/0</span>
                    </div>
                    <div class="progress-bar">
                        <div id="upload-progress-bar" class="progress-fill" style="width: 0%"></div>
                    </div>
                </div>
            </div>

            <!-- Step 3: Uploaded Images (shown when club has images) -->
            <div id="images-section" class="card hide">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-brand-500 flex items-center justify-center text-sm font-bold">3</div>
                        <h3 class="font-semibold text-lg">Uploaded Images</h3>
                    </div>
                    <div class="flex items-center gap-4">
                        <span id="images-count-badge" class="badge badge-info">0 images</span>
                        <span id="collection-status-badge" class="badge"></span>
                    </div>
                </div>
                
                <!-- Collection Image -->
                <div id="collection-image-section" class="mb-6 pb-6 border-b border-gray-800">
                    <p class="section-title">Collection Image</p>
                    <div id="collection-image-empty" class="flex items-center gap-4 p-4 rounded-xl bg-gray-900/50 border border-dashed border-gray-800">
                        <div class="w-12 h-12 rounded-lg bg-gray-800 flex items-center justify-center">
                            <svg class="w-6 h-6 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </div>
                        <div>
                            <p class="text-gray-400 text-sm">No collection image uploaded</p>
                            <p class="text-gray-600 text-xs">Upload a file named <span class="font-mono text-brand-400">collection-image.png</span></p>
                        </div>
                    </div>
                    <div id="collection-image-preview" class="hide">
                        <div class="flex items-center gap-4">
                            <img id="collection-image-img" src="" class="w-20 h-20 rounded-xl object-cover border-2 border-brand-500">
                            <div class="flex-1">
                                <p class="text-white font-medium">Collection Image</p>
                                <p class="text-gray-500 text-sm">Used as the Shopify collection thumbnail</p>
                            </div>
                            <button onclick="deleteCollectionImage()" class="btn-secondary text-red-400 hover:text-red-300 text-sm">
                                Delete
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Product Images Grid -->
                <p class="section-title">Product Images (<span id="images-count">0</span>)</p>
                <div id="images-loading" class="flex items-center justify-center py-12 hide">
                    <div class="spinner"></div>
                    <span class="ml-3 text-gray-500 text-sm">Loading images...</span>
                </div>
                <div id="images-empty" class="text-center py-12 hide">
                    <p class="text-gray-500">No product images uploaded yet</p>
                </div>
                <div id="images-grid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3">
                    <!-- Populated by JS -->
                </div>
            </div>
            
            <!-- Naming Help Tooltip (positioned dynamically) -->
            <div id="naming-help-tooltip" class="tooltip hide" style="display: none;">
                <div class="flex items-center justify-between mb-3">
                    <h4 class="font-semibold text-brand-400">Image Naming Guide</h4>
                    <button onclick="hideNamingHelp()" class="text-gray-500 hover:text-white">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                    </button>
                </div>
                <div class="space-y-3 text-sm">
                    <div>
                        <p class="text-gray-400 mb-1">Product Images:</p>
                        <div class="bg-black/50 rounded-lg p-2 font-mono text-xs">
                            <span class="text-gray-500">Code:</span> <span class="text-brand-400">APX/ATL/001</span><br>
                            <span class="text-gray-500">File:</span> <span class="text-green-400">APX-ATL-001.png</span>
                        </div>
                    </div>
                    <div>
                        <p class="text-gray-400 mb-1">Collection Image:</p>
                        <div class="bg-black/50 rounded-lg p-2 font-mono text-xs">
                            <span class="text-green-400">collection-image.png</span>
                        </div>
                    </div>
                    <p class="text-gray-500 text-xs">Replace / with - in product codes</p>
                </div>
            </div>
        </div>

        <!-- TOOL: Store Generator -->
        <div id="tool-generator" class="hide p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                ← Back to Launchpad
            </button>
            <h2 class="text-2xl font-bold mb-6">Store Generator</h2>

            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="font-semibold mb-4">Generate Shopify CSV</h3>
                
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Salesperson</label>
                        <select id="gen-salesperson" class="w-full px-4 py-3 rounded-lg">
                            <option value="">Select salesperson...</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Club (with uploaded images)</label>
                        <div class="relative">
                            <input type="text" id="gen-club-search" placeholder="Type to search clubs..." class="w-full px-4 py-3 rounded-lg" oninput="filterClubDropdown()" onfocus="showClubDropdown()" onblur="hideClubDropdown()">
                            <input type="hidden" id="gen-club" value="">
                            <div id="gen-club-dropdown" class="absolute z-10 w-full mt-1 bg-gray-800 border border-gray-700 rounded-lg max-h-60 overflow-y-auto hide">
                                <!-- Club options populated by JS -->
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gen-preview" class="hide mb-6">
                    <div class="bg-gray-900 rounded-lg p-4">
                        <div class="grid grid-cols-2 gap-4 mb-3">
                            <div>
                                <p class="text-gray-400 text-sm">Selected Club:</p>
                                <p id="gen-selected-club" class="text-xl font-bold text-white">-</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-sm">Products with images:</p>
                                <p id="gen-product-count" class="text-3xl font-bold text-brand-400">0</p>
                            </div>
                        </div>
                        <div class="border-t border-gray-800 pt-3">
                            <p class="text-gray-500 text-sm">Collection: <span id="gen-collection-name" class="text-brand-400 font-semibold"></span></p>
                            <p id="gen-collection-image-info" class="text-sm mt-1"></p>
                        </div>
                    </div>
                </div>

                <button onclick="generateShopifyCSV()" class="w-full bg-brand-500 hover:bg-brand-600 py-4 rounded-lg font-semibold text-lg transition">
                    Generate Shopify CSV
                </button>
            </div>
        </div>

        <!-- TOOL: Factory Orders -->
        <div id="tool-orders" class="hide p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                ← Back to Launchpad
            </button>
            <h2 class="text-2xl font-bold mb-6">Factory Order Form</h2>

            <div class="glass rounded-2xl p-6 mb-6">
                <!-- Order Header -->
                <div class="grid md:grid-cols-4 gap-4 mb-6">
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Club</label>
                        <select id="order-club" class="w-full px-4 py-3 rounded-lg" onchange="updateOrderClub()">
                            <option value="">Select or create club...</option>
                            <option value="new">+ Create New Club</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Club Suffix</label>
                        <input type="text" id="order-suffix" class="w-full px-4 py-3 rounded-lg bg-gray-900" readonly>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">PO Number</label>
                        <input type="text" id="order-po" class="w-full px-4 py-3 rounded-lg bg-gray-900" readonly>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Pricing</label>
                        <select id="order-pricing" class="w-full px-4 py-3 rounded-lg" onchange="recalculateOrder()">
                            <option value="partner">Partner Price</option>
                            <option value="retail">Retail Price</option>
                        </select>
                    </div>
                </div>

                <!-- Order Lines -->
                <div id="order-lines" class="space-y-4 mb-6">
                    <!-- Lines will be added here -->
                </div>

                <button onclick="addOrderLine()" class="w-full border border-dashed border-gray-600 hover:border-brand-500 py-3 rounded-lg text-gray-400 hover:text-brand-400 transition">
                    + Add Product Line
                </button>
            </div>

            <!-- Order Summary -->
            <div class="glass rounded-2xl p-6">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">Subtotal</span>
                    <span id="order-subtotal" class="text-xl font-semibold">£0.00</span>
                </div>
                <div class="flex justify-between items-center mb-4">
                    <span class="text-gray-400">VAT (20% on adult items)</span>
                    <span id="order-vat" class="text-xl font-semibold">£0.00</span>
                </div>
                <div class="flex justify-between items-center mb-6 pt-4 border-t border-gray-800">
                    <span class="text-lg font-semibold">Total</span>
                    <span id="order-total" class="text-3xl font-bold text-brand-400">£0.00</span>
                </div>
                <button onclick="generateOrderPDF()" class="w-full bg-brand-500 hover:bg-brand-600 py-4 rounded-lg font-semibold text-lg transition">
                    Generate Purchase Order PDF
                </button>
            </div>
        </div>

        <!-- TOOL: PO Tracker V2 -->
        <div id="tool-po-tracker" class="hide p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                ← Back to Launchpad
            </button>
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold">PO Tracker</h2>
                <button onclick="openCreatePoModal()" class="bg-brand-500 hover:bg-brand-600 px-5 py-2.5 rounded-lg font-semibold transition flex items-center gap-2">
                    + New PO
                </button>
            </div>

            <!-- Filters -->
            <div class="glass rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center">
                <input type="text" id="po-search" placeholder="Search by PO number, factory, club..." class="flex-1 min-w-48 px-4 py-2 rounded-lg text-sm" oninput="renderPoList()">
                <select id="po-status-filter" class="px-4 py-2 rounded-lg text-sm" onchange="renderPoList()">
                    <option value="">All Statuses</option>
                    <option value="draft">Draft</option>
                    <option value="sent">Sent to Factory</option>
                    <option value="acknowledged">Acknowledged</option>
                    <option value="in_production">In Production</option>
                    <option value="shipped">Shipped</option>
                    <option value="delivered">Delivered</option>
                    <option value="cancelled">Cancelled</option>
                </select>
            </div>

            <!-- PO List -->
            <div id="po-list" class="space-y-3">
                <p class="text-gray-400 text-center py-12">No purchase orders yet. Click "+ New PO" to create one.</p>
            </div>
        </div>

        <!-- MODAL: Create / Edit PO -->
        <div id="po-modal" class="fixed inset-0 bg-black/80 z-50 flex items-start justify-center overflow-y-auto py-8 hide">
            <div class="glass rounded-2xl p-6 w-full max-w-3xl mx-4 my-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold" id="po-modal-title">New Purchase Order</h3>
                    <button onclick="hidePoModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <input type="hidden" id="po-edit-id">

                <!-- PO Header fields -->
                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">PO Number *</label>
                        <input type="text" id="po-number" class="w-full px-4 py-3 rounded-lg" placeholder="e.g. PO-2024-001">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Status</label>
                        <select id="po-status" class="w-full px-4 py-3 rounded-lg">
                            <option value="draft">Draft</option>
                            <option value="sent">Sent to Factory</option>
                            <option value="acknowledged">Acknowledged</option>
                            <option value="in_production">In Production</option>
                            <option value="shipped">Shipped</option>
                            <option value="delivered">Delivered</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Factory Name</label>
                        <input type="text" id="po-factory" class="w-full px-4 py-3 rounded-lg" placeholder="e.g. Acme Manufacturing">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Club (optional)</label>
                        <select id="po-club-id" class="w-full px-4 py-3 rounded-lg">
                            <option value="">— No specific club —</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Expected Delivery</label>
                        <input type="date" id="po-expected-delivery" class="w-full px-4 py-3 rounded-lg">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Season / Reference</label>
                        <input type="text" id="po-season" class="w-full px-4 py-3 rounded-lg" placeholder="e.g. 2024/25">
                    </div>
                </div>

                <!-- Shopify Order IDs -->
                <div class="mb-4">
                    <label class="text-gray-400 text-sm mb-1 block">Linked Shopify Order IDs <span class="text-gray-500">(comma-separated)</span></label>
                    <input type="text" id="po-shopify-orders" class="w-full px-4 py-3 rounded-lg" placeholder="e.g. 5001, 5002, 5003">
                </div>

                <!-- Notes -->
                <div class="mb-6">
                    <label class="text-gray-400 text-sm mb-1 block">Notes</label>
                    <textarea id="po-notes" rows="2" class="w-full px-4 py-3 rounded-lg resize-none" placeholder="Internal notes…"></textarea>
                </div>

                <!-- Summary Line Items -->
                <div class="mb-4">
                    <div class="flex justify-between items-center mb-3">
                        <h4 class="font-semibold text-gray-300">Summary Line Items</h4>
                        <button onclick="addPoLineItem()" class="text-brand-400 hover:text-brand-300 text-sm font-medium">+ Add Line</button>
                    </div>
                    <div id="po-line-items" class="space-y-2">
                        <!-- Lines added dynamically -->
                    </div>
                    <button onclick="addPoLineItem()" class="w-full border border-dashed border-gray-600 hover:border-brand-500 py-2 rounded-lg text-gray-400 hover:text-brand-400 transition text-sm mt-2">
                        + Add Line Item
                    </button>
                </div>

                <!-- PO Total -->
                <div class="glass rounded-lg p-4 mb-6 flex justify-between items-center">
                    <span class="text-gray-400">Estimated Total</span>
                    <span id="po-total-display" class="text-xl font-bold text-brand-400">£0.00</span>
                </div>

                <div class="flex gap-3 justify-end">
                    <button onclick="hidePoModal()" class="px-6 py-3 rounded-lg border border-gray-600 hover:border-gray-400 transition">Cancel</button>
                    <button onclick="savePo()" class="bg-brand-500 hover:bg-brand-600 px-8 py-3 rounded-lg font-semibold transition">Save PO</button>
                </div>
            </div>
        </div>

        <!-- MODAL: PO Detail / View -->
        <div id="po-detail-modal" class="fixed inset-0 bg-black/80 z-50 flex items-start justify-center overflow-y-auto py-8 hide">
            <div class="glass rounded-2xl p-6 w-full max-w-3xl mx-4 my-auto">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-bold" id="po-detail-number">PO Detail</h3>
                        <p class="text-gray-400 text-sm" id="po-detail-factory"></p>
                    </div>
                    <button onclick="hidePoDetailModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div id="po-detail-body">
                    <!-- Populated dynamically -->
                </div>

                <div class="flex gap-3 justify-end mt-6">
                    <button onclick="hidePoDetailModal()" class="px-6 py-3 rounded-lg border border-gray-600 hover:border-gray-400 transition">Close</button>
                    <button onclick="editCurrentPo()" class="bg-yellow-500 hover:bg-yellow-600 px-6 py-3 rounded-lg font-semibold transition">Edit PO</button>
                    <button onclick="deleteCurrentPo()" class="bg-red-600 hover:bg-red-700 px-6 py-3 rounded-lg font-semibold transition">Delete</button>
                </div>
            </div>
        </div>

        <!-- TOOL: Brand Settings (Super Admin Only) -->
        <div id="tool-settings" class="hide p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                ← Back to Launchpad
            </button>
            <h2 class="text-2xl font-bold mb-6">Brand Settings</h2>
            <p class="text-purple-400 mb-6">Managing: <span id="settings-brand-name" class="font-semibold"></span></p>

            <!-- Salespeople Management -->
            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="font-semibold mb-4">Salespeople</h3>
                <div class="flex gap-4 mb-4">
                    <input type="text" id="new-sp-first" placeholder="First name" class="flex-1 px-4 py-3 rounded-lg">
                    <input type="text" id="new-sp-last" placeholder="Last name" class="flex-1 px-4 py-3 rounded-lg">
                    <input type="email" id="new-sp-email" placeholder="Email (optional)" class="flex-1 px-4 py-3 rounded-lg">
                    <button onclick="addSalesperson()" class="bg-brand-500 hover:bg-brand-600 px-6 py-3 rounded-lg font-semibold">Add</button>
                </div>
                <div id="salespeople-list" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Brand Info -->
            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="font-semibold mb-4">Brand Information</h3>
                <div class="grid md:grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Brand Name</label>
                        <input type="text" id="edit-brand-name" class="w-full px-4 py-3 rounded-lg">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-2 block">Brand Slug</label>
                        <input type="text" id="edit-brand-slug" class="w-full px-4 py-3 rounded-lg bg-gray-800" readonly>
                    </div>
                </div>
                <button onclick="updateBrandInfo()" class="mt-4 bg-brand-500 hover:bg-brand-600 px-6 py-3 rounded-lg font-semibold">Save Changes</button>
            </div>

            <!-- Shopify API Configuration -->
            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="font-semibold mb-1">Shopify API Configuration</h3>
                <p class="text-gray-500 text-sm mb-4">Connect this brand to your Shopify store for direct product sync and draft order creation.</p>

                <div class="bg-yellow-500/10 border border-yellow-500/20 rounded-lg p-3 mb-4">
                    <p class="text-yellow-400 text-xs font-medium mb-1">Setup Instructions</p>
                    <ol class="text-gray-400 text-xs space-y-1 list-decimal list-inside">
                        <li>Create a Shopify Custom App in your Shopify Admin → Settings → Apps and sales channels</li>
                        <li>Grant permissions: read/write products, read/write draft orders, read/write collections</li>
                        <li>Add this app's domain to the Custom App's allowed CORS origins</li>
                        <li>Copy the <strong class="text-gray-300">API key (Client ID)</strong> and <strong class="text-gray-300">API secret key (Client Secret)</strong> and paste them below</li>
                    </ol>
                </div>

                <div class="grid md:grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Shopify Store Domain</label>
                        <input type="text" id="shopify-domain" placeholder="yourstore.myshopify.com" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">API Version</label>
                        <select id="shopify-api-version" class="w-full px-3 py-2 rounded-lg text-sm">
                            <option value="2025-01">2025-01</option>
                            <option value="2024-10">2024-10</option>
                            <option value="2024-07">2024-07</option>
                            <option value="2024-04">2024-04</option>
                            <option value="2024-01">2024-01</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Client ID (API Key)</label>
                        <input type="text" id="shopify-client-id" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Client Secret (API Secret Key)</label>
                        <input type="password" id="shopify-client-secret" placeholder="xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="saveShopifyConfig()" class="btn-primary text-sm">Save Shopify Config</button>
                    <button onclick="testShopifyConnection()" class="btn-secondary text-sm">Test Connection</button>
                </div>
                <div id="shopify-config-status" class="mt-3 text-sm hide"></div>
            </div>

            <!-- Feature Toggles -->
            <div class="glass rounded-2xl p-6 mb-6">
                <h3 class="font-semibold mb-1">Feature Toggles</h3>
                <p class="text-gray-500 text-sm mb-5">Enable or disable modules for this brand. Disabled features will be hidden from the launchpad.</p>
                <div id="feature-toggles-list" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- Danger Zone -->
            <div class="glass rounded-2xl p-6 border border-red-500/30">
                <h3 class="font-semibold mb-4 text-red-400">Danger Zone</h3>
                <p class="text-gray-400 text-sm mb-4">Deleting a brand will remove all its products, clubs, images, and orders. This cannot be undone.</p>
                <button onclick="confirmDeleteBrand()" class="bg-red-500/20 hover:bg-red-500/30 text-red-400 px-6 py-3 rounded-lg font-semibold border border-red-500/50">
                    Delete Brand
                </button>
            </div>
        </div>

        <!-- TOOL: User Management (Super Admin Only) -->
        <div id="tool-users" class="hide p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-400 hover:text-white mb-4 flex items-center gap-2">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>
            <div class="flex items-center justify-between mb-2">
                <div>
                    <h2 class="text-2xl font-bold">User Management</h2>
                    <p class="text-gray-500 text-sm mt-1">Master admin area — allocate licenses and set permissions across all brands in TeamwearOS</p>
                </div>
                <button onclick="showAddUserModal()" class="btn-primary flex items-center gap-2 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                    Add User
                </button>
            </div>

            <!-- Filters -->
            <div class="glass rounded-2xl p-4 mb-5 mt-6">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Filter by Brand</label>
                        <select id="user-filter-brand" class="w-full px-3 py-2 rounded-lg text-sm" onchange="loadAllUsers()">
                            <option value="">All Brands</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-xs mb-1 block">Search</label>
                        <input type="text" id="user-search" placeholder="Search by email..." class="w-full px-3 py-2 rounded-lg text-sm" oninput="filterUsersList()">
                    </div>
                </div>
            </div>

            <!-- All Users -->
            <div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-4">
                    <div>
                        <h3 class="font-semibold">All Users</h3>
                        <p class="text-gray-400 text-sm mt-1">Assign users to brands (APX, ROKOR, or any brand) and control feature access per user.</p>
                    </div>
                </div>
                <div id="users-list" class="space-y-4">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- Add User Modal -->
        <div id="add-user-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Add New User</h3>
                    <button onclick="hideAddUserModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Email Address *</label>
                        <input type="email" id="new-user-email" placeholder="user@example.com" class="w-full px-3 py-2 rounded-lg">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Assign to Brand</label>
                        <select id="new-user-brand" class="w-full px-3 py-2 rounded-lg">
                            <option value="">No brand assigned</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Role</label>
                        <select id="new-user-role" class="w-full px-3 py-2 rounded-lg">
                            <option value="user">User</option>
                            <option value="admin">Admin</option>
                            <option value="super_admin">Super Admin</option>
                        </select>
                    </div>
                    <p class="text-gray-500 text-xs">An invitation email will be sent to this address via Supabase Auth.</p>
                </div>
                <div class="flex gap-3 mt-6">
                    <button onclick="hideAddUserModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="inviteNewUser()" class="flex-1 btn-primary py-3">Send Invite</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             TOOL: PROSPECTING
             ============================================================ -->
        <div id="tool-prospecting" class="hide p-6 md:p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>

            <!-- Prospecting Sub-Launchpad (home view) -->
            <div id="prospect-home">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold">Prospecting</h2>
                    <p class="text-gray-500 text-sm mt-1">Track and manage your leads pipeline</p>
                </div>

                <div class="grid md:grid-cols-2 gap-5 mb-8">
                    <!-- Not Contacted -->
                    <div onclick="showProspectView('not-contacted')" class="prospect-card">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:rgba(20,184,166,0.1)"><svg class="w-7 h-7" fill="none" stroke="#2dd4bf" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z"/></svg></div>
                            <span id="nc-count-badge" class="text-sm font-bold px-3 py-1 rounded-full" style="background:rgba(20,184,166,0.12);color:#2dd4bf">0</span>
                        </div>
                        <h3 class="text-xl font-bold mb-2">Not Contacted</h3>
                        <p class="text-gray-500 text-sm">New leads waiting to be contacted. Filter by sport and county.</p>
                        <div class="mt-5 flex items-center gap-2 text-brand-400 text-sm font-semibold">
                            View list
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </div>
                    </div>

                    <!-- In Discussion -->
                    <div onclick="showProspectView('in-discussion')" class="prospect-card">
                        <div class="flex items-start justify-between mb-4">
                            <div class="w-14 h-14 rounded-2xl flex items-center justify-center" style="background:rgba(139,92,246,0.1)"><svg class="w-7 h-7" fill="none" stroke="#a78bfa" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M20.25 8.511c.884.284 1.5 1.128 1.5 2.097v4.286c0 1.136-.847 2.1-1.98 2.193-.34.027-.68.052-1.02.072v3.091l-3-3c-1.354 0-2.694-.055-4.02-.163a2.115 2.115 0 01-.825-.242m9.345-8.334a2.126 2.126 0 00-.476-.095 48.64 48.64 0 00-8.048 0c-1.131.094-1.976 1.057-1.976 2.192v4.286c0 .837.46 1.58 1.155 1.951m9.345-8.334V6.637c0-1.621-1.152-3.026-2.76-3.235A48.455 48.455 0 0011.25 3c-2.115 0-4.198.137-6.24.402-1.608.209-2.76 1.614-2.76 3.235v6.226c0 1.621 1.152 3.026 2.76 3.235.577.075 1.157.14 1.74.194V21l4.155-4.155"/></svg></div>
                            <span id="id-count-badge" class="text-sm font-bold px-3 py-1 rounded-full" style="background:rgba(139,92,246,0.12);color:#a78bfa">0</span>
                        </div>
                        <h3 class="text-xl font-bold mb-2">In Discussion</h3>
                        <p class="text-gray-500 text-sm">Active conversations on a visual Kanban board with customisable stages.</p>
                        <div class="mt-5 flex items-center gap-2 text-sm font-semibold" style="color:#a78bfa">
                            View board
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </div>
                    </div>
                </div>

                <!-- Quick actions -->
                <div class="flex flex-wrap gap-3">
                    <button onclick="openLeadModal(null)" class="btn-primary flex items-center gap-2 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Lead
                    </button>
                    <button onclick="exportLeadsCSV()" class="btn-secondary text-sm">Export CSV</button>
                    <button onclick="document.getElementById('leads-csv-import-modal').classList.remove('hide')" class="btn-secondary text-sm">Import CSV</button>
                </div>
            </div>

            <!-- Not Contacted List View -->
            <div id="prospect-not-contacted" class="hide">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <button onclick="showProspectView('home')" class="text-gray-500 hover:text-white flex items-center gap-1 text-sm transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Back
                        </button>
                        <h3 class="text-xl font-bold">Not Contacted</h3>
                        <span id="nc-list-count" class="text-sm font-semibold px-3 py-1 rounded-full" style="background:rgba(20,184,166,0.1);color:#2dd4bf">0</span>
                    </div>
                    <button onclick="openLeadModal(null, 'not_contacted')" class="btn-primary text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Lead
                    </button>
                </div>

                <!-- Filters -->
                <div class="filter-bar">
                    <input type="text" id="nc-search" placeholder="Search leads..." oninput="renderNotContacted()" style="min-width:200px">
                    <select id="nc-filter-sport" onchange="renderNotContacted()">
                        <option value="">All Sports</option>
                        <option>Football</option><option>Rugby</option><option>Cricket</option>
                        <option>Basketball</option><option>Netball</option><option>Hockey</option>
                        <option>Athletics</option><option>Cycling</option><option>Swimming</option>
                        <option>Tennis</option><option>Other</option>
                    </select>
                    <select id="nc-filter-county" onchange="renderNotContacted()">
                        <option value="">All Counties</option>
                    </select>
                    <button onclick="exportLeadsCSV('not_contacted')" class="btn-secondary text-sm">Export CSV</button>
                </div>

                <div id="nc-list" class="space-y-2">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- In Discussion Kanban View -->
            <div id="prospect-in-discussion" class="hide">
                <div class="flex items-center justify-between mb-6">
                    <div class="flex items-center gap-3">
                        <button onclick="showProspectView('home')" class="text-gray-500 hover:text-white flex items-center gap-1 text-sm transition">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                            Back
                        </button>
                        <h3 class="text-xl font-bold">In Discussion</h3>
                        <span id="id-board-count" class="text-sm font-semibold px-3 py-1 rounded-full" style="background:rgba(139,92,246,0.1);color:#a78bfa">0</span>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="openStageConfig()" class="btn-secondary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                            Configure Stages
                        </button>
                        <button onclick="openLeadModal(null, 'in_discussion')" class="btn-primary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add Lead
                        </button>
                    </div>
                </div>

                <div id="kanban-board" class="kanban-board">
                    <!-- Populated by JS -->
                </div>
            </div>
        </div>

        <!-- MODAL: Lead Record -->
        <div id="lead-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hide" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(8px)">
            <div class="glass rounded-2xl w-full max-w-2xl max-h-screen overflow-y-auto" style="max-height:90vh">
                <div class="p-6 border-b border-white border-opacity-5 flex items-center justify-between sticky top-0 glass z-10">
                    <h3 id="lead-modal-title" class="text-lg font-bold">New Lead</h3>
                    <button onclick="closeLeadModal()" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white hover:bg-opacity-5">✕</button>
                </div>
                <div class="p-6">
                    <input type="hidden" id="lead-id">

                    <!-- Core info -->
                    <div class="modal-section">
                        <p class="modal-section-title">Lead Information</p>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Lead Name *</label>
                                <input type="text" id="lead-name" placeholder="e.g. Westfield FC Enquiry" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Club Name *</label>
                                <input type="text" id="lead-club-name" placeholder="e.g. Westfield FC" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Sport</label>
                                <select id="lead-sport" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="">Select sport...</option>
                                    <option>Football</option><option>Rugby</option><option>Cricket</option>
                                    <option>Basketball</option><option>Netball</option><option>Hockey</option>
                                    <option>Athletics</option><option>Cycling</option><option>Swimming</option>
                                    <option>Tennis</option><option>Other</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Sport Level</label>
                                <select id="lead-sport-level" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="">Select level...</option>
                                    <option value="grassroots">Grassroots</option>
                                    <option value="amateur">Amateur</option>
                                    <option value="semi-pro">Semi-Pro</option>
                                    <option value="professional">Professional</option>
                                    <option value="elite">Elite / National</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-4">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">County</label>
                                <input type="text" id="lead-county" placeholder="e.g. Yorkshire" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Location / Town</label>
                                <input type="text" id="lead-location" placeholder="e.g. Leeds" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                        </div>
                        <div class="mb-4">
                            <label class="text-xs text-gray-500 mb-1 block">Number of Teams</label>
                            <input type="number" id="lead-teams" placeholder="e.g. 4" min="1" class="w-full px-3 py-2 rounded-lg text-sm" style="max-width:160px">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Notes</label>
                            <textarea id="lead-notes" rows="3" placeholder="Any additional notes about this lead..." class="w-full px-3 py-2 rounded-lg text-sm resize-none"></textarea>
                        </div>
                    </div>

                    <!-- Status & Stage -->
                    <div class="modal-section">
                        <p class="modal-section-title">Status & Pipeline</p>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Status</label>
                                <select id="lead-status" class="w-full px-3 py-2 rounded-lg text-sm" onchange="toggleKanbanStageField()">
                                    <option value="not_contacted">Not Contacted</option>
                                    <option value="in_discussion">In Discussion</option>
                                </select>
                            </div>
                            <div id="lead-stage-field">
                                <label class="text-xs text-gray-500 mb-1 block">Kanban Stage</label>
                                <select id="lead-stage" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="">Select stage...</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Contacts -->
                    <div class="modal-section">
                        <div class="flex items-center justify-between mb-3">
                            <p class="modal-section-title" style="margin-bottom:0">Contacts</p>
                            <button onclick="showAddContactForm()" class="text-xs text-brand-400 hover:text-brand-300 font-semibold flex items-center gap-1">
                                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                                Add Contact
                            </button>
                        </div>
                        <div id="lead-contacts-list" class="mb-3">
                            <!-- Populated by JS -->
                        </div>
                        <!-- Add contact form (hidden by default) -->
                        <div id="add-contact-form" class="hide" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:14px">
                            <p class="text-xs text-gray-500 font-semibold uppercase tracking-wider mb-3">New Contact</p>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <input type="text" id="contact-first-name" placeholder="First name" class="px-3 py-2 rounded-lg text-sm">
                                <input type="text" id="contact-last-name" placeholder="Last name" class="px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <input type="email" id="contact-email" placeholder="Email" class="px-3 py-2 rounded-lg text-sm">
                                <input type="tel" id="contact-phone" placeholder="Phone" class="px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <input type="text" id="contact-role" placeholder="Role (e.g. Manager)" class="px-3 py-2 rounded-lg text-sm">
                                <div class="flex items-center gap-2">
                                    <input type="checkbox" id="contact-primary" class="w-4 h-4">
                                    <label for="contact-primary" class="text-sm text-gray-400">Primary contact</label>
                                </div>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="saveContact()" class="btn-primary text-xs py-2 px-4">Save Contact</button>
                                <button onclick="document.getElementById('add-contact-form').classList.add('hide')" class="btn-secondary text-xs py-2 px-4">Cancel</button>
                            </div>
                        </div>
                    </div>

                    <!-- Action buttons -->
                    <div class="flex items-center justify-between mt-2">
                        <div class="flex gap-3">
                            <button id="lead-save-btn" onclick="saveLead()" class="btn-primary">Save Lead</button>
                            <button onclick="closeLeadModal()" class="btn-secondary">Cancel</button>
                        </div>
                        <div class="flex gap-2" id="lead-danger-actions" style="display:none!important">
                            <button onclick="archiveLead('not_interested')" class="text-xs text-orange-400 hover:text-orange-300 px-3 py-2 rounded-lg" style="background:rgba(249,115,22,0.1)">Archive — Not Interested</button>
                            <button onclick="deleteLead()" class="text-xs text-red-400 hover:text-red-300 px-3 py-2 rounded-lg" style="background:rgba(239,68,68,0.1)">Delete</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Stage Config -->
        <div id="stage-config-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hide" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(8px)">
            <div class="glass rounded-2xl w-full max-w-md">
                <div class="p-5 border-b border-white border-opacity-5 flex items-center justify-between">
                    <h3 class="text-lg font-bold">Configure Kanban Stages</h3>
                    <button onclick="closeStageConfig()" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white hover:bg-opacity-5">✕</button>
                </div>
                <div class="p-5">
                    <p class="text-gray-500 text-sm mb-4">Create up to 3 stages for your In Discussion pipeline. Drag to reorder.</p>
                    <div id="stages-list" class="space-y-2 mb-4">
                        <!-- Populated by JS -->
                    </div>
                    <div id="add-stage-form" class="hide mb-4" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06);border-radius:10px;padding:14px">
                        <div class="flex gap-3 items-end">
                            <div class="flex-1">
                                <label class="text-xs text-gray-500 mb-1 block">Stage Name</label>
                                <input type="text" id="new-stage-name" placeholder="e.g. Proposal Sent" class="w-full px-3 py-2 rounded-lg text-sm">
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Colour</label>
                                <input type="color" id="new-stage-color" value="#14b8a6" class="h-10 w-12 rounded-lg cursor-pointer" style="padding:2px;background:#111;border:1px solid #333">
                            </div>
                            <button onclick="saveNewStage()" class="btn-primary text-sm py-2">Add</button>
                        </div>
                    </div>
                    <button id="add-stage-btn" onclick="showAddStageForm()" class="btn-secondary text-sm w-full flex items-center justify-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Stage
                    </button>
                    <div class="mt-4 text-right">
                        <button onclick="closeStageConfig()" class="btn-primary text-sm">Done</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: CSV Import Leads -->
        <div id="leads-csv-import-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hide" style="background:rgba(0,0,0,0.7);backdrop-filter:blur(8px)">
            <div class="glass rounded-2xl w-full max-w-lg">
                <div class="p-5 border-b border-white border-opacity-5 flex items-center justify-between">
                    <h3 class="text-lg font-bold">Import Leads from CSV</h3>
                    <button onclick="document.getElementById('leads-csv-import-modal').classList.add('hide')" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg hover:bg-white hover:bg-opacity-5">✕</button>
                </div>
                <div class="p-5">
                    <div class="mb-4 p-3 rounded-lg text-sm" style="background:rgba(20,184,166,0.07);border:1px solid rgba(20,184,166,0.15)">
                        <p class="text-brand-400 font-semibold mb-1">Required CSV columns:</p>
                        <p class="text-gray-400 text-xs font-mono">lead_name, club_name, sport, county, location, sport_level, amount_of_teams, notes</p>
                    </div>
                    <label class="dropzone flex flex-col items-center justify-center p-8 cursor-pointer mb-4">
                        <svg class="w-10 h-10 text-gray-600 mb-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <p class="text-gray-400 text-sm">Click to select CSV file</p>
                        <input type="file" accept=".csv" id="leads-csv-file" onchange="handleLeadsCSVUpload(event)" class="hidden">
                    </label>
                    <div id="leads-import-status" class="hide text-sm text-brand-400"></div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             TOOL: SALES
             ============================================================ -->
        <div id="tool-sales" class="hide p-6 md:p-8 max-w-7xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>

            <!-- SALES HOME -->
            <div id="sales-home">
                <div class="mb-8">
                    <h2 class="text-2xl font-bold">Sales</h2>
                    <p class="text-gray-500 text-sm mt-1">Manage jobs, design briefs and your sales pipeline</p>
                </div>
                <div class="grid md:grid-cols-3 gap-5 mb-8">
                    <div onclick="openNewJobModal()" class="feature-card accent-purple" style="cursor:pointer">
                        <div class="card-icon" style="background:rgba(139,92,246,0.12)">✨</div>
                        <h3>Create New Job</h3>
                        <p>Start a new job record and kick off the sales process</p>
                    </div>
                    <div onclick="showSalesView('live')" class="feature-card accent-teal" style="cursor:pointer">
                        <div class="flex items-start justify-between mb-4">
                            <div class="card-icon" style="background:rgba(20,184,166,0.12);margin-bottom:0">🔥</div>
                            <span id="sales-live-badge" class="text-sm font-bold px-3 py-1 rounded-full" style="background:rgba(20,184,166,0.12);color:#2dd4bf">0</span>
                        </div>
                        <h3>Live Jobs</h3>
                        <p>Active jobs across all pipeline stages</p>
                    </div>
                    <div onclick="showSalesView('completed')" class="feature-card accent-green" style="cursor:pointer">
                        <div class="flex items-start justify-between mb-4">
                            <div class="card-icon" style="background:rgba(34,197,94,0.12);margin-bottom:0">✅</div>
                            <span id="sales-done-badge" class="text-sm font-bold px-3 py-1 rounded-full" style="background:rgba(34,197,94,0.1);color:#4ade80">0</span>
                        </div>
                        <h3>Completed</h3>
                        <p>All finished jobs and historical records</p>
                    </div>
                </div>
                <!-- Recent jobs preview -->
                <div>
                    <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">Recent Jobs</h3>
                    <div id="sales-recent-jobs" class="space-y-2"></div>
                </div>
            </div>

            <!-- LIVE JOBS VIEW -->
            <div id="sales-live-view" class="hide">
                <div class="flex items-center gap-3 mb-6">
                    <button onclick="showSalesView('home')" class="text-gray-500 hover:text-white flex items-center gap-1 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
                    </button>
                    <h3 class="text-xl font-bold">Live Jobs</h3>
                </div>
                <!-- Stage filter grid -->
                <div class="stage-nav-grid" id="stage-nav-grid"></div>
                <!-- Jobs list -->
                <div class="flex items-center justify-between mb-4">
                    <p id="live-jobs-filter-label" class="text-sm text-gray-500">All stages</p>
                    <button onclick="openNewJobModal()" class="btn-primary text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        New Job
                    </button>
                </div>
                <div id="live-jobs-list" class="space-y-3"></div>
            </div>

            <!-- COMPLETED JOBS VIEW -->
            <div id="sales-completed-view" class="hide">
                <div class="flex items-center gap-3 mb-6">
                    <button onclick="showSalesView('home')" class="text-gray-500 hover:text-white flex items-center gap-1 text-sm">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>Back
                    </button>
                    <h3 class="text-xl font-bold">Completed Jobs</h3>
                </div>
                <div id="completed-jobs-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- ============================================================
             TOOL: JOB RECORD (Full page, 7 tabs)
             ============================================================ -->
        <div id="tool-job-record" class="hide p-6 md:p-8 max-w-7xl mx-auto">
            <div class="flex items-center gap-3 mb-6">
                <button onclick="closeJobRecord()" class="text-gray-500 hover:text-white flex items-center gap-1 text-sm">
                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                    Back to Sales
                </button>
            </div>

            <!-- Record header - compact -->
            <div class="glass rounded-2xl p-5 mb-4">
                <div class="flex items-start justify-between flex-wrap gap-4">
                    <div>
                        <span id="jr-job-number" class="text-xs text-gray-600 font-mono block mb-1"></span>
                        <h2 id="jr-job-name" class="text-2xl font-bold mb-1">Job Name</h2>
                        <p id="jr-job-desc" class="text-gray-500 text-sm"></p>
                    </div>
                    <button onclick="openEditJobModal()" class="btn-secondary text-sm flex-shrink-0">Edit Job</button>
                </div>
                <!-- Quick meta -->
                <div class="flex gap-5 mt-4 pt-4 border-t border-gray-800 flex-wrap" id="jr-meta-row">
                    <div><span class="text-xs text-gray-600">Type</span><p id="jr-type" class="text-sm font-semibold mt-0.5">—</p></div>
                    <div><span class="text-xs text-gray-600">Club Type</span><p id="jr-club-type" class="text-sm font-semibold mt-0.5">—</p></div>
                    <div><span class="text-xs text-gray-600">Channel</span><p id="jr-channel" class="text-sm font-semibold mt-0.5">—</p></div>
                    <div><span class="text-xs text-gray-600">Linked Club</span><p id="jr-club-link" class="text-sm font-semibold mt-0.5">—</p></div>
                    <div><span class="text-xs text-gray-600">Created</span><p id="jr-created" class="text-sm font-semibold mt-0.5">—</p></div>
                    <div><span class="text-xs text-gray-600">Days Open</span><p id="jr-days-open" class="text-sm font-semibold mt-0.5">—</p></div>
                </div>
            </div>

            <!-- Timeline: Job Stage + Design Stage -->
            <div class="record-timeline">
                <div class="flex-1 flex items-center flex-wrap gap-1" id="jr-stage-pills">
                    <!-- Populated by renderJobStagePills() -->
                </div>
                <!-- Hidden select kept for JS compat -->
                <select id="jr-stage-select" onchange="updateJobStage(this.value)" class="hide">
                    <option value="discovery">Discovery</option>
                    <option value="concepts">Concepts</option>
                    <option value="awaiting_approval">Awaiting Approval</option>
                    <option value="quote">Quote</option>
                    <option value="paid">Paid</option>
                    <option value="on_boarding">On-Boarding</option>
                    <option value="completed">Completed</option>
                </select>
                <div class="ml-4 pl-4 border-l border-gray-800 flex items-center gap-3 flex-shrink-0">
                    <span class="text-xs text-gray-600 font-semibold uppercase tracking-wider whitespace-nowrap">Design</span>
                    <div class="design-stage-row" id="jr-design-stage-pills"></div>
                </div>
            </div>

            <!-- Record layout: side nav + content -->
            <div class="record-layout">
                <!-- Side nav -->
                <div class="record-side-nav" id="job-record-nav">
                    <button class="record-nav-item active" onclick="showJobTab('overview')" id="jt-overview">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                        Overview
                    </button>
                    <button class="record-nav-item" onclick="showJobTab('products')" id="jt-products">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                        Products
                    </button>
                    <button class="record-nav-item" onclick="showJobTab('club')" id="jt-club">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-2 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4"/></svg>
                        Club Record
                    </button>
                    <button class="record-nav-item" onclick="showJobTab('team')" id="jt-team">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Team
                    </button>
                    <div class="record-nav-divider"></div>
                    <button class="record-nav-item" onclick="showJobTab('design')" id="jt-design">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"/></svg>
                        Design Studio
                    </button>
                    <button class="record-nav-item" onclick="showJobTab('orderform')" id="jt-orderform">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Order Form
                    </button>
                    <button class="record-nav-item" onclick="showJobTab('production')" id="jt-production">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"/></svg>
                        Production
                    </button>
                </div>
                <!-- Content area -->
                <div class="record-content">

            <!-- TAB: Overview -->
            <div id="jt-content-overview">
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="glass rounded-2xl p-5">
                        <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider mb-4">Job Details</h4>
                        <div id="jr-overview-details" class="space-y-3"></div>
                        <!-- Assigned user row -->
                        <div class="mt-4 pt-4 border-t border-gray-800">
                            <label class="text-xs text-gray-500 mb-2 block">Assigned To</label>
                            <select id="jr-assigned-user" onchange="saveJobAssignment(this.value)" class="w-full px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:#ddd">
                                <option value="">Unassigned</option>
                            </select>
                        </div>
                    </div>
                    <!-- Activity Log -->
                    <div class="glass rounded-2xl p-5 flex flex-col">
                        <div class="flex items-center justify-between mb-4">
                            <h4 class="text-xs font-bold text-gray-500 uppercase tracking-wider">Activity Log</h4>
                        </div>
                        <div id="jr-activity-log" class="flex-1 overflow-y-auto max-h-64 mb-3 space-y-1">
                            <!-- Populated by JS -->
                        </div>
                        <div class="flex gap-2 mt-auto">
                            <input type="text" id="jr-activity-input" placeholder="Add a note..." class="flex-1 px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:#ddd" onkeydown="if(event.key==='Enter')addJobActivity()">
                            <button onclick="addJobActivity()" class="btn-primary text-sm px-4">Post</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Products -->
            <div id="jt-content-products" class="hide">
                <div class="flex items-center justify-between mb-5">
                    <div>
                        <h4 class="font-semibold">Club Products</h4>
                        <p class="text-gray-500 text-sm mt-0.5">Products created for this job's club. Pricing from the club's partnership level.</p>
                    </div>
                    <div class="flex gap-3">
                        <div id="jr-range-approved-wrap" class="flex items-center gap-2 px-4 py-2 rounded-lg" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07)">
                            <input type="checkbox" id="jr-range-approved" onchange="toggleRangeApproved(this.checked)" class="w-4 h-4">
                            <label for="jr-range-approved" class="text-sm font-semibold text-gray-300 cursor-pointer">Range Approved</label>
                        </div>
                        <button onclick="showJobAddClubProductModal()" class="btn-primary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add Product
                        </button>
                    </div>
                </div>
                <div id="jr-products-list" class="space-y-3"></div>
                <div id="jr-products-empty" class="empty-state hide"><div class="empty-icon">📦</div><p>No products added yet. Link a club first, then add products.</p></div>
            </div>

            <!-- TAB: Club Record -->
            <div id="jt-content-club" class="hide">
                <div id="jr-club-content">
                    <div class="glass rounded-2xl p-6 text-center">
                        <div class="empty-icon">🏟️</div>
                        <p class="text-gray-500 mb-4">No club linked to this job yet.</p>
                        <div class="flex gap-3 justify-center">
                            <button onclick="showLinkClubModal()" class="btn-secondary text-sm">Link Existing Club</button>
                            <button onclick="showCreateClubForJob()" class="btn-primary text-sm">Create New Club</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TAB: Team -->
            <div id="jt-content-team" class="hide">
                <!-- Section 1: Club Team (from club_teams linked to the club) -->
                <div class="glass rounded-2xl p-5 mb-5">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-semibold">Club Team</h4>
                            <p class="text-gray-500 text-sm mt-0.5">Which club team is this job for?</p>
                        </div>
                    </div>
                    <div id="jr-club-team-section">
                        <p class="text-gray-600 text-sm">Link a club to this job first to select a team.</p>
                    </div>
                </div>

                <!-- Section 2: Project Team (internal staff on this job) -->
                <div class="glass rounded-2xl p-5">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <h4 class="font-semibold">Project Team</h4>
                            <p class="text-gray-500 text-sm mt-0.5">Internal staff members working on this job</p>
                        </div>
                        <button onclick="openTeamModal(null)" class="btn-primary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add Member
                        </button>
                    </div>
                    <div id="jr-teams-list" class="space-y-3"></div>
                    <div id="jr-teams-empty" class="empty-state hide"><div class="empty-icon">👤</div><p>No project team members added yet.</p></div>
                </div>
            </div>

            <!-- TAB: Design Studio -->
            <div id="jt-content-design" class="hide">
                <div id="jr-design-content">
                    <!-- Populated by JS - shows design task or create button -->
                </div>
            </div>

            <!-- TAB: Order Form -->
            <div id="jt-content-orderform" class="hide">
                <div id="jr-orderform-content">
                    <!-- Populated by JS -->
                </div>
            </div>

            <!-- TAB: Production -->
            <div id="jt-content-production" class="hide">
                <div class="glass rounded-2xl p-6">
                    <h4 class="font-semibold mb-4">Production</h4>
                    <div class="grid md:grid-cols-2 gap-6">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">PO Number</label>
                            <input type="text" id="jr-po-number" placeholder="e.g. PO-0001" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div class="flex items-end">
                            <button onclick="generateProductionWorksheet()" class="btn-primary text-sm w-full">
                                Generate Production Worksheet (PDF)
                            </button>
                        </div>
                    </div>
                    <div class="mt-6">
                        <p class="text-xs text-gray-500 mb-2">Production worksheet is auto-generated from the approved order form. It includes the PO number at the top and excludes commercial pricing.</p>
                        <div id="jr-production-status" class="p-4 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                            <p class="text-sm text-gray-600">No order form approved yet. Approve an order form to enable worksheet generation.</p>
                        </div>
                    </div>
                </div>
            </div>

                </div><!-- /record-content -->
            </div><!-- /record-layout -->
        </div>

        <!-- MODAL: New/Edit Job -->
        <div id="job-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hide" style="background:rgba(0,0,0,0.75);backdrop-filter:blur(8px)">
            <div class="glass rounded-2xl w-full max-w-lg max-h-screen overflow-y-auto" style="max-height:90vh">
                <div class="p-5 border-b border-white border-opacity-5 flex items-center justify-between sticky top-0 glass">
                    <h3 id="job-modal-title" class="text-lg font-bold">New Job</h3>
                    <button onclick="closeJobModal()" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg">✕</button>
                </div>
                <div class="p-5">
                    <input type="hidden" id="job-id">
                    <div class="modal-section">
                        <p class="modal-section-title">Job Information</p>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Job Name *</label>
                            <input type="text" id="job-name" placeholder="e.g. Westfield FC 2025 Kit" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div class="mb-3">
                            <label class="text-xs text-gray-500 mb-1 block">Description</label>
                            <textarea id="job-description" rows="2" placeholder="Brief overview of this job..." class="w-full px-3 py-2 rounded-lg text-sm resize-none"></textarea>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Job Type</label>
                                <select id="job-type" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="new_club">New Club</option>
                                    <option value="repeat_order">Repeat Order</option>
                                    <option value="new_concept">New Concept</option>
                                    <option value="new_team">New Team</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Club Type</label>
                                <select id="job-club-type" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="retail">Retail</option>
                                    <option value="partner">Partner</option>
                                    <option value="partner_plus">Partner+</option>
                                </select>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 mb-3">
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Channel</label>
                                <select id="job-channel" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="direct">Direct</option>
                                    <option value="store">Store</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-500 mb-1 block">Stage</label>
                                <select id="job-stage" class="w-full px-3 py-2 rounded-lg text-sm">
                                    <option value="discovery">Discovery</option>
                                    <option value="concepts">Concepts</option>
                                    <option value="awaiting_approval">Awaiting Approval</option>
                                    <option value="quote">Quote</option>
                                    <option value="paid">Paid</option>
                                    <option value="on_boarding">On-Boarding</option>
                                    <option value="completed">Completed</option>
                                </select>
                            </div>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Link Club</label>
                            <select id="job-club-id" class="w-full px-3 py-2 rounded-lg text-sm">
                                <option value="">— No club linked —</option>
                            </select>
                        </div>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="saveJob()" class="btn-primary">Save Job</button>
                        <button onclick="closeJobModal()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Team record -->
        <div id="team-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hide" style="background:rgba(0,0,0,0.75);backdrop-filter:blur(8px)">
            <div class="glass rounded-2xl w-full max-w-lg">
                <div class="p-5 border-b border-white border-opacity-5 flex items-center justify-between">
                    <h3 id="team-modal-title" class="text-lg font-bold">Team Details</h3>
                    <button onclick="closeTeamModal()" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg">✕</button>
                </div>
                <div class="p-5">
                    <input type="hidden" id="team-id">
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div class="col-span-2">
                            <label class="text-xs text-gray-500 mb-1 block">Team Name *</label>
                            <input type="text" id="team-name" placeholder="e.g. Westfield FC First Team" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Manager Name</label>
                            <input type="text" id="team-manager-name" placeholder="Name" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Manager Email</label>
                            <input type="email" id="team-manager-email" placeholder="email@example.com" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Manager Phone</label>
                            <input type="tel" id="team-manager-phone" placeholder="Phone" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Notes</label>
                            <input type="text" id="team-notes" placeholder="Any notes..." class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                    </div>
                    <div class="flex gap-3 mt-2">
                        <button onclick="saveTeam()" class="btn-primary">Save Team</button>
                        <button onclick="closeTeamModal()" class="btn-secondary">Cancel</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- MODAL: Link Club to Job -->
        <div id="link-club-modal" class="fixed inset-0 z-50 flex items-center justify-center p-4 hide" style="background:rgba(0,0,0,0.75);backdrop-filter:blur(8px)">
            <div class="glass rounded-2xl w-full max-w-md">
                <div class="p-5 border-b border-white border-opacity-5 flex items-center justify-between">
                    <h3 class="text-lg font-bold">Link Club</h3>
                    <button onclick="document.getElementById('link-club-modal').classList.add('hide')" class="text-gray-500 hover:text-white w-8 h-8 flex items-center justify-center rounded-lg">✕</button>
                </div>
                <div class="p-5">
                    <label class="text-xs text-gray-500 mb-2 block">Select Club</label>
                    <select id="link-club-select" class="w-full px-3 py-2 rounded-lg text-sm mb-4">
                        <option value="">Choose club...</option>
                    </select>
                    <button onclick="linkClubToJob()" class="btn-primary w-full">Link Club</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             TOOL: CLUBS (Enhanced)
             ============================================================ -->
        <div id="tool-clubs" class="hide p-6 md:p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>
            <div class="mb-6">
                <h2 class="text-2xl font-bold">Clubs</h2>
                <p class="text-gray-500 text-sm mt-1">Manage all your clubs, products and Shopify stores</p>
            </div>

            <!-- Split action grid -->
            <div class="split-action-grid mb-8">
                <div onclick="showCreateClubModal()" class="split-action-card">
                    <div class="text-4xl mb-3">➕</div>
                    <h3 class="text-lg font-bold mb-1">Create New Club</h3>
                    <p class="text-gray-500 text-sm">Set up a brand new club record with all details</p>
                </div>
                <div onclick="showClubSearch()" class="split-action-card">
                    <div class="text-4xl mb-3">🔍</div>
                    <h3 class="text-lg font-bold mb-1">Search Clubs</h3>
                    <p class="text-gray-500 text-sm">Find and manage existing clubs by name, sport or county</p>
                </div>
            </div>

            <!-- Club search area (hidden until Search clicked) -->
            <div id="club-search-area" class="hide">
                <div class="glass rounded-xl p-4 mb-5 flex flex-wrap gap-4">
                    <input type="text" id="clubs-search" placeholder="Search clubs by name..." class="flex-1 min-w-48 px-3 py-2 rounded-lg text-sm" oninput="renderClubsEnhanced()">
                    <select id="clubs-filter-sport" class="px-3 py-2 rounded-lg text-sm" onchange="renderClubsEnhanced()">
                        <option value="">All Sports</option>
                        <option value="Football">Football</option><option value="Rugby">Rugby</option>
                        <option value="Cricket">Cricket</option><option value="Basketball">Basketball</option>
                        <option value="Netball">Netball</option><option value="Hockey">Hockey</option>
                        <option value="Athletics">Athletics</option><option value="Other">Other</option>
                    </select>
                    <select id="clubs-filter-partner" class="px-3 py-2 rounded-lg text-sm" onchange="renderClubsEnhanced()">
                        <option value="">All Status</option>
                        <option value="retail">Retail</option>
                        <option value="partner">Partner</option>
                        <option value="partner_plus">Partner+</option>
                    </select>
                </div>
                <div id="clubs-enhanced-list" class="space-y-3"></div>
                <div id="clubs-enhanced-empty" class="hide text-center py-16">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center text-3xl">🏟️</div>
                    <p class="text-gray-400 font-medium mb-2">No clubs found</p>
                    <p class="text-gray-600 text-sm">Try adjusting your search or filters</p>
                </div>
            </div>

            <!-- Recent clubs when not searching -->
            <div id="clubs-recent" class="">
                <h3 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-4">All Clubs</h3>
                <div id="clubs-recent-list" class="space-y-3"></div>
            </div>
        </div>

        <!-- ============================================================
             TOOL: CLUB DETAIL DASHBOARD
             ============================================================ -->
        <div id="tool-club-detail" class="hide p-6 md:p-8 max-w-6xl mx-auto">
            <button onclick="goBack()" id="club-detail-back-btn" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                <span id="club-detail-back-label">Back to Clubs</span>
            </button>

            <!-- Club record header -->
            <div class="glass rounded-2xl p-5 mb-4">
                <div class="flex items-start justify-between flex-wrap gap-4">
                    <div class="flex items-center gap-4">
                        <div class="w-14 h-14 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(20,184,166,0.1)">
                            <span id="club-detail-initials" class="text-brand-400 font-bold text-xl"></span>
                        </div>
                        <div>
                            <div class="flex items-center gap-3 flex-wrap">
                                <h2 id="club-detail-name" class="text-2xl font-bold"></h2>
                                <span id="club-detail-partner-badge" class="badge text-xs"></span>
                            </div>
                            <div class="flex items-center gap-3 mt-1">
                                <span id="club-detail-sport" class="text-gray-500 text-sm"></span>
                                <span id="club-detail-suffix" class="text-gray-600 font-mono text-xs"></span>
                            </div>
                        </div>
                    </div>
                    <button onclick="showEditClubModal()" class="btn-secondary text-sm flex-shrink-0">Edit Club Info</button>
                </div>
            </div>

            <!-- Timeline: Club onboarding progress -->
            <div class="record-timeline" id="club-record-timeline">
                <div class="tl-step" id="club-tl-profile">
                    <div class="tl-dot"></div>
                    <span class="tl-label">Profile</span>
                </div>
                <div class="tl-step" id="club-tl-products">
                    <div class="tl-dot"></div>
                    <span class="tl-label">Products</span>
                </div>
                <div class="tl-step" id="club-tl-mockups">
                    <div class="tl-dot"></div>
                    <span class="tl-label">Mock-Ups</span>
                </div>
                <div class="tl-step" id="club-tl-store">
                    <div class="tl-dot"></div>
                    <span class="tl-label">Store</span>
                </div>
                <div class="tl-step" id="club-tl-active">
                    <div class="tl-dot"></div>
                    <span class="tl-label">Active</span>
                </div>
            </div>

            <!-- Record layout: side nav + content -->
            <div class="record-layout">
                <!-- Side nav -->
                <div class="record-side-nav" id="club-record-nav">
                    <button class="record-nav-item active" id="tab-btn-overview" onclick="showClubTab('overview')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 10h16M4 14h16M4 18h16"/></svg>
                        Overview
                    </button>
                    <button class="record-nav-item" id="tab-btn-teams" onclick="showClubTab('teams')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0z"/></svg>
                        Teams
                    </button>
                    <button class="record-nav-item" id="tab-btn-products" onclick="showClubTab('products')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                        Club Products
                    </button>
                    <button class="record-nav-item" id="tab-btn-orderforms" onclick="showClubTab('orderforms')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
                        Order Forms
                    </button>
                    <button class="record-nav-item" id="tab-btn-jobs" onclick="showClubTab('jobs')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 13.255A23.931 23.931 0 0112 15c-3.183 0-6.22-.62-9-1.745M16 6V4a2 2 0 00-2-2h-4a2 2 0 00-2 2v2m4 6h.01M5 20h14a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                        Jobs
                    </button>
                    <div class="record-nav-divider"></div>
                    <button class="record-nav-item" id="tab-btn-onboarding" onclick="showClubTab('onboarding')">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"/></svg>
                        Onboarding
                    </button>
                </div>
                <!-- Content area -->
                <div class="record-content">

            <!-- TAB: Overview -->
            <div id="club-tab-overview" class="club-tab-content">
                <div class="grid md:grid-cols-3 gap-5">
                    <!-- Club identity card -->
                    <div class="card md:col-span-2">
                        <div class="flex items-start justify-between mb-4">
                            <h3 class="font-semibold text-brand-400">Club Details</h3>
                            <button onclick="showEditClubModal()" class="text-xs text-gray-500 hover:text-white px-3 py-1.5 rounded-lg" style="background:rgba(255,255,255,0.05)">Edit</button>
                        </div>
                        <div id="club-overview-info"><!-- Populated by JS --></div>
                    </div>
                    <!-- Branding card -->
                    <div class="card">
                        <h3 class="font-semibold text-brand-400 mb-4">Brand Identity</h3>
                        <!-- Club Logo / Crest -->
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-2">Club Logo / Crest</p>
                            <div class="flex items-start gap-3">
                                <div id="club-crest-display" class="w-20 h-20 rounded-xl flex items-center justify-center text-3xl flex-shrink-0" style="background:rgba(255,255,255,0.04);border:1px dashed rgba(255,255,255,0.1)">🏟️</div>
                                <div class="flex flex-col gap-2 justify-center">
                                    <button onclick="document.getElementById('club-logo-upload-inline').click()" class="text-xs btn-secondary px-3 py-1.5">Upload Logo</button>
                                    <input type="file" id="club-logo-upload-inline" accept="image/*" class="hide" onchange="uploadClubLogoInline(event)">
                                    <button id="club-logo-download-btn" onclick="downloadClubLogo()" class="text-xs btn-secondary px-3 py-1.5 hide">Download</button>
                                </div>
                            </div>
                        </div>
                        <!-- Pantone colours -->
                        <div class="mb-4">
                            <p class="text-xs text-gray-500 mb-2">Pantone Colours</p>
                            <div class="flex gap-2 items-center">
                                <div id="pantone-main-swatch" class="pantone-swatch" title="Main"></div>
                                <div id="pantone-sec-swatch" class="pantone-swatch" title="Secondary"></div>
                                <div id="pantone-acc-swatch" class="pantone-swatch" title="Accent"></div>
                                <span id="pantone-labels" class="text-xs text-gray-600">—</span>
                            </div>
                        </div>
                        <!-- Sponsor logos -->
                        <div>
                            <p class="text-xs text-gray-500 mb-2">Sponsor Logos</p>
                            <div id="sponsor-logos-display" class="text-xs text-gray-600">—</div>
                        </div>
                    </div>
                </div>
                <!-- Stats row -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mt-5">
                    <div class="stat-card">
                        <p class="text-xs text-gray-500 mb-1">Club Products</p>
                        <p id="overview-stat-products" class="text-2xl font-bold text-brand-400">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-xs text-gray-500 mb-1">Active Forms</p>
                        <p id="overview-stat-forms" class="text-2xl font-bold" style="color:#4ade80">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-xs text-gray-500 mb-1">Submissions</p>
                        <p id="overview-stat-submissions" class="text-2xl font-bold" style="color:#60a5fa">0</p>
                    </div>
                    <div class="stat-card">
                        <p class="text-xs text-gray-500 mb-1">Shopify Synced</p>
                        <p id="overview-stat-synced" class="text-2xl font-bold" style="color:#c084fc">0</p>
                    </div>
                </div>
            </div>

            <!-- TAB: Teams -->
            <div id="club-tab-teams" class="club-tab-content hide">
                <div class="section-header mb-5">
                    <div>
                        <h3 class="font-semibold text-lg">Club Teams</h3>
                        <p class="text-gray-500 text-sm mt-1">All squads and teams within this club. Every team must belong to a club.</p>
                    </div>
                    <button onclick="openClubTeamModal(null)" class="btn-primary text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Team
                    </button>
                </div>
                <div id="club-teams-list" class="grid md:grid-cols-2 gap-4">
                    <!-- Populated by JS -->
                </div>
                <div id="club-teams-empty" class="hide text-center py-12">
                    <div class="empty-icon">👕</div>
                    <p class="text-gray-500">No teams yet. Add teams for this club.</p>
                </div>
            </div>

            <!-- TAB: Products -->
            <div id="club-tab-products" class="club-tab-content hide">
                <!-- Header -->
                <div class="section-header mb-4">
                    <div>
                        <h3 class="font-semibold text-lg">Club Products</h3>
                        <p id="cp-partnership-warning" class="text-yellow-400 text-xs mt-1 hide">⚠️ Set a Partnership Level in Club Info before adding products</p>
                        <p class="text-gray-500 text-xs mt-1" id="cp-tier-info"></p>
                    </div>
                    <div class="flex gap-2 flex-wrap">
                        <button onclick="toggleMockupUploadSection()" id="cp-upload-toggle-btn" class="btn-secondary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            Upload Mock-Ups
                        </button>
                        <button onclick="showBulkAddProductsModal()" class="btn-secondary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"/></svg>
                            Bulk Add
                        </button>
                        <button onclick="showAddClubProductModal()" class="btn-primary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add Product
                        </button>
                    </div>
                </div>

                <!-- Inline Mock-Up Upload Section -->
                <div id="club-mockup-upload-inline" class="card mb-5 hide">
                    <div class="flex items-center justify-between mb-3">
                        <div>
                            <h4 class="font-semibold text-sm">Upload Product Mock-Ups</h4>
                            <p class="text-gray-500 text-xs mt-0.5">Name files as the product code (e.g. <span class="font-mono text-brand-400">APX-ATL-001.png</span>). Images auto-match to products and set the club's pricing from the selected Partnership Level.</p>
                        </div>
                        <button onclick="showNamingHelp(event)" class="help-trigger text-xs flex items-center gap-1 flex-shrink-0">
                            <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Naming Help
                        </button>
                    </div>
                    <div id="club-detail-dropzone" class="dropzone p-6 text-center cursor-pointer"
                        onclick="document.getElementById('club-image-upload').click()"
                        ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleClubDetailDrop(event)">
                        <input type="file" id="club-image-upload" accept="image/*" multiple class="hide" onchange="handleClubDetailImageUpload(event)">
                        <div class="w-10 h-10 mx-auto mb-2 rounded-full bg-brand-500/10 flex items-center justify-center">
                            <svg class="w-5 h-5 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </div>
                        <p class="text-white text-sm font-medium mb-1">Drop images or click to browse</p>
                        <p class="text-gray-600 text-xs">JPG, PNG accepted · Multiple files supported</p>
                    </div>
                    <div id="club-detail-upload-progress" class="mt-3 hide">
                        <div class="flex justify-between mb-1 text-xs text-gray-400">
                            <span id="club-detail-upload-text">Uploading...</span>
                            <span id="club-detail-upload-count"></span>
                        </div>
                        <div class="progress-bar"><div id="club-detail-upload-bar" class="progress-fill" style="width:0%"></div></div>
                    </div>
                </div>

                <!-- Products list -->
                <div id="club-products-list" class="space-y-3"></div>
                <div id="club-products-empty" class="hide text-center py-12">
                    <div class="w-16 h-16 mx-auto mb-4 rounded-2xl bg-gray-800 flex items-center justify-center">
                        <svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4"/></svg>
                    </div>
                    <p class="text-gray-500 text-sm font-medium mb-1">No products yet</p>
                    <p class="text-gray-600 text-xs">Upload mock-up images (auto-creates products) or click Add Product to add manually</p>
                </div>
            </div>

            <!-- TAB: Order Forms -->
            <div id="club-tab-orderforms" class="club-tab-content hide">
                <div class="section-header">
                    <div>
                        <h3 class="font-semibold text-lg">Order Forms</h3>
                        <p class="text-gray-500 text-sm mt-1">Direct order forms for this club</p>
                    </div>
                    <button onclick="showCreateOrderFormModal()" class="btn-primary text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        New Order Form
                    </button>
                </div>
                <div id="club-order-forms-list" class="space-y-3">
                    <!-- Populated by JS -->
                </div>
                <div id="club-order-forms-empty" class="hide text-center py-12">
                    <p class="text-gray-500">No order forms yet. Create one to get a shareable link for the club.</p>
                </div>
            </div>

            <!-- TAB: Shopify Sync -->
            <!-- TAB: Onboarding (formerly Shopify Sync) -->
            <div id="club-tab-onboarding" class="club-tab-content hide">
                <!-- Step 1: Create Club Range -->
                <div class="card mb-5">
                    <div class="flex items-start justify-between mb-3">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center" style="background:rgba(20,184,166,0.2);color:#2dd4bf">1</span>
                                <h3 class="font-semibold">Club Range &amp; Mock-Ups</h3>
                            </div>
                            <p class="text-gray-500 text-sm">Upload finished mock-up images for this club. TeamwearOS reads the filename and auto-creates club products from the master catalogue.</p>
                        </div>
                        <button onclick="showMockupUploadModal()" class="btn-primary text-sm flex items-center gap-2 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                            Upload Mock-Ups
                        </button>
                    </div>
                    <!-- Products with images summary -->
                    <div id="onboard-images-summary" class="p-3 rounded-xl mt-2" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                        <p class="text-xs text-gray-500">Club products with images: <span id="onboard-image-count" class="text-white font-semibold">0</span> of <span id="onboard-total-count" class="text-white font-semibold">0</span></p>
                    </div>
                </div>

                <!-- Step 2: Create Club Shop with CSV -->
                <div class="card mb-5">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center" style="background:rgba(20,184,166,0.2);color:#2dd4bf">2</span>
                                <h3 class="font-semibold">Create Club Shop with CSV</h3>
                            </div>
                            <p class="text-gray-500 text-sm">Generate a complete Shopify import CSV for all club products. Select the price list to use — the CSV maps all product fields, sizes, variants and images ready for collection creation in Shopify.</p>
                        </div>
                    </div>
                    <!-- Collection image upload -->
                    <div class="flex items-center gap-4 mb-4 p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                        <div id="onboard-coll-img-preview" class="w-14 h-14 rounded-lg flex items-center justify-center flex-shrink-0 text-xl" style="background:rgba(255,255,255,0.04);border:1px dashed rgba(255,255,255,0.15)">🏟️</div>
                        <div class="flex-1 min-w-0">
                            <p class="text-xs font-medium text-gray-300 mb-0.5">Collection Image</p>
                            <p class="text-xs text-gray-600">Recommended: 1200×600px. Used as the Shopify collection banner.</p>
                        </div>
                        <button onclick="document.getElementById('onboard-coll-img-input').click()" class="btn-secondary text-xs px-3 py-1.5 flex-shrink-0">Upload</button>
                        <input type="file" id="onboard-coll-img-input" accept="image/*" class="hide" onchange="uploadOnboardCollectionImage(event)">
                    </div>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openCreateStoreModal()" class="btn-primary flex items-center gap-2 text-sm">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Create Club Shop (CSV)
                        </button>
                        <button id="onboard-api-btn" onclick="syncClubCollection()" class="btn-secondary text-sm flex items-center gap-2 hide">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/></svg>
                            Push via Shopify API
                        </button>
                    </div>
                    <div id="club-shopify-collection-status" class="mt-3"></div>
                </div>

                <!-- Step 3: Add New Product To Collection -->
                <div class="card mb-5">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center" style="background:rgba(20,184,166,0.2);color:#2dd4bf">3</span>
                                <h3 class="font-semibold">Add New Product To Collection</h3>
                            </div>
                            <p class="text-gray-500 text-sm">Select an individual club product to download a single-product CSV. Upload this to Shopify to add that product to the team collection without regenerating the entire shop.</p>
                        </div>
                    </div>
                    <div class="flex gap-3 items-end flex-wrap">
                        <div class="flex-1" style="min-width:200px">
                            <label class="text-xs text-gray-500 mb-1.5 block">Select Product</label>
                            <select id="onboard-single-product-select" class="w-full px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1);color:#ddd">
                                <option value="">Choose a club product...</option>
                            </select>
                        </div>
                        <button onclick="downloadSingleClubProductCSV()" class="btn-primary text-sm flex items-center gap-2 flex-shrink-0">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Download Product CSV
                        </button>
                    </div>
                </div>

                <!-- Step 4: Product Sync (AI — coming soon) -->
                <div class="card mb-5">
                    <div class="flex items-start gap-3 mb-3">
                        <span class="w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center flex-shrink-0 mt-0.5" style="background:rgba(20,184,166,0.2);color:#2dd4bf">4</span>
                        <div>
                            <h3 class="font-semibold mb-1">Product Sync</h3>
                            <p class="text-gray-500 text-sm">AI-powered live sync to your Shopify store. New products added in TeamwearOS will be automatically created in Shopify and added to the team collection — no manual CSV uploads required.</p>
                        </div>
                    </div>
                    <div id="club-shopify-products-status" class="space-y-2 mb-3"></div>
                    <div class="flex items-center gap-3 p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                        <span class="w-2 h-2 rounded-full flex-shrink-0" style="background:#555"></span>
                        <p class="text-sm text-gray-500">Sync not yet enabled — coming soon</p>
                    </div>
                </div>

                <!-- Order Forms -->
                <div class="card mb-5">
                    <div class="flex items-center justify-between mb-4">
                        <div>
                            <div class="flex items-center gap-2 mb-1">
                                <span class="w-6 h-6 rounded-full text-xs font-bold flex items-center justify-center" style="background:rgba(20,184,166,0.2);color:#2dd4bf">5</span>
                                <h3 class="font-semibold">Order Forms</h3>
                            </div>
                            <p class="text-gray-500 text-sm mt-0.5">Create direct order links for the club to collect individual kit orders</p>
                        </div>
                        <button onclick="showCreateOrderFormModal()" class="btn-primary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            New Form
                        </button>
                    </div>
                    <div id="club-order-forms-list-onboard" class="space-y-2"></div>
                    <div id="club-order-forms-empty-onboard" class="hide text-center py-6 text-gray-600 text-sm">No order forms yet.</div>
                </div>

                <!-- Checklist -->
                <div class="card">
                    <h3 class="font-semibold text-brand-400 mb-4">Onboarding Checklist</h3>
                    <div id="onboarding-checklist" class="space-y-3"></div>
                </div>
            </div>

            <!-- Keep legacy id for JS compatibility -->
            <div id="club-tab-shopify" class="hide"></div>

            <!-- TAB: Images (embedded mockups) — tab button removed; kept for JS compatibility -->
            <div id="club-tab-images" class="club-tab-content hide">
                <p class="text-gray-500 text-sm mb-4">Upload product images for Shopify CSV export. Images are matched to master products by filename.</p>
                <div class="card mb-4">
                    <div class="section-header mb-4">
                        <h3 class="font-semibold">Upload Images</h3>
                        <button onclick="showNamingHelp(event)" class="help-trigger text-sm flex items-center gap-1">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                            Naming Help
                        </button>
                    </div>
                    <div id="club-detail-dropzone" class="dropzone p-8 text-center cursor-pointer"
                        onclick="document.getElementById('club-image-upload-legacy').click()"
                        ondragover="handleDragOver(event)" ondragleave="handleDragLeave(event)" ondrop="handleClubDetailDrop(event)">
                        <input type="file" id="club-image-upload-legacy" accept="image/*" multiple class="hide" onchange="handleClubDetailImageUpload(event)">
                        <div class="w-12 h-12 mx-auto mb-3 rounded-full bg-brand-500/10 flex items-center justify-center">
                            <svg class="w-6 h-6 text-brand-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                        </div>
                        <p class="text-white text-sm font-medium mb-1">Drop images or click to browse</p>
                        <p class="text-gray-600 text-xs">Name files as product code (e.g. APX-ATL-001.png)</p>
                    </div>
                    <div id="club-detail-upload-progress" class="mt-3 hide">
                        <div class="flex justify-between mb-1 text-xs text-gray-400">
                            <span id="club-detail-upload-text">Uploading...</span>
                            <span id="club-detail-upload-count"></span>
                        </div>
                        <div class="progress-bar"><div id="club-detail-upload-bar" class="progress-fill" style="width:0%"></div></div>
                    </div>
                </div>
                <!-- Images grid -->
                <div id="club-detail-images-section" class="card">
                    <div class="section-header mb-4">
                        <h3 class="font-semibold">Uploaded Images (<span id="club-detail-image-count">0</span>)</h3>
                        <span id="club-detail-collection-badge" class="badge"></span>
                    </div>
                    <div id="club-detail-images-grid" class="grid grid-cols-3 md:grid-cols-5 lg:grid-cols-7 gap-3">
                        <!-- Populated by JS -->
                    </div>
                    <div id="club-detail-images-empty" class="hide text-center py-8 text-gray-600 text-sm">No images uploaded yet</div>
                </div>
            </div>

            <!-- TAB: Jobs -->
            <div id="club-tab-jobs" class="club-tab-content hide">
                <div class="section-header mb-5">
                    <div>
                        <h3 class="font-semibold text-lg">Club Jobs</h3>
                        <p class="text-gray-500 text-sm mt-1">All sales jobs linked to this club</p>
                    </div>
                </div>
                <div id="club-jobs-list" class="space-y-3"></div>
                <div id="club-jobs-empty" class="hide text-center py-12">
                    <div class="empty-icon">💼</div>
                    <p class="text-gray-500">No jobs linked to this club yet.</p>
                </div>
            </div>

                </div><!-- /record-content -->
            </div><!-- /record-layout -->
        </div>

        <!-- ============================================================
             TOOL: ORDER FORMS (Global view - all submissions)
             ============================================================ -->
        <div id="tool-order-forms" class="hide p-6 md:p-8 max-w-6xl mx-auto">
            <button onclick="showLaunchpad()" class="text-gray-500 hover:text-white mb-6 flex items-center gap-2 text-sm transition">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                Back to Launchpad
            </button>

            <div class="flex items-center justify-between mb-6">
                <div>
                    <h2 class="text-2xl font-bold">Order Forms</h2>
                    <p class="text-gray-500 text-sm mt-1">All direct order submissions across all clubs</p>
                </div>
            </div>

            <!-- Filter bar -->
            <div class="glass rounded-xl p-4 mb-6 flex flex-wrap gap-4 items-center">
                <select id="global-forms-club-filter" class="flex-1 min-w-48 px-3 py-2 rounded-lg text-sm" onchange="loadAllSubmissions()">
                    <option value="">All Clubs</option>
                </select>
                <select id="global-forms-status-filter" class="px-3 py-2 rounded-lg text-sm" onchange="loadAllSubmissions()">
                    <option value="">All Statuses</option>
                    <option value="new">New (no draft order)</option>
                    <option value="drafted">Draft Order Created</option>
                </select>
                <span class="text-gray-500 text-sm">Total: <span id="global-submissions-count" class="text-white font-semibold">0</span></span>
            </div>

            <div id="global-submissions-list" class="space-y-3">
                <!-- Populated by JS -->
            </div>
            <div id="global-submissions-empty" class="hide text-center py-16">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-gray-800 flex items-center justify-center"><svg class="w-7 h-7 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/></svg></div>
                <p class="text-gray-400 font-medium">No submissions yet</p>
                <p class="text-gray-600 text-sm mt-1">Submissions will appear here when clubs submit their order forms</p>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Create Club (Enhanced)
             ============================================================ -->
        <div id="create-club-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl w-full max-w-2xl mx-4 my-auto" style="max-height:92vh;overflow-y:auto">
                <div class="flex justify-between items-center p-6 pb-4 sticky top-0 glass z-10">
                    <h3 id="club-modal-title" class="text-xl font-bold">Create New Club</h3>
                    <button onclick="hideCreateClubModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="px-6 pb-6">
                <input type="hidden" id="edit-club-id">

                <!-- Basic info -->
                <div class="modal-section">
                    <p class="modal-section-title">Club Identity</p>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Club Name *</label>
                            <input type="text" id="club-name" placeholder="Westfield FC" class="w-full px-3 py-2 rounded-lg text-sm" oninput="generateClubSlugAndSuffix()">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Suffix * <span class="text-gray-600">(auto-generated · max 8 chars)</span></label>
                            <div class="relative">
                                <input type="text" id="club-suffix" placeholder="Auto-generated" class="w-full px-3 py-2 rounded-lg text-sm uppercase font-mono pr-20" maxlength="8" oninput="checkSuffixUniqueness()">
                                <span id="suffix-status" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs"></span>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Sport</label>
                            <select id="club-sport" class="w-full px-3 py-2 rounded-lg text-sm">
                                <option value="">Select sport...</option>
                                <option>Football</option><option>Rugby Union</option><option>Rugby League</option>
                                <option>Cricket</option><option>Basketball</option><option>Netball</option>
                                <option>Hockey</option><option>Athletics</option><option>Cycling</option>
                                <option>Swimming</option><option>Tennis</option><option>Badminton</option>
                                <option>Volleyball</option><option>American Football</option><option>Gaelic Football</option>
                                <option>Hurling</option><option>Boxing</option><option>Martial Arts</option>
                                <option>Rowing</option><option>Other</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Partnership Level *</label>
                            <select id="club-status" class="w-full px-3 py-2 rounded-lg text-sm">
                                <!-- Populated dynamically from brand pricing tiers -->
                            </select>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mb-3">
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Salesperson *</label>
                            <select id="club-salesperson-id" class="w-full px-3 py-2 rounded-lg text-sm">
                                <option value="">Select salesperson...</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">League</label>
                            <input type="text" id="club-league" placeholder="e.g. Southern Counties" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="text-gray-400 text-xs mb-1 block">URL Slug <span class="text-gray-600">(auto-generated from Shopify collection)</span></label>
                        <input type="text" id="club-slug" placeholder="westfield-fc" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <!-- Club Colours -->
                    <div>
                        <label class="text-gray-400 text-xs mb-2 block font-medium">Club Colours</label>
                        <div class="grid grid-cols-3 gap-3">
                            <div class="bg-gray-900 rounded-xl p-3">
                                <p class="text-gray-500 text-xs mb-2">Main</p>
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="color" id="club-pantone-main" value="#14b8a6" class="h-10 w-10 rounded-lg cursor-pointer flex-shrink-0" style="padding:2px;background:transparent;border:2px solid rgba(255,255,255,0.15)" oninput="syncHexInput('club-pantone-main','club-hex-main')">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-gray-600 text-xs mb-1">Hex</p>
                                        <input type="text" id="club-hex-main" placeholder="#14b8a6" maxlength="7" class="w-full px-2 py-1 rounded text-xs font-mono" oninput="syncColorPicker('club-hex-main','club-pantone-main')">
                                    </div>
                                </div>
                                <input type="text" id="club-pantone-main-text" placeholder="Pantone ref e.g. 355 C" class="w-full px-2 py-1 rounded text-xs text-gray-500" title="Pantone reference code">
                            </div>
                            <div class="bg-gray-900 rounded-xl p-3">
                                <p class="text-gray-500 text-xs mb-2">Secondary</p>
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="color" id="club-pantone-sec" value="#ffffff" class="h-10 w-10 rounded-lg cursor-pointer flex-shrink-0" style="padding:2px;background:transparent;border:2px solid rgba(255,255,255,0.15)" oninput="syncHexInput('club-pantone-sec','club-hex-sec')">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-gray-600 text-xs mb-1">Hex</p>
                                        <input type="text" id="club-hex-sec" placeholder="#ffffff" maxlength="7" class="w-full px-2 py-1 rounded text-xs font-mono" oninput="syncColorPicker('club-hex-sec','club-pantone-sec')">
                                    </div>
                                </div>
                                <input type="text" id="club-pantone-sec-text" placeholder="Pantone ref e.g. 032 C" class="w-full px-2 py-1 rounded text-xs text-gray-500" title="Pantone reference code">
                            </div>
                            <div class="bg-gray-900 rounded-xl p-3">
                                <p class="text-gray-500 text-xs mb-2">Accent</p>
                                <div class="flex items-center gap-2 mb-2">
                                    <input type="color" id="club-pantone-acc" value="#000000" class="h-10 w-10 rounded-lg cursor-pointer flex-shrink-0" style="padding:2px;background:transparent;border:2px solid rgba(255,255,255,0.15)" oninput="syncHexInput('club-pantone-acc','club-hex-acc')">
                                    <div class="flex-1 min-w-0">
                                        <p class="text-gray-600 text-xs mb-1">Hex</p>
                                        <input type="text" id="club-hex-acc" placeholder="#000000" maxlength="7" class="w-full px-2 py-1 rounded text-xs font-mono" oninput="syncColorPicker('club-hex-acc','club-pantone-acc')">
                                    </div>
                                </div>
                                <input type="text" id="club-pantone-acc-text" placeholder="Pantone ref e.g. Black C" class="w-full px-2 py-1 rounded text-xs text-gray-500" title="Pantone reference code">
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Club Logo Upload -->
                <div class="modal-section">
                    <p class="modal-section-title">Club Logo</p>
                    <div class="flex items-center gap-4">
                        <div id="club-logo-preview" class="w-20 h-20 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(255,255,255,0.04);border:1px dashed rgba(255,255,255,0.15)"><svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z"/></svg></div>
                        <div class="flex-1">
                            <input type="file" id="club-logo-upload" accept="image/*" class="hide" onchange="previewClubLogo(event)">
                            <button onclick="document.getElementById('club-logo-upload').click()" class="btn-secondary text-sm mb-2 w-full">Upload Logo / Crest</button>
                            <p class="text-xs text-gray-600">PNG or SVG recommended. Shown in design studio assets.</p>
                        </div>
                    </div>
                    <input type="hidden" id="club-logo-url-existing">
                </div>

                <!-- Address -->
                <div class="modal-section">
                    <p class="modal-section-title">Address</p>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Address Line 1</label>
                            <input type="text" id="club-addr1" placeholder="123 Stadium Road" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Address Line 2</label>
                            <input type="text" id="club-addr2" placeholder="Optional" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Town / City</label>
                            <input type="text" id="club-town" placeholder="Town" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">County</label>
                            <input type="text" id="club-county" placeholder="County" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Postcode</label>
                            <input type="text" id="club-postcode" placeholder="SW1A 1AA" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                    </div>
                </div>

                <!-- Contact details -->
                <div class="modal-section">
                    <p class="modal-section-title">Key Contact</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Contact Name</label>
                            <input type="text" id="club-contact-name" placeholder="John Smith" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Email</label>
                            <input type="email" id="club-contact-email" placeholder="john@club.com" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-400 text-xs mb-1 block">Phone</label>
                            <input type="tel" id="club-contact-phone" placeholder="+44 7700 000000" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                    </div>
                </div>

                <!-- Hidden legacy partner checkbox for JS compatibility -->
                <input type="hidden" id="club-is-partner" value="false">

                <div class="flex gap-3 mt-4">
                    <button onclick="hideCreateClubModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="saveClubEnhanced()" class="flex-1 btn-primary py-3">Save Club</button>
                </div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Manage Pricing Tiers
             ============================================================ -->
        <div id="pricing-tiers-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-lg mx-4">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-bold">Partnership Levels</h3>
                        <p class="text-gray-500 text-xs mt-1">Define pricing tiers for this brand. Each tier has Youth &amp; Adult pricing per product.</p>
                    </div>
                    <button onclick="hidePricingTiersModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div id="pricing-tiers-list" class="space-y-2 mb-4">
                    <!-- Rendered by JS -->
                </div>
                <div class="flex gap-2 mt-4 pt-4 border-t border-gray-800">
                    <input type="text" id="new-tier-key" placeholder="Key e.g. partner_plus" class="flex-1 px-3 py-2 rounded-lg text-sm font-mono">
                    <input type="text" id="new-tier-name" placeholder="Display name e.g. Partner+" class="flex-1 px-3 py-2 rounded-lg text-sm">
                    <button onclick="addPricingTier()" class="btn-primary text-sm px-4">Add</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Catalogue Settings
             ============================================================ -->
        <div id="catalogue-settings-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl w-full max-w-2xl mx-4 my-auto">
                <div class="flex justify-between items-center p-6 border-b border-white/5">
                    <div>
                        <h3 class="text-xl font-bold">Catalogue Settings</h3>
                        <p class="text-gray-500 text-xs mt-1">Configure categories, ranges, fit types and pricing tiers for the Master Product Catalogue</p>
                    </div>
                    <button onclick="hideCatalogueSettings()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="p-6 space-y-6">

                    <!-- Pricing Tiers -->
                    <div>
                        <div class="flex items-center justify-between mb-3">
                            <div>
                                <h4 class="font-semibold text-brand-400">Price Lists</h4>
                                <p class="text-gray-500 text-xs mt-0.5">Up to 4 price lists — each has a Youth and Adult price per product</p>
                            </div>
                        </div>
                        <div id="cs-tiers-list" class="space-y-2 mb-3"></div>
                        <div class="flex gap-2">
                            <input type="text" id="cs-new-tier-key" placeholder="Key e.g. partner_plus" class="flex-1 px-3 py-2 rounded-lg text-sm font-mono" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
                            <input type="text" id="cs-new-tier-name" placeholder="Display name e.g. Partner+" class="flex-1 px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
                            <button onclick="csAddTier()" class="btn-primary text-sm px-4">Add</button>
                        </div>
                    </div>

                    <!-- Active Price List for Catalogue View -->
                    <div class="pt-4 border-t border-white/5">
                        <h4 class="font-semibold text-brand-400 mb-2">Catalogue Display Price</h4>
                        <p class="text-gray-500 text-xs mb-3">Choose which price lists are shown as columns in the Master Product Catalogue table (select up to 4)</p>
                        <div id="cs-active-price-list" class="space-y-2">
                            <!-- Populated dynamically -->
                        </div>
                    </div>

                    <!-- Categories -->
                    <div class="pt-4 border-t border-white/5">
                        <h4 class="font-semibold text-brand-400 mb-2">Categories</h4>
                        <p class="text-gray-500 text-xs mb-3">Custom categories available when adding products (products already in the catalogue are included automatically)</p>
                        <div id="cs-categories-list" class="flex flex-wrap gap-2 mb-3 min-h-6"></div>
                        <div class="flex gap-2">
                            <input type="text" id="cs-new-category" placeholder="e.g. Goalkeeper Kit" class="flex-1 px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
                            <button onclick="csAddCategory()" class="btn-primary text-sm px-4">Add</button>
                        </div>
                    </div>

                    <!-- Ranges -->
                    <div class="pt-4 border-t border-white/5">
                        <h4 class="font-semibold text-brand-400 mb-2">Ranges</h4>
                        <p class="text-gray-500 text-xs mb-3">Custom ranges available when adding products</p>
                        <div id="cs-ranges-list" class="flex flex-wrap gap-2 mb-3 min-h-6"></div>
                        <div class="flex gap-2">
                            <input type="text" id="cs-new-range" placeholder="e.g. Atlas, Warrior, Pro" class="flex-1 px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
                            <button onclick="csAddRange()" class="btn-primary text-sm px-4">Add</button>
                        </div>
                    </div>

                    <!-- Fit Types -->
                    <div class="pt-4 border-t border-white/5">
                        <h4 class="font-semibold text-brand-400 mb-2">Fit Types</h4>
                        <p class="text-gray-500 text-xs mb-3">Available fit type options in the product form</p>
                        <div id="cs-fittypes-list" class="flex flex-wrap gap-2 mb-3 min-h-6"></div>
                        <div class="flex gap-2">
                            <input type="text" id="cs-new-fittype" placeholder="e.g. Ladies Fit, Junior" class="flex-1 px-3 py-2 rounded-lg text-sm" style="background:rgba(255,255,255,0.05);border:1px solid rgba(255,255,255,0.1)">
                            <button onclick="csAddFitType()" class="btn-primary text-sm px-4">Add</button>
                        </div>
                    </div>

                </div>
                <div class="p-6 border-t border-white/5">
                    <button onclick="hideCatalogueSettings()" class="w-full btn-primary py-3">Done</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Add/Edit Club Team
             ============================================================ -->
        <div id="club-team-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl p-6 w-full max-w-lg mx-4 my-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="club-team-modal-title" class="text-xl font-bold">Add Team</h3>
                    <button onclick="closeClubTeamModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <input type="hidden" id="edit-club-team-id">
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="col-span-2">
                        <label class="text-gray-400 text-sm mb-1 block">Team Name *</label>
                        <input type="text" id="ct-name" placeholder="e.g. U14s Boys, First Team, Ladies" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Age Group</label>
                        <input type="text" id="ct-age-group" placeholder="e.g. Under 14s, Senior" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Gender</label>
                        <select id="ct-gender" class="w-full px-3 py-2 rounded-lg text-sm">
                            <option value="">Not specified</option>
                            <option value="Boys / Male">Boys / Male</option>
                            <option value="Girls / Female">Girls / Female</option>
                            <option value="Mixed">Mixed</option>
                        </select>
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Coach / Manager Name</label>
                        <input type="text" id="ct-coach-name" placeholder="John Smith" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Coach Email</label>
                        <input type="email" id="ct-coach-email" placeholder="coach@club.com" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div>
                        <label class="text-gray-400 text-sm mb-1 block">Coach Phone</label>
                        <input type="tel" id="ct-coach-phone" placeholder="+44 7700 000000" class="w-full px-3 py-2 rounded-lg text-sm">
                    </div>
                    <div class="col-span-2">
                        <label class="text-gray-400 text-sm mb-1 block">Notes</label>
                        <textarea id="ct-notes" rows="2" placeholder="Any additional notes..." class="w-full px-3 py-2 rounded-lg text-sm resize-none"></textarea>
                    </div>
                </div>
                <div class="flex gap-3">
                    <button onclick="closeClubTeamModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="saveClubTeam()" class="flex-1 btn-primary py-3">Save Team</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Upload Club Mock-Ups / Create Club Range
             ============================================================ -->
        <div id="mockup-upload-modal" class="fixed inset-0 bg-black/85 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl w-full max-w-3xl mx-4 my-auto">
                <div class="flex justify-between items-center p-6 border-b border-white/5">
                    <div>
                        <h3 class="text-xl font-bold">Upload Club Mock-Ups</h3>
                        <p class="text-gray-500 text-sm mt-0.5">Drop finished images — TeamwearOS reads the filename and maps each to the master catalogue</p>
                    </div>
                    <button onclick="hideMockupUploadModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <!-- Filename guide -->
                <div class="mx-6 mt-4 p-4 rounded-xl text-xs font-mono" style="background:rgba(20,184,166,0.06);border:1px solid rgba(20,184,166,0.2)">
                    <p class="text-brand-400 font-semibold mb-1.5 font-sans text-sm">Filename naming convention</p>
                    <div class="grid grid-cols-2 gap-x-6 gap-y-1 text-gray-400">
                        <span><span class="text-white">APX-COR-001.png</span> → Front view, product V1</span>
                        <span><span class="text-white">APX-COR-001-B.png</span> → Back view (-B)</span>
                        <span><span class="text-white">APX-COR-001-S.png</span> → Side view (-S)</span>
                        <span><span class="text-white">APX-COR-001-V2.png</span> → Second product variant (V2)</span>
                        <span><span class="text-white">APX-COR-001-B-V2.png</span> → Back view of V2 variant</span>
                        <span class="text-gray-600">V1 is never written — just the code + view</span>
                    </div>
                </div>

                <!-- Dropzone -->
                <div class="px-6 pt-4">
                    <label id="mockup-dropzone" class="dropzone flex flex-col items-center justify-center p-8 cursor-pointer" onclick="document.getElementById('mockup-file-input').click()">
                        <svg class="w-10 h-10 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <p class="text-gray-400 text-sm text-center">Click to select images, or drag &amp; drop</p>
                        <p class="text-gray-600 text-xs mt-1">PNG, JPG, WEBP — multiple files accepted</p>
                    </label>
                    <input type="file" id="mockup-file-input" accept="image/*" multiple class="hide" onchange="previewMockupFiles(event)">
                </div>

                <!-- Preview table -->
                <div id="mockup-preview-wrap" class="px-6 pb-2 hide">
                    <div class="flex items-center justify-between mb-2">
                        <p class="text-sm font-semibold"><span id="mockup-file-count">0</span> files selected</p>
                        <div class="flex gap-2 text-xs">
                            <span class="px-2 py-0.5 rounded-full" style="background:rgba(34,197,94,0.12);color:#4ade80">■ matched</span>
                            <span class="px-2 py-0.5 rounded-full" style="background:rgba(239,68,68,0.12);color:#f87171">■ no match</span>
                            <span class="px-2 py-0.5 rounded-full" style="background:rgba(251,191,36,0.12);color:#fbbf24">■ new variant</span>
                        </div>
                    </div>
                    <div class="overflow-y-auto max-h-52">
                        <table class="w-full text-xs">
                            <thead><tr class="text-gray-500 border-b border-white/5 text-left">
                                <th class="pb-1.5 pr-3">Filename</th>
                                <th class="pb-1.5 pr-3">Product Code</th>
                                <th class="pb-1.5 pr-3">Item Name</th>
                                <th class="pb-1.5 pr-3">View</th>
                                <th class="pb-1.5">Variant</th>
                            </tr></thead>
                            <tbody id="mockup-preview-table" class="space-y-1"></tbody>
                        </table>
                    </div>
                </div>

                <div class="flex gap-3 p-6 pt-4">
                    <button onclick="hideMockupUploadModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="uploadMockupsAndCreateProducts()" id="mockup-upload-btn" class="flex-1 btn-primary py-3" disabled>
                        Upload &amp; Create Products
                    </button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Create Club Store (price list selector)
             ============================================================ -->
        <div id="create-store-modal" class="fixed inset-0 bg-black/85 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl w-full max-w-lg mx-4">
                <div class="flex justify-between items-center p-6 border-b border-white/5">
                    <h3 class="text-xl font-bold">Create Club Store</h3>
                    <button onclick="document.getElementById('create-store-modal').classList.add('hide')" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="p-6">
                    <div class="mb-5">
                        <label class="text-gray-400 text-sm mb-2 block font-semibold">Price List</label>
                        <div id="price-list-options" class="space-y-2">
                            <!-- Populated dynamically from brandPricingTiers by openCreateStoreModal() -->
                        </div>
                    </div>

                    <div id="store-preview-info" class="mb-5 p-4 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.06)">
                        <p class="text-xs text-gray-500 mb-2">Store overview</p>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <div><p class="text-gray-500 text-xs">Club</p><p id="cstore-club-name" class="font-semibold">—</p></div>
                            <div><p class="text-gray-500 text-xs">Products with images</p><p id="cstore-product-count" class="font-semibold text-brand-400">—</p></div>
                            <div><p class="text-gray-500 text-xs">Collection image</p><p id="cstore-collection-img" class="font-semibold">—</p></div>
                            <div><p class="text-gray-500 text-xs">Collection name</p><p id="cstore-collection-name" class="font-semibold">—</p></div>
                        </div>
                    </div>

                    <div class="flex gap-3">
                        <button onclick="document.getElementById('create-store-modal').classList.add('hide')" class="flex-1 btn-secondary py-3">Cancel</button>
                        <button onclick="downloadClubStoreCSV()" class="flex-1 btn-primary py-3 flex items-center justify-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
                            Download CSV
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Bulk Add Club Products
             ============================================================ -->
        <div id="bulk-products-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl p-6 w-full max-w-2xl mx-4 my-auto">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold">Bulk Add Products</h3>
                    <button onclick="hideBulkProductsModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <p class="text-gray-500 text-sm mb-4">Select one or more products. Click a row to toggle; click first then Shift+click to select a range.</p>
                <div class="flex gap-3 mb-4">
                    <input type="text" id="bulk-product-search" placeholder="Search products..." class="flex-1 px-3 py-2 rounded-lg text-sm" oninput="filterBulkProductList()">
                    <button onclick="selectAllBulkProducts()" class="btn-secondary text-sm px-4">Select All</button>
                    <button onclick="clearBulkProductSelection()" class="btn-secondary text-sm px-4">Clear</button>
                </div>
                <div id="bulk-product-list" class="space-y-1.5 max-h-80 overflow-y-auto mb-4">
                    <!-- Populated by JS -->
                </div>
                <div class="flex items-center justify-between">
                    <p class="text-sm text-gray-500"><span id="bulk-selected-count">0</span> selected</p>
                    <div class="flex gap-3">
                        <button onclick="hideBulkProductsModal()" class="btn-secondary py-2 px-5">Cancel</button>
                        <button onclick="saveBulkProducts()" class="btn-primary py-2 px-5">Add Selected</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Upload Design Version
             ============================================================ -->
        <div id="upload-version-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-md mx-4">
                <div class="flex justify-between items-center mb-5">
                    <h3 class="text-xl font-bold">Upload Design Version</h3>
                    <button onclick="hideUploadVersionModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <div class="mb-4">
                    <label class="dropzone flex flex-col items-center justify-center p-8 cursor-pointer mb-3" id="version-dropzone" onclick="document.getElementById('version-file-input').click()">
                        <svg class="w-10 h-10 text-gray-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"/></svg>
                        <p class="text-gray-500 text-sm text-center" id="version-file-label">Click to select image (PNG, JPG, PDF)</p>
                    </label>
                    <input type="file" id="version-file-input" accept="image/*,.pdf" class="hide" onchange="previewVersionFile(event)">
                    <div id="version-file-preview" class="hide mb-3 rounded-xl overflow-hidden" style="max-height:200px">
                        <img id="version-file-preview-img" class="w-full object-contain" style="max-height:200px">
                    </div>
                </div>
                <div class="mb-4">
                    <label class="text-gray-400 text-sm mb-1 block">Notes (optional)</label>
                    <textarea id="version-notes" rows="2" placeholder="Any notes about this version..." class="w-full px-3 py-2 rounded-lg text-sm resize-none"></textarea>
                </div>
                <div class="flex gap-3">
                    <button onclick="hideUploadVersionModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="uploadDesignVersion()" class="flex-1 btn-primary py-3" id="upload-version-btn">Upload Version</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Design Annotation
             ============================================================ -->
        <div id="annotation-modal" class="fixed inset-0 bg-black/90 z-50 flex items-center justify-center hide overflow-hidden">
            <div class="glass rounded-2xl w-full mx-4 flex flex-col" style="max-width:1100px;max-height:90vh">
                <!-- Header -->
                <div class="flex items-center justify-between p-5 border-b border-white/5 flex-shrink-0">
                    <div class="flex items-center gap-3">
                        <h3 class="text-lg font-bold">Annotate Design</h3>
                        <span id="ann-version-label" class="stage-pill design-status-in_review text-xs"></span>
                        <span class="text-xs text-gray-500">Click image to place markers</span>
                    </div>
                    <div class="flex items-center gap-3">
                        <button onclick="declineAnnotatedVersion()" class="text-sm px-4 py-2 rounded-lg font-semibold" style="background:rgba(239,68,68,0.12);color:#f87171;border:1px solid rgba(239,68,68,0.3)">Decline</button>
                        <button onclick="approveAnnotatedVersion()" class="text-sm px-4 py-2 rounded-lg font-semibold" style="background:rgba(34,197,94,0.12);color:#4ade80;border:1px solid rgba(34,197,94,0.3)">Approve</button>
                        <button onclick="saveAnnotations()" class="btn-primary text-sm">Save Feedback</button>
                        <button onclick="closeAnnotationModal()" class="text-gray-400 hover:text-white text-2xl ml-1">&times;</button>
                    </div>
                </div>
                <!-- Body -->
                <div class="flex flex-1 overflow-hidden">
                    <!-- Image area -->
                    <div class="flex-1 overflow-auto p-5 flex items-start justify-center" style="background:rgba(0,0,0,0.4)">
                        <div id="ann-img-container">
                            <img id="ann-img" src="" alt="Design version" style="max-width:100%;display:block;border-radius:10px;user-select:none">
                            <div id="ann-overlay" onclick="placeAnnotationMarker(event)"></div>
                            <!-- Markers placed here by JS -->
                        </div>
                    </div>
                    <!-- Comments panel -->
                    <div class="w-80 flex-shrink-0 flex flex-col border-l border-white/5">
                        <div class="p-4 border-b border-white/5">
                            <p class="text-xs text-gray-500 uppercase tracking-wider font-semibold">Annotations</p>
                        </div>
                        <div id="ann-comments-list" class="flex-1 overflow-y-auto p-4 space-y-3">
                            <!-- Populated by JS -->
                        </div>
                        <div class="p-4 border-t border-white/5">
                            <button onclick="clearAllAnnotations()" class="text-xs text-gray-500 hover:text-red-400 transition">Clear all markers</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Add/Edit Club Product
             ============================================================ -->
        <div id="club-product-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide overflow-y-auto py-8">
            <div class="glass rounded-2xl p-6 w-full max-w-2xl mx-4 my-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="club-product-modal-title" class="text-xl font-bold">Add Club Product</h3>
                    <button onclick="hideClubProductModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>
                <input type="hidden" id="edit-club-product-id">

                <!-- Select master product -->
                <div class="mb-4">
                    <label class="text-gray-400 text-sm mb-1 block">Master Product *</label>
                    <select id="cp-master-product" class="w-full px-3 py-2 rounded-lg" onchange="onMasterProductChange()">
                        <option value="">Select from master catalogue...</option>
                    </select>
                </div>

                <!-- Custom name -->
                <div class="mb-4">
                    <label class="text-gray-400 text-sm mb-1 block">Club Product Name *</label>
                    <input type="text" id="cp-custom-name" placeholder="e.g. U11s Match Jersey – TLC Driving Sponsor" class="w-full px-3 py-2 rounded-lg">
                    <p class="text-gray-600 text-xs mt-1">Give it a specific name for this club (e.g. include sponsor or team name)</p>
                </div>

                <!-- Pricing info (read-only — from master product × club tier) -->
                <div id="cp-pricing-info" class="bg-gray-800/50 rounded-xl p-4 mb-4 hide">
                    <h4 class="font-semibold text-sm mb-3 text-brand-400">Pricing <span class="text-gray-500 font-normal text-xs ml-1">(from master product)</span></h4>
                    <div id="cp-pricing-rows" class="space-y-2"></div>
                </div>

                <!-- Sizes from master product -->
                <div id="cp-sizes-info" class="bg-gray-900/50 rounded-xl p-4 mb-4 hide">
                    <p class="text-xs text-gray-500 mb-3 font-medium">Sizes (from master product)</p>
                    <div class="space-y-2" id="cp-sizes-display"></div>
                </div>

                <div class="flex gap-3">
                    <button onclick="hideClubProductModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="saveClubProduct()" class="flex-1 btn-primary py-3">Save Product</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: Create Order Form
             ============================================================ -->
        <div id="order-form-modal" class="fixed inset-0 bg-black/80 z-50 flex items-center justify-center hide">
            <div class="glass rounded-2xl p-6 w-full max-w-lg mx-4">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Create Order Form</h3>
                    <button onclick="hideOrderFormModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <div class="mb-4">
                    <label class="text-gray-400 text-sm mb-1 block">Form Title *</label>
                    <input type="text" id="of-title" placeholder="e.g. 2024/25 Season Kit Order" class="w-full px-3 py-2 rounded-lg">
                </div>
                <div class="mb-4">
                    <label class="text-gray-400 text-sm mb-1 block">Season</label>
                    <input type="text" id="of-season" placeholder="e.g. 2024/25" class="w-full px-3 py-2 rounded-lg">
                </div>
                <div class="mb-6">
                    <label class="text-gray-400 text-sm mb-1 block">Description / Instructions</label>
                    <textarea id="of-description" rows="3" placeholder="Any notes or instructions for the club contact..." class="w-full px-3 py-2 rounded-lg"></textarea>
                </div>
                <div class="bg-brand-500/10 rounded-lg p-3 mb-6">
                    <p class="text-brand-400 text-xs">A unique shareable link will be generated. The club contact opens this link to fill in their order — no login required.</p>
                </div>

                <div class="flex gap-3">
                    <button onclick="hideOrderFormModal()" class="flex-1 btn-secondary py-3">Cancel</button>
                    <button onclick="createOrderForm()" class="flex-1 btn-primary py-3">Create Form</button>
                </div>
            </div>
        </div>

        <!-- ============================================================
             MODAL: View Submission (with draft order creation)
             ============================================================ -->
        <div id="submission-modal" class="fixed inset-0 bg-black/80 z-50 flex items-start justify-center overflow-y-auto py-8 hide">
            <div class="glass rounded-2xl p-6 w-full max-w-3xl mx-4 my-auto hide" id="submission-modal-inner">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-xl font-bold">Order Submission</h3>
                    <button onclick="hideSubmissionModal()" class="text-gray-400 hover:text-white text-2xl">&times;</button>
                </div>

                <!-- Contact info -->
                <div class="grid md:grid-cols-2 gap-4 mb-6">
                    <div class="card">
                        <h4 class="font-semibold text-brand-400 mb-3 text-sm">Contact Details</h4>
                        <div id="sub-contact-info" class="space-y-2"></div>
                    </div>
                    <div class="card">
                        <h4 class="font-semibold text-brand-400 mb-3 text-sm">Order Info</h4>
                        <div id="sub-order-info" class="space-y-2"></div>
                    </div>
                </div>

                <!-- Line items -->
                <div class="card mb-6">
                    <h4 class="font-semibold text-brand-400 mb-3 text-sm">Items (<span id="sub-items-count">0</span>)</h4>
                    <div class="overflow-x-auto">
                        <table class="w-full items-table">
                            <thead>
                                <tr class="text-left">
                                    <th>Product</th>
                                    <th>Size</th>
                                    <th>Qty</th>
                                    <th>Player Name</th>
                                    <th>No.</th>
                                    <th>Notes</th>
                                </tr>
                            </thead>
                            <tbody id="sub-items-table"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Draft order section -->
                <div class="card border border-brand-500/20">
                    <div class="flex items-start justify-between">
                        <div>
                            <h4 class="font-semibold mb-1">Shopify Draft Order</h4>
                            <p id="sub-draft-status" class="text-gray-500 text-sm"></p>
                        </div>
                        <button id="sub-create-draft-btn" onclick="createDraftOrderFromSubmission()" class="btn-primary text-sm">
                            Create Draft Order
                        </button>
                    </div>
                    <div id="sub-draft-link" class="mt-3 hide">
                        <a id="sub-draft-url" href="#" target="_blank" class="text-brand-400 text-sm hover:underline">Open Draft Order in Shopify →</a>
                    </div>
                </div>

                <div class="mt-4 flex justify-end">
                    <button onclick="hideSubmissionModal()" class="btn-secondary">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================================
         PUBLIC ORDER FORM VIEW (shown when ?form=TOKEN in URL)
         ============================================================ -->
    <div id="public-form-view" class="hide">
        <div class="public-form-header">
            <div class="max-w-3xl mx-auto flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <span id="pf-brand-logo" class="text-brand-400 font-bold text-xl">TeamwearOS</span>
                    <span class="text-gray-600">|</span>
                    <span id="pf-club-name" class="text-white font-semibold"></span>
                </div>
                <span class="text-gray-500 text-sm">Order Form</span>
            </div>
        </div>

        <div class="max-w-3xl mx-auto p-6">
            <!-- Loading state -->
            <div id="pf-loading" class="text-center py-16">
                <div class="spinner mx-auto mb-4"></div>
                <p class="text-gray-500">Loading order form...</p>
            </div>

            <!-- Error state -->
            <div id="pf-error" class="hide text-center py-16">
                <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/10 flex items-center justify-center text-3xl">❌</div>
                <h2 class="text-xl font-bold mb-2">Form Not Found</h2>
                <p class="text-gray-500">This order form is no longer active or the link is invalid.</p>
            </div>

            <!-- Success state (after submit) -->
            <div id="pf-success" class="hide text-center py-16">
                <div class="w-20 h-20 mx-auto mb-6 rounded-full bg-green-500/10 flex items-center justify-center text-4xl">✅</div>
                <h2 class="text-2xl font-bold mb-3">Order Submitted!</h2>
                <p class="text-gray-400 max-w-sm mx-auto">Thank you. Your order has been received and our team will be in touch shortly.</p>
            </div>

            <!-- Form content -->
            <div id="pf-content" class="hide">
                <!-- Form header -->
                <div class="card mb-6">
                    <h1 id="pf-form-title" class="text-2xl font-bold mb-1"></h1>
                    <p id="pf-form-season" class="text-brand-400 text-sm mb-3"></p>
                    <p id="pf-form-description" class="text-gray-400 text-sm"></p>
                </div>

                <!-- Contact details -->
                <div class="card mb-6">
                    <h3 class="font-semibold mb-4">Contact Details</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">Your Name *</label>
                            <input type="text" id="pf-contact-name" placeholder="Full name" class="w-full px-3 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">Email *</label>
                            <input type="email" id="pf-contact-email" placeholder="your@email.com" class="w-full px-3 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">Phone</label>
                            <input type="tel" id="pf-contact-phone" placeholder="+44 7700 000000" class="w-full px-3 py-2 rounded-lg">
                        </div>
                        <div>
                            <label class="text-gray-400 text-sm mb-1 block">Team Name / Age Group</label>
                            <input type="text" id="pf-team-name" placeholder="e.g. U11s Boys" class="w-full px-3 py-2 rounded-lg">
                        </div>
                    </div>
                    <div class="mt-4">
                        <label class="text-gray-400 text-sm mb-1 block">Notes / Special Requests</label>
                        <textarea id="pf-notes" rows="2" placeholder="Any special requests or additional information..." class="w-full px-3 py-2 rounded-lg"></textarea>
                    </div>
                </div>

                <!-- Order items -->
                <div class="card mb-6">
                    <div class="section-header mb-4">
                        <h3 class="font-semibold">Items</h3>
                        <button onclick="addPublicFormRow()" class="btn-primary text-sm flex items-center gap-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                            Add Row
                        </button>
                    </div>

                    <!-- Column headers -->
                    <div class="player-row mb-2 px-2">
                        <span class="text-gray-500 text-xs font-medium">Product *</span>
                        <span class="text-gray-500 text-xs font-medium">Size *</span>
                        <span class="text-gray-500 text-xs font-medium">Qty *</span>
                        <span class="text-gray-500 text-xs font-medium">Player Name</span>
                        <span class="text-gray-500 text-xs font-medium">No.</span>
                        <span></span>
                    </div>

                    <div id="pf-items-container" class="space-y-2">
                        <!-- Populated by JS -->
                    </div>
                </div>

                <!-- Submit -->
                <button onclick="submitPublicOrderForm()" class="w-full btn-primary py-4 text-lg">
                    Submit Order
                </button>
                <p class="text-gray-600 text-xs text-center mt-3">By submitting this form you agree to our standard terms and conditions.</p>
            </div>
        </div>
    </div>

    <script>
        // =============================================
        // SUPABASE CONFIG
        // =============================================
        const SUPABASE_URL = 'https://odfpmwgwnyexuxqbusvi.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9kZnBtd2d3bnlleHV4cWJ1c3ZpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAzNzk5ODcsImV4cCI6MjA4NTk1NTk4N30.HWndMOL2InGTbE_Mb96qtcjgcyQPOhV8VnuX6AP_8eM';
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // =============================================
        // APP STATE
        // =============================================
        let currentUser = null;
        let currentBrand = null;
        let currentUserProfile = null;
        let _appInitialising = false; // guard against double-init from handleLogin + onAuthStateChange
        let viewScope = localStorage.getItem('teamwear_view_scope') || 'all'; // 'all' | 'mine'
        let allBrands = [];
        let isSuperAdmin = false;
        let products = [];
        let clubs = [];
        let salespeople = [];
        let brandPricingTiers = [];   // brand_pricing_tiers rows for current brand
        let brandShopifyTags = [];    // brand_shopify_tags rows for current brand
        let currentProductTags = [];  // tags currently applied to product being edited
        let catalogueCustomCategories = [];   // persisted in localStorage per brand
        let catalogueCustomRanges = [];       // persisted in localStorage per brand
        let catalogueCustomFitTypes = [];     // persisted in localStorage per brand
        let catalogueActivePriceKeys = [];    // which tier keys to show in the catalogue table (array)
        let clubImages = [];
        let orderLines = [];
        let poSequence = 1;

        // Prospecting state
        let leads = [];
        let kanbanStages = [];
        let featureToggles = {};
        let currentLeadId = null;
        let currentLeadContacts = [];
        let editingLeadContacts = [];
        let dragLeadId = null;

        // =============================================
        // TOAST NOTIFICATIONS
        // =============================================
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const inner = toast.querySelector('div');
            inner.textContent = message;
            inner.className = `glass rounded-lg px-4 py-3 text-sm ${type === 'error' ? 'border-red-500 text-red-400' : 'border-brand-500 text-brand-400'}`;
            toast.classList.remove('hide');
            setTimeout(() => toast.classList.add('hide'), 3000);
        }

        // =============================================
        // AUTH FUNCTIONS
        // =============================================
        function showSignup() {
            document.getElementById('login-form').classList.add('hide');
            document.getElementById('signup-form').classList.remove('hide');
        }

        function showLogin() {
            document.getElementById('signup-form').classList.add('hide');
            document.getElementById('login-form').classList.remove('hide');
        }

        async function handleLogin() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showToast('Please enter email and password', 'error');
                return;
            }

            try {
                const { data, error } = await supabase.auth.signInWithPassword({ email, password });

                if (error) {
                    showToast(error.message, 'error');
                    return;
                }

                // Always reset the guard before a manual login attempt so that
                // a failed page-load auto-login can never block the user
                _appInitialising = false;
                await initApp(data.user);
            } catch (err) {
                console.error('Login error:', err);
                showToast('Login error: ' + (err?.message || 'Please try again'), 'error');
                // Ensure auth screen stays visible if app failed to load
                document.getElementById('auth-screen').classList.remove('hide');
                document.getElementById('main-app').classList.add('hide');
                _appInitialising = false;
            }
        }

        async function handleSignup() {
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const confirm = document.getElementById('signup-confirm').value;

            if (!email || !password) {
                showToast('Please fill in all fields', 'error');
                return;
            }

            if (password !== confirm) {
                showToast('Passwords do not match', 'error');
                return;
            }

            const { data, error } = await supabase.auth.signUp({ email, password });

            if (error) {
                showToast(error.message, 'error');
                return;
            }

            showToast('Account created! Please sign in.');
            showLogin();
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            currentBrand = null;
            isSuperAdmin = false;
            allBrands = [];
            _appInitialising = false;
            document.getElementById('main-app').classList.add('hide');
            document.getElementById('auth-screen').classList.remove('hide');
        }

        // =============================================
        // APP INITIALIZATION
        // =============================================
        async function initApp(user) {
            // Prevent double-initialization (onAuthStateChange + handleLogin both call this)
            if (_appInitialising) return;
            _appInitialising = true;

            currentUser = user;
            document.getElementById('user-email').textContent = user.email;

            // Get user profile
            let { data: profile } = await supabase
                .from('user_profiles')
                .select('*, brands(*)')
                .eq('id', user.id)
                .single();

            // Auto-create profile if missing (e.g. user registered before the trigger was added)
            if (!profile) {
                await supabase.from('user_profiles').insert({ id: user.id, email: user.email, role: 'user' });
                const { data: newProfile } = await supabase
                    .from('user_profiles')
                    .select('*, brands(*)')
                    .eq('id', user.id)
                    .single();
                profile = newProfile;
            }

            currentUserProfile = profile;
            isSuperAdmin = profile?.role === 'super_admin';

            // Show super admin badge if applicable
            if (isSuperAdmin) {
                document.getElementById('user-role').classList.remove('hide');
                document.getElementById('brand-selector').classList.remove('hide');
                
                // Load all brands for super admin
                const { data: brands } = await supabase
                    .from('brands')
                    .select('*')
                    .order('name');
                allBrands = brands || [];
                
                // Populate brand selector
                const brandSelect = document.getElementById('brand-select');
                brandSelect.innerHTML = allBrands.map(b => 
                    `<option value="${b.id}">${b.name}</option>`
                ).join('');
                
                // Set current brand (from profile or first brand)
                if (profile?.brands) {
                    currentBrand = profile.brands;
                } else if (allBrands.length) {
                    currentBrand = allBrands[0];
                }
                
                if (currentBrand) {
                    brandSelect.value = currentBrand.id;
                }
            } else {
                // Regular user - use their assigned brand
                if (profile?.brands) {
                    currentBrand = profile.brands;
                }
            }

            if (currentBrand) {
                document.getElementById('brand-badge').textContent = currentBrand.name;
            } else {
                document.getElementById('brand-badge').textContent = 'No Brand';
            }

            // Show main app
            document.getElementById('auth-screen').classList.add('hide');
            document.getElementById('main-app').classList.remove('hide');

            // Load data
            await loadAllData();
            // Apply any feature access restrictions for this user
            await applyUserFeaturePermissions();
            showLaunchpad();
            _appInitialising = false;
        }

        // =============================================
        // BRAND MANAGEMENT (Super Admin)
        // =============================================
        async function switchBrand(brandId) {
            const brand = allBrands.find(b => b.id === brandId);
            if (!brand) return;
            
            currentBrand = brand;
            document.getElementById('brand-badge').textContent = brand.name;
            
            // Reload all data for new brand
            await loadAllData();
            await applyUserFeaturePermissions();
            showLaunchpad();
            showToast(`Switched to ${brand.name}`);
        }

        function showCreateBrand() {
            document.getElementById('create-brand-modal').classList.remove('hide');
            document.getElementById('new-brand-name').value = '';
            document.getElementById('new-brand-slug').value = '';
        }

        function hideCreateBrand() {
            document.getElementById('create-brand-modal').classList.add('hide');
        }

        async function createBrand() {
            const name = document.getElementById('new-brand-name').value.trim();
            let slug = document.getElementById('new-brand-slug').value.trim();
            
            if (!name) {
                showToast('Please enter a brand name', 'error');
                return;
            }
            
            // Auto-generate slug if not provided
            if (!slug) {
                slug = name.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            }
            
            const { data, error } = await supabase
                .from('brands')
                .insert({ name, slug })
                .select()
                .single();
            
            if (error) {
                showToast(error.message, 'error');
                return;
            }
            
            // Add to brands list and select it
            allBrands.push(data);
            const brandSelect = document.getElementById('brand-select');
            brandSelect.innerHTML = allBrands.map(b => 
                `<option value="${b.id}">${b.name}</option>`
            ).join('');
            brandSelect.value = data.id;
            
            hideCreateBrand();
            await switchBrand(data.id);
            showToast(`Brand "${name}" created!`);
        }

        async function loadAllData() {
            if (!currentBrand) return;

            // Load products
            const { data: prods } = await supabase
                .from('products')
                .select('*')
                .eq('brand_id', currentBrand.id)
                .order('product_code');
            products = prods || [];

            // Load clubs
            const { data: clbs } = await supabase
                .from('clubs')
                .select('*')
                .eq('brand_id', currentBrand.id)
                .order('name');
            clubs = clbs || [];

            // Load salespeople
            const { data: sales } = await supabase
                .from('salespeople')
                .select('*')
                .eq('brand_id', currentBrand.id)
                .eq('is_active', true);
            salespeople = sales || [];

            // Load brand pricing tiers
            const { data: tiers } = await supabase
                .from('brand_pricing_tiers')
                .select('*')
                .eq('brand_id', currentBrand.id)
                .eq('is_active', true)
                .order('sort_order');
            brandPricingTiers = tiers || [];
            // If no tiers yet, seed defaults in memory
            if (brandPricingTiers.length === 0) {
                brandPricingTiers = [
                    { id: 'retail', brand_id: currentBrand.id, tier_key: 'retail', tier_name: 'Retail', sort_order: 0, is_active: true },
                    { id: 'partner', brand_id: currentBrand.id, tier_key: 'partner', tier_name: 'Partner', sort_order: 1, is_active: true }
                ];
            }

            // Load brand shopify tags
            const { data: stags } = await supabase
                .from('brand_shopify_tags')
                .select('*')
                .eq('brand_id', currentBrand.id)
                .order('tag');
            brandShopifyTags = stags || [];

            // Load catalogue settings from localStorage
            loadCatalogueSettings();
            if (!catalogueActivePriceKeys.length && brandPricingTiers.length) {
                catalogueActivePriceKeys = [brandPricingTiers[0].tier_key];
            }

            // Load PO count for sequence
            const { count } = await supabase
                .from('purchase_orders')
                .select('*', { count: 'exact', head: true })
                .eq('brand_id', currentBrand.id);
            poSequence = (count || 0) + 1;

            // Load feature toggles
            await loadFeatureToggles();

            // Load leads
            await loadLeads();

            // Load kanban stages
            await loadKanbanStages();

            // Load jobs
            await loadJobs();

            // Load user feature permissions (used to restrict UI access per user)
            await loadUserFeaturePermissions();

            // Load design task counts for launchpad badges
            const { data: dtData } = await supabase
                .from('design_tasks')
                .select('status, jobs!inner(brand_id)')
                .eq('jobs.brand_id', currentBrand.id);
            const activeDT = (dtData || []).filter(dt => dt.status === 'in_progress').length;
            const reviewDT = (dtData || []).filter(dt => dt.status === 'in_review').length;
            const el_da = document.getElementById('stat-design-active');
            const el_dr = document.getElementById('stat-design-review');
            if (el_da) el_da.textContent = `${activeDT} active`;
            if (el_dr) el_dr.textContent = `${reviewDT} in review`;

            updateStats();
        }

        function updateStats() {
            document.getElementById('stat-products').textContent = products.length;
            document.getElementById('stat-clubs').textContent = clubs.length;

            // Leads count (replaces salespeople in new stat bar)
            const totalLeads = leads.filter(l => l.status !== 'archived').length;
            document.getElementById('stat-salespeople').textContent = totalLeads;

            // Launchpad feature card stats
            const ncLeads = leads.filter(l => l.status === 'not_contacted').length;
            const idLeads = leads.filter(l => l.status === 'in_discussion').length;
            const el_nc = document.getElementById('stat-leads-nc');
            const el_id = document.getElementById('stat-leads-id');
            const el_clubs_lp = document.getElementById('stat-clubs-lp');
            const el_prods_lp = document.getElementById('stat-products-lp');
            if (el_nc) el_nc.textContent = `${ncLeads} new lead${ncLeads !== 1 ? 's' : ''}`;
            if (el_id) el_id.textContent = `${idLeads} in discussion`;
            if (el_clubs_lp) el_clubs_lp.textContent = `${clubs.length} club${clubs.length !== 1 ? 's' : ''}`;
            if (el_prods_lp) el_prods_lp.textContent = `${products.length} product${products.length !== 1 ? 's' : ''}`;
            const el_prods_db = document.getElementById('stat-products-db');
            if (el_prods_db) el_prods_db.textContent = `${products.length} product${products.length !== 1 ? 's' : ''}`;

            // Prospecting home badges
            const ncBadge = document.getElementById('nc-count-badge');
            const idBadge = document.getElementById('id-count-badge');
            if (ncBadge) ncBadge.textContent = ncLeads;
            if (idBadge) idBadge.textContent = idLeads;

            // Sales stats
            updateSalesBadges();

            supabase
                .from('purchase_orders')
                .select('*', { count: 'exact', head: true })
                .eq('brand_id', currentBrand?.id)
                .then(({ count }) => {
                    const posCount = count || 0;
                    document.getElementById('stat-orders').textContent = posCount;
                    const el_pos = document.getElementById('stat-pos-lp');
                    if (el_pos) el_pos.textContent = `${posCount} active PO${posCount !== 1 ? 's' : ''}`;
                });
        }

        // =============================================
        // NAVIGATION
        // =============================================
        function showLaunchpad() {
            document.querySelectorAll('[id^="tool-"]').forEach(el => el.classList.add('hide'));
            document.getElementById('launchpad').classList.remove('hide');

            // Show admin section only for super admins
            if (isSuperAdmin) {
                document.getElementById('admin-section').classList.remove('hide');
            } else {
                document.getElementById('admin-section').classList.add('hide');
            }

            // Update launchpad brand display
            const brandDisplay = document.getElementById('launchpad-brand-display');
            const brandNameEl = document.getElementById('launchpad-brand-name');
            const noBrandNotice = document.getElementById('no-brand-notice');
            if (currentBrand) {
                if (brandDisplay) brandDisplay.classList.remove('hide');
                if (brandNameEl) brandNameEl.textContent = currentBrand.name;
                if (noBrandNotice) noBrandNotice.classList.add('hide');
            } else {
                if (noBrandNotice) noBrandNotice.classList.remove('hide');
            }

            // Apply feature toggles to cards
            applyFeatureToggles();
        }

        function applyFeatureToggles() {
            const featureMap = {
                'prospecting':    { card: 'fc-prospecting', badge: 'badge-prospecting', onclick: "showTool('prospecting')" },
                'sales':          { card: 'fc-sales',       badge: 'badge-sales',       onclick: "showTool('sales')" },
                'clubs':          { card: 'fc-clubs',       badge: 'badge-clubs',       onclick: "showTool('clubs')" },
                'production':     { card: 'fc-production',  badge: 'badge-production',  onclick: "showTool('po-tracker')" },
                'design_studio':  { card: 'fc-design',      badge: 'badge-design',      onclick: "showTool('design-studio')" },
                'store_generator':{ card: 'fc-store',       badge: 'badge-store',       onclick: "showTool('generator')" },
                'products':       { card: 'fc-products',    badge: 'badge-products',    onclick: "showTool('products')" }
            };
            Object.entries(featureMap).forEach(([feature, cfg]) => {
                const card = document.getElementById(cfg.card);
                const badgeEl = document.getElementById(cfg.badge);
                if (!card) return;
                const enabled = featureToggles[feature] !== false;
                if (enabled) {
                    card.classList.remove('disabled-card');
                    if (badgeEl) badgeEl.style.display = 'none';
                    card.setAttribute('onclick', cfg.onclick);
                } else {
                    card.classList.add('disabled-card');
                    if (badgeEl) { badgeEl.style.display = ''; badgeEl.textContent = 'Off'; badgeEl.className = 'card-badge badge-off'; }
                    card.removeAttribute('onclick');
                }
            });
        }

        function showTool(tool) {
            // Check if admin tools and user is not super admin
            if ((tool === 'settings' || tool === 'users') && !isSuperAdmin) {
                showToast('Access denied. Super admin only.', 'error');
                return;
            }

            document.getElementById('launchpad').classList.add('hide');
            document.querySelectorAll('[id^="tool-"]').forEach(el => el.classList.add('hide'));
            const toolEl = document.getElementById(`tool-${tool}`);
            if (toolEl) toolEl.classList.remove('hide');

            // Initialize tool
            switch(tool) {
                case 'products':
                    renderProductsTable();
                    break;
                case 'clubs':
                    renderClubsEnhanced();
                    break;
                case 'design-studio':
                    loadDesignStudio();
                    break;
                case 'mockups':
                    populateClubSelect();
                    break;
                case 'order-forms':
                    loadAllSubmissions();
                    break;
                case 'generator':
                    populateGeneratorSelects();
                    break;
                case 'orders':
                    populateOrderSelects();
                    initOrderForm();
                    break;
                case 'settings':
                    loadBrandSettings();
                    break;
                case 'users':
                    loadAllUsers();
                    break;
                case 'po-tracker':
                    loadPoTracker();
                    break;
                case 'prospecting':
                    showProspectView('home');
                    break;
                case 'sales':
                    showSalesView('home');
                    break;
            }
        }

        // =============================================
        // ADMIN: BRAND SETTINGS
        // =============================================
        function loadBrandSettings() {
            if (!currentBrand) return;

            document.getElementById('settings-brand-name').textContent = currentBrand.name;
            document.getElementById('edit-brand-name').value = currentBrand.name;
            document.getElementById('edit-brand-slug').value = currentBrand.slug;

            renderSalespeopleList();
            loadShopifyConfigUI();
            renderFeatureToggles();
        }

        function renderSalespeopleList() {
            const container = document.getElementById('salespeople-list');
            
            if (salespeople.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No salespeople added yet</p>';
                return;
            }
            
            container.innerHTML = salespeople.map(sp => `
                <div class="flex items-center justify-between bg-gray-800 rounded-lg px-4 py-3">
                    <div>
                        <span class="font-medium">${sp.first_name} ${sp.last_name}</span>
                        ${sp.email ? `<span class="text-gray-400 text-sm ml-2">${sp.email}</span>` : ''}
                    </div>
                    <button onclick="removeSalesperson('${sp.id}')" class="text-red-400 hover:text-red-300 text-sm">Remove</button>
                </div>
            `).join('');
        }

        async function addSalesperson() {
            const firstName = document.getElementById('new-sp-first').value.trim();
            const lastName = document.getElementById('new-sp-last').value.trim();
            const email = document.getElementById('new-sp-email').value.trim();
            
            if (!firstName || !lastName) {
                showToast('Please enter first and last name', 'error');
                return;
            }
            
            const { data, error } = await supabase
                .from('salespeople')
                .insert({
                    brand_id: currentBrand.id,
                    first_name: firstName,
                    last_name: lastName,
                    email: email || null
                })
                .select()
                .single();
            
            if (error) {
                showToast(error.message, 'error');
                return;
            }
            
            salespeople.push(data);
            document.getElementById('new-sp-first').value = '';
            document.getElementById('new-sp-last').value = '';
            document.getElementById('new-sp-email').value = '';
            
            renderSalespeopleList();
            updateStats();
            showToast(`Added ${firstName} ${lastName}`);
        }

        async function removeSalesperson(id) {
            if (!confirm('Remove this salesperson?')) return;
            
            const { error } = await supabase
                .from('salespeople')
                .update({ is_active: false })
                .eq('id', id);
            
            if (error) {
                showToast(error.message, 'error');
                return;
            }
            
            salespeople = salespeople.filter(sp => sp.id !== id);
            renderSalespeopleList();
            updateStats();
            showToast('Salesperson removed');
        }

        async function updateBrandInfo() {
            const name = document.getElementById('edit-brand-name').value.trim();
            
            if (!name) {
                showToast('Brand name is required', 'error');
                return;
            }
            
            const { error } = await supabase
                .from('brands')
                .update({ name })
                .eq('id', currentBrand.id);
            
            if (error) {
                showToast(error.message, 'error');
                return;
            }
            
            currentBrand.name = name;
            document.getElementById('brand-badge').textContent = name;
            document.getElementById('settings-brand-name').textContent = name;
            
            // Update brand selector
            const brandSelect = document.getElementById('brand-select');
            const option = brandSelect.querySelector(`option[value="${currentBrand.id}"]`);
            if (option) option.textContent = name;
            
            showToast('Brand updated');
        }

        async function confirmDeleteBrand() {
            if (allBrands.length <= 1) {
                showToast('Cannot delete the only brand', 'error');
                return;
            }
            
            const confirmName = prompt(`Type "${currentBrand.name}" to confirm deletion:`);
            if (confirmName !== currentBrand.name) {
                showToast('Deletion cancelled', 'error');
                return;
            }
            
            const { error } = await supabase
                .from('brands')
                .delete()
                .eq('id', currentBrand.id);
            
            if (error) {
                showToast(error.message, 'error');
                return;
            }
            
            allBrands = allBrands.filter(b => b.id !== currentBrand.id);
            
            // Switch to another brand
            if (allBrands.length > 0) {
                await switchBrand(allBrands[0].id);
            }
            
            // Update brand selector
            const brandSelect = document.getElementById('brand-select');
            brandSelect.innerHTML = allBrands.map(b => 
                `<option value="${b.id}">${b.name}</option>`
            ).join('');
            
            showToast('Brand deleted');
            showLaunchpad();
        }

        // =============================================
        // ADMIN: USER MANAGEMENT
        // =============================================
        async function loadAllUsers() {
            let query = supabase.from('user_profiles').select('*, brands(name)').order('email');

            // Apply brand filter
            const brandFilter = document.getElementById('user-filter-brand')?.value || '';
            if (brandFilter) query = query.eq('brand_id', brandFilter);

            const { data: users } = await query;
            await loadUserFeaturePermissions();

            // Populate brand filter dropdown if not yet done
            const filterEl = document.getElementById('user-filter-brand');
            if (filterEl && filterEl.options.length <= 1) {
                filterEl.innerHTML = '<option value="">All Brands</option>' +
                    allBrands.map(b => `<option value="${b.id}" ${b.id === brandFilter ? 'selected' : ''}>${escHtml(b.name)}</option>`).join('');
            }

            // Also populate new-user-brand select
            const newUserBrandEl = document.getElementById('new-user-brand');
            if (newUserBrandEl) {
                newUserBrandEl.innerHTML = '<option value="">No brand assigned</option>' +
                    allBrands.map(b => `<option value="${b.id}">${escHtml(b.name)}</option>`).join('');
            }

            renderUsersList(users || []);
        }

        function renderUsersList(users) {
            const container = document.getElementById('users-list');
            if (!users.length) {
                container.innerHTML = '<p class="text-gray-500 py-4 text-center">No users found</p>';
                return;
            }
            const searchQuery = document.getElementById('user-search')?.value?.toLowerCase() || '';
            const filtered = searchQuery ? users.filter(u => u.email?.toLowerCase().includes(searchQuery)) : users;

            container.innerHTML = filtered.map(user => {
                const perms = userFeaturePermissions[user.id] || {};
                const featureChecks = FEATURES.map(f => {
                    const enabled = perms[f.key] !== false;
                    return `<label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="saveUserFeaturePermission('${user.id}','${f.key}',this.checked)" class="rounded" ${user.role === 'super_admin' ? 'disabled' : ''}>
                        <span class="text-xs">${f.label}</span>
                    </label>`;
                }).join('');
                const brandName = user.brands?.name || '—';
                return `
                <div class="glass rounded-xl p-4">
                    <div class="flex items-center justify-between mb-3 flex-wrap gap-3">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full bg-gray-800 flex items-center justify-center text-xs font-bold text-brand-400">${(user.email||'?')[0].toUpperCase()}</div>
                            <div>
                                <span class="font-medium text-sm">${escHtml(user.email)}</span>
                                ${user.role === 'super_admin' ? '<span class="text-purple-400 text-xs ml-2 px-2 py-0.5 rounded" style="background:rgba(167,139,250,0.1)">SUPER ADMIN</span>' : ''}
                                <p class="text-gray-600 text-xs mt-0.5">${escHtml(brandName)}</p>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <select onchange="assignUserToBrand('${user.id}', this.value)" class="bg-gray-700 border border-gray-600 px-3 py-1 rounded text-sm" ${user.role === 'super_admin' ? 'disabled' : ''}>
                                <option value="">No brand</option>
                                ${allBrands.map(b => `<option value="${b.id}" ${user.brand_id === b.id ? 'selected' : ''}>${escHtml(b.name)}</option>`).join('')}
                            </select>
                            <select onchange="updateUserRole('${user.id}', this.value)" class="bg-gray-700 border border-gray-600 px-3 py-1 rounded text-sm" ${user.role === 'super_admin' ? 'disabled' : ''}>
                                <option value="user" ${user.role === 'user' ? 'selected' : ''}>User</option>
                                <option value="admin" ${user.role === 'admin' ? 'selected' : ''}>Admin</option>
                                <option value="super_admin" ${user.role === 'super_admin' ? 'selected' : ''}>Super Admin</option>
                            </select>
                        </div>
                    </div>
                    ${user.role !== 'super_admin' ? `<div>
                        <p class="text-xs text-gray-500 mb-2 font-semibold uppercase tracking-wider">Feature Access</p>
                        <div class="flex flex-wrap gap-x-5 gap-y-2">${featureChecks}</div>
                    </div>` : '<p class="text-xs text-gray-600">Super admin — full access to all features</p>'}
                </div>`;
            }).join('');
        }

        function filterUsersList() {
            // Re-render from existing DOM without re-fetching
            loadAllUsers();
        }

        function showAddUserModal() {
            document.getElementById('new-user-email').value = '';
            document.getElementById('new-user-role').value = 'user';
            // Populate brand select
            const sel = document.getElementById('new-user-brand');
            if (sel) sel.innerHTML = '<option value="">No brand assigned</option>' +
                allBrands.map(b => `<option value="${b.id}">${escHtml(b.name)}</option>`).join('');
            document.getElementById('add-user-modal').classList.remove('hide');
        }

        function hideAddUserModal() {
            document.getElementById('add-user-modal').classList.add('hide');
        }

        async function inviteNewUser() {
            const email = document.getElementById('new-user-email').value.trim();
            const brandId = document.getElementById('new-user-brand').value || null;
            const role = document.getElementById('new-user-role').value;
            if (!email) { showToast('Email is required', 'error'); return; }

            // Invite via Supabase Auth Admin (requires service role key in production)
            // For now we insert a user profile record and rely on manual auth setup
            // In production, use supabase.auth.admin.inviteUserByEmail()
            showToast('User invitation requires Supabase Admin API. Contact your administrator to invite users via the Supabase dashboard, then assign them here.', 'error');
            hideAddUserModal();
        }

        async function assignUserToBrand(userId, brandId) {
            const { error } = await supabase.from('user_profiles').update({ brand_id: brandId || null }).eq('id', userId);
            if (error) { showToast(error.message, 'error'); return; }
            showToast('Brand assigned');
        }

        async function updateUserRole(userId, role) {
            const { error } = await supabase.from('user_profiles').update({ role }).eq('id', userId);
            if (error) { showToast(error.message, 'error'); return; }
            showToast('Role updated');
        }

        // =============================================
        // PRODUCT DATABASE
        // =============================================
        async function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showToast('Parsing CSV...');

            Papa.parse(file, {
                complete: async function(results) {
                    const rows = results.data;
                    let imported = 0;
                    let currentRange = '';
                    let currentCategory = '';

                    // Determine if it's cut & sew based on range
                    const cutAndSewRanges = ['ATLAS', 'CENTURION', 'ELITE', 'SPARTAN', 'VANGUARD', 'WARRIOR', 'ACADEMY', 'ESSENTIALS'];

                    for (const row of rows) {
                        // Check for range header
                        if (row[0] && !row[0].includes('/') && row[0].toUpperCase() === row[0] && row[0].length > 2) {
                            const possibleRange = row[0].trim().toUpperCase();
                            if (cutAndSewRanges.includes(possibleRange)) {
                                currentRange = row[0].trim();
                                currentCategory = 'Cut & Sew Teamwear';
                            } else if (possibleRange.includes('SUBLIMATED')) {
                                currentRange = 'Sublimated';
                                currentCategory = 'Sublimated Training';
                            } else if (possibleRange.includes('JACKET')) {
                                currentRange = 'Jackets';
                                currentCategory = 'Jackets';
                            } else if (possibleRange.includes('FOOTBALL MATCH')) {
                                currentRange = 'Football';
                                currentCategory = 'Football Match Kit';
                            } else if (possibleRange.includes('FOOTBALL SOCK')) {
                                currentRange = 'Football Socks';
                                currentCategory = 'Football Socks';
                            } else if (possibleRange.includes('RUGBY')) {
                                currentRange = 'Rugby';
                                currentCategory = 'Rugby Match Kit';
                            } else if (possibleRange.includes('BASKETBALL')) {
                                currentRange = 'Basketball';
                                currentCategory = 'Basketball Match Kit';
                            } else if (possibleRange.includes('NETBALL')) {
                                currentRange = 'Netball';
                                currentCategory = 'Netball';
                            } else if (possibleRange.includes('CRICKET')) {
                                currentRange = 'Cricket';
                                currentCategory = 'Cricket';
                            } else if (possibleRange.includes('ACCESSOR')) {
                                currentRange = 'Accessories';
                                currentCategory = 'Accessories';
                            }
                            continue;
                        }

                        // Check for product row (starts with APX/)
                        if (row[0] && row[0].startsWith('APX/')) {
                            const productCode = row[0].trim();
                            const itemName = row[2]?.trim() || '';
                            
                            // Parse prices (remove £ and convert to number)
                            const parsePrice = (val) => {
                                if (!val) return null;
                                return parseFloat(val.replace('£', '').replace(',', '').trim()) || null;
                            };

                            const youthRetail = parsePrice(row[6]);
                            const youthPartner = parsePrice(row[8]);
                            const adultRetail = parsePrice(row[10]);
                            const adultPartner = parsePrice(row[12]);

                            // Get description (column 14)
                            const description = row[14]?.trim() || '';

                            // Get sizes (last column with sizes)
                            let sizes = 'YXXS,YXS,YS,YM,YL,YXL,S,M,L,XL,2XL,3XL,4XL,5XL,6XL';
                            const lastCol = row[row.length - 1];
                            if (lastCol && lastCol.includes(',')) {
                                sizes = lastCol.trim();
                            } else if (lastCol && lastCol.includes('One Size')) {
                                sizes = 'One Size';
                            }

                            // Determine if single price (accessories)
                            const isSinglePrice = currentCategory === 'Accessories' || currentCategory === 'Football Socks';

                            // Determine if has addons
                            const hasAddons = cutAndSewRanges.includes(currentRange.toUpperCase());

                            // Extract range from product code if not set
                            let rangeFromCode = currentRange;
                            const codeParts = productCode.split('/');
                            if (codeParts.length >= 2) {
                                const rangeCode = codeParts[1];
                                const rangeMap = {
                                    'ATL': 'Atlas', 'CEN': 'Centurion', 'ELI': 'Elite', 
                                    'SPA': 'Spartan', 'VAN': 'Vanguard', 'WAR': 'Warrior',
                                    'ACA': 'Academy', 'ESS': 'Essentials', 'SUB': 'Sublimated',
                                    'JKT': 'Jackets', 'FOT': 'Football', 'SOC': 'Football Socks',
                                    'RUG': 'Rugby', 'BAS': 'Basketball', 'NET': 'Netball',
                                    'CRI': 'Cricket', 'ACC': 'Accessories'
                                };
                                rangeFromCode = rangeMap[rangeCode] || currentRange;
                            }

                            // Insert or update product
                            const { error } = await supabase
                                .from('products')
                                .upsert({
                                    brand_id: currentBrand.id,
                                    product_code: productCode,
                                    range_name: rangeFromCode,
                                    category: currentCategory,
                                    item_name: itemName,
                                    youth_retail_price: youthRetail,
                                    youth_partner_price: youthPartner,
                                    adult_retail_price: adultRetail,
                                    adult_partner_price: adultPartner,
                                    is_single_price: isSinglePrice,
                                    single_retail_price: isSinglePrice ? youthRetail : null,
                                    single_partner_price: isSinglePrice ? youthPartner : null,
                                    description: description,
                                    sizes: sizes,
                                    has_addons: hasAddons,
                                    fit_type: isSinglePrice ? 'One Size Only' : 'Adult / Youth'
                                }, { 
                                    onConflict: 'brand_id,product_code' 
                                });

                            if (!error) imported++;
                        }
                    }

                    // Reload products
                    await loadAllData();
                    renderProductsTable();

                    document.getElementById('import-status').classList.remove('hide');
                    document.getElementById('import-message').textContent = `Successfully imported ${imported} products`;
                    showToast(`Imported ${imported} products`);
                },
                error: function(error) {
                    showToast('Error parsing CSV: ' + error.message, 'error');
                }
            });
        }

        function renderProductsTable() {
            const tbody = document.getElementById('products-table');
            const filtered = getFilteredProducts();

            document.getElementById('product-count').textContent = products.length;
            document.getElementById('filtered-count').textContent = filtered.length;

            // Populate filter dropdowns
            populateFilterDropdowns();

            if (filtered.length === 0) {
                tbody.innerHTML = '<tr><td colspan="10" class="py-8 text-center text-gray-500">No products found</td></tr>';
                return;
            }

            // Build active tiers array (default to first tier if none selected)
            const activeTierList = catalogueActivePriceKeys.length
                ? brandPricingTiers.filter(t => catalogueActivePriceKeys.includes(t.tier_key))
                : brandPricingTiers.slice(0, 1);

            // Update table header to show one Youth + Adult column per active tier
            const headerRow = document.getElementById('products-table-header');
            if (headerRow) {
                const priceCols = activeTierList.map(t =>
                    `<th class="pb-3 pr-3 text-right whitespace-nowrap">${escHtml(t.tier_name)} Y</th>` +
                    `<th class="pb-3 pr-3 text-right whitespace-nowrap">${escHtml(t.tier_name)} A</th>`
                ).join('');
                headerRow.innerHTML = `
                    <th class="pb-3 pr-3 whitespace-nowrap">Code</th>
                    <th class="pb-3 pr-3">Name</th>
                    <th class="pb-3 pr-3">Category</th>
                    <th class="pb-3 pr-3">Range</th>
                    ${priceCols}
                    <th class="pb-3 pr-3">Tags</th>
                    <th class="pb-3 text-center">Actions</th>`;
            }

            tbody.innerHTML = filtered.map(p => {
                const tierPricesObj = (p.tier_prices && typeof p.tier_prices === 'object') ? p.tier_prices : {};
                const priceCells = activeTierList.map(t => {
                    const tp = tierPricesObj[t.tier_key] || {};
                    const y = tp.youth || (t.tier_key === 'retail' ? p.youth_retail_price : (t.tier_key === 'partner' ? p.youth_partner_price : null));
                    const a = tp.adult || (t.tier_key === 'retail' ? p.adult_retail_price : (t.tier_key === 'partner' ? p.adult_partner_price : null));
                    return `<td class="py-3 pr-3 text-right text-sm">${y ? '£' + Number(y).toFixed(2) : '-'}</td>` +
                           `<td class="py-3 pr-3 text-right text-sm">${a ? '£' + Number(a).toFixed(2) : (p.is_single_price ? '<span class="text-gray-600 text-xs">single</span>' : '-')}</td>`;
                }).join('');
                return `<tr class="border-b border-gray-800 hover:bg-gray-900/50">
                    <td class="py-3 pr-3 font-mono text-brand-400 whitespace-nowrap text-xs">${escHtml(p.product_code)}</td>
                    <td class="py-3 pr-3 text-sm">${escHtml(p.item_name)}</td>
                    <td class="py-3 pr-3 text-gray-400 text-xs">${escHtml(p.category || '-')}</td>
                    <td class="py-3 pr-3 text-gray-400 text-xs">${escHtml(p.range_name || '-')}</td>
                    ${priceCells}
                    <td class="py-3 pr-3">${renderProductTagChips(p.shopify_tags)}</td>
                    <td class="py-3 text-center whitespace-nowrap">
                        <button onclick="editProduct('${p.id}')" class="text-brand-400 hover:text-brand-300 text-sm mr-2">Edit</button>
                        <button onclick="showDeleteProductModal('${p.id}')" class="text-red-400 hover:text-red-300 text-sm">Delete</button>
                    </td>
                </tr>`;
            }).join('');
        }

        function getFilteredProducts() {
            const search = document.getElementById('product-search')?.value?.toLowerCase() || '';
            const categoryFilter = document.getElementById('filter-category')?.value || '';
            const rangeFilter = document.getElementById('filter-range')?.value || '';
            const fitFilter = document.getElementById('filter-fit')?.value || '';
            const tagFilter = document.getElementById('filter-tag')?.value?.toLowerCase() || '';

            return products.filter(p => {
                // Search filter
                if (search && !p.product_code.toLowerCase().includes(search) &&
                    !p.item_name.toLowerCase().includes(search) &&
                    !(p.range_name && p.range_name.toLowerCase().includes(search))) {
                    return false;
                }
                // Category filter
                if (categoryFilter && p.category !== categoryFilter) return false;
                // Range filter
                if (rangeFilter && p.range_name !== rangeFilter) return false;
                // Fit type filter
                if (fitFilter && p.fit_type !== fitFilter) return false;
                // Tag filter
                if (tagFilter) {
                    const tags = Array.isArray(p.shopify_tags) ? p.shopify_tags : (p.shopify_tags ? JSON.parse(p.shopify_tags) : []);
                    if (!tags.some(t => t.toLowerCase().includes(tagFilter))) return false;
                }
                return true;
            });
        }

        function renderProductTagChips(tags) {
            const arr = Array.isArray(tags) ? tags : (tags ? (typeof tags === 'string' ? JSON.parse(tags) : []) : []);
            if (!arr.length) return '<span class="text-gray-700 text-xs">—</span>';
            return arr.slice(0, 3).map(t => `<span class="inline-block px-1.5 py-0.5 rounded text-xs bg-gray-800 text-gray-400 mr-1">${escHtml(t)}</span>`).join('') + (arr.length > 3 ? `<span class="text-gray-600 text-xs">+${arr.length - 3}</span>` : '');
        }

        function populateFilterDropdowns() {
            // Get unique categories and ranges (from products + custom catalogue settings)
            const categories = [...new Set([...products.map(p => p.category).filter(Boolean), ...catalogueCustomCategories])].sort();
            const ranges = [...new Set([...products.map(p => p.range_name).filter(Boolean), ...catalogueCustomRanges])].sort();

            // Preserve current selections
            const currentCategory = document.getElementById('filter-category')?.value || '';
            const currentRange = document.getElementById('filter-range')?.value || '';

            // Populate category dropdown
            const categorySelect = document.getElementById('filter-category');
            if (categorySelect) {
                categorySelect.innerHTML = '<option value="">All Categories</option>' +
                    categories.map(c => `<option value="${c}" ${c === currentCategory ? 'selected' : ''}>${c}</option>`).join('');
            }

            // Populate range dropdown
            const rangeSelect = document.getElementById('filter-range');
            if (rangeSelect) {
                rangeSelect.innerHTML = '<option value="">All Ranges</option>' +
                    ranges.map(r => `<option value="${r}" ${r === currentRange ? 'selected' : ''}>${r}</option>`).join('');
            }
        }

        function filterProducts() {
            renderProductsTable();
        }

        function clearFilters() {
            document.getElementById('product-search').value = '';
            document.getElementById('filter-category').value = '';
            document.getElementById('filter-range').value = '';
            document.getElementById('filter-fit').value = '';
            const tagEl = document.getElementById('filter-tag');
            if (tagEl) tagEl.value = '';
            renderProductsTable();
        }

        function toggleSinglePrice() {
            const isSingle = document.getElementById('prod-single-price').checked;
            brandPricingTiers.forEach(tier => {
                const adultEl = document.getElementById(`tier-adult-${tier.tier_key}`);
                if (adultEl) { adultEl.disabled = isSingle; if (isSingle) adultEl.value = ''; }
            });
            if (isSingle) {
                ['prod-fit-adult', 'prod-fit-youth', 'prod-fit-women'].forEach(id => {
                    const el = document.getElementById(id);
                    if (el) el.checked = false;
                });
            } else {
                const fAdult = document.getElementById('prod-fit-adult');
                if (fAdult && !document.getElementById('prod-fit-youth')?.checked && !document.getElementById('prod-fit-women')?.checked) {
                    fAdult.checked = true;
                }
            }
            onFitsChanged();
        }

        // onFitTypeChange kept for backward compat — now delegates to onFitsChanged
        function onFitTypeChange() { onFitsChanged(); }

        function onFitsChanged() {
            const hasAdult = document.getElementById('prod-fit-adult')?.checked;
            const hasYouth = document.getElementById('prod-fit-youth')?.checked;
            const hasWomen = document.getElementById('prod-fit-women')?.checked;
            // Show/hide size rows and adult row
            document.getElementById('prod-adult-sizes-row')?.classList.toggle('hide', !hasAdult);
            document.getElementById('prod-youth-sizes-row')?.classList.toggle('hide', !hasYouth);
            document.getElementById('prod-women-sizes-row')?.classList.toggle('hide', !hasWomen);
            // Pre-fill standard sizes when first ticked (only if currently empty)
            const adultInput = document.getElementById('prod-sizes');
            const youthInput = document.getElementById('prod-youth-sizes');
            const womenInput = document.getElementById('prod-women-sizes');
            if (hasAdult && adultInput && !adultInput.value) adultInput.value = 'S,M,L,XL,2XL,3XL,4XL,5XL,6XL';
            if (hasYouth && youthInput && !youthInput.value) youthInput.value = 'YXXS,YXS,YS,YM,YL,YXL';
            if (hasWomen && womenInput && !womenInput.value) womenInput.value = '6,8,10,12,14,16,18,20,22,24,26';
            // Sync hidden fit_type for backward compat
            const parts = [];
            if (hasAdult) parts.push('Adult');
            if (hasYouth) parts.push('Youth');
            if (hasWomen) parts.push("Women's");
            const fitTypeEl = document.getElementById('prod-fit-type');
            if (fitTypeEl) fitTypeEl.value = parts.join(' / ') || 'One Size Only';
        }

        function showAddProductModal() {
            document.getElementById('product-modal-title').textContent = 'Add Product';
            document.getElementById('edit-product-id').value = '';

            // Clear all fields
            document.getElementById('prod-code').value = '';
            document.getElementById('prod-name').value = '';
            document.getElementById('prod-category').value = '';
            document.getElementById('prod-range').value = '';
            document.getElementById('prod-single-price').checked = false;
            document.getElementById('prod-weight').value = '450';
            // Default: Adult only ticked
            const fAdult = document.getElementById('prod-fit-adult');
            const fYouth = document.getElementById('prod-fit-youth');
            const fWomen = document.getElementById('prod-fit-women');
            if (fAdult) fAdult.checked = true;
            if (fYouth) fYouth.checked = false;
            if (fWomen) fWomen.checked = false;
            document.getElementById('prod-sizes').value = 'S,M,L,XL,2XL,3XL,4XL,5XL,6XL';
            const ySizes = document.getElementById('prod-youth-sizes');
            if (ySizes) ySizes.value = 'YXXS,YXS,YS,YM,YL,YXL';
            const wSizes = document.getElementById('prod-women-sizes');
            if (wSizes) wSizes.value = '6,8,10,12,14,16,18,20,22,24,26';
            onFitsChanged();
            document.getElementById('prod-description').value = '';

            // Reset tags
            currentProductTags = [];
            renderProductTagsUI();
            populateProdCategoryDatalist();
            populateProdRangeDatalist();
            populateProdFitTypeSelect();
            renderPricingFields({});

            document.getElementById('product-modal').classList.remove('hide');
        }

        function editProduct(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('product-modal-title').textContent = 'Edit Product';
            document.getElementById('edit-product-id').value = productId;

            // Populate fields
            document.getElementById('prod-code').value = product.product_code || '';
            document.getElementById('prod-name').value = product.item_name || '';
            document.getElementById('prod-category').value = product.category || '';
            document.getElementById('prod-range').value = product.range_name || '';
            document.getElementById('prod-single-price').checked = product.is_single_price || false;
            document.getElementById('prod-weight').value = product.weight_grams || 450;
            document.getElementById('prod-sizes').value = product.sizes || '';
            document.getElementById('prod-description').value = product.description || '';
            populateProdCategoryDatalist();
            populateProdRangeDatalist();
            populateProdFitTypeSelect();
            // Set fit checkboxes from available_fits
            const availFits = (product.available_fits || 'adult').split(',').map(f => f.trim().toLowerCase());
            const fAdult = document.getElementById('prod-fit-adult');
            const fYouth = document.getElementById('prod-fit-youth');
            const fWomen = document.getElementById('prod-fit-women');
            if (fAdult) fAdult.checked = availFits.includes('adult');
            if (fYouth) fYouth.checked = availFits.includes('youth');
            if (fWomen) fWomen.checked = availFits.includes('women');
            // Set size fields (fall back to standard defaults)
            document.getElementById('prod-sizes').value = product.sizes || 'S,M,L,XL,2XL,3XL,4XL,5XL,6XL';
            const ySizes = document.getElementById('prod-youth-sizes');
            if (ySizes) ySizes.value = product.youth_sizes || 'YXXS,YXS,YS,YM,YL,YXL';
            const wSizes = document.getElementById('prod-women-sizes');
            if (wSizes) wSizes.value = product.women_sizes || '6,8,10,12,14,16,18,20,22,24,26';
            onFitsChanged();

            // Load tier prices
            let tierPrices = {};
            if (product.tier_prices && typeof product.tier_prices === 'object') {
                tierPrices = product.tier_prices;
            } else if (product.youth_retail_price || product.adult_retail_price) {
                // Migrate legacy pricing
                tierPrices = {
                    retail: { youth: product.youth_retail_price, adult: product.adult_retail_price },
                    partner: { youth: product.youth_partner_price, adult: product.adult_partner_price }
                };
            }
            renderPricingFields(tierPrices);

            // Load tags
            const rawTags = product.shopify_tags;
            currentProductTags = Array.isArray(rawTags) ? [...rawTags] : (rawTags ? (typeof rawTags === 'string' ? JSON.parse(rawTags) : []) : []);
            populateProdCategoryDatalist();
            populateProdRangeDatalist();
            renderProductTagsUI();
            toggleSinglePrice();

            document.getElementById('product-modal').classList.remove('hide');
        }

        function hideProductModal() {
            document.getElementById('product-modal').classList.add('hide');
        }

        // =============================================
        // PRODUCT: DYNAMIC PRICING FIELDS
        // =============================================
        function renderPricingFields(tierPrices) {
            const container = document.getElementById('product-pricing-fields');
            if (!container) return;
            if (!brandPricingTiers.length) {
                container.innerHTML = '<p class="text-gray-600 text-sm">No pricing tiers configured. Click "Manage Tiers" to add.</p>';
                return;
            }
            container.innerHTML = brandPricingTiers.map(tier => {
                const tp = tierPrices[tier.tier_key] || {};
                return `<div class="rounded-lg p-3" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06)">
                    <p class="text-gray-400 text-xs font-semibold uppercase tracking-wider mb-2">${escHtml(tier.tier_name)}</p>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="text-gray-500 text-xs mb-1 block">Youth Price</label>
                            <input type="number" step="0.01" id="tier-youth-${escHtml(tier.tier_key)}" value="${tp.youth || ''}" placeholder="0.00" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                        <div>
                            <label class="text-gray-500 text-xs mb-1 block">Adult Price</label>
                            <input type="number" step="0.01" id="tier-adult-${escHtml(tier.tier_key)}" value="${tp.adult || ''}" placeholder="0.00" class="w-full px-3 py-2 rounded-lg text-sm">
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        // =============================================
        // PRODUCT: SHOPIFY TAGS UI
        // =============================================
        function renderProductTagsUI() {
            // Render saved brand tags as clickable suggestions
            const savedEl = document.getElementById('brand-saved-tags');
            if (savedEl) {
                savedEl.innerHTML = brandShopifyTags.map(t =>
                    `<button type="button" onclick="toggleProductTag('${escHtml(t.tag)}')" class="px-2 py-1 rounded text-xs border transition ${currentProductTags.includes(t.tag) ? 'bg-brand-500/20 border-brand-500 text-brand-400' : 'bg-gray-800 border-gray-700 text-gray-500 hover:border-gray-500'}">${escHtml(t.tag)}</button>`
                ).join('');
            }
            // Render current product tags as removable chips
            const chipsEl = document.getElementById('product-tags-chips');
            if (chipsEl) {
                if (currentProductTags.length === 0) {
                    chipsEl.innerHTML = '<span class="text-gray-700 text-xs italic">No tags added yet</span>';
                } else {
                    chipsEl.innerHTML = currentProductTags.map(t =>
                        `<span class="inline-flex items-center gap-1 px-2 py-1 rounded bg-brand-500/10 border border-brand-500/30 text-brand-400 text-xs">${escHtml(t)}<button type="button" onclick="removeProductTag('${escHtml(t)}')" class="text-brand-600 hover:text-red-400 ml-0.5">&times;</button></span>`
                    ).join('');
                }
            }
        }

        function toggleProductTag(tag) {
            const idx = currentProductTags.indexOf(tag);
            if (idx === -1) currentProductTags.push(tag);
            else currentProductTags.splice(idx, 1);
            renderProductTagsUI();
        }

        function removeProductTag(tag) {
            currentProductTags = currentProductTags.filter(t => t !== tag);
            renderProductTagsUI();
        }

        function addProductTag() {
            const input = document.getElementById('prod-tag-input');
            if (!input) return;
            const tag = input.value.trim();
            if (!tag) return;
            if (!currentProductTags.includes(tag)) {
                currentProductTags.push(tag);
                renderProductTagsUI();
            }
            input.value = '';
        }

        function handleProductTagInput(event) {
            if (event.key === 'Enter') {
                event.preventDefault();
                addProductTag();
            }
        }

        // =============================================
        // PRODUCT: CATEGORY & RANGE DATALISTS
        // =============================================
        function populateProdCategoryDatalist() {
            const dl = document.getElementById('prod-categories-list');
            if (!dl) return;
            const fromProducts = products.map(p => p.category).filter(Boolean);
            const defaults = ['Cut & Sew Teamwear','Sublimated Training','Jackets','Football Match Kit','Football Socks','Rugby Match Kit','Basketball Match Kit','Netball','Cricket','Accessories','Goalkeeper Kit','Training Wear'];
            const all = [...new Set([...fromProducts, ...catalogueCustomCategories, ...defaults])].sort();
            dl.innerHTML = all.map(c => `<option value="${escHtml(c)}">`).join('');
        }

        function populateProdRangeDatalist() {
            const dl = document.getElementById('prod-ranges-list');
            if (!dl) return;
            const fromProducts = products.map(p => p.range_name).filter(Boolean);
            const all = [...new Set([...fromProducts, ...catalogueCustomRanges])].sort();
            dl.innerHTML = all.map(r => `<option value="${escHtml(r)}">`).join('');
        }

        function populateProdFitTypeSelect() {
            const sel = document.getElementById('prod-fit-type');
            if (!sel) return;
            const defaults = ['Adult / Youth', "Women's", 'One Size Only'];
            const all = [...new Set([...defaults, ...catalogueCustomFitTypes])];
            const current = sel.value;
            sel.innerHTML = all.map(f => `<option value="${escHtml(f)}" ${f === current ? 'selected' : ''}>${escHtml(f)}</option>`).join('');
        }

        // =============================================
        // PRICING TIERS MODAL
        // =============================================
        function showManagePricingTiersModal() {
            renderPricingTiersList();
            document.getElementById('pricing-tiers-modal').classList.remove('hide');
        }

        function hidePricingTiersModal() {
            document.getElementById('pricing-tiers-modal').classList.add('hide');
            // Re-render pricing fields with latest tiers
            const productId = document.getElementById('edit-product-id').value;
            const product = productId ? products.find(p => p.id === productId) : null;
            renderPricingFields(product?.tier_prices || {});
        }

        function renderPricingTiersList() {
            const container = document.getElementById('pricing-tiers-list');
            if (!container) return;
            if (!brandPricingTiers.length) {
                container.innerHTML = '<p class="text-gray-500 text-sm">No tiers yet. Add one below.</p>';
                return;
            }
            container.innerHTML = brandPricingTiers.map((tier, idx) => `
                <div class="flex items-center justify-between bg-gray-800 rounded-lg px-4 py-3">
                    <div>
                        <span class="font-medium text-sm">${escHtml(tier.tier_name)}</span>
                        <span class="text-gray-600 text-xs ml-2 font-mono">${escHtml(tier.tier_key)}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${idx > 0 ? `<button onclick="moveTierUp(${idx})" class="text-gray-500 hover:text-white text-xs">↑</button>` : ''}
                        <button onclick="removePricingTier('${tier.tier_key}')" class="text-red-400 hover:text-red-300 text-xs">Remove</button>
                    </div>
                </div>`).join('');
        }

        async function addPricingTier() {
            const keyEl = document.getElementById('new-tier-key');
            const nameEl = document.getElementById('new-tier-name');
            const key = keyEl.value.trim().toLowerCase().replace(/\s+/g, '_');
            const name = nameEl.value.trim();
            if (!key || !name) { showToast('Enter both key and display name', 'error'); return; }
            if (brandPricingTiers.find(t => t.tier_key === key)) { showToast('Tier key already exists', 'error'); return; }

            const newTier = { brand_id: currentBrand.id, tier_key: key, tier_name: name, sort_order: brandPricingTiers.length };
            const { data, error } = await supabase.from('brand_pricing_tiers').insert(newTier).select().single();
            if (error) { showToast(error.message, 'error'); return; }
            brandPricingTiers.push(data);
            keyEl.value = ''; nameEl.value = '';
            renderPricingTiersList();
            showToast(`Tier "${name}" added`);
            // Repopulate club-status selects
            populatePartnershipLevelSelect(document.getElementById('club-status')?.value || 'retail');
        }

        async function removePricingTier(tierKey) {
            if (!confirm(`Remove pricing tier "${tierKey}"? This won't affect existing saved prices.`)) return;
            const tier = brandPricingTiers.find(t => t.tier_key === tierKey);
            if (!tier || !tier.id) { brandPricingTiers = brandPricingTiers.filter(t => t.tier_key !== tierKey); renderPricingTiersList(); return; }
            const { error } = await supabase.from('brand_pricing_tiers').update({ is_active: false }).eq('id', tier.id);
            if (error) { showToast(error.message, 'error'); return; }
            brandPricingTiers = brandPricingTiers.filter(t => t.tier_key !== tierKey);
            renderPricingTiersList();
            showToast('Tier removed');
        }

        function moveTierUp(idx) {
            if (idx <= 0) return;
            [brandPricingTiers[idx-1], brandPricingTiers[idx]] = [brandPricingTiers[idx], brandPricingTiers[idx-1]];
            renderPricingTiersList();
        }

        // =============================================
        // CATALOGUE SETTINGS
        // =============================================

        function _csStorageKey() {
            return `catalogue_settings_${currentBrand?.id || 'default'}`;
        }

        function loadCatalogueSettings() {
            try {
                const raw = localStorage.getItem(_csStorageKey());
                if (raw) {
                    const s = JSON.parse(raw);
                    catalogueCustomCategories = s.categories || [];
                    catalogueCustomRanges = s.ranges || [];
                    catalogueCustomFitTypes = s.fitTypes || [];
                    catalogueActivePriceKeys = s.activePriceKeys || (s.activePriceKey ? [s.activePriceKey] : []);
                }
            } catch (e) { /* ignore */ }
        }

        function saveCatalogueSettings() {
            try {
                localStorage.setItem(_csStorageKey(), JSON.stringify({
                    categories: catalogueCustomCategories,
                    ranges: catalogueCustomRanges,
                    fitTypes: catalogueCustomFitTypes,
                    activePriceKeys: catalogueActivePriceKeys
                }));
            } catch (e) { /* ignore */ }
        }

        function showCatalogueSettings() {
            // Render pricing tiers section
            renderCsTiersList();
            // Populate active price list checkboxes
            const activeSel = document.getElementById('cs-active-price-list');
            if (activeSel) {
                activeSel.innerHTML = brandPricingTiers.map(t => `
                    <label class="flex items-center gap-2 cursor-pointer">
                        <input type="checkbox" value="${escHtml(t.tier_key)}" ${catalogueActivePriceKeys.includes(t.tier_key) ? 'checked' : ''} onchange="csToggleActivePriceKey('${escHtml(t.tier_key)}', this.checked)" class="rounded accent-brand-500">
                        <span class="text-sm">${escHtml(t.tier_name)}</span>
                    </label>`).join('');
                if (!catalogueActivePriceKeys.length && brandPricingTiers.length) {
                    catalogueActivePriceKeys = [brandPricingTiers[0].tier_key];
                    // check first checkbox
                    const firstCb = activeSel.querySelector('input[type=checkbox]');
                    if (firstCb) firstCb.checked = true;
                }
            }
            // Render categories
            renderCsCategoriesList();
            // Render ranges
            renderCsRangesList();
            // Render fit types
            renderCsFitTypesList();
            document.getElementById('catalogue-settings-modal').classList.remove('hide');
        }

        function hideCatalogueSettings() {
            document.getElementById('catalogue-settings-modal').classList.add('hide');
            saveCatalogueSettings();
            populateProdCategoryDatalist();
            populateProdRangeDatalist();
            populateProdFitTypeSelect();
            populateFilterDropdowns();
            renderProductsTable();
        }

        function renderCsTiersList() {
            const container = document.getElementById('cs-tiers-list');
            if (!container) return;
            if (!brandPricingTiers.length) {
                container.innerHTML = '<p class="text-gray-600 text-sm">No price lists yet. Add up to 4 below.</p>';
                return;
            }
            container.innerHTML = brandPricingTiers.map((tier, idx) => `
                <div class="flex items-center justify-between rounded-lg px-4 py-3" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.07)">
                    <div>
                        <span class="font-medium text-sm">${escHtml(tier.tier_name)}</span>
                        <span class="text-gray-600 text-xs ml-2 font-mono">${escHtml(tier.tier_key)}</span>
                    </div>
                    <div class="flex items-center gap-2">
                        ${idx > 0 ? `<button onclick="csTierMoveUp(${idx})" class="text-gray-500 hover:text-white text-xs px-2">↑</button>` : ''}
                        ${brandPricingTiers.length > 1 ? `<button onclick="csRemoveTier('${escHtml(tier.tier_key)}')" class="text-red-400 hover:text-red-300 text-xs">Remove</button>` : ''}
                    </div>
                </div>`).join('');
        }

        async function csAddTier() {
            if (brandPricingTiers.length >= 4) { showToast('Maximum 4 price lists allowed', 'error'); return; }
            const keyEl = document.getElementById('cs-new-tier-key');
            const nameEl = document.getElementById('cs-new-tier-name');
            const key = (keyEl.value.trim()).toLowerCase().replace(/\s+/g, '_');
            const name = nameEl.value.trim();
            if (!key || !name) { showToast('Enter both a key and display name', 'error'); return; }
            if (brandPricingTiers.find(t => t.tier_key === key)) { showToast('That key already exists', 'error'); return; }
            const newTier = { brand_id: currentBrand.id, tier_key: key, tier_name: name, sort_order: brandPricingTiers.length };
            const { data, error } = await supabase.from('brand_pricing_tiers').insert(newTier).select().single();
            if (error) { showToast(error.message, 'error'); return; }
            brandPricingTiers.push(data);
            keyEl.value = ''; nameEl.value = '';
            renderCsTiersList();
            showToast(`Price list "${name}" added`);
        }

        async function csRemoveTier(tierKey) {
            if (!confirm(`Remove price list "${tierKey}"? Existing saved prices are not deleted.`)) return;
            const tier = brandPricingTiers.find(t => t.tier_key === tierKey);
            if (tier && tier.id) {
                const { error } = await supabase.from('brand_pricing_tiers').update({ is_active: false }).eq('id', tier.id);
                if (error) { showToast(error.message, 'error'); return; }
            }
            brandPricingTiers = brandPricingTiers.filter(t => t.tier_key !== tierKey);
            catalogueActivePriceKeys = catalogueActivePriceKeys.filter(k => k !== tierKey);
            if (!catalogueActivePriceKeys.length && brandPricingTiers.length) catalogueActivePriceKeys = [brandPricingTiers[0].tier_key];
            renderCsTiersList();
            showCatalogueSettings();
            showToast('Price list removed');
        }

        function csTierMoveUp(idx) {
            if (idx <= 0) return;
            [brandPricingTiers[idx-1], brandPricingTiers[idx]] = [brandPricingTiers[idx], brandPricingTiers[idx-1]];
            renderCsTiersList();
        }

        function csSetActivePriceList(key) {
            // Legacy support
            if (!catalogueActivePriceKeys.includes(key)) catalogueActivePriceKeys.push(key);
            saveCatalogueSettings();
        }

        function csToggleActivePriceKey(key, checked) {
            if (checked) {
                if (!catalogueActivePriceKeys.includes(key)) catalogueActivePriceKeys.push(key);
            } else {
                catalogueActivePriceKeys = catalogueActivePriceKeys.filter(k => k !== key);
                if (!catalogueActivePriceKeys.length && brandPricingTiers.length) {
                    catalogueActivePriceKeys = [brandPricingTiers[0].tier_key];
                    showCatalogueSettings(); // re-render to reflect forced selection
                }
            }
            saveCatalogueSettings();
        }

        function renderCsCategoriesList() {
            const container = document.getElementById('cs-categories-list');
            if (!container) return;
            const fromProducts = [...new Set(products.map(p => p.category).filter(Boolean))].sort();
            if (!catalogueCustomCategories.length && !fromProducts.length) {
                container.innerHTML = '<span class="text-gray-600 text-xs italic">No custom categories yet</span>';
                return;
            }
            const allCustom = [...new Set([...catalogueCustomCategories])].sort();
            container.innerHTML = [
                ...fromProducts.map(c => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-gray-800/50 text-gray-500">${escHtml(c)}</span>`),
                ...allCustom.map(c => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-brand-500/10 border border-brand-500/30 text-brand-400">${escHtml(c)}<button type="button" onclick="csRemoveCategory('${escHtml(c)}')" class="text-brand-600 hover:text-red-400 ml-0.5">&times;</button></span>`)
            ].join('');
        }

        function csAddCategory() {
            const input = document.getElementById('cs-new-category');
            const val = input.value.trim();
            if (!val) return;
            if (!catalogueCustomCategories.includes(val)) {
                catalogueCustomCategories.push(val);
                renderCsCategoriesList();
            }
            input.value = '';
        }

        function csRemoveCategory(cat) {
            catalogueCustomCategories = catalogueCustomCategories.filter(c => c !== cat);
            renderCsCategoriesList();
        }

        function renderCsRangesList() {
            const container = document.getElementById('cs-ranges-list');
            if (!container) return;
            const fromProducts = [...new Set(products.map(p => p.range_name).filter(Boolean))].sort();
            if (!catalogueCustomRanges.length && !fromProducts.length) {
                container.innerHTML = '<span class="text-gray-600 text-xs italic">No custom ranges yet</span>';
                return;
            }
            container.innerHTML = [
                ...fromProducts.map(r => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-gray-800/50 text-gray-500">${escHtml(r)}</span>`),
                ...catalogueCustomRanges.map(r => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-brand-500/10 border border-brand-500/30 text-brand-400">${escHtml(r)}<button type="button" onclick="csRemoveRange('${escHtml(r)}')" class="text-brand-600 hover:text-red-400 ml-0.5">&times;</button></span>`)
            ].join('');
        }

        function csAddRange() {
            const input = document.getElementById('cs-new-range');
            const val = input.value.trim();
            if (!val) return;
            if (!catalogueCustomRanges.includes(val)) {
                catalogueCustomRanges.push(val);
                renderCsRangesList();
            }
            input.value = '';
        }

        function csRemoveRange(range) {
            catalogueCustomRanges = catalogueCustomRanges.filter(r => r !== range);
            renderCsRangesList();
        }

        function renderCsFitTypesList() {
            const container = document.getElementById('cs-fittypes-list');
            if (!container) return;
            const defaults = ['Adult / Youth', "Women's", 'One Size Only'];
            if (!catalogueCustomFitTypes.length) {
                container.innerHTML = defaults.map(f => `<span class="px-2 py-1 rounded text-xs bg-gray-800/50 text-gray-500">${escHtml(f)}</span>`).join('');
                return;
            }
            container.innerHTML = [
                ...defaults.map(f => `<span class="px-2 py-1 rounded text-xs bg-gray-800/50 text-gray-500">${escHtml(f)}</span>`),
                ...catalogueCustomFitTypes.map(f => `<span class="inline-flex items-center gap-1 px-2 py-1 rounded text-xs bg-brand-500/10 border border-brand-500/30 text-brand-400">${escHtml(f)}<button type="button" onclick="csRemoveFitType('${escHtml(f)}')" class="text-brand-600 hover:text-red-400 ml-0.5">&times;</button></span>`)
            ].join('');
        }

        function csAddFitType() {
            const input = document.getElementById('cs-new-fittype');
            const val = input.value.trim();
            if (!val) return;
            const defaults = ['Adult / Youth', "Women's", 'One Size Only'];
            if (!defaults.includes(val) && !catalogueCustomFitTypes.includes(val)) {
                catalogueCustomFitTypes.push(val);
                renderCsFitTypesList();
            }
            input.value = '';
        }

        function csRemoveFitType(fitType) {
            catalogueCustomFitTypes = catalogueCustomFitTypes.filter(f => f !== fitType);
            renderCsFitTypesList();
        }

        async function saveProduct() {
            const productId = document.getElementById('edit-product-id').value;
            const isSinglePrice = document.getElementById('prod-single-price').checked;

            // Collect tier prices from dynamic fields
            const tierPrices = {};
            brandPricingTiers.forEach(tier => {
                const youthEl = document.getElementById(`tier-youth-${tier.tier_key}`);
                const adultEl = document.getElementById(`tier-adult-${tier.tier_key}`);
                const youthVal = youthEl ? parseFloat(youthEl.value) || null : null;
                const adultVal = adultEl ? parseFloat(adultEl.value) || null : null;
                if (youthVal !== null || adultVal !== null) {
                    tierPrices[tier.tier_key] = { youth: youthVal, adult: adultVal };
                }
            });

            // Also save tags to brand_shopify_tags for future reuse
            for (const tag of currentProductTags) {
                if (tag && !brandShopifyTags.find(t => t.tag === tag)) {
                    const { data: newTag } = await supabase.from('brand_shopify_tags')
                        .insert({ brand_id: currentBrand.id, tag })
                        .select().single();
                    if (newTag) brandShopifyTags.push(newTag);
                }
            }

            // Extract legacy pricing from tiers for backward compat
            const retailTier = tierPrices['retail'] || {};
            const partnerTier = tierPrices['partner'] || {};

            const productData = {
                brand_id: currentBrand.id,
                product_code: document.getElementById('prod-code').value.trim().toUpperCase(),
                item_name: document.getElementById('prod-name').value.trim(),
                category: document.getElementById('prod-category').value.trim(),
                range_name: document.getElementById('prod-range').value.trim(),
                tier_prices: tierPrices,
                youth_retail_price: retailTier.youth || null,
                youth_partner_price: partnerTier.youth || null,
                adult_retail_price: isSinglePrice ? null : (retailTier.adult || null),
                adult_partner_price: isSinglePrice ? null : (partnerTier.adult || null),
                is_single_price: isSinglePrice,
                single_retail_price: isSinglePrice ? (retailTier.youth || null) : null,
                single_partner_price: isSinglePrice ? (partnerTier.youth || null) : null,
                fit_type: document.getElementById('prod-fit-type').value,
                weight_grams: parseInt(document.getElementById('prod-weight').value) || 450,
                sizes: document.getElementById('prod-sizes').value.trim(),
                youth_sizes: document.getElementById('prod-youth-sizes')?.value.trim() || null,
                women_sizes: document.getElementById('prod-women-sizes')?.value.trim() || null,
                available_fits: (() => {
                    if (document.getElementById('prod-single-price').checked) return 'adult';
                    const fits = [];
                    if (document.getElementById('prod-fit-adult')?.checked) fits.push('adult');
                    if (document.getElementById('prod-fit-youth')?.checked) fits.push('youth');
                    if (document.getElementById('prod-fit-women')?.checked) fits.push('women');
                    return fits.length ? fits.join(',') : 'adult';
                })(),
                has_addons: false,
                shopify_tags: currentProductTags,
                description: document.getElementById('prod-description').value.trim()
            };

            // Validation
            if (!productData.product_code || !productData.item_name || !productData.category || !productData.range_name) {
                showToast('Please fill in all required fields: Code, Name, Category and Range', 'error');
                return;
            }

            let result;
            if (productId) {
                // Update existing
                result = await supabase
                    .from('products')
                    .update(productData)
                    .eq('id', productId)
                    .select()
                    .single();
            } else {
                // Insert new
                result = await supabase
                    .from('products')
                    .insert(productData)
                    .select()
                    .single();
            }

            if (result.error) {
                showToast(result.error.message, 'error');
                return;
            }

            // Update local state
            if (productId) {
                const index = products.findIndex(p => p.id === productId);
                if (index !== -1) products[index] = result.data;
            } else {
                products.push(result.data);
            }

            hideProductModal();
            renderProductsTable();
            updateStats();
            showToast(productId ? 'Product updated' : 'Product added');
        }

        function showDeleteProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (!product) return;

            document.getElementById('delete-product-id').value = productId;
            document.getElementById('delete-product-name').textContent = `${product.product_code} - ${product.item_name}`;
            document.getElementById('delete-product-modal').classList.remove('hide');
        }

        function hideDeleteModal() {
            document.getElementById('delete-product-modal').classList.add('hide');
        }

        async function confirmDeleteProduct() {
            const productId = document.getElementById('delete-product-id').value;

            const { error } = await supabase
                .from('products')
                .delete()
                .eq('id', productId);

            if (error) {
                showToast(error.message, 'error');
                return;
            }

            products = products.filter(p => p.id !== productId);
            hideDeleteModal();
            renderProductsTable();
            updateStats();
            showToast('Product deleted');
        }

        // =============================================
        // MOCK-UP UPLOAD: filename parser + upload flow
        // =============================================

        function parseDesignFilename(filename) {
            const base = filename.replace(/\.[^.]+$/, '');
            let variantNumber = 1;
            let name = base;
            const variantMatch = base.match(/-V(\d+)$/i);
            if (variantMatch) {
                variantNumber = parseInt(variantMatch[1]);
                name = base.slice(0, -variantMatch[0].length);
            }
            const viewMap = { '-B': 'back', '-S': 'side', '-T': 'top', '-F': 'front' };
            let view = 'front';
            let productCode = name;
            for (const [suffix, viewName] of Object.entries(viewMap)) {
                if (name.toUpperCase().endsWith(suffix)) {
                    view = viewName;
                    productCode = name.slice(0, -suffix.length);
                    break;
                }
            }
            return { productCode: productCode.toUpperCase(), view, variantNumber };
        }

        function showMockupUploadModal() {
            document.getElementById('mockup-upload-modal').classList.remove('hide');
            document.getElementById('mockup-preview-table').innerHTML = '';
            document.getElementById('mockup-preview-wrap').classList.add('hide');
            document.getElementById('mockup-file-input').value = '';
            document.getElementById('mockup-upload-btn').disabled = true;
        }

        function hideMockupUploadModal() {
            document.getElementById('mockup-upload-modal').classList.add('hide');
        }

        function previewMockupFiles(event) {
            const files = Array.from(event.target.files);
            const tbody = document.getElementById('mockup-preview-table');
            const wrap = document.getElementById('mockup-preview-wrap');
            const countEl = document.getElementById('mockup-file-count');
            tbody.innerHTML = '';
            if (!files.length) { wrap.classList.add('hide'); return; }
            wrap.classList.remove('hide');
            if (countEl) countEl.textContent = files.length;

            files.forEach(file => {
                const { productCode, view, variantNumber } = parseDesignFilename(file.name);
                const masterProduct = products.find(p =>
                    p.product_code.toUpperCase() === productCode
                );
                const tr = document.createElement('tr');
                tr.className = 'border-b border-white/5';
                tr.innerHTML = `
                    <td class="py-1.5 pr-3 text-xs text-gray-400">${escHtml(file.name)}</td>
                    <td class="py-1.5 pr-3 text-xs font-mono text-brand-400">${productCode}</td>
                    <td class="py-1.5 pr-3 text-xs ${masterProduct ? 'text-gray-200' : 'text-red-400'}">${masterProduct ? escHtml(masterProduct.item_name) : '⚠️ No match'}</td>
                    <td class="py-1.5 pr-3 text-xs capitalize text-gray-400">${view}</td>
                    <td class="py-1.5 text-xs text-gray-400">V${variantNumber}</td>`;
                tbody.appendChild(tr);
            });
            document.getElementById('mockup-upload-btn').disabled = false;
        }

        async function uploadMockupsAndCreateProducts() {
            if (!currentClub) return;
            const files = Array.from(document.getElementById('mockup-file-input').files);
            if (!files.length) return;
            const btn = document.getElementById('mockup-upload-btn');
            btn.disabled = true;
            btn.textContent = 'Uploading…';

            const brandSlug = (currentBrand.slug || currentBrand.name || '').toLowerCase().replace(/[^a-z0-9]/g, '-');
            const clubSuffix = (currentClub.suffix || currentClub.id).toLowerCase();
            let successCount = 0, errors = [];

            for (const file of files) {
                const { productCode, variantNumber } = parseDesignFilename(file.name);
                const masterProduct = products.find(p => p.product_code.toUpperCase() === productCode);
                if (!masterProduct) { errors.push(`${file.name}: no matching product`); continue; }

                const storagePath = `${brandSlug}/${clubSuffix}/${file.name}`;
                const { error: uploadErr } = await supabase.storage.from('club-images')
                    .upload(storagePath, file, { upsert: true });
                if (uploadErr) { errors.push(`${file.name}: ${uploadErr.message}`); continue; }

                const { data: { publicUrl } } = supabase.storage.from('club-images').getPublicUrl(storagePath);

                const { data: existingCP } = await supabase.from('club_products')
                    .select('*').eq('club_id', currentClub.id)
                    .eq('product_id', masterProduct.id).eq('variant_number', variantNumber).maybeSingle();

                if (!existingCP) {
                    const { error: createErr } = await supabase.from('club_products').insert({
                        club_id: currentClub.id,
                        product_id: masterProduct.id,
                        custom_name: `${currentClub.name} ${masterProduct.item_name}`,
                        variant_number: variantNumber,
                        image_urls: [publicUrl],
                        web_price: masterProduct.adult_retail_price || masterProduct.single_retail_price,
                        partner_price: masterProduct.adult_partner_price || masterProduct.single_partner_price,
                        is_active: true
                    });
                    if (createErr) { errors.push(`${file.name}: ${createErr.message}`); continue; }
                } else {
                    const urls = Array.isArray(existingCP.image_urls) ? existingCP.image_urls : [];
                    if (!urls.includes(publicUrl)) urls.push(publicUrl);
                    const { error: updateErr } = await supabase.from('club_products')
                        .update({ image_urls: urls }).eq('id', existingCP.id);
                    if (updateErr) { errors.push(`${file.name}: ${updateErr.message}`); continue; }
                }
                successCount++;
            }

            btn.disabled = false;
            btn.textContent = 'Upload & Create Products';

            if (errors.length) {
                showToast(`${successCount} uploaded, ${errors.length} failed`, 'error');
                console.error('Mockup upload errors:', errors);
            } else {
                showToast(`${successCount} mock-up${successCount !== 1 ? 's' : ''} uploaded and mapped!`);
                hideMockupUploadModal();
                await loadClubProducts();
                renderOnboardingImageSummary();
            }
        }

        // =============================================
        // STORE CREATOR: price list + CSV download
        // =============================================
        let _selectedPriceList = 'retail';

        function selectPriceList(type) {
            _selectedPriceList = type;
            const radioEl = document.getElementById(`pl-${type}`);
            if (radioEl) radioEl.checked = true;
        }

        function openCreateStoreModal() {
            if (!currentClub) return;
            const withImages = (currentClubProducts || []).filter(cp => (cp.image_urls || []).length > 0);
            document.getElementById('cstore-club-name').textContent = currentClub.name || '—';
            document.getElementById('cstore-product-count').textContent = withImages.length;
            document.getElementById('cstore-collection-img').textContent =
                currentClub.collection_image_url ? '✓ Uploaded' : '⚠️ Not set';
            document.getElementById('cstore-collection-name').textContent = currentClub.name || '—';

            // Populate price list options dynamically from brandPricingTiers
            const optionsEl = document.getElementById('price-list-options');
            if (optionsEl) {
                if (brandPricingTiers.length) {
                    optionsEl.innerHTML = brandPricingTiers.map((tier, idx) => {
                        const isFirst = idx === 0;
                        const bg = isFirst ? 'background:rgba(20,184,166,0.06);border:1px solid rgba(20,184,166,0.25)' : 'background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.07)';
                        const nameClass = isFirst ? 'text-brand-400' : 'text-white';
                        return `<label class="flex items-center gap-3 p-3 rounded-xl cursor-pointer" style="${bg}" onclick="selectPriceList('${escHtml(tier.tier_key)}')">
                            <input type="radio" name="price-list" value="${escHtml(tier.tier_key)}" id="pl-${escHtml(tier.tier_key)}" class="accent-brand-500" ${isFirst ? 'checked' : ''}>
                            <div><p class="text-sm font-semibold ${nameClass}">${escHtml(tier.tier_name)}</p></div>
                        </label>`;
                    }).join('');
                    _selectedPriceList = brandPricingTiers[0].tier_key;
                } else {
                    optionsEl.innerHTML = '<p class="text-gray-500 text-sm p-3">No pricing tiers configured. Open Catalogue Settings to add price lists.</p>';
                    _selectedPriceList = 'retail';
                }
            }
            document.getElementById('create-store-modal').classList.remove('hide');
        }

        async function downloadClubStoreCSV() {
            document.getElementById('create-store-modal').classList.add('hide');
            await generateShopifyCSVForClub(null, _selectedPriceList);
        }

        // =============================================
        // ONBOARDING: collection image + image summary
        // =============================================

        async function uploadOnboardCollectionImage(event) {
            const file = event.target.files[0];
            if (!file || !currentClub) return;
            const brandSlug = (currentBrand.slug || currentBrand.name || '').toLowerCase().replace(/[^a-z0-9]/g, '-');
            const clubSuffix = (currentClub.suffix || currentClub.id).toLowerCase();
            const ext = file.name.split('.').pop();
            const storagePath = `${brandSlug}/${clubSuffix}/collection_image.${ext}`;
            const { error } = await supabase.storage.from('club-images').upload(storagePath, file, { upsert: true });
            if (error) { showToast(error.message, 'error'); return; }
            const { data: { publicUrl } } = supabase.storage.from('club-images').getPublicUrl(storagePath);
            const { error: updateErr } = await supabase.from('clubs')
                .update({ collection_image_url: publicUrl }).eq('id', currentClub.id);
            if (updateErr) { showToast(updateErr.message, 'error'); return; }
            currentClub.collection_image_url = publicUrl;
            const preview = document.getElementById('onboard-coll-img-preview');
            if (preview) preview.innerHTML = `<img src="${publicUrl}" class="w-full h-full object-cover rounded-xl">`;
            showToast('Collection image uploaded!');
        }

        function renderOnboardingImageSummary() {
            const withImages = (currentClubProducts || []).filter(cp => (cp.image_urls || []).length > 0);
            const total = (currentClubProducts || []).length;
            const countEl = document.getElementById('onboard-image-count');
            const totalEl = document.getElementById('onboard-total-count');
            if (countEl) countEl.textContent = withImages.length;
            if (totalEl) totalEl.textContent = total;
        }

        function exportProductsCSV() {
            if (products.length === 0) {
                showToast('No products to export', 'error');
                return;
            }

            const headers = [
                'Product Code', 'Item Name', 'Category', 'Range', 
                'Youth Retail', 'Youth Partner', 'Adult Retail', 'Adult Partner',
                'Fit Type', 'Sizes', 'Weight (g)', 'Has Addons', 'Description'
            ];

            const rows = products.map(p => [
                p.product_code,
                p.item_name,
                p.category,
                p.range_name,
                p.youth_retail_price || '',
                p.youth_partner_price || '',
                p.adult_retail_price || '',
                p.adult_partner_price || '',
                p.fit_type,
                p.sizes,
                p.weight_grams,
                p.has_addons ? 'Yes' : 'No',
                p.description || ''
            ]);

            const csv = Papa.unparse({ fields: headers, data: rows });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${currentBrand.slug}_products_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();

            showToast('Products exported');
        }

        function showBulkDeleteModal() {
            if (products.length === 0) {
                showToast('No products to delete', 'error');
                return;
            }
            
            document.getElementById('bulk-delete-count').textContent = products.length;
            document.getElementById('bulk-delete-brand').textContent = currentBrand.name;
            document.getElementById('bulk-delete-confirm').value = '';
            document.getElementById('bulk-delete-modal').classList.remove('hide');
        }

        function hideBulkDeleteModal() {
            document.getElementById('bulk-delete-modal').classList.add('hide');
        }

        async function confirmBulkDelete() {
            const confirmText = document.getElementById('bulk-delete-confirm').value.trim();
            
            if (confirmText !== 'DELETE ALL') {
                showToast('Please type DELETE ALL to confirm', 'error');
                return;
            }

            showToast('Deleting all products...');

            const { error } = await supabase
                .from('products')
                .delete()
                .eq('brand_id', currentBrand.id);

            if (error) {
                showToast(error.message, 'error');
                return;
            }

            products = [];
            hideBulkDeleteModal();
            renderProductsTable();
            updateStats();
            showToast('All products deleted');
        }

        // =============================================
        // CLUB MOCK-UPS
        // =============================================
        let selectedClubId = null;

        function populateClubSelect() {
            // For backward compatibility with other sections
            const select = document.getElementById('club-select');
            if (select) {
                select.innerHTML = '<option value="">Select a club...</option>' +
                    clubs.map(c => `<option value="${c.id}">${c.name} (${c.suffix})</option>`).join('');
            }
            renderClubsList();
        }

        function renderClubsList() {
            const container = document.getElementById('clubs-list');
            const emptyEl = document.getElementById('clubs-empty');
            const loadingEl = document.getElementById('clubs-loading');
            
            if (!container) return;
            
            loadingEl?.classList.add('hide');

            if (clubs.length === 0) {
                container.innerHTML = '';
                emptyEl?.classList.remove('hide');
                return;
            }

            emptyEl?.classList.add('hide');
            
            container.innerHTML = clubs.map(club => {
                const imageCount = club.image_count || 0;
                const hasCollection = club.collection_image_url;
                
                return `
                <div class="club-card ${selectedClubId === club.id ? 'pulse-border border-brand-500' : ''}">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-lg bg-brand-500/10 flex items-center justify-center">
                            <span class="text-brand-400 font-bold text-sm">${club.suffix.substring(0, 2)}</span>
                        </div>
                        <div>
                            <p class="font-medium text-white">${club.name}</p>
                            <div class="flex items-center gap-2 mt-0.5">
                                <span class="text-gray-500 font-mono text-xs">${club.suffix}</span>
                                ${club.has_images ? '<span class="badge badge-success text-xs">Images</span>' : ''}
                                ${hasCollection ? '<span class="badge badge-info text-xs">Collection</span>' : ''}
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-2">
                        <button onclick="selectClubForUpload('${club.id}')" class="btn-primary text-sm py-2 px-4">
                            ${selectedClubId === club.id ? 'Selected' : 'Manage'}
                        </button>
                        <button onclick="deleteClub('${club.id}')" class="btn-secondary text-red-400 hover:text-red-300 p-2">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/></svg>
                        </button>
                    </div>
                </div>
            `}).join('');
        }

        function generateSuffix() {
            const name = document.getElementById('new-club-name').value.trim();
            const suffixInput = document.getElementById('generated-suffix');
            
            if (!name) {
                suffixInput.value = '';
                return;
            }

            const words = name.toUpperCase().split(/\s+/).filter(w => w.length > 0);
            let suffix = '';

            const lastWord = words[words.length - 1];
            if (lastWord === 'FC') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'FC';
            } else if (lastWord === 'AFC') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'AFC';
            } else if (lastWord === 'UNITED') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'UTD';
            } else if (lastWord === 'CITY') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'C';
            } else if (lastWord === 'TOWN') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'T';
            } else if (words.length > 1) {
                suffix = words.map(w => w[0]).join('');
            } else {
                suffix = name.substring(0, 4).toUpperCase();
            }

            suffixInput.value = suffix.substring(0, 6);
        }

        async function createClub() {
            const name = document.getElementById('new-club-name').value.trim();
            const suffix = document.getElementById('generated-suffix').value.trim().toUpperCase();
            const btn = document.getElementById('create-club-btn');

            if (!name) {
                showToast('Please enter a club name', 'error');
                return;
            }

            if (!suffix || suffix.length < 2) {
                showToast('Suffix must be at least 2 characters', 'error');
                return;
            }

            // Check for existing suffix
            const existing = clubs.find(c => c.suffix.toUpperCase() === suffix);
            if (existing) {
                showToast(`Suffix "${suffix}" already used by ${existing.name}`, 'error');
                return;
            }

            // Show loading state
            btn.disabled = true;
            btn.innerHTML = '<div class="spinner" style="width:16px;height:16px;border-width:2px;"></div><span>Creating...</span>';

            const { data, error } = await supabase
                .from('clubs')
                .insert({
                    brand_id: currentBrand.id,
                    name: name,
                    suffix: suffix
                })
                .select()
                .single();

            // Reset button
            btn.disabled = false;
            btn.innerHTML = '<svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg> Create Club';

            if (error) {
                showToast('Error: ' + error.message, 'error');
                return;
            }

            clubs.push(data);
            document.getElementById('new-club-name').value = '';
            document.getElementById('generated-suffix').value = '';
            renderClubsList();
            updateStats();
            showToast(`${name} created successfully`);
            
            // Auto-select the new club
            selectClubForUpload(data.id);
        }

        async function deleteClub(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;

            if (!confirm(`Delete "${club.name}"?\n\nThis will also delete all uploaded images.`)) return;

            // Delete images from storage
            const { data: images } = await supabase
                .from('club_images')
                .select('storage_path')
                .eq('club_id', clubId);

            if (images?.length > 0) {
                await supabase.storage
                    .from('club-images')
                    .remove(images.map(i => i.storage_path));
            }

            // Delete collection image if exists
            if (club.collection_image_url) {
                const urlParts = club.collection_image_url.split('/club-images/');
                if (urlParts.length > 1) {
                    await supabase.storage.from('club-images').remove([urlParts[1]]);
                }
            }

            const { error } = await supabase
                .from('clubs')
                .delete()
                .eq('id', clubId);

            if (error) {
                showToast(error.message, 'error');
                return;
            }

            clubs = clubs.filter(c => c.id !== clubId);
            if (selectedClubId === clubId) closeUploadSection();
            renderClubsList();
            updateStats();
            showToast('Club deleted');
        }

        function selectClubForUpload(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;

            selectedClubId = clubId;
            
            document.getElementById('selected-club-name').textContent = club.name;
            document.getElementById('selected-club-suffix').textContent = `(${club.suffix})`;
            document.getElementById('upload-section').classList.remove('hide');
            document.getElementById('images-section').classList.remove('hide');
            
            renderClubsList(); // Update selected state
            updateCollectionImageDisplay(club);
            loadClubImages();
            
            setTimeout(() => {
                document.getElementById('upload-section').scrollIntoView({ behavior: 'smooth', block: 'start' });
            }, 100);
        }

        function closeUploadSection() {
            selectedClubId = null;
            document.getElementById('upload-section').classList.add('hide');
            document.getElementById('images-section').classList.add('hide');
            renderClubsList();
        }

        function updateCollectionImageDisplay(club) {
            const emptyEl = document.getElementById('collection-image-empty');
            const previewEl = document.getElementById('collection-image-preview');
            const imgEl = document.getElementById('collection-image-img');
            const badgeEl = document.getElementById('collection-status-badge');
            
            if (club?.collection_image_url) {
                emptyEl?.classList.add('hide');
                previewEl?.classList.remove('hide');
                if (imgEl) imgEl.src = club.collection_image_url;
                if (badgeEl) {
                    badgeEl.className = 'badge badge-success';
                    badgeEl.textContent = '✓ Collection';
                }
            } else {
                emptyEl?.classList.remove('hide');
                previewEl?.classList.add('hide');
                if (badgeEl) {
                    badgeEl.className = 'badge badge-warning';
                    badgeEl.textContent = 'No collection';
                }
            }
        }

        async function deleteCollectionImage() {
            if (!selectedClubId) return;
            
            const club = clubs.find(c => c.id === selectedClubId);
            if (!club?.collection_image_url) return;

            // Delete from storage
            const urlParts = club.collection_image_url.split('/club-images/');
            if (urlParts.length > 1) {
                await supabase.storage.from('club-images').remove([urlParts[1]]);
            }

            // Update database
            await supabase
                .from('clubs')
                .update({ collection_image_url: null })
                .eq('id', selectedClubId);

            // Update local
            const idx = clubs.findIndex(c => c.id === selectedClubId);
            if (idx !== -1) clubs[idx].collection_image_url = null;

            updateCollectionImageDisplay(clubs[idx]);
            renderClubsList();
            showToast('Collection image deleted');
        }

        async function loadClubImages() {
            if (!selectedClubId) return;

            const grid = document.getElementById('images-grid');
            const countEl = document.getElementById('images-count');
            const countBadge = document.getElementById('images-count-badge');
            const loadingEl = document.getElementById('images-loading');
            const emptyEl = document.getElementById('images-empty');

            // Show loading
            loadingEl?.classList.remove('hide');
            emptyEl?.classList.add('hide');
            grid.innerHTML = '';

            const { data, error } = await supabase
                .from('club_images')
                .select('*, products(item_name, product_code)')
                .eq('club_id', selectedClubId);

            loadingEl?.classList.add('hide');

            if (error) {
                grid.innerHTML = '<p class="text-red-400 col-span-full text-center py-8">Error loading images</p>';
                return;
            }

            clubImages = data || [];
            if (countEl) countEl.textContent = clubImages.length;
            if (countBadge) countBadge.textContent = `${clubImages.length} image${clubImages.length !== 1 ? 's' : ''}`;

            if (clubImages.length === 0) {
                emptyEl?.classList.remove('hide');
                return;
            }

            grid.innerHTML = clubImages.map(img => `
                <div class="image-item">
                    <img src="${img.public_url}" alt="${img.file_name}" loading="lazy" 
                        onerror="this.parentElement.innerHTML='<div class=\\'flex items-center justify-center h-full text-gray-600 text-xs\\'>Error</div>'">
                    <div class="overlay">
                        <p class="text-xs text-white text-center px-2 mb-2 line-clamp-2">${img.products?.item_name || 'Unknown'}</p>
                        <button onclick="deleteClubImage('${img.id}')" class="text-red-400 hover:text-red-300 text-xs">Delete</button>
                    </div>
                </div>
            `).join('');
        }

        // Drag and drop handlers
        function handleDragOver(e) {
            e.preventDefault();
            e.currentTarget.classList.add('drag-over');
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        function handleDrop(e) {
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                document.getElementById('image-upload').files = files;
                handleImageUpload({ target: { files } });
            }
        }

        // Help tooltip
        function showNamingHelp(e) {
            e.stopPropagation();
            const tooltip = document.getElementById('naming-help-tooltip');
            tooltip.style.display = 'block';
            tooltip.classList.remove('hide');
            
            // Position near the button
            const rect = e.target.getBoundingClientRect();
            tooltip.style.top = (rect.bottom + 10) + 'px';
            tooltip.style.right = '20px';
        }

        function hideNamingHelp() {
            const tooltip = document.getElementById('naming-help-tooltip');
            tooltip.classList.add('hide');
            tooltip.style.display = 'none';
        }

        // Close tooltip when clicking outside
        document.addEventListener('click', (e) => {
            if (!e.target.closest('#naming-help-tooltip') && !e.target.closest('.help-trigger')) {
                hideNamingHelp();
            }
        });

        async function handleImageUpload(event) {
            const files = event.target.files;
            
            if (!selectedClubId || !files.length) {
                showToast('Please select a club first', 'error');
                return;
            }

            const club = clubs.find(c => c.id === selectedClubId);
            if (!club) return;

            // Show progress
            const progressEl = document.getElementById('upload-progress');
            const progressBar = document.getElementById('upload-progress-bar');
            const statusText = document.getElementById('upload-status-text');
            const countText = document.getElementById('upload-count-text');
            
            progressEl.classList.remove('hide');
            progressBar.style.width = '0%';

            let uploaded = 0;
            let failed = 0;
            const total = files.length;

            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const progress = Math.round(((i + 1) / total) * 100);
                
                statusText.textContent = `Uploading ${file.name}...`;
                countText.textContent = `${i + 1}/${total}`;
                progressBar.style.width = `${progress}%`;

                const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '').toLowerCase();
                
                // Collection image
                if (nameWithoutExt === 'collection-image') {
                    try {
                        const storagePath = `${currentBrand.slug}/${club.suffix}/collection-image${file.name.substring(file.name.lastIndexOf('.'))}`;
                        
                        const { error: uploadError } = await supabase.storage
                            .from('club-images')
                            .upload(storagePath, file, { upsert: true });

                        if (!uploadError) {
                            const { data: urlData } = supabase.storage
                                .from('club-images')
                                .getPublicUrl(storagePath);

                            await supabase
                                .from('clubs')
                                .update({ collection_image_url: urlData.publicUrl })
                                .eq('id', selectedClubId);

                            const clubIdx = clubs.findIndex(c => c.id === selectedClubId);
                            if (clubIdx !== -1) clubs[clubIdx].collection_image_url = urlData.publicUrl;
                            
                            updateCollectionImageDisplay(clubs[clubIdx]);
                            uploaded++;
                        } else {
                            failed++;
                        }
                    } catch (err) {
                        failed++;
                    }
                    continue;
                }

                // Product image
                const productCode = nameWithoutExt.replace(/-/g, '/').toUpperCase();
                const product = products.find(p => p.product_code.toUpperCase() === productCode);
                
                if (!product) {
                    showToast(`No product: ${nameWithoutExt}`, 'error');
                    failed++;
                    continue;
                }

                try {
                    const storagePath = `${currentBrand.slug}/${club.suffix}/${file.name}`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('club-images')
                        .upload(storagePath, file, { upsert: true });

                    if (uploadError) {
                        failed++;
                        continue;
                    }

                    const { data: urlData } = supabase.storage
                        .from('club-images')
                        .getPublicUrl(storagePath);

                    await supabase
                        .from('club_images')
                        .upsert({
                            club_id: selectedClubId,
                            product_id: product.id,
                            file_name: file.name,
                            storage_path: storagePath,
                            public_url: urlData.publicUrl,
                            uploaded_by: currentUser.id
                        }, { onConflict: 'club_id,product_id' });

                    uploaded++;
                } catch (err) {
                    failed++;
                }
            }

            // Update club has_images
            if (uploaded > 0) {
                await supabase
                    .from('clubs')
                    .update({ has_images: true })
                    .eq('id', selectedClubId);

                const clubIdx = clubs.findIndex(c => c.id === selectedClubId);
                if (clubIdx !== -1) clubs[clubIdx].has_images = true;
                renderClubsList();
            }

            // Complete
            statusText.textContent = 'Complete!';
            progressBar.style.width = '100%';
            
            setTimeout(() => {
                progressEl.classList.add('hide');
            }, 1500);

            loadClubImages();
            event.target.value = '';

            if (failed > 0) {
                showToast(`${uploaded} uploaded, ${failed} failed`, uploaded > 0 ? 'success' : 'error');
            } else {
                showToast(`${uploaded} images uploaded`);
            }
        }

        async function deleteClubImage(imageId) {
            const image = clubImages.find(i => i.id === imageId);
            if (!image) return;

            await supabase.storage
                .from('club-images')
                .remove([image.storage_path]);

            await supabase
                .from('club_images')
                .delete()
                .eq('id', imageId);

            // Check remaining images
            const { count } = await supabase
                .from('club_images')
                .select('*', { count: 'exact', head: true })
                .eq('club_id', selectedClubId);

            if (count === 0) {
                await supabase
                    .from('clubs')
                    .update({ has_images: false })
                    .eq('id', selectedClubId);

                const clubIdx = clubs.findIndex(c => c.id === selectedClubId);
                if (clubIdx !== -1) clubs[clubIdx].has_images = false;
                renderClubsList();
            }

            loadClubImages();
            showToast('Image deleted');
        }

        // =============================================
        // STORE GENERATOR
        // =============================================
        let clubsWithImages = [];

        function populateGeneratorSelects() {
            // Salespeople
            const spSelect = document.getElementById('gen-salesperson');
            spSelect.innerHTML = '<option value="">Select salesperson...</option>' +
                salespeople.map(s => `<option value="${s.id}">${s.first_name} ${s.last_name}</option>`).join('');

            // Clubs with images - for searchable dropdown
            clubsWithImages = clubs.filter(c => c.has_images);
            
            // Clear any previous selection
            document.getElementById('gen-club').value = '';
            document.getElementById('gen-club-search').value = '';
            document.getElementById('gen-preview').classList.add('hide');
            
            // Populate the dropdown
            renderClubDropdown(clubsWithImages);
        }

        function renderClubDropdown(filteredClubs) {
            const dropdown = document.getElementById('gen-club-dropdown');
            
            if (filteredClubs.length === 0) {
                dropdown.innerHTML = '<div class="px-4 py-3 text-gray-500 text-sm">No clubs with images found</div>';
                return;
            }
            
            dropdown.innerHTML = filteredClubs.map(c => `
                <div class="px-4 py-3 hover:bg-gray-700 cursor-pointer flex justify-between items-center" onclick="selectClub('${c.id}')">
                    <div>
                        <span class="text-white">${c.name}</span>
                        <span class="text-brand-400 font-mono text-sm ml-2">${c.suffix}</span>
                    </div>
                </div>
            `).join('');
        }

        function filterClubDropdown() {
            const search = document.getElementById('gen-club-search').value.toLowerCase();
            const filtered = clubsWithImages.filter(c => 
                c.name.toLowerCase().includes(search) || 
                c.suffix.toLowerCase().includes(search)
            );
            renderClubDropdown(filtered);
            showClubDropdown();
        }

        function showClubDropdown() {
            document.getElementById('gen-club-dropdown').classList.remove('hide');
        }

        function hideClubDropdown() {
            setTimeout(() => {
                document.getElementById('gen-club-dropdown').classList.add('hide');
            }, 200);
        }

        function selectClub(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;
            
            document.getElementById('gen-club').value = clubId;
            document.getElementById('gen-club-search').value = `${club.name} (${club.suffix})`;
            document.getElementById('gen-club-dropdown').classList.add('hide');
            
            loadClubProducts();
        }

        async function loadClubProducts() {
            const clubId = document.getElementById('gen-club').value;
            const preview = document.getElementById('gen-preview');

            if (!clubId) {
                preview.classList.add('hide');
                return;
            }

            const club = clubs.find(c => c.id === clubId);

            const { data } = await supabase
                .from('club_images')
                .select('product_id')
                .eq('club_id', clubId);

            document.getElementById('gen-product-count').textContent = data?.length || 0;
            document.getElementById('gen-selected-club').textContent = club?.name || '-';
            document.getElementById('gen-collection-name').textContent = club?.name || '-';
            
            // Show collection image status
            const collectionImageInfo = document.getElementById('gen-collection-image-info');
            if (collectionImageInfo) {
                if (club?.collection_image_url) {
                    collectionImageInfo.innerHTML = `<span class="text-green-400">✓ Collection image ready</span>`;
                } else {
                    collectionImageInfo.innerHTML = `<span class="text-yellow-400">⚠ No collection image uploaded</span>`;
                }
            }
            
            preview.classList.remove('hide');
        }

        async function generateShopifyCSV() {
            const salespersonId = document.getElementById('gen-salesperson').value;
            const clubId = document.getElementById('gen-club').value;

            if (!salespersonId || !clubId) {
                showToast('Please select salesperson and club', 'error');
                return;
            }

            const club = clubs.find(c => c.id === clubId);
            const salesperson = salespeople.find(s => s.id === salespersonId);

            // Get club images with products
            const { data: images } = await supabase
                .from('club_images')
                .select('*, products(*)')
                .eq('club_id', clubId);

            if (!images?.length) {
                showToast('No products with images found', 'error');
                return;
            }

            // CSV Headers - Shopify required format
            const headers = [
                'Title', 'URL handle', 'Description', 'Vendor', 'Product category', 'Type',
                'Tags', 'Published on online store', 'Status', 'Collection', 'SKU', 'Barcode',
                'Option1 name', 'Option1 value', 'Option2 name', 'Option2 value',
                'Option3 name', 'Option3 value', 'Price', 'Compare-at price', 'Cost per item',
                'Charge tax', 'Tax code', 'Inventory policy', 'Inventory tracker',
                'Inventory quantity', 'Continue selling when out of stock', 'Weight value (grams)',
                'Weight unit for display', 'Requires shipping', 'Fulfillment service',
                'Product image URL', 'Image position', 'Image alt text', 'Variant image URL',
                'Gift card', 'SEO title', 'SEO description', 'Google Shopping / Google product category',
                'Google Shopping / Gender', 'Google Shopping / Age group', 'Google Shopping / MPN',
                'Google Shopping / AdWords Grouping', 'Google Shopping / AdWords labels',
                'Google Shopping / Condition', 'Google Shopping / Custom product',
                'Google Shopping / Custom label 0', 'Google Shopping / Custom label 1',
                'Google Shopping / Custom label 2', 'Google Shopping / Custom label 3',
                'Google Shopping / Custom label 4'
            ];

            const rows = [];

            for (const img of images) {
                const product = img.products;
                if (!product) continue;

                // Parse sizes
                const sizes = product.sizes?.split(',').map(s => s.trim()) || [];
                const youthSizes = sizes.filter(s => s.startsWith('Y'));
                const adultSizes = sizes.filter(s => !s.startsWith('Y') && s !== 'One Size');

                // Build description - just replace placeholders and format for HTML
                let description = product.description || '';
                description = description
                    .replace(/\*ADD CLUB NAME \+ RANGE\*/g, `${club.name} ${product.range_name}`)
                    .replace(/\*ADD CLUB \+ RANGE\*/g, `${club.name} ${product.range_name}`)
                    .replace(/\*ADD CLUB NAME\*/g, club.name);
                // Convert line breaks to paragraphs for HTML
                description = description.split(/\n+/).filter(p => p.trim()).map(p => `<p>${p.trim()}</p>`).join('');

                // Build tags
                const tags = [
                    club.name,
                    `${salesperson.first_name}-${salesperson.last_name}`.toLowerCase(),
                    product.range_name,
                    product.category
                ];
                if (product.has_addons) {
                    tags.push('apx-with-addons');
                }

                // URL handle
                const handle = `${club.name.toLowerCase().replace(/[^a-z0-9]+/g, '-')}-${product.range_name.toLowerCase()}-${product.item_name.toLowerCase().replace(/[^a-z0-9]+/g, '-')}`;

                // Product title
                const title = `${club.name} ${product.item_name}`;

                // Generate rows for each variant
                let variantIndex = 0;
                
                if (product.is_single_price) {
                    // Single price item (accessories) - just one size option
                    const row = {
                        'Title': title,
                        'URL handle': handle,
                        'Description': description,
                        'Vendor': currentBrand.name,
                        'Product category': 'Apparel & Accessories > Clothing',
                        'Type': product.category,
                        'Tags': tags.join(','),
                        'Published on online store': 'TRUE',
                        'Status': 'active',
                        'Collection': club.name,
                        'SKU': `${product.product_code}/${club.suffix}-OS`,
                        'Barcode': '',
                        'Option1 name': 'Size',
                        'Option1 value': 'One Size',
                        'Option2 name': '',
                        'Option2 value': '',
                        'Option3 name': '',
                        'Option3 value': '',
                        'Price': product.single_retail_price?.toFixed(2) || '',
                        'Compare-at price': '',
                        'Cost per item': '',
                        'Charge tax': 'FALSE',
                        'Tax code': '',
                        'Inventory policy': 'continue',
                        'Inventory tracker': 'shopify',
                        'Inventory quantity': '0',
                        'Continue selling when out of stock': 'TRUE',
                        'Weight value (grams)': product.weight_grams || '450',
                        'Weight unit for display': 'g',
                        'Requires shipping': 'TRUE',
                        'Fulfillment service': 'manual',
                        'Product image URL': img.public_url,
                        'Image position': '1',
                        'Image alt text': title,
                        'Variant image URL': '',
                        'Gift card': 'FALSE',
                        'SEO title': `${title} | Official ${club.name} Merchandise`,
                        'SEO description': `Shop the official ${title}. Premium quality teamwear.`,
                        'Google Shopping / Google product category': 'Apparel & Accessories > Clothing',
                        'Google Shopping / Gender': 'Unisex',
                        'Google Shopping / Age group': 'Adult',
                        'Google Shopping / MPN': `${product.product_code}/${club.suffix}-OS`,
                        'Google Shopping / AdWords Grouping': 'Teamwear',
                        'Google Shopping / AdWords labels': '',
                        'Google Shopping / Condition': 'new',
                        'Google Shopping / Custom product': 'FALSE',
                        'Google Shopping / Custom label 0': club.name,
                        'Google Shopping / Custom label 1': product.range_name,
                        'Google Shopping / Custom label 2': product.category,
                        'Google Shopping / Custom label 3': '',
                        'Google Shopping / Custom label 4': ''
                    };
                    rows.push(row);
                } else {
                    // Products with Youth and Adult sizes - use Fit as Option1, Size as Option2
                    // Keep original size labels (YXXS, YXS, etc.) for clarity
                    
                    // Generate Youth variants first
                    youthSizes.forEach((size, idx) => {
                        const sku = `${product.product_code}/${club.suffix}-${size}`;
                        const isFirst = variantIndex === 0;
                        
                        const row = {
                            'Title': isFirst ? title : '',
                            'URL handle': handle,
                            'Description': isFirst ? description : '',
                            'Vendor': isFirst ? currentBrand.name : '',
                            'Product category': isFirst ? 'Apparel & Accessories > Clothing' : '',
                            'Type': isFirst ? product.category : '',
                            'Tags': isFirst ? tags.join(',') : '',
                            'Published on online store': isFirst ? 'TRUE' : '',
                            'Status': 'active',
                            'Collection': isFirst ? club.name : '',
                            'SKU': sku,
                            'Barcode': '',
                            'Option1 name': 'Fit',
                            'Option1 value': 'Youth',
                            'Option2 name': 'Size',
                            'Option2 value': size,
                            'Option3 name': '',
                            'Option3 value': '',
                            'Price': product.youth_retail_price?.toFixed(2) || '',
                            'Compare-at price': '',
                            'Cost per item': '',
                            'Charge tax': 'FALSE',
                            'Tax code': '',
                            'Inventory policy': 'continue',
                            'Inventory tracker': 'shopify',
                            'Inventory quantity': '0',
                            'Continue selling when out of stock': 'TRUE',
                            'Weight value (grams)': product.weight_grams || '450',
                            'Weight unit for display': 'g',
                            'Requires shipping': 'TRUE',
                            'Fulfillment service': 'manual',
                            'Product image URL': isFirst ? img.public_url : '',
                            'Image position': isFirst ? '1' : '',
                            'Image alt text': isFirst ? title : '',
                            'Variant image URL': '',
                            'Gift card': 'FALSE',
                            'SEO title': isFirst ? `${title} | Official ${club.name} Merchandise` : '',
                            'SEO description': isFirst ? `Shop the official ${title}. Premium quality teamwear.` : '',
                            'Google Shopping / Google product category': 'Apparel & Accessories > Clothing',
                            'Google Shopping / Gender': 'Unisex',
                            'Google Shopping / Age group': 'Kids',
                            'Google Shopping / MPN': sku,
                            'Google Shopping / AdWords Grouping': 'Teamwear',
                            'Google Shopping / AdWords labels': '',
                            'Google Shopping / Condition': 'new',
                            'Google Shopping / Custom product': 'FALSE',
                            'Google Shopping / Custom label 0': club.name,
                            'Google Shopping / Custom label 1': product.range_name,
                            'Google Shopping / Custom label 2': product.category,
                            'Google Shopping / Custom label 3': '',
                            'Google Shopping / Custom label 4': ''
                        };
                        rows.push(row);
                        variantIndex++;
                    });
                    
                    // Generate Adult variants
                    adultSizes.forEach((size, idx) => {
                        const sku = `${product.product_code}/${club.suffix}-${size}`;
                        const isFirst = variantIndex === 0;
                        
                        const row = {
                            'Title': isFirst ? title : '',
                            'URL handle': handle,
                            'Description': isFirst ? description : '',
                            'Vendor': isFirst ? currentBrand.name : '',
                            'Product category': isFirst ? 'Apparel & Accessories > Clothing' : '',
                            'Type': isFirst ? product.category : '',
                            'Tags': isFirst ? tags.join(',') : '',
                            'Published on online store': isFirst ? 'TRUE' : '',
                            'Status': 'active',
                            'Collection': isFirst ? club.name : '',
                            'SKU': sku,
                            'Barcode': '',
                            'Option1 name': 'Fit',
                            'Option1 value': 'Adult',
                            'Option2 name': 'Size',
                            'Option2 value': size,
                            'Option3 name': '',
                            'Option3 value': '',
                            'Price': product.adult_retail_price?.toFixed(2) || '',
                            'Compare-at price': '',
                            'Cost per item': '',
                            'Charge tax': 'TRUE',
                            'Tax code': '',
                            'Inventory policy': 'continue',
                            'Inventory tracker': 'shopify',
                            'Inventory quantity': '0',
                            'Continue selling when out of stock': 'TRUE',
                            'Weight value (grams)': product.weight_grams || '450',
                            'Weight unit for display': 'g',
                            'Requires shipping': 'TRUE',
                            'Fulfillment service': 'manual',
                            'Product image URL': isFirst ? img.public_url : '',
                            'Image position': isFirst ? '1' : '',
                            'Image alt text': isFirst ? title : '',
                            'Variant image URL': '',
                            'Gift card': 'FALSE',
                            'SEO title': isFirst ? `${title} | Official ${club.name} Merchandise` : '',
                            'SEO description': isFirst ? `Shop the official ${title}. Premium quality teamwear.` : '',
                            'Google Shopping / Google product category': 'Apparel & Accessories > Clothing',
                            'Google Shopping / Gender': 'Unisex',
                            'Google Shopping / Age group': 'Adult',
                            'Google Shopping / MPN': sku,
                            'Google Shopping / AdWords Grouping': 'Teamwear',
                            'Google Shopping / AdWords labels': '',
                            'Google Shopping / Condition': 'new',
                            'Google Shopping / Custom product': 'FALSE',
                            'Google Shopping / Custom label 0': club.name,
                            'Google Shopping / Custom label 1': product.range_name,
                            'Google Shopping / Custom label 2': product.category,
                            'Google Shopping / Custom label 3': '',
                            'Google Shopping / Custom label 4': ''
                        };
                        rows.push(row);
                        variantIndex++;
                    });
                }
            }

            // Generate CSV
            const csv = Papa.unparse({
                fields: headers,
                data: rows.map(row => headers.map(h => row[h] || ''))
            });

            // Download
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${club.suffix}_shopify_products.csv`;
            a.click();

            // Save to generated stores
            await supabase.from('generated_stores').insert({
                brand_id: currentBrand.id,
                club_id: clubId,
                salesperson_id: salespersonId,
                products_count: images.length,
                generated_by: currentUser.id
            });

            showToast(`CSV generated with ${images.length} products`);
        }

        // =============================================
        // FACTORY ORDERS
        // =============================================
        function populateOrderSelects() {
            const clubSelect = document.getElementById('order-club');
            clubSelect.innerHTML = '<option value="">Select club...</option>' +
                '<option value="new">+ Create New Club</option>' +
                clubs.map(c => `<option value="${c.id}">${c.name} (${c.suffix})</option>`).join('');

            document.getElementById('order-po').value = `APX/PO-${String(poSequence).padStart(3, '0')}`;
        }

        function updateOrderClub() {
            const clubId = document.getElementById('order-club').value;
            
            if (clubId === 'new') {
                const name = prompt('Enter new club name:');
                if (name) {
                    createOrderClub(name);
                }
                return;
            }

            const club = clubs.find(c => c.id === clubId);
            document.getElementById('order-suffix').value = club?.suffix || '';
        }

        async function createOrderClub(name) {
            const words = name.toUpperCase().split(/\s+/);
            let suffix = '';

            if (words[words.length - 1] === 'FC') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'FC';
            } else if (words[words.length - 1] === 'AFC') {
                suffix = words.slice(0, -1).map(w => w[0]).join('') + 'AFC';
            } else if (words.length > 1) {
                suffix = words.map(w => w[0]).join('');
            } else {
                suffix = name.substring(0, 4).toUpperCase();
            }

            const { data, error } = await supabase
                .from('clubs')
                .insert({
                    brand_id: currentBrand.id,
                    name: name,
                    suffix: suffix
                })
                .select()
                .single();

            if (!error) {
                clubs.push(data);
                populateOrderSelects();
                document.getElementById('order-club').value = data.id;
                document.getElementById('order-suffix').value = suffix;
                showToast(`Club "${name}" created`);
            }
        }

        function initOrderForm() {
            orderLines = [];
            document.getElementById('order-lines').innerHTML = '';
            addOrderLine();
        }

        function addOrderLine() {
            const lineId = Date.now();
            orderLines.push({
                id: lineId,
                productId: '',
                range: '',
                fit: 'Youth',
                size: '',
                quantity: 1,
                customType: 'none',
                customValue: ''
            });

            const container = document.getElementById('order-lines');
            const lineHtml = `
                <div id="line-${lineId}" class="glass rounded-xl p-4">
                    <div class="grid grid-cols-6 gap-3 mb-3">
                        <select onchange="updateLineRange(${lineId}, this.value)" class="px-3 py-2 rounded-lg text-sm">
                            <option value="">Range...</option>
                            ${getUniqueRanges().map(r => `<option value="${r}">${r}</option>`).join('')}
                        </select>
                        <select id="line-product-${lineId}" onchange="updateLineProduct(${lineId}, this.value)" class="px-3 py-2 rounded-lg text-sm col-span-2">
                            <option value="">Select product...</option>
                        </select>
                        <select onchange="updateLineFit(${lineId}, this.value)" class="px-3 py-2 rounded-lg text-sm">
                            <option value="Youth">Youth</option>
                            <option value="Adult">Adult</option>
                        </select>
                        <select id="line-size-${lineId}" onchange="updateLineSize(${lineId}, this.value)" class="px-3 py-2 rounded-lg text-sm">
                            <option value="">Size...</option>
                        </select>
                        <input type="number" min="1" value="1" onchange="updateLineQty(${lineId}, this.value)" class="px-3 py-2 rounded-lg text-sm text-center">
                    </div>
                    <div class="flex items-center gap-3">
                        <select onchange="updateLineCustom(${lineId}, this.value)" class="px-3 py-2 rounded-lg text-sm">
                            <option value="none">No Customisation</option>
                            <option value="initials">Initials</option>
                            <option value="number">Number</option>
                            <option value="name">Name + Number</option>
                        </select>
                        <input type="text" id="line-custom-${lineId}" placeholder="Custom value..." class="flex-1 px-3 py-2 rounded-lg text-sm hide" onchange="updateLineCustomValue(${lineId}, this.value)">
                        <span id="line-total-${lineId}" class="text-brand-400 font-semibold">£0.00</span>
                        <button onclick="removeLine(${lineId})" class="text-red-400 hover:text-red-300 px-2">✕</button>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', lineHtml);
        }

        function getUniqueRanges() {
            return [...new Set(products.map(p => p.range_name))].sort();
        }

        function updateLineRange(lineId, range) {
            const line = orderLines.find(l => l.id === lineId);
            line.range = range;
            
            const productSelect = document.getElementById(`line-product-${lineId}`);
            const rangeProducts = products.filter(p => p.range_name === range);
            productSelect.innerHTML = '<option value="">Select product...</option>' +
                rangeProducts.map(p => `<option value="${p.id}">${p.item_name} - ${p.product_code}</option>`).join('');
        }

        function updateLineProduct(lineId, productId) {
            const line = orderLines.find(l => l.id === lineId);
            line.productId = productId;
            updateLineSizes(lineId);
            recalculateOrder();
        }

        function updateLineFit(lineId, fit) {
            const line = orderLines.find(l => l.id === lineId);
            line.fit = fit;
            updateLineSizes(lineId);
            recalculateOrder();
        }

        function updateLineSizes(lineId) {
            const line = orderLines.find(l => l.id === lineId);
            const product = products.find(p => p.id === line.productId);
            const sizeSelect = document.getElementById(`line-size-${lineId}`);
            
            if (!product) {
                sizeSelect.innerHTML = '<option value="">Size...</option>';
                return;
            }

            const allSizes = product.sizes?.split(',').map(s => s.trim()) || [];
            let sizes;
            
            if (line.fit === 'Youth') {
                sizes = allSizes.filter(s => s.startsWith('Y'));
            } else {
                sizes = allSizes.filter(s => !s.startsWith('Y') && s !== 'One Size');
            }

            if (product.is_single_price) {
                sizes = ['One Size'];
            }

            sizeSelect.innerHTML = '<option value="">Size...</option>' +
                sizes.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        function updateLineSize(lineId, size) {
            const line = orderLines.find(l => l.id === lineId);
            line.size = size;
            recalculateOrder();
        }

        function updateLineQty(lineId, qty) {
            const line = orderLines.find(l => l.id === lineId);
            line.quantity = parseInt(qty) || 1;
            recalculateOrder();
        }

        function updateLineCustom(lineId, customType) {
            const line = orderLines.find(l => l.id === lineId);
            line.customType = customType;
            
            const input = document.getElementById(`line-custom-${lineId}`);
            if (customType !== 'none') {
                input.classList.remove('hide');
                input.placeholder = customType === 'initials' ? 'e.g. JKS' : customType === 'number' ? 'e.g. 10' : 'e.g. Smith 7, Jones 10';
            } else {
                input.classList.add('hide');
            }
        }

        function updateLineCustomValue(lineId, value) {
            const line = orderLines.find(l => l.id === lineId);
            line.customValue = value;
        }

        function removeLine(lineId) {
            orderLines = orderLines.filter(l => l.id !== lineId);
            document.getElementById(`line-${lineId}`)?.remove();
            recalculateOrder();
        }

        function recalculateOrder() {
            const pricing = document.getElementById('order-pricing').value;
            let subtotal = 0;
            let vatAmount = 0;

            for (const line of orderLines) {
                const product = products.find(p => p.id === line.productId);
                if (!product || !line.size) continue;

                let price;
                if (product.is_single_price) {
                    price = pricing === 'partner' ? product.single_partner_price : product.single_retail_price;
                } else if (line.fit === 'Youth') {
                    price = pricing === 'partner' ? product.youth_partner_price : product.youth_retail_price;
                } else {
                    price = pricing === 'partner' ? product.adult_partner_price : product.adult_retail_price;
                }

                const lineTotal = (price || 0) * line.quantity;
                subtotal += lineTotal;

                // VAT only on adult
                if (line.fit === 'Adult' && !product.is_single_price) {
                    vatAmount += lineTotal * 0.2;
                }

                // Update line total display
                const totalEl = document.getElementById(`line-total-${line.id}`);
                if (totalEl) totalEl.textContent = `£${lineTotal.toFixed(2)}`;
            }

            document.getElementById('order-subtotal').textContent = `£${subtotal.toFixed(2)}`;
            document.getElementById('order-vat').textContent = `£${vatAmount.toFixed(2)}`;
            document.getElementById('order-total').textContent = `£${(subtotal + vatAmount).toFixed(2)}`;
        }

        async function generateOrderPDF() {
            const clubId = document.getElementById('order-club').value;
            const suffix = document.getElementById('order-suffix').value;
            const poNumber = document.getElementById('order-po').value;

            if (!clubId || clubId === 'new') {
                showToast('Please select a club', 'error');
                return;
            }

            const club = clubs.find(c => c.id === clubId);
            const validLines = orderLines.filter(l => l.productId && l.size);

            if (!validLines.length) {
                showToast('Please add at least one product', 'error');
                return;
            }

            // Create PDF using jsPDF
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

            // Header
            doc.setFontSize(24);
            doc.setTextColor(20, 184, 166);
            doc.text('APX TEAMWEAR', 20, 25);

            doc.setFontSize(12);
            doc.setTextColor(100);
            doc.text('PURCHASE ORDER', 20, 35);

            doc.setFontSize(10);
            doc.setTextColor(50);
            doc.text(`PO Number: ${poNumber}`, 140, 25);
            doc.text(`Date: ${new Date().toLocaleDateString()}`, 140, 32);
            doc.text(`Club: ${club.name}`, 140, 39);
            doc.text(`Suffix: ${suffix}`, 140, 46);

            // Line items table
            const tableData = validLines.map(line => {
                const product = products.find(p => p.id === line.productId);
                return [
                    product?.product_code || '',
                    product?.item_name || '',
                    line.fit,
                    line.size,
                    line.quantity,
                    line.customType !== 'none' ? `${line.customType}: ${line.customValue}` : '-'
                ];
            });

            doc.autoTable({
                startY: 60,
                head: [['Code', 'Product', 'Fit', 'Size', 'Qty', 'Customisation']],
                body: tableData,
                theme: 'grid',
                headStyles: { fillColor: [20, 184, 166] },
                styles: { fontSize: 9 }
            });

            // Product summary
            const summaryY = doc.lastAutoTable.finalY + 15;
            doc.setFontSize(12);
            doc.setTextColor(20, 184, 166);
            doc.text('PRODUCT SUMMARY', 20, summaryY);

            const summary = {};
            for (const line of validLines) {
                const product = products.find(p => p.id === line.productId);
                const key = `${product?.product_code}-${line.size}`;
                if (!summary[key]) {
                    summary[key] = { code: product?.product_code, name: product?.item_name, size: line.size, qty: 0 };
                }
                summary[key].qty += line.quantity;
            }

            const summaryData = Object.values(summary).map(s => [s.code, s.name, s.size, s.qty]);
            
            doc.autoTable({
                startY: summaryY + 5,
                head: [['Code', 'Product', 'Size', 'Total Qty']],
                body: summaryData,
                theme: 'grid',
                headStyles: { fillColor: [100, 100, 100] },
                styles: { fontSize: 9 }
            });

            // Save PDF
            doc.save(`${poNumber.replace(/\//g, '-')}.pdf`);

            // Calculate totals
            const pricing = document.getElementById('order-pricing').value;
            let subtotal = 0;
            let vatAmount = 0;
            
            for (const line of validLines) {
                const product = products.find(p => p.id === line.productId);
                if (!product) continue;
                
                let price;
                if (product.is_single_price) {
                    price = pricing === 'partner' ? product.single_partner_price : product.single_retail_price;
                } else if (line.fit === 'Youth') {
                    price = pricing === 'partner' ? product.youth_partner_price : product.youth_retail_price;
                } else {
                    price = pricing === 'partner' ? product.adult_partner_price : product.adult_retail_price;
                }
                
                const lineTotal = (price || 0) * line.quantity;
                subtotal += lineTotal;
                
                if (line.fit === 'Adult' && !product.is_single_price) {
                    vatAmount += lineTotal * 0.2;
                }
            }

            // Save PO to database
            const { data: poData, error: poError } = await supabase
                .from('purchase_orders')
                .insert({
                    brand_id: currentBrand.id,
                    po_number: poNumber,
                    po_sequence: poSequence,
                    club_id: clubId,
                    club_name: club.name,
                    club_suffix: suffix,
                    pricing_type: pricing,
                    subtotal: subtotal,
                    vat_amount: vatAmount,
                    total: subtotal + vatAmount,
                    status: 'confirmed',
                    created_by: currentUser.id
                })
                .select()
                .single();

            if (poError) {
                showToast('Error saving order: ' + poError.message, 'error');
                return;
            }

            // Save PO lines to database
            const lineInserts = validLines.map((line, index) => {
                const product = products.find(p => p.id === line.productId);
                let price;
                if (product.is_single_price) {
                    price = pricing === 'partner' ? product.single_partner_price : product.single_retail_price;
                } else if (line.fit === 'Youth') {
                    price = pricing === 'partner' ? product.youth_partner_price : product.youth_retail_price;
                } else {
                    price = pricing === 'partner' ? product.adult_partner_price : product.adult_retail_price;
                }
                
                return {
                    purchase_order_id: poData.id,
                    product_id: line.productId,
                    product_code: product?.product_code || '',
                    product_name: product?.item_name || '',
                    range_name: product?.range_name || '',
                    fit: line.fit,
                    size: line.size,
                    quantity: line.quantity,
                    custom_type: line.customType,
                    custom_value: line.customValue || null,
                    unit_price: price || 0,
                    line_total: (price || 0) * line.quantity,
                    line_order: index + 1
                };
            });

            await supabase.from('purchase_order_lines').insert(lineInserts);

            poSequence++;
            showToast('Purchase order created and saved');
            
            // Reset form for next order
            initOrderForm();
            document.getElementById('order-po').value = `APX/PO-${String(poSequence).padStart(3, '0')}`;
        }

        // =============================================
        // INIT
        // =============================================
        async function init() {
            // Check for public order form URL (?form=TOKEN)
            const urlParams = new URLSearchParams(window.location.search);
            const formToken = urlParams.get('form');
            if (formToken) {
                document.getElementById('auth-screen').classList.add('hide');
                document.getElementById('public-form-view').classList.remove('hide');
                await loadPublicForm(formToken);
                return;
            }

            const { data: { session } } = await supabase.auth.getSession();

            if (session?.user) {
                try {
                    await initApp(session.user);
                } catch (err) {
                    console.error('Auto-login failed:', err);
                    _appInitialising = false;
                }
            }

            // Listen for auth changes
            supabase.auth.onAuthStateChange(async (event, session) => {
                if (event === 'SIGNED_IN' && session?.user) {
                    _appInitialising = false; // reset before each auth-state-driven init
                    await initApp(session.user);
                } else if (event === 'SIGNED_OUT') {
                    _appInitialising = false;
                    document.getElementById('main-app').classList.add('hide');
                    document.getElementById('auth-screen').classList.remove('hide');
                }
            });
        }

        // =============================================
        // NAVIGATION STACK
        // =============================================
        let navStack = [];

        function pushNav(ctx) {
            navStack.push(ctx);
        }

        function goBack() {
            const prev = navStack.pop();
            if (!prev) { showLaunchpad(); return; }
            switch (prev.type) {
                case 'launchpad':
                    showLaunchpad(); break;
                case 'tool':
                    showTool(prev.tool);
                    if (prev.tool === 'sales' && prev.view) setTimeout(() => showSalesView(prev.view), 0);
                    break;
                case 'job':
                    openJobRecord(prev.jobId); break;
                case 'club-detail':
                    openClubDashboard(prev.clubId); break;
                default:
                    showLaunchpad();
            }
        }

        function setClubDetailBackLabel(label) {
            const lbl = document.getElementById('club-detail-back-label');
            if (lbl) lbl.textContent = label;
        }

        // Open club from within a job record (pushes job record to stack)
        function openClubFromJob(clubId) {
            pushNav({ type: 'job', jobId: currentJobId, label: 'Back to Job' });
            setClubDetailBackLabel('Back to Job');
            openClubDashboard(clubId);
        }

        // =============================================
        // ENHANCED CLUBS STATE
        // =============================================
        let currentClub = null;
        let currentClubProducts = [];
        let currentOrderForms = [];
        let currentClubTab = 'overview';

        // =============================================
        // CLUBS: LIST VIEW
        // =============================================
        function renderClubsEnhanced(targetContainer) {
            const search = (document.getElementById('clubs-search')?.value || '').toLowerCase();
            const sportFilter = document.getElementById('clubs-filter-sport')?.value || '';
            const partnerFilter = document.getElementById('clubs-filter-partner')?.value || '';

            let filtered = clubs.filter(c => {
                if (viewScope === 'mine' && currentUser && c.created_by !== currentUser.id) return false;
                if (search && !c.name.toLowerCase().includes(search) && !(c.suffix || '').toLowerCase().includes(search) && !(c.address_county || '').toLowerCase().includes(search)) return false;
                if (sportFilter && c.sport !== sportFilter) return false;
                if (partnerFilter && (c.club_status || (c.is_partner ? 'partner' : 'retail')) !== partnerFilter) return false;
                return true;
            });

            const makeClubHtml = (club) => {
                const { tierName, badgeClass } = getClubTierDisplay(club);
                const sp = salespeople.find(s => s.id === club.assigned_salesperson_id);
                const ownerName = getUserDisplayName(club.created_by);
                return `<div class="club-list-card" onclick="openClubDashboard('${club.id}')">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-4">
                            <div class="w-11 h-11 rounded-xl flex items-center justify-center flex-shrink-0" style="background:rgba(20,184,166,0.08)">
                                <span class="text-brand-400 font-bold text-sm">${((club.suffix || club.name.substring(0,2))).substring(0,2)}</span>
                            </div>
                            <div>
                                <div class="flex items-center gap-2 flex-wrap">
                                    <span class="font-semibold text-white">${escHtml(club.name)}</span>
                                    <span class="badge ${badgeClass} text-xs">${escHtml(tierName)}</span>
                                    ${club.sport ? `<span class="badge badge-info text-xs">${escHtml(club.sport)}</span>` : ''}
                                </div>
                                <div class="flex items-center gap-3 mt-0.5">
                                    <span class="text-gray-600 font-mono text-xs">${escHtml(club.suffix || '')}</span>
                                    ${club.address_county ? `<span class="text-gray-500 text-xs">${escHtml(club.address_county)}</span>` : ''}
                                    ${sp ? `<span class="text-gray-500 text-xs">${escHtml(sp.first_name + ' ' + sp.last_name)}</span>` : (club.contact_name ? `<span class="text-gray-500 text-xs">${escHtml(club.contact_name)}</span>` : '')}
                                    ${ownerName !== '—' ? `<span class="text-gray-600 text-xs">Owner: ${escHtml(ownerName)}</span>` : ''}
                                </div>
                            </div>
                        </div>
                        <div class="flex items-center gap-2 flex-shrink-0">
                            ${club.has_images ? '<span class="badge badge-success text-xs">Images</span>' : ''}
                            ${club.shopify_collection_id ? '<span class="badge badge-info text-xs">Shopify ✓</span>' : ''}
                            <svg class="w-4 h-4 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </div>
                    </div>
                </div>`;
            };

            // Update recent list (all clubs)
            const recentList = document.getElementById('clubs-recent-list');
            if (recentList) {
                if (clubs.length === 0) {
                    recentList.innerHTML = `<div class="empty-state"><div class="empty-icon"><svg class="w-12 h-12 mx-auto text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M9 21V5.25A2.25 2.25 0 0111.25 3h1.5A2.25 2.25 0 0115 5.25V21m-6 0h6M3.75 21V10.5A2.25 2.25 0 016 8.25h.75M20.25 21V10.5a2.25 2.25 0 00-2.25-2.25H17.25"/></svg></div><p>No clubs yet. Create your first club above.</p></div>`;
                } else {
                    recentList.innerHTML = clubs.slice(0, 20).map(c => makeClubHtml(c)).join('');
                }
            }

            // Update search results if search is active
            const container = document.getElementById('clubs-enhanced-list');
            const emptyEl = document.getElementById('clubs-enhanced-empty');
            if (!container) return;
            if (!filtered.length) {
                container.innerHTML = '';
                emptyEl?.classList.remove('hide');
                return;
            }
            emptyEl?.classList.add('hide');
            container.innerHTML = filtered.map(c => makeClubHtml(c)).join('');
        }

        function showClubSearch() {
            const searchArea = document.getElementById('club-search-area');
            const recentArea = document.getElementById('clubs-recent');
            if (searchArea) searchArea.classList.remove('hide');
            if (recentArea) recentArea.classList.add('hide');
            document.getElementById('clubs-search')?.focus();
            renderClubsEnhanced();
        }

        async function generateShopifyCSVForClub(overrideClubId, priceList = 'shop') {
            const club = overrideClubId ? clubs.find(c => c.id === overrideClubId) : currentClub;
            if (!club) { showToast('No club selected', 'error'); return; }

            // Fetch club products with master product data
            let clubProds = currentClubProducts;
            if (overrideClubId && overrideClubId !== currentClub?.id) {
                const { data } = await supabase.from('club_products')
                    .select('*, products(*)')
                    .eq('club_id', overrideClubId).eq('is_active', true).order('created_at');
                clubProds = data || [];
            }

            // Only products that have mock-up images uploaded
            const productsWithImages = clubProds.filter(cp => (cp.image_urls || []).length > 0);
            if (!productsWithImages.length) {
                showToast('No products with images — upload mock-ups first.', 'error');
                return;
            }

            const headers = [
                'Title', 'URL handle', 'Description', 'Vendor', 'Product category', 'Type',
                'Tags', 'Published on online store', 'Status', 'Collection', 'SKU', 'Barcode',
                'Option1 name', 'Option1 value', 'Option2 name', 'Option2 value',
                'Option3 name', 'Option3 value', 'Price', 'Compare-at price', 'Cost per item',
                'Charge tax', 'Tax code', 'Inventory policy', 'Inventory tracker',
                'Inventory quantity', 'Continue selling when out of stock', 'Weight value (grams)',
                'Weight unit for display', 'Requires shipping', 'Fulfillment service',
                'Product image URL', 'Image position', 'Image alt text', 'Variant image URL',
                'Gift card', 'SEO title', 'SEO description'
            ];

            // Price helper: uses tier_prices[priceList] from the master product (no markup)
            function derivePrice(cp, mp, fit) {
                const tierPrices = (mp.tier_prices && typeof mp.tier_prices === 'object') ? mp.tier_prices : {};
                const tp = tierPrices[priceList] || {};

                if (mp.is_single_price) {
                    // Use tier price if available, otherwise fall back to legacy fields
                    if (tp.youth) return tp.youth;
                    if (priceList === 'retail') return mp.single_retail_price || 0;
                    return mp.single_partner_price || mp.single_retail_price || 0;
                }
                if (fit === 'Youth') {
                    if (tp.youth) return tp.youth;
                    if (priceList === 'retail') return mp.youth_retail_price || 0;
                    return mp.youth_partner_price || mp.youth_retail_price || 0;
                }
                if (fit === "Women's") {
                    if (tp.adult) return tp.adult;
                    const pp = mp.women_partner_price || mp.adult_partner_price || 0;
                    const rp = mp.women_retail_price || mp.adult_retail_price || 0;
                    return priceList === 'retail' ? rp : pp;
                }
                // Adult / Unisex
                if (tp.adult) return tp.adult || cp.web_price || 0;
                const pp = mp.adult_partner_price || 0, rp = mp.adult_retail_price || 0;
                return (priceList === 'retail' ? rp : pp) || cp.web_price || 0;
            }

            const rows = [];

            for (const cp of productsWithImages) {
                const mp = cp.products;
                if (!mp) continue;

                const imageUrls = cp.image_urls || [];
                const title = cp.custom_name || `${club.name} ${mp.item_name}`;
                const handle = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');

                let description = mp.description || '';
                description = description
                    .replace(/\*ADD CLUB NAME \+ RANGE\*/g, `${club.name} ${mp.range_name}`)
                    .replace(/\*ADD CLUB \+ RANGE\*/g, `${club.name} ${mp.range_name}`)
                    .replace(/\*ADD CLUB NAME\*/g, club.name);
                description = description.split(/\n+/).filter(p => p.trim()).map(p => `<p>${p.trim()}</p>`).join('');

                // Build tags: club name, range, category + any product shopify_tags + salesperson
                const tags = [club.name, mp.range_name, mp.category].filter(Boolean);
                const productTags = Array.isArray(mp.shopify_tags) ? mp.shopify_tags : (mp.shopify_tags ? JSON.parse(mp.shopify_tags) : []);
                tags.push(...productTags);
                // Add salesperson as tag (required for Shopify CSV upload routing)
                if (club.assigned_salesperson_id) {
                    const sp = salespeople.find(s => s.id === club.assigned_salesperson_id);
                    if (sp) tags.push(`salesperson-${sp.first_name}-${sp.last_name}`.toLowerCase().replace(/\s+/g, '-'));
                }
                // Legacy: keep has_addons for backward compat
                if (mp.has_addons) tags.push('with-addons');

                const chargeText = mp.is_taxable !== false ? 'TRUE' : 'FALSE';
                const cogs = mp.cogs ? Number(mp.cogs).toFixed(2) : '';

                // Determine fits
                const fits = (mp.available_fits || 'adult,youth').split(',').map(f => f.trim());
                const hasYouth = fits.includes('youth');
                const hasAdult = fits.includes('adult');
                const hasWomen = fits.includes('women');
                const multifit = (hasYouth ? 1 : 0) + (hasAdult ? 1 : 0) + (hasWomen ? 1 : 0) > 1;

                // Size arrays — use stored values, fall back to standard defaults
                let adultSizes = (mp.sizes || 'S,M,L,XL,2XL,3XL,4XL,5XL,6XL').split(',').map(s => s.trim()).filter(Boolean);
                let youthSizes = (mp.youth_sizes || 'YXXS,YXS,YS,YM,YL,YXL').split(',').map(s => s.trim()).filter(Boolean);
                if (!mp.youth_sizes && mp.sizes) {
                    // Legacy: if youth sizes not set separately, extract Y-prefixed from adult
                    const yFromAdult = adultSizes.filter(s => s.startsWith('Y'));
                    if (yFromAdult.length) {
                        youthSizes = yFromAdult;
                        adultSizes = adultSizes.filter(s => !s.startsWith('Y') && s !== 'One Size');
                    }
                }
                const womenSizes = (mp.women_sizes || '6,8,10,12,14,16,18,20,22,24,26').split(',').map(s => s.trim()).filter(Boolean);

                let variantIndex = 0;
                const buildRow = (fit, size, price, imgUrl, imgPos) => {
                    const sku = `${mp.product_code}/${club.suffix}-${size}`;
                    const isFirst = variantIndex === 0;
                    variantIndex++;
                    return {
                        'Title': isFirst ? title : '',
                        'URL handle': handle,
                        'Description': isFirst ? description : '',
                        'Vendor': isFirst ? (currentBrand?.name || '') : '',
                        'Product category': isFirst ? 'Apparel & Accessories > Clothing' : '',
                        'Type': isFirst ? mp.category : '',
                        'Tags': isFirst ? tags : '',
                        'Published on online store': isFirst ? 'TRUE' : '',
                        'Status': 'active',
                        'Collection': isFirst ? club.name : '',
                        'SKU': sku, 'Barcode': '',
                        'Option1 name': multifit ? 'Fit' : 'Size',
                        'Option1 value': multifit ? fit : size,
                        'Option2 name': multifit ? 'Size' : '',
                        'Option2 value': multifit ? size : '',
                        'Option3 name': '', 'Option3 value': '',
                        'Price': price > 0 ? Number(price).toFixed(2) : '',
                        'Compare-at price': '',
                        'Cost per item': cogs,
                        'Charge tax': chargeText, 'Tax code': '',
                        'Inventory policy': 'continue', 'Inventory tracker': 'shopify',
                        'Inventory quantity': '0', 'Continue selling when out of stock': 'TRUE',
                        'Weight value (grams)': mp.weight_grams || '450',
                        'Weight unit for display': 'g', 'Requires shipping': 'TRUE',
                        'Fulfillment service': 'manual',
                        'Product image URL': imgUrl || '',
                        'Image position': imgUrl ? String(imgPos) : '',
                        'Image alt text': imgUrl ? title : '',
                        'Variant image URL': '',
                        'Gift card': 'FALSE',
                        'SEO title': isFirst ? `${title} | Official ${club.name} Merchandise` : '',
                        'SEO description': isFirst ? `Shop the official ${title}. Premium quality teamwear.` : ''
                    };
                };

                if (mp.is_single_price || (!hasAdult && !hasYouth && !hasWomen)) {
                    const price = derivePrice(cp, mp, 'Adult');
                    rows.push(buildRow('One Size', 'OS', price, imageUrls[0] || '', 1));
                } else {
                    if (hasYouth && youthSizes.length) {
                        youthSizes.forEach(size => {
                            rows.push(buildRow('Youth', size, derivePrice(cp, mp, 'Youth'),
                                variantIndex === 1 ? (imageUrls[0] || '') : '', 1));
                        });
                    }
                    if (hasAdult && adultSizes.length) {
                        adultSizes.forEach(size => {
                            rows.push(buildRow('Adult', size, derivePrice(cp, mp, 'Adult'),
                                variantIndex === 1 ? (imageUrls[0] || '') : '', 1));
                        });
                    }
                    if (hasWomen && womenSizes.length) {
                        womenSizes.forEach(size => {
                            rows.push(buildRow("Women's", size, derivePrice(cp, mp, "Women's"),
                                variantIndex === 1 ? (imageUrls[0] || '') : '', 1));
                        });
                    }
                }

                // Additional images as extra rows
                imageUrls.slice(1).forEach((imgUrl, i) => {
                    rows.push({
                        'URL handle': handle,
                        'Product image URL': imgUrl,
                        'Image position': String(i + 2),
                        'Image alt text': title,
                        'Status': ''
                    });
                });
            }

            if (!rows.length) {
                showToast('Could not generate CSV — check club products have images and master product data', 'error');
                return;
            }

            const csv = Papa.unparse({ fields: headers, data: rows.map(row => headers.map(h => row[h] ?? '')) });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${club.suffix}_shopify_products.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`CSV downloaded — ${productsWithImages.length} product${productsWithImages.length !== 1 ? 's' : ''} (${priceList} pricing)`);
        }

        // =============================================
        // CLUBS: CREATE / EDIT MODAL
        // =============================================
        function populatePartnershipLevelSelect(selectedKey) {
            const sel = document.getElementById('club-status');
            if (!sel) return;
            sel.innerHTML = brandPricingTiers.map(t =>
                `<option value="${escHtml(t.tier_key)}" ${t.tier_key === selectedKey ? 'selected' : ''}>${escHtml(t.tier_name)}</option>`
            ).join('');
            if (!brandPricingTiers.length) {
                sel.innerHTML = '<option value="retail">Retail</option><option value="partner">Partner</option>';
            }
        }

        function populateSalespersonSelect(selectedId) {
            const sel = document.getElementById('club-salesperson-id');
            if (!sel) return;
            sel.innerHTML = '<option value="">Select salesperson...</option>' +
                salespeople.map(s => `<option value="${s.id}" ${s.id === selectedId ? 'selected' : ''}>${escHtml(s.first_name + ' ' + s.last_name)}</option>`).join('');
        }

        function syncHexInput(colorPickerId, hexInputId) {
            const picker = document.getElementById(colorPickerId);
            const hexInput = document.getElementById(hexInputId);
            if (picker && hexInput) hexInput.value = picker.value;
        }

        function syncColorPicker(hexInputId, colorPickerId) {
            const hexInput = document.getElementById(hexInputId);
            const picker = document.getElementById(colorPickerId);
            if (!hexInput || !picker) return;
            const val = hexInput.value.trim();
            if (/^#[0-9a-fA-F]{6}$/.test(val)) picker.value = val;
        }

        function showCreateClubModal() {
            document.getElementById('club-modal-title').textContent = 'Create New Club';
            document.getElementById('edit-club-id').value = '';
            ['club-name','club-suffix','club-slug','club-league','club-addr1','club-addr2',
             'club-town','club-county','club-postcode','club-contact-name','club-contact-email','club-contact-phone'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = '';
            });
            document.getElementById('club-sport').value = '';
            populatePartnershipLevelSelect('retail');
            populateSalespersonSelect(null);
            // Colours
            document.getElementById('club-pantone-main').value = '#14b8a6';
            document.getElementById('club-hex-main').value = '#14b8a6';
            document.getElementById('club-pantone-sec').value = '#ffffff';
            document.getElementById('club-hex-sec').value = '#ffffff';
            document.getElementById('club-pantone-acc').value = '#000000';
            document.getElementById('club-hex-acc').value = '#000000';
            document.getElementById('club-pantone-main-text').value = '';
            document.getElementById('club-pantone-sec-text').value = '';
            document.getElementById('club-pantone-acc-text').value = '';
            // Reset logo preview
            const logoPreview = document.getElementById('club-logo-preview');
            if (logoPreview) logoPreview.innerHTML = '<svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z"/></svg>';
            const logoExisting = document.getElementById('club-logo-url-existing');
            if (logoExisting) logoExisting.value = '';
            const suffixStatus = document.getElementById('suffix-status');
            if (suffixStatus) suffixStatus.textContent = '';
            document.getElementById('create-club-modal').classList.remove('hide');
        }

        function showEditClubModal() {
            if (!currentClub) return;
            document.getElementById('club-modal-title').textContent = 'Edit Club';
            document.getElementById('edit-club-id').value = currentClub.id;
            document.getElementById('club-name').value = currentClub.name || '';
            document.getElementById('club-suffix').value = currentClub.suffix || '';
            document.getElementById('club-sport').value = currentClub.sport || '';
            populatePartnershipLevelSelect(currentClub.club_status || (currentClub.is_partner ? 'partner' : 'retail'));
            populateSalespersonSelect(currentClub.assigned_salesperson_id || null);
            document.getElementById('club-slug').value = currentClub.slug || '';
            document.getElementById('club-league').value = currentClub.league || '';
            document.getElementById('club-addr1').value = currentClub.address_line1 || '';
            document.getElementById('club-addr2').value = currentClub.address_line2 || '';
            document.getElementById('club-town').value = currentClub.address_town || '';
            document.getElementById('club-county').value = currentClub.address_county || '';
            document.getElementById('club-postcode').value = currentClub.address_postcode || '';
            const mainColor = currentClub.pantone_main || '#14b8a6';
            const secColor = currentClub.pantone_secondary || '#ffffff';
            const accColor = currentClub.pantone_accent || '#000000';
            document.getElementById('club-pantone-main').value = mainColor;
            document.getElementById('club-hex-main').value = mainColor;
            document.getElementById('club-pantone-main-text').value = currentClub.pantone_main_code || '';
            document.getElementById('club-pantone-sec').value = secColor;
            document.getElementById('club-hex-sec').value = secColor;
            document.getElementById('club-pantone-sec-text').value = currentClub.pantone_sec_code || '';
            document.getElementById('club-pantone-acc').value = accColor;
            document.getElementById('club-hex-acc').value = accColor;
            document.getElementById('club-pantone-acc-text').value = currentClub.pantone_acc_code || '';
            document.getElementById('club-contact-name').value = currentClub.contact_name || '';
            document.getElementById('club-contact-email').value = currentClub.contact_email || '';
            document.getElementById('club-contact-phone').value = currentClub.contact_phone || '';
            const suffixStatus = document.getElementById('suffix-status');
            if (suffixStatus) { suffixStatus.textContent = '✓ Saved'; suffixStatus.className = 'absolute right-2 top-1/2 -translate-y-1/2 text-xs text-green-400'; }
            // Logo preview
            const logoSrc = currentClub.logo_url || currentClub.club_crest_url;
            const logoPreview = document.getElementById('club-logo-preview');
            const logoExisting = document.getElementById('club-logo-url-existing');
            if (logoPreview) logoPreview.innerHTML = logoSrc ? `<img src="${escHtml(logoSrc)}" class="w-full h-full object-contain rounded-xl">` : '<svg class="w-8 h-8 text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5m-18-18v18m10.5-18v18m6-13.5V21M6.75 6.75h.75m-.75 3h.75m-.75 3h.75m3-6h.75m-.75 3h.75m-.75 3h.75M6.75 21v-3.375c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21M3 3h12m-.75 4.5H21m-3.75 3.75h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008zm0 3h.008v.008h-.008v-.008z"/></svg>';
            if (logoExisting) logoExisting.value = logoSrc || '';
            document.getElementById('create-club-modal').classList.remove('hide');
        }

        function hideCreateClubModal() {
            document.getElementById('create-club-modal').classList.add('hide');
        }

        // Sport-specific suffix abbreviation rules
        const SPORT_SUFFIX_RULES = {
            // Football variants
            'FC': 'FC', 'AFC': 'AFC', 'F.C.': 'FC', 'A.F.C.': 'AFC',
            // Rugby
            'RFC': 'RFC', 'RUFC': 'RUFC', 'RFC.': 'RFC',
            // Cricket
            'CC': 'CC', 'C.C.': 'CC',
            // General
            'UNITED': 'UTD', 'UTD': 'UTD',
            'CITY': 'CTY', 'C': 'C',
            'TOWN': 'TWN', 'T': 'T',
            'ATHLETIC': 'ATH', 'ATHLETICS': 'ATH',
            'RANGERS': 'RNG', 'RANGERS': 'RNG',
            'ROVERS': 'RVR',
            'WANDERERS': 'WDR',
            'STANLEY': 'STN',
            'HOTSPUR': 'HTS',
            'ALBION': 'ALB',
            'ACADEMY': 'ACD',
            'SPORTS': 'SC',
            'SC': 'SC',
            'JUNIORS': 'JNR',
            'LADIES': 'LAD',
            'WOMEN': 'WOM',
            'YOUTH': 'YTH',
            'BASKETBALL': 'BBC',
            'BBC': 'BBC',
            'NETBALL': 'NBC',
            'NBC': 'NBC',
            'HOCKEY': 'HC',
            'HC': 'HC',
            'TENNIS': 'TC',
            'TC': 'TC',
        };

        function generateClubSuffix(name) {
            const words = name.toUpperCase().split(/\s+/).filter(w => w.length > 0);
            if (!words.length) return '';

            const lastWord = words[words.length - 1];
            const suffix = SPORT_SUFFIX_RULES[lastWord];

            let base = '';
            if (suffix) {
                // Use first letters of all words except the last, then append sport suffix
                const prefix = words.slice(0, -1).map(w => w[0]).join('');
                base = prefix + suffix;
            } else if (words.length > 1) {
                base = words.map(w => w[0]).join('');
            } else {
                base = name.substring(0, 4).toUpperCase();
            }

            return base.substring(0, 8);
        }

        async function generateClubSlugAndSuffix() {
            const name = document.getElementById('club-name').value.trim();
            if (!name) return;

            // Auto-generate suffix if empty
            const suffixEl = document.getElementById('club-suffix');
            if (!suffixEl.value) {
                const generated = generateClubSuffix(name);
                suffixEl.value = generated;
                await checkSuffixUniqueness();
            }

            // Auto-generate slug if empty
            const slugEl = document.getElementById('club-slug');
            if (!slugEl.value) {
                slugEl.value = name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '');
            }
        }

        async function checkSuffixUniqueness() {
            const suffixEl = document.getElementById('club-suffix');
            const statusEl = document.getElementById('suffix-status');
            const editClubId = document.getElementById('edit-club-id').value;
            const val = suffixEl.value.trim().toUpperCase();
            if (!val || val.length < 2) { statusEl.textContent = ''; return; }

            const existing = clubs.find(c => c.suffix && c.suffix.toUpperCase() === val && c.id !== editClubId);
            if (existing) {
                statusEl.textContent = 'In use';
                statusEl.className = 'absolute right-2 top-1/2 -translate-y-1/2 text-xs text-red-400';
                // Auto-increment: append a number
                let attempt = val, i = 2;
                while (clubs.find(c => c.suffix && c.suffix.toUpperCase() === attempt && c.id !== editClubId)) {
                    attempt = (val.length <= 6 ? val : val.substring(0, 6)) + i;
                    i++;
                }
                suffixEl.value = attempt;
                statusEl.textContent = 'Auto-adjusted';
                statusEl.className = 'absolute right-2 top-1/2 -translate-y-1/2 text-xs text-yellow-400';
            } else {
                statusEl.textContent = val ? '✓ Unique' : '';
                statusEl.className = 'absolute right-2 top-1/2 -translate-y-1/2 text-xs text-green-400';
            }
        }

        async function saveClubEnhanced() {
            const clubId = document.getElementById('edit-club-id').value;
            const name = document.getElementById('club-name').value.trim();
            const suffix = document.getElementById('club-suffix').value.trim().toUpperCase();
            const salespersonId = document.getElementById('club-salesperson-id')?.value || null;
            if (!name) { showToast('Club name is required', 'error'); return; }
            if (!suffix || suffix.length < 2) { showToast('Suffix must be at least 2 chars', 'error'); return; }
            if (!salespersonId) { showToast('Please assign a salesperson — this is required', 'error'); return; }
            if (!clubId) {
                const existing = clubs.find(c => c.suffix && c.suffix.toUpperCase() === suffix);
                if (existing) { showToast(`Suffix "${suffix}" already used by another club`, 'error'); return; }
            }
            const clubStatus = document.getElementById('club-status')?.value || 'retail';
            // Handle logo upload if a new file was selected
            let logoUrl = document.getElementById('club-logo-url-existing')?.value || null;
            const logoFile = document.getElementById('club-logo-upload')?.files[0];
            if (logoFile && currentBrand) {
                const ext = logoFile.name.substring(logoFile.name.lastIndexOf('.'));
                const sp = `${currentBrand.slug}/${suffix}/logo${ext}`;
                const { error: upErr } = await supabase.storage.from('club-images').upload(sp, logoFile, { upsert: true });
                if (!upErr) {
                    const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(sp);
                    logoUrl = urlData.publicUrl;
                }
            }
            // Determine is_partner from tier (any non-retail tier = partner)
            const selectedTier = brandPricingTiers.find(t => t.tier_key === clubStatus);
            const isPartner = clubStatus !== 'retail';
            const clubData = {
                brand_id: currentBrand.id, name, suffix,
                created_by: clubId ? undefined : (currentUser?.id || null),
                sport: document.getElementById('club-sport').value || null,
                slug: document.getElementById('club-slug').value.trim() || name.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                club_status: clubStatus,
                is_partner: isPartner,
                assigned_salesperson_id: salespersonId || null,
                league: document.getElementById('club-league')?.value.trim() || null,
                address_line1: document.getElementById('club-addr1')?.value.trim() || null,
                address_line2: document.getElementById('club-addr2')?.value.trim() || null,
                address_town: document.getElementById('club-town')?.value.trim() || null,
                address_county: document.getElementById('club-county')?.value.trim() || null,
                address_postcode: document.getElementById('club-postcode')?.value.trim() || null,
                pantone_main: document.getElementById('club-pantone-main')?.value || null,
                pantone_secondary: document.getElementById('club-pantone-sec')?.value || null,
                pantone_accent: document.getElementById('club-pantone-acc')?.value || null,
                pantone_main_code: document.getElementById('club-pantone-main-text')?.value.trim() || null,
                pantone_sec_code: document.getElementById('club-pantone-sec-text')?.value.trim() || null,
                pantone_acc_code: document.getElementById('club-pantone-acc-text')?.value.trim() || null,
                contact_name: document.getElementById('club-contact-name').value.trim() || null,
                contact_email: document.getElementById('club-contact-email').value.trim() || null,
                contact_phone: document.getElementById('club-contact-phone').value.trim() || null,
                logo_url: logoUrl
            };
            let result;
            if (clubId) {
                result = await supabase.from('clubs').update(clubData).eq('id', clubId).select().single();
            } else {
                result = await supabase.from('clubs').insert(clubData).select().single();
            }
            if (result.error) { showToast(result.error.message, 'error'); return; }
            if (clubId) {
                const idx = clubs.findIndex(c => c.id === clubId);
                if (idx !== -1) { clubs[idx] = { ...clubs[idx], ...result.data }; }
                if (currentClub && currentClub.id === clubId) {
                    currentClub = clubs.find(c => c.id === clubId);
                    updateClubDetailHeader();
                    renderClubOverviewInfo();
                }
            } else {
                clubs.push(result.data);
                updateStats();
            }
            hideCreateClubModal();
            renderClubsEnhanced();
            showToast(clubId ? 'Club updated' : `${name} created`);
            if (!clubId) {
                // If we came from a job's "Create New Club" flow, auto-link
                if (window._pendingJobLink) {
                    const linkJobId = window._pendingJobLink;
                    window._pendingJobLink = null;
                    await supabase.from('jobs').update({ club_id: result.data.id }).eq('id', linkJobId);
                    // Reload current job so the Club tab reflects the new link
                    const { data: updatedJob } = await supabase.from('jobs').select('*, clubs(*)').eq('id', linkJobId).single();
                    if (updatedJob) {
                        currentJob = updatedJob;
                        const idx = jobs.findIndex(j => j.id === linkJobId);
                        if (idx !== -1) jobs[idx] = updatedJob;
                    }
                    showToast(`${name} created and linked to job`);
                    openJobRecord(linkJobId);
                    return;
                }
                openClubDashboard(result.data.id);
            }
        }

        // =============================================
        // CLUB DASHBOARD
        // =============================================
        async function openClubDashboard(clubId) {
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;
            currentClub = club;
            currentClubProducts = [];
            currentOrderForms = [];
            currentClubTab = 'overview';
            document.getElementById('launchpad').classList.add('hide');
            document.querySelectorAll('[id^="tool-"]').forEach(el => el.classList.add('hide'));
            document.getElementById('tool-club-detail').classList.remove('hide');
            // Update back label from navStack context (if pushed from a job, label was already set)
            const backLbl = document.getElementById('club-detail-back-label');
            if (backLbl && navStack.length > 0) {
                const top = navStack[navStack.length - 1];
                if (top.type === 'job') backLbl.textContent = 'Back to Job';
                else backLbl.textContent = 'Back to Clubs';
            } else if (backLbl) {
                backLbl.textContent = 'Back to Clubs';
            }
            updateClubDetailHeader();
            showClubTab('overview');
            renderClubTimeline();
            await Promise.all([loadCurrentClubProducts(), loadCurrentClubOrderForms()]);
            renderClubOverviewInfo();
            updateOverviewStats();
            renderClubTimeline(); // re-render with product data loaded
        }

        // Dynamic tier name/badge lookup (works with any brand tier)
        function getClubTierDisplay(club) {
            const cs = club?.club_status || (club?.is_partner ? 'partner' : 'retail');
            const tier = brandPricingTiers.find(t => t.tier_key === cs);
            const tierName = tier?.tier_name || cs.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            const badgeClass = cs === 'retail' ? 'badge-nonpartner' : 'badge-partner';
            return { cs, tierName, badgeClass };
        }

        function updateClubDetailHeader() {
            if (!currentClub) return;
            const initials = ((currentClub.suffix || currentClub.name.substring(0, 2))).substring(0, 2);
            document.getElementById('club-detail-initials').textContent = initials;
            document.getElementById('club-detail-name').textContent = currentClub.name;
            document.getElementById('club-detail-sport').textContent = currentClub.sport || '';
            document.getElementById('club-detail-suffix').textContent = `(${currentClub.suffix || ''})`;
            const badge = document.getElementById('club-detail-partner-badge');
            const { tierName, badgeClass } = getClubTierDisplay(currentClub);
            badge.className = `badge ${badgeClass} text-xs`;
            badge.textContent = tierName;
        }

        function showClubTab(tab) {
            currentClubTab = tab;
            document.querySelectorAll('.club-tab-content').forEach(el => el.classList.add('hide'));
            document.querySelectorAll('#club-record-nav .record-nav-item').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`club-tab-${tab}`)?.classList.remove('hide');
            document.getElementById(`tab-btn-${tab}`)?.classList.add('active');
            if (tab === 'overview') renderClubOverviewInfo();
            if (tab === 'teams') { loadClubTeams().then(() => renderClubTeams()); }
            if (tab === 'products') renderClubProducts();
            if (tab === 'orderforms') renderClubOrderForms();
            if (tab === 'jobs') loadClubJobs();
            if (tab === 'onboarding') { renderShopifySyncStatus(); renderOnboardingTab(); }
            if (tab === 'shopify') renderShopifySyncStatus(); // legacy compatibility
            if (tab === 'images') loadClubDetailImages();
        }

        function renderClubTimeline() {
            if (!currentClub) return;
            const steps = {
                profile:  !!(currentClub.name && currentClub.sport),
                products: !!(currentClubProducts && currentClubProducts.length > 0),
                mockups:  !!(currentClub.has_images),
                store:    !!(currentClub.shopify_collection_id),
                active:   !!(currentClub.shopify_collection_id && currentClub.has_images)
            };
            const keys = ['profile','products','mockups','store','active'];
            // Find the active (first incomplete) step
            let activeFound = false;
            keys.forEach(key => {
                const el = document.getElementById(`club-tl-${key}`);
                if (!el) return;
                const dot = el.querySelector('.tl-dot');
                if (!dot) return;
                if (steps[key] && !activeFound) {
                    dot.className = 'tl-dot done';
                    el.className = 'tl-step done';
                } else if (!steps[key] && !activeFound) {
                    dot.className = 'tl-dot active';
                    el.className = 'tl-step active';
                    activeFound = true;
                } else {
                    dot.className = 'tl-dot';
                    el.className = 'tl-step';
                }
            });
            // If all done, mark active as done too
            if (!activeFound) {
                const el = document.getElementById('club-tl-active');
                if (el) { el.className = 'tl-step done'; const dot = el.querySelector('.tl-dot'); if (dot) dot.className = 'tl-dot done'; }
            }
        }

        function renderOnboardingTab() {
            if (!currentClub) return;

            // Step 1: image summary
            renderOnboardingImageSummary();

            // Step 2: collection image preview
            const collPreview = document.getElementById('onboard-coll-img-preview');
            if (collPreview && currentClub.collection_image_url) {
                collPreview.innerHTML = `<img src="${currentClub.collection_image_url}" class="w-full h-full object-cover rounded-lg">`;
            }

            // Step 2: show/hide API button based on brand settings
            const apiBtn = document.getElementById('onboard-api-btn');
            if (apiBtn) apiBtn.classList.toggle('hide', !currentBrand?.shopify_api_enabled);

            // Step 3: populate single-product dropdown
            const singleSel = document.getElementById('onboard-single-product-select');
            if (singleSel) {
                const withImages = (currentClubProducts || []).filter(cp => (cp.image_urls || []).length > 0);
                singleSel.innerHTML = '<option value="">Choose a club product...</option>' +
                    withImages.map(cp => {
                        const label = escHtml(cp.custom_name || (cp.products?.item_name ? `${currentClub.name} ${cp.products.item_name}` : `Product ${cp.id}`));
                        return `<option value="${cp.id}">${label}</option>`;
                    }).join('');
                if (!withImages.length) {
                    singleSel.innerHTML = '<option value="">No products with images yet</option>';
                }
            }

            // Populate order forms in onboarding tab
            const formsList = document.getElementById('club-order-forms-list-onboard');
            const formsEmpty = document.getElementById('club-order-forms-empty-onboard');
            if (formsList) {
                if (currentOrderForms.length === 0) {
                    formsList.innerHTML = '';
                    formsEmpty?.classList.remove('hide');
                } else {
                    formsEmpty?.classList.add('hide');
                    const baseUrl = window.location.origin + window.location.pathname;
                    formsList.innerHTML = currentOrderForms.map(f => `
                        <div class="flex items-center justify-between p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05)">
                            <div>
                                <p class="text-sm font-semibold">${escHtml(f.title)}</p>
                                <p class="text-xs text-gray-500">${f.season || ''} · ${f.is_active ? '<span style="color:#4ade80">Active</span>' : 'Closed'}</p>
                            </div>
                            <div class="flex gap-2">
                                <button onclick="copyFormLink('${baseUrl}?form=${f.token}')" class="text-xs btn-secondary py-1 px-3">Copy Link</button>
                            </div>
                        </div>`).join('');
                }
            }

            // Onboarding checklist
            const checklistEl = document.getElementById('onboarding-checklist');
            if (checklistEl && currentClub) {
                const checks = [
                    { done: !!currentClub.name, label: 'Club record created' },
                    { done: (currentClubProducts.length > 0), label: 'Club products added' },
                    { done: currentClubProducts.some(p => p.shopify_product_id), label: 'Products synced to Shopify' },
                    { done: !!currentClub.shopify_collection_id, label: 'Shopify collection created' },
                    { done: currentOrderForms.some(f => f.is_active), label: 'Order form live' },
                ];
                checklistEl.innerHTML = checks.map(c => `
                    <div class="flex items-center gap-3 p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05)">
                        <span class="w-5 h-5 rounded-full flex items-center justify-center flex-shrink-0 text-sm" style="${c.done ? 'background:rgba(34,197,94,0.15);color:#4ade80' : 'background:rgba(255,255,255,0.05);color:#555'}">
                            ${c.done ? '✓' : '○'}
                        </span>
                        <span class="text-sm ${c.done ? 'text-gray-300' : 'text-gray-600'}">${c.label}</span>
                    </div>`).join('');
            }
        }

        // Download a single-product Shopify CSV for an individual club product
        async function downloadSingleClubProductCSV() {
            const sel = document.getElementById('onboard-single-product-select');
            if (!sel || !sel.value) { showToast('Please select a product first', 'error'); return; }
            const cp = (currentClubProducts || []).find(p => String(p.id) === String(sel.value));
            if (!cp) { showToast('Product not found', 'error'); return; }
            const imgUrls = Array.isArray(cp.image_urls) ? cp.image_urls : (cp.image_urls ? JSON.parse(cp.image_urls) : []);
            if (!imgUrls.length) { showToast('This product has no mock-up image — upload one first', 'error'); return; }
            const mp = cp.products;
            if (!mp) { showToast('Master product data missing — try reloading', 'error'); return; }

            const club = currentClub;
            const priceList = club.club_status || 'retail';

            const headers = [
                'Title', 'URL handle', 'Description', 'Vendor', 'Product category', 'Type',
                'Tags', 'Published on online store', 'Status', 'Collection', 'SKU', 'Barcode',
                'Option1 name', 'Option1 value', 'Option2 name', 'Option2 value',
                'Option3 name', 'Option3 value', 'Price', 'Compare-at price', 'Cost per item',
                'Charge tax', 'Tax code', 'Inventory policy', 'Inventory tracker',
                'Inventory quantity', 'Continue selling when out of stock', 'Weight value (grams)',
                'Weight unit for display', 'Requires shipping', 'Fulfillment service',
                'Product image URL', 'Image position', 'Image alt text', 'Variant image URL',
                'Gift card', 'SEO title', 'SEO description'
            ];

            function derivePrice(fit) {
                const tierPrices = (mp.tier_prices && typeof mp.tier_prices === 'object') ? mp.tier_prices : {};
                const tp = tierPrices[priceList] || {};
                if (mp.is_single_price) {
                    return tp.youth || (priceList === 'retail' ? mp.single_retail_price : mp.single_partner_price) || 0;
                }
                if (fit === 'Youth') return tp.youth || (priceList === 'retail' ? mp.youth_retail_price : mp.youth_partner_price) || 0;
                if (fit === "Women's") {
                    const rp = mp.women_retail_price || mp.adult_retail_price || 0;
                    const pp = mp.women_partner_price || mp.adult_partner_price || 0;
                    return tp.adult || (priceList === 'retail' ? rp : pp);
                }
                return tp.adult || (priceList === 'retail' ? mp.adult_retail_price : mp.adult_partner_price) || cp.web_price || 0;
            }

            const title = cp.custom_name || `${club.name} ${mp.item_name}`;
            const handle = title.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/(^-|-$)/g, '');
            let description = (mp.description || '')
                .replace(/\*ADD CLUB NAME \+ RANGE\*/g, `${club.name} ${mp.range_name}`)
                .replace(/\*ADD CLUB \+ RANGE\*/g, `${club.name} ${mp.range_name}`)
                .replace(/\*ADD CLUB NAME\*/g, club.name);
            description = description.split(/\n+/).filter(p => p.trim()).map(p => `<p>${p.trim()}</p>`).join('');

            const tags = [club.name, mp.range_name, mp.category].filter(Boolean);
            const productTags = Array.isArray(mp.shopify_tags) ? mp.shopify_tags : (mp.shopify_tags ? JSON.parse(mp.shopify_tags) : []);
            tags.push(...productTags);
            if (club.assigned_salesperson_id) {
                const sp = salespeople.find(s => s.id === club.assigned_salesperson_id);
                if (sp) tags.push(`salesperson-${sp.first_name}-${sp.last_name}`.toLowerCase().replace(/\s+/g, '-'));
            }
            if (mp.has_addons) tags.push('with-addons');

            const chargeText = mp.is_taxable !== false ? 'TRUE' : 'FALSE';
            const cogs = mp.cogs ? Number(mp.cogs).toFixed(2) : '';
            const fits = (mp.available_fits || 'adult').split(',').map(f => f.trim());
            const hasYouth = fits.includes('youth');
            const hasAdult = fits.includes('adult');
            const hasWomen = fits.includes('women');
            const multifit = (hasYouth ? 1 : 0) + (hasAdult ? 1 : 0) + (hasWomen ? 1 : 0) > 1;

            let adultSizes = (mp.sizes || '').split(',').map(s => s.trim()).filter(Boolean);
            let youthSizes = (mp.youth_sizes || '').split(',').map(s => s.trim()).filter(Boolean);
            if (!youthSizes.length && mp.sizes) {
                youthSizes = adultSizes.filter(s => s.startsWith('Y'));
                adultSizes = adultSizes.filter(s => !s.startsWith('Y') && s !== 'One Size');
            }
            const womenSizes = (mp.women_sizes || '').split(',').map(s => s.trim()).filter(Boolean);

            const rows = [];
            let variantIndex = 0;
            const buildRow = (fit, size, price, imgUrl, imgPos) => {
                const sku = `${mp.product_code}/${club.suffix}-${size}`;
                const isFirst = variantIndex === 0;
                variantIndex++;
                return {
                    'Title': isFirst ? title : '', 'URL handle': handle,
                    'Description': isFirst ? description : '',
                    'Vendor': isFirst ? (currentBrand?.name || '') : '',
                    'Product category': isFirst ? 'Apparel & Accessories > Clothing' : '',
                    'Type': isFirst ? mp.category : '',
                    'Tags': isFirst ? tags : '',
                    'Published on online store': isFirst ? 'TRUE' : '',
                    'Status': 'active', 'Collection': isFirst ? club.name : '',
                    'SKU': sku, 'Barcode': '',
                    'Option1 name': multifit ? 'Fit' : 'Size',
                    'Option1 value': multifit ? fit : size,
                    'Option2 name': multifit ? 'Size' : '',
                    'Option2 value': multifit ? size : '',
                    'Option3 name': '', 'Option3 value': '',
                    'Price': price > 0 ? Number(price).toFixed(2) : '', 'Compare-at price': '',
                    'Cost per item': cogs, 'Charge tax': chargeText, 'Tax code': '',
                    'Inventory policy': 'continue', 'Inventory tracker': 'shopify',
                    'Inventory quantity': '0', 'Continue selling when out of stock': 'TRUE',
                    'Weight value (grams)': mp.weight_grams || '450',
                    'Weight unit for display': 'g', 'Requires shipping': 'TRUE',
                    'Fulfillment service': 'manual',
                    'Product image URL': imgUrl || '', 'Image position': imgUrl ? String(imgPos) : '',
                    'Image alt text': imgUrl ? title : '', 'Variant image URL': '',
                    'Gift card': 'FALSE',
                    'SEO title': isFirst ? `${title} | Official ${club.name} Merchandise` : '',
                    'SEO description': isFirst ? `Shop the official ${title}. Premium quality teamwear.` : ''
                };
            };

            if (mp.is_single_price || (!hasAdult && !hasYouth && !hasWomen)) {
                rows.push(buildRow('One Size', 'OS', derivePrice('Adult'), imgUrls[0] || '', 1));
            } else {
                if (hasYouth && youthSizes.length) {
                    youthSizes.forEach(size => rows.push(buildRow('Youth', size, derivePrice('Youth'), variantIndex === 0 ? (imgUrls[0] || '') : '', 1)));
                }
                if (hasAdult && adultSizes.length) {
                    adultSizes.forEach(size => rows.push(buildRow('Adult', size, derivePrice('Adult'), variantIndex === 0 ? (imgUrls[0] || '') : '', 1)));
                }
                if (hasWomen && womenSizes.length) {
                    womenSizes.forEach(size => rows.push(buildRow("Women's", size, derivePrice("Women's"), variantIndex === 0 ? (imgUrls[0] || '') : '', 1)));
                }
            }
            // Additional images
            imgUrls.slice(1).forEach((imgUrl, i) => {
                rows.push({ 'URL handle': handle, 'Product image URL': imgUrl, 'Image position': String(i + 2), 'Image alt text': title, 'Status': '' });
            });

            if (!rows.length) { showToast('Could not generate CSV — check product has sizes and data', 'error'); return; }
            const csv = Papa.unparse({ fields: headers, data: rows.map(row => headers.map(h => row[h] ?? '')) });
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const productSlug = (cp.custom_name || mp.item_name || 'product').toLowerCase().replace(/[^a-z0-9]+/g, '-');
            a.download = `${club.suffix}_${productSlug}_shopify.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast(`CSV downloaded for: ${title}`);
        }

        function renderClubOverviewInfo() {
            const el = document.getElementById('club-overview-info');
            if (!el || !currentClub) return;
            const { tierName } = getClubTierDisplay(currentClub);
            const salesperson = salespeople.find(s => s.id === currentClub.assigned_salesperson_id);
            const fullAddress = [
                currentClub.address_line1, currentClub.address_line2,
                currentClub.address_town, currentClub.address_county,
                currentClub.address_postcode
            ].filter(Boolean).join(', ');
            const rows = [
                ['Name', currentClub.name],
                ['Suffix', currentClub.suffix || '—'],
                ['Sport', currentClub.sport || '—'],
                ['Partnership Level', tierName],
                ['Salesperson', salesperson ? `${salesperson.first_name} ${salesperson.last_name}` : '—'],
                ['Owner', getUserDisplayName(currentClub.created_by)],
                ['League', currentClub.league || '—'],
                ['Address', fullAddress || '—'],
                ['Contact', currentClub.contact_name || '—'],
                ['Email', currentClub.contact_email || '—'],
                ['Phone', currentClub.contact_phone || '—'],
            ];
            el.innerHTML = rows.map(([label, value]) =>
                `<div class="info-row"><span class="info-label">${escHtml(label)}</span><span class="info-value">${escHtml(value)}</span></div>`
            ).join('');

            // Update branding panel — prefer logo_url, fall back to club_crest_url
            const crestEl = document.getElementById('club-crest-display');
            const logoSrc = currentClub.logo_url || currentClub.club_crest_url;
            if (crestEl) {
                crestEl.innerHTML = logoSrc
                    ? `<img src="${escHtml(logoSrc)}" class="w-full h-full object-contain rounded-xl">`
                    : '<svg class="w-10 h-10 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M9 21V5.25A2.25 2.25 0 0111.25 3h1.5A2.25 2.25 0 0115 5.25V21m-6 0h6M3.75 21V10.5A2.25 2.25 0 016 8.25h.75M20.25 21V10.5a2.25 2.25 0 00-2.25-2.25H17.25"/></svg>';
            }
            const dlBtn = document.getElementById('club-logo-download-btn');
            if (dlBtn) { if (logoSrc) dlBtn.classList.remove('hide'); else dlBtn.classList.add('hide'); }
            // Populate assignment dropdown
            populateUserAssignDropdown('club-assigned-user', currentClub.assigned_user_id);
            const mainSwatch = document.getElementById('pantone-main-swatch');
            const secSwatch = document.getElementById('pantone-sec-swatch');
            const accSwatch = document.getElementById('pantone-acc-swatch');
            const pantoneLabels = document.getElementById('pantone-labels');
            if (mainSwatch) mainSwatch.style.background = currentClub.pantone_main || 'rgba(255,255,255,0.04)';
            if (secSwatch) secSwatch.style.background = currentClub.pantone_secondary || 'rgba(255,255,255,0.04)';
            if (accSwatch) accSwatch.style.background = currentClub.pantone_accent || 'rgba(255,255,255,0.04)';
            if (pantoneLabels) {
                const codes = [currentClub.pantone_main_code, currentClub.pantone_sec_code, currentClub.pantone_acc_code].filter(Boolean);
                pantoneLabels.textContent = codes.length ? codes.join(' / ') : (currentClub.pantone_main ? '' : '—');
            }
        }

        function updateOverviewStats() {
            document.getElementById('overview-stat-products').textContent = currentClubProducts.length;
            document.getElementById('overview-stat-forms').textContent = currentOrderForms.filter(f => f.is_active).length;
            document.getElementById('overview-stat-synced').textContent = currentClubProducts.filter(p => p.shopify_product_id).length;
            if (currentOrderForms.length > 0) {
                supabase.from('order_submissions')
                    .select('*', { count: 'exact', head: true })
                    .in('form_id', currentOrderForms.map(f => f.id))
                    .then(({ count }) => { document.getElementById('overview-stat-submissions').textContent = count || 0; });
            } else {
                document.getElementById('overview-stat-submissions').textContent = '0';
            }
        }

        // =============================================
        // CLUB PRODUCTS
        // =============================================

        function toggleMockupUploadSection() {
            const section = document.getElementById('club-mockup-upload-inline');
            if (section) section.classList.toggle('hide');
        }

        function triggerClubProductImageUpload(cpId, productId) {
            // Create a hidden file input for per-product image upload
            const existing = document.getElementById('cp-single-image-upload');
            if (existing) existing.remove();
            const input = document.createElement('input');
            input.type = 'file'; input.id = 'cp-single-image-upload';
            input.accept = 'image/*'; input.style.display = 'none';
            input.onchange = (e) => handleSingleClubProductImageUpload(e, cpId, productId);
            document.body.appendChild(input);
            input.click();
        }

        async function handleSingleClubProductImageUpload(event, cpId, productId) {
            const file = event.target.files[0];
            if (!file || !currentClub) return;
            const masterProduct = products.find(p => p.id === productId);
            if (!masterProduct) { showToast('Master product not found', 'error'); return; }
            showToast('Uploading image...');
            const storagePath = `${currentBrand.slug}/${currentClub.suffix}/${file.name}`;
            const { error: uploadError } = await supabase.storage.from('club-images').upload(storagePath, file, { upsert: true });
            if (uploadError) { showToast(uploadError.message, 'error'); return; }
            const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(storagePath);
            const imageUrl = urlData.publicUrl;
            // Upsert into club_images
            await supabase.from('club_images').upsert({
                club_id: currentClub.id, product_id: productId,
                file_name: file.name, storage_path: storagePath,
                public_url: imageUrl, uploaded_by: currentUser.id
            }, { onConflict: 'club_id,product_id' });
            // Update club_product image_urls
            const { data: cp } = await supabase.from('club_products').select('image_urls').eq('id', cpId).single();
            const currentUrls = Array.isArray(cp?.image_urls) ? cp.image_urls : [];
            if (!currentUrls.includes(imageUrl)) currentUrls.push(imageUrl);
            await supabase.from('club_products').update({ image_urls: currentUrls }).eq('id', cpId);
            // Update local state
            const idx = currentClubProducts.findIndex(p => p.id === cpId);
            if (idx !== -1) currentClubProducts[idx].image_urls = currentUrls;
            renderClubProducts();
            showToast('Image uploaded!');
            event.target.remove();
        }

        async function loadCurrentClubProducts() {
            if (!currentClub) return;
            const { data } = await supabase.from('club_products')
                .select('*, products(product_code, item_name, category, range_name, fit_type, sizes, youth_sizes, women_sizes, available_fits, has_addons, weight_grams, description, tier_prices, cogs)')
                .eq('club_id', currentClub.id).eq('is_active', true).order('created_at');
            currentClubProducts = data || [];
        }

        function renderClubProducts() {
            const container = document.getElementById('club-products-list');
            const emptyEl = document.getElementById('club-products-empty');
            // Show partnership level warning
            const warningEl = document.getElementById('cp-partnership-warning');
            const tierInfoEl = document.getElementById('cp-tier-info');
            if (warningEl) warningEl.classList.toggle('hide', !!currentClub?.club_status);
            if (tierInfoEl && currentClub?.club_status) {
                const activeTier = brandPricingTiers.find(t => t.tier_key === currentClub.club_status);
                tierInfoEl.textContent = activeTier ? `Pricing: ${activeTier.tier_name}` : '';
            } else if (tierInfoEl) { tierInfoEl.textContent = ''; }

            if (!currentClubProducts.length) {
                container.innerHTML = '';
                emptyEl.classList.remove('hide');
                return;
            }
            emptyEl.classList.add('hide');

            container.innerHTML = currentClubProducts.map(cp => {
                const syncBadge = cp.shopify_product_id
                    ? `<span class="text-xs text-green-400">✓ Shopify</span>`
                    : '<span class="text-xs text-gray-600">Not synced</span>';
                const imgUrls = Array.isArray(cp.image_urls) ? cp.image_urls : (cp.image_urls ? JSON.parse(cp.image_urls) : []);
                const hasImage = imgUrls.length > 0;
                const imageSection = hasImage
                    ? `<div class="w-16 h-16 rounded-xl overflow-hidden flex-shrink-0 bg-gray-800">
                            <img src="${imgUrls[0]}" class="w-full h-full object-cover" loading="lazy">
                       </div>`
                    : `<div class="w-16 h-16 rounded-xl flex-shrink-0 bg-gray-800 border border-dashed border-gray-700 flex items-center justify-center" title="Images managed via onboarding">
                            <svg class="w-6 h-6 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"/></svg>
                       </div>`;
                // Derive prices from master product for each brand tier
                const mp = cp.products;
                const tierPricesObj = (mp?.tier_prices && typeof mp.tier_prices === 'object') ? mp.tier_prices : {};
                const pricingHtml = brandPricingTiers.map(tier => {
                    const tp = tierPricesObj[tier.tier_key] || {};
                    const adultP = tp.adult || null;
                    const youthP = tp.youth || null;
                    if (!adultP && !youthP) return '';
                    const val = adultP ? `£${Number(adultP).toFixed(2)}` : `£${Number(youthP).toFixed(2)}`;
                    return `<div><p class="text-xs text-gray-500 mb-0.5">${escHtml(tier.tier_name)}</p><p class="font-semibold">${val}</p></div>`;
                }).filter(Boolean).join('');
                // Size summary from available_fits
                const availFits = (mp?.available_fits || 'adult').split(',').map(f => f.trim().toLowerCase());
                const fitLabels = [
                    availFits.includes('adult') ? 'Adult' : null,
                    availFits.includes('youth') ? 'Youth Unisex' : null,
                    availFits.includes('women') ? "Women's" : null
                ].filter(Boolean);
                return `
                <div class="club-product-card" id="cp-card-${cp.id}">
                    <div class="flex items-start gap-4">
                        ${imageSection}
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1 flex-wrap">
                                <span class="font-semibold text-sm">${escHtml(cp.custom_name)}</span>
                                ${syncBadge}
                            </div>
                            <div class="text-xs text-gray-500 mb-2">
                                <span class="font-mono text-gray-600 mr-2">${escHtml(mp?.product_code || '')}</span>
                                <span>${escHtml(mp?.item_name || '')}</span>
                                ${mp?.range_name ? `· <span>${escHtml(mp.range_name)}</span>` : ''}
                                ${fitLabels.length ? `<span class="text-gray-600 ml-2">${fitLabels.join(' · ')}</span>` : ''}
                            </div>
                            <div class="flex gap-4 text-sm flex-wrap">
                                ${pricingHtml || '<p class="text-xs text-gray-600">Pricing in master product</p>'}
                            </div>
                        </div>
                        <div class="flex flex-col gap-1.5 flex-shrink-0">
                            <button onclick="editClubProduct('${cp.id}')" class="btn-secondary text-xs py-1 px-3">Edit</button>
                            <button onclick="syncProductToShopify('${cp.id}')" class="btn-secondary text-xs py-1 px-3 text-brand-400">Sync</button>
                            <button onclick="removeClubProduct('${cp.id}')" class="btn-secondary text-xs py-1.5 px-2 text-red-400">Remove</button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function showAddClubProductModal() {
            if (!currentClub?.club_status) {
                showToast('Please set a Partnership Level in Club Info before adding products', 'error');
                return;
            }
            document.getElementById('club-product-modal-title').textContent = 'Add Club Product';
            document.getElementById('edit-club-product-id').value = '';
            document.getElementById('cp-custom-name').value = '';
            document.getElementById('cp-sizes-info').classList.add('hide');
            document.getElementById('cp-pricing-info')?.classList.add('hide');
            // Show which tier is being used
            const tierKey = currentClub.club_status;
            const activeTier = brandPricingTiers.find(t => t.tier_key === tierKey);
            const modalTitle = document.getElementById('club-product-modal-title');
            if (modalTitle && activeTier) modalTitle.textContent = `Add Club Product — ${activeTier.tier_name} pricing`;
            const assignedIds = currentClubProducts.map(cp => cp.product_id);
            const available = products.filter(p => !assignedIds.includes(p.id));
            const select = document.getElementById('cp-master-product');
            select.innerHTML = '<option value="">Select from master catalogue...</option>' +
                available.map(p => `<option value="${p.id}">${escHtml(p.product_code)} – ${escHtml(p.item_name)} (${escHtml(p.range_name)})</option>`).join('');
            select.disabled = false;
            document.getElementById('club-product-modal').classList.remove('hide');
        }

        function editClubProduct(cpId) {
            const cp = currentClubProducts.find(p => p.id === cpId);
            if (!cp) return;
            document.getElementById('club-product-modal-title').textContent = 'Edit Club Product';
            document.getElementById('edit-club-product-id').value = cpId;
            document.getElementById('cp-custom-name').value = cp.custom_name || '';
            const select = document.getElementById('cp-master-product');
            select.innerHTML = products.map(p =>
                `<option value="${p.id}" ${p.id === cp.product_id ? 'selected' : ''}>${p.product_code} – ${p.item_name}</option>`
            ).join('');
            select.disabled = true;
            onMasterProductChange();
            document.getElementById('club-product-modal').classList.remove('hide');
        }

        function hideClubProductModal() {
            document.getElementById('club-product-modal').classList.add('hide');
            document.getElementById('cp-master-product').disabled = false;
        }

        // =============================================
        // BULK ADD PRODUCTS
        // =============================================
        let bulkSelectedProducts = new Set();
        let bulkLastClickedIndex = -1;

        function showBulkAddProductsModal() {
            bulkSelectedProducts = new Set();
            bulkLastClickedIndex = -1;
            document.getElementById('bulk-product-search').value = '';
            renderBulkProductList();
            document.getElementById('bulk-products-modal').classList.remove('hide');
        }

        function hideBulkProductsModal() {
            document.getElementById('bulk-products-modal').classList.add('hide');
        }

        function renderBulkProductList() {
            const search = document.getElementById('bulk-product-search').value.toLowerCase();
            const assignedIds = new Set(currentClubProducts.map(cp => cp.product_id));
            const available = products.filter(p => !assignedIds.has(p.id));
            const filtered = search
                ? available.filter(p => (p.product_code + ' ' + p.item_name + ' ' + (p.range_name||'')).toLowerCase().includes(search))
                : available;
            const container = document.getElementById('bulk-product-list');
            if (filtered.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No unassigned products match your search</p>';
                return;
            }
            container.innerHTML = filtered.map((p, i) => {
                const sel = bulkSelectedProducts.has(p.id);
                return `<div class="product-select-item${sel ? ' selected' : ''}" data-product-id="${p.id}" data-index="${i}" onclick="toggleBulkProduct(event, '${p.id}', ${i})">
                    <input type="checkbox" ${sel ? 'checked' : ''} onclick="event.stopPropagation()" onchange="toggleBulkProduct(event, '${p.id}', ${i})">
                    <div class="flex-1 min-w-0">
                        <p class="text-sm font-semibold">${escHtml(p.product_code)} — ${escHtml(p.item_name)}</p>
                        <p class="text-xs text-gray-500">${escHtml(p.range_name||'')}</p>
                    </div>
                    <span class="text-xs text-gray-600 font-mono flex-shrink-0">£${Number(p.adult_partner_price||p.single_partner_price||0).toFixed(2)}</span>
                </div>`;
            }).join('');
            updateBulkCount();
        }

        function filterBulkProductList() { renderBulkProductList(); }

        function toggleBulkProduct(event, productId, index) {
            if (event.shiftKey && bulkLastClickedIndex >= 0) {
                // Range select: get all visible items between last and current
                const items = Array.from(document.querySelectorAll('#bulk-product-list .product-select-item'));
                const from = Math.min(bulkLastClickedIndex, index);
                const to   = Math.max(bulkLastClickedIndex, index);
                items.slice(from, to + 1).forEach(el => {
                    const pid = el.dataset.productId;
                    bulkSelectedProducts.add(pid);
                });
            } else {
                if (bulkSelectedProducts.has(productId)) bulkSelectedProducts.delete(productId);
                else bulkSelectedProducts.add(productId);
            }
            bulkLastClickedIndex = index;
            renderBulkProductList();
        }

        function selectAllBulkProducts() {
            document.querySelectorAll('#bulk-product-list .product-select-item').forEach(el => bulkSelectedProducts.add(el.dataset.productId));
            renderBulkProductList();
        }

        function clearBulkProductSelection() {
            bulkSelectedProducts.clear();
            renderBulkProductList();
        }

        function updateBulkCount() {
            document.getElementById('bulk-selected-count').textContent = bulkSelectedProducts.size;
        }

        async function saveBulkProducts() {
            if (!currentClub) return;
            if (!currentClub.club_status) { showToast('Please set a Partnership Level in Club Info before adding products', 'error'); return; }
            if (bulkSelectedProducts.size === 0) { showToast('Select at least one product', 'error'); return; }
            const btn = document.querySelector('#bulk-products-modal .btn-primary');
            if (btn) { btn.disabled = true; btn.textContent = 'Adding…'; }
            let added = 0, failed = 0;
            for (const productId of bulkSelectedProducts) {
                const p = products.find(x => x.id === productId);
                if (!p) continue;
                const tierPrices = (p.tier_prices && typeof p.tier_prices === 'object') ? p.tier_prices : {};
                const clubTierKey = currentClub?.club_status || 'retail';
                const tp = tierPrices[clubTierKey] || tierPrices['retail'] || {};
                const partnerPrice = tp.adult || (p.is_single_price ? p.single_partner_price : p.adult_partner_price);
                const retailPrice  = tp.youth || (p.is_single_price ? p.single_retail_price  : p.adult_retail_price);
                const webPrice = partnerPrice ? Number(partnerPrice) : null;
                const { error } = await supabase.from('club_products').insert({
                    club_id: currentClub.id,
                    product_id: productId,
                    custom_name: `${currentClub.name} ${p.item_name}`,
                    web_price: webPrice,
                    partner_price: partnerPrice ? Number(partnerPrice) : null,
                    non_partner_price: retailPrice ? Number(retailPrice) : null,
                    is_active: true
                });
                if (error) failed++; else added++;
            }
            // Reload
            await loadCurrentClubProducts();
            renderClubProducts();
            hideBulkProductsModal();
            if (btn) { btn.disabled = false; btn.textContent = 'Add Selected'; }
            showToast(failed ? `${added} added, ${failed} failed` : `${added} product${added !== 1 ? 's' : ''} added`);
        }

        // =============================================
        // CLUB JOBS TAB
        // =============================================
        async function loadClubJobs() {
            if (!currentClub) return;
            const { data } = await supabase
                .from('jobs')
                .select('*')
                .eq('club_id', currentClub.id)
                .order('created_at', { ascending: false });
            renderClubJobs(data || []);
        }

        function renderClubJobs(jobList) {
            const container = document.getElementById('club-jobs-list');
            const emptyEl   = document.getElementById('club-jobs-empty');
            if (!container) return;
            if (jobList.length === 0) {
                container.innerHTML = '';
                emptyEl?.classList.remove('hide');
                return;
            }
            emptyEl?.classList.add('hide');
            container.innerHTML = jobList.map(j => {
                const stage = JOB_STAGES.find(s => s.key === j.stage) || JOB_STAGES[0];
                return `<div class="glass rounded-xl p-4 flex items-center justify-between gap-4 cursor-pointer hover:border-brand-500/30 transition" onclick="openJobFromClub('${j.id}')">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-xs text-gray-600 font-mono">${escHtml(j.job_number||'')}</span>
                            <span class="stage-pill ${stage.colorClass}" style="font-size:10px">${stage.label}</span>
                        </div>
                        <p class="font-semibold truncate">${escHtml(j.job_name||'Untitled Job')}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${new Date(j.created_at).toLocaleDateString('en-GB')}</p>
                    </div>
                    <svg class="w-4 h-4 text-gray-600 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                </div>`;
            }).join('');
        }

        function openJobFromClub(jobId) {
            pushNav({ type: 'club-detail', clubId: currentClub.id, label: 'Back to Club' });
            openJobRecord(jobId);
        }

        // When partner price changes, mirror to web price if web price is empty
        function onPartnerPriceInput() {
            const webEl = document.getElementById('cp-web-price');
            if (!webEl.value) {
                const partner = parseFloat(document.getElementById('cp-partner-price').value);
                if (!isNaN(partner)) webEl.value = partner.toFixed(2);
            }
        }

        function onMasterProductChange() {
            const productId = document.getElementById('cp-master-product').value;
            if (!productId) {
                document.getElementById('cp-sizes-info').classList.add('hide');
                document.getElementById('cp-pricing-info')?.classList.add('hide');
                return;
            }
            const product = products.find(p => p.id === productId);
            if (!product) return;
            if (!document.getElementById('cp-custom-name').value && !document.getElementById('edit-club-product-id').value) {
                document.getElementById('cp-custom-name').value = `${currentClub.name} ${product.item_name}`;
            }
            // Show pricing info derived from master product tiers
            const tierPrices = (product.tier_prices && typeof product.tier_prices === 'object') ? product.tier_prices : {};
            const pricingRows = document.getElementById('cp-pricing-rows');
            const pricingInfo = document.getElementById('cp-pricing-info');
            if (pricingRows && brandPricingTiers.length) {
                pricingRows.innerHTML = brandPricingTiers.map(tier => {
                    const tp = tierPrices[tier.tier_key] || {};
                    const adultP = tp.adult || null;
                    const youthP = tp.youth || null;
                    if (!adultP && !youthP) return '';
                    const parts = [];
                    if (adultP) parts.push(`Adult £${Number(adultP).toFixed(2)}`);
                    if (youthP && !product.is_single_price) parts.push(`Youth £${Number(youthP).toFixed(2)}`);
                    return `<div class="flex items-baseline gap-3">
                        <span class="text-xs font-medium text-gray-400 w-28 flex-shrink-0">${escHtml(tier.tier_name)}</span>
                        <span class="text-sm font-semibold text-white">${parts.join(' · ')}</span>
                    </div>`;
                }).filter(Boolean).join('');
                if (pricingRows.innerHTML) pricingInfo?.classList.remove('hide');
            }
            // Build structured sizes display by category
            const availFits = (product.available_fits || 'adult').split(',').map(f => f.trim().toLowerCase());
            const sizeRows = [];
            if (availFits.includes('adult')) {
                const sz = (product.sizes || 'S,M,L,XL,2XL,3XL,4XL,5XL,6XL').split(',').map(s => s.trim()).filter(Boolean);
                sizeRows.push({ label: 'Adult', sizes: sz, color: 'text-brand-400' });
            }
            if (availFits.includes('youth')) {
                const sz = (product.youth_sizes || 'YXXS,YXS,YS,YM,YL,YXL').split(',').map(s => s.trim()).filter(Boolean);
                sizeRows.push({ label: 'Youth Unisex', sizes: sz, color: 'text-green-400' });
            }
            if (availFits.includes('women')) {
                const sz = (product.women_sizes || '6,8,10,12,14,16,18,20,22,24,26').split(',').map(s => s.trim()).filter(Boolean);
                sizeRows.push({ label: "Women's", sizes: sz, color: 'text-purple-400' });
            }
            const display = document.getElementById('cp-sizes-display');
            if (sizeRows.length) {
                display.innerHTML = sizeRows.map(row =>
                    `<div class="flex items-baseline gap-2">
                        <span class="text-xs ${row.color} font-medium w-24 flex-shrink-0">${row.label}</span>
                        <span class="text-xs font-mono text-gray-400">${row.sizes.join(' · ')}</span>
                    </div>`
                ).join('');
            } else {
                display.innerHTML = '<p class="text-xs text-gray-500">See master product</p>';
            }
            document.getElementById('cp-sizes-info').classList.remove('hide');
        }

        async function saveClubProduct() {
            const cpId = document.getElementById('edit-club-product-id').value;
            const productId = document.getElementById('cp-master-product').value;
            const customName = document.getElementById('cp-custom-name').value.trim();
            if (!productId) { showToast('Please select a master product', 'error'); return; }
            if (!customName) { showToast('Club product name is required', 'error'); return; }
            const cpData = {
                club_id: currentClub.id, product_id: productId, custom_name: customName, is_active: true
            };
            let result;
            if (cpId) {
                result = await supabase.from('club_products')
                    .update({ custom_name: cpData.custom_name, updated_at: new Date().toISOString() })
                    .eq('id', cpId)
                    .select('*, products(product_code, item_name, category, range_name, fit_type, sizes, youth_sizes, women_sizes, available_fits, has_addons, weight_grams, description, tier_prices, cogs)').single();
            } else {
                result = await supabase.from('club_products').insert(cpData)
                    .select('*, products(product_code, item_name, category, range_name, fit_type, sizes, youth_sizes, women_sizes, available_fits, has_addons, weight_grams, description, tier_prices, cogs)').single();
            }
            if (result.error) { showToast(result.error.message, 'error'); return; }
            if (cpId) {
                const idx = currentClubProducts.findIndex(p => p.id === cpId);
                if (idx !== -1) currentClubProducts[idx] = result.data;
            } else {
                currentClubProducts.push(result.data);
            }
            hideClubProductModal();
            renderClubProducts();
            updateOverviewStats();
            showToast(cpId ? 'Product updated' : 'Product added to club');
        }

        async function removeClubProduct(cpId) {
            if (!confirm('Remove this product from the club?')) return;
            const { error } = await supabase.from('club_products').update({ is_active: false }).eq('id', cpId);
            if (error) { showToast(error.message, 'error'); return; }
            currentClubProducts = currentClubProducts.filter(p => p.id !== cpId);
            renderClubProducts();
            updateOverviewStats();
            showToast('Product removed');
        }

        // =============================================
        // SHOPIFY CONFIG
        // =============================================
        function loadShopifyConfigUI() {
            if (!currentBrand) return;
            document.getElementById('shopify-domain').value = currentBrand.shopify_domain || '';
            document.getElementById('shopify-client-id').value = currentBrand.shopify_client_id || '';
            document.getElementById('shopify-client-secret').value = currentBrand.shopify_client_secret || '';
            document.getElementById('shopify-api-version').value = currentBrand.shopify_api_version || '2025-01';
        }

        async function saveShopifyConfig() {
            const domain = document.getElementById('shopify-domain').value.trim();
            const clientId = document.getElementById('shopify-client-id').value.trim();
            const clientSecret = document.getElementById('shopify-client-secret').value.trim();
            const version = document.getElementById('shopify-api-version').value;
            const { error } = await supabase.from('brands').update({
                shopify_domain: domain || null,
                shopify_client_id: clientId || null,
                shopify_client_secret: clientSecret || null,
                shopify_api_version: version
            }).eq('id', currentBrand.id);
            if (error) { showToast(error.message, 'error'); return; }
            currentBrand.shopify_domain = domain;
            currentBrand.shopify_client_id = clientId;
            currentBrand.shopify_client_secret = clientSecret;
            currentBrand.shopify_api_version = version;
            showToast('Shopify config saved');
            const statusEl = document.getElementById('shopify-config-status');
            if (statusEl) {
                statusEl.className = 'mt-3 text-sm text-green-400';
                statusEl.textContent = domain ? `Connected to ${domain}` : 'Config cleared';
                statusEl.classList.remove('hide');
            }
        }

        async function testShopifyConnection() {
            const domain = document.getElementById('shopify-domain').value.trim();
            const clientId = document.getElementById('shopify-client-id').value.trim();
            const clientSecret = document.getElementById('shopify-client-secret').value.trim();
            const version = document.getElementById('shopify-api-version').value;
            if (!domain || !clientId || !clientSecret) { showToast('Enter domain, client ID, and client secret first', 'error'); return; }
            const statusEl = document.getElementById('shopify-config-status');
            statusEl.className = 'mt-3 text-sm text-gray-400';
            statusEl.textContent = 'Testing connection...';
            statusEl.classList.remove('hide');
            try {
                const result = await shopifyApiRequest(domain, clientId, clientSecret, version, 'GET', 'shop.json');
                if (result.shop) {
                    statusEl.className = 'mt-3 text-sm text-green-400';
                    statusEl.textContent = `✓ Connected to ${result.shop.name} (${result.shop.domain})`;
                    showToast('Shopify connection successful!');
                } else {
                    statusEl.className = 'mt-3 text-sm text-red-400';
                    statusEl.textContent = 'Connection failed – check credentials';
                }
            } catch (err) {
                statusEl.className = 'mt-3 text-sm text-red-400';
                statusEl.textContent = `Error: ${err.message}. Ensure CORS is enabled for this domain in your Shopify Custom App.`;
            }
        }

        async function shopifyApiRequest(domain, clientId, clientSecret, version, method, endpoint, body = null) {
            const url = `https://${domain}/admin/api/${version}/${endpoint}`;
            const opts = { method, headers: { 'Content-Type': 'application/json', 'Authorization': 'Basic ' + btoa(clientId + ':' + clientSecret) } };
            if (body) opts.body = JSON.stringify(body);
            const res = await fetch(url, opts);
            if (!res.ok) {
                const errText = await res.text().catch(() => res.statusText);
                throw new Error(`${res.status}: ${errText}`);
            }
            return res.json();
        }

        function getShopifyCredentials() {
            const domain = currentBrand?.shopify_domain;
            const clientId = currentBrand?.shopify_client_id;
            const clientSecret = currentBrand?.shopify_client_secret;
            const version = currentBrand?.shopify_api_version || '2025-01';
            if (!domain || !clientId || !clientSecret) {
                showToast('Shopify credentials not configured. Go to Brand Settings → Shopify API.', 'error');
                return null;
            }
            return { domain, clientId, clientSecret, version };
        }

        // =============================================
        // SHOPIFY SYNC: COLLECTION
        // =============================================
        function renderShopifySyncStatus() {
            const collEl = document.getElementById('club-shopify-collection-status');
            if (collEl && currentClub) {
                if (currentClub.shopify_collection_id) {
                    collEl.innerHTML = `<div class="flex items-center gap-2 text-sm"><span class="text-green-400">✓</span><span>Collection synced – Shopify ID: <code class="text-brand-400">${currentClub.shopify_collection_id}</code></span></div>`;
                } else {
                    collEl.innerHTML = `<div class="text-yellow-400 text-sm">⚠ No Shopify collection yet</div>`;
                }
            }
            const prodEl = document.getElementById('club-shopify-products-status');
            if (prodEl) {
                if (!currentClubProducts.length) {
                    prodEl.innerHTML = '<p class="text-gray-600 text-sm">No club products. Add products in the Products tab first.</p>';
                    return;
                }
                prodEl.innerHTML = currentClubProducts.map(cp => `
                    <div class="flex items-center justify-between py-2 border-b border-gray-800 last:border-0">
                        <div>
                            <span class="text-sm">${cp.custom_name}</span>
                            <span class="text-xs text-gray-600 ml-2">${cp.products?.product_code || ''}</span>
                        </div>
                        <div class="flex items-center gap-3">
                            ${cp.shopify_product_id ? `<span class="text-xs text-green-400">✓ #${cp.shopify_product_id}</span>` : '<span class="text-xs text-gray-600">Not synced</span>'}
                            <button onclick="syncProductToShopify('${cp.id}')" class="text-xs text-brand-400 hover:text-brand-300">Sync</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        async function syncClubCollection() {
            const creds = getShopifyCredentials();
            if (!creds || !currentClub) return;
            showToast('Syncing collection to Shopify...');
            try {
                const collectionData = {
                    custom_collection: {
                        title: currentClub.name,
                        handle: currentClub.slug || currentClub.name.toLowerCase().replace(/[^a-z0-9]+/g, '-'),
                        body_html: `Official ${currentClub.name} teamwear collection.`,
                        published: true
                    }
                };
                if (currentClub.collection_image_url) {
                    collectionData.custom_collection.image = { src: currentClub.collection_image_url };
                }
                let result;
                if (currentClub.shopify_collection_id) {
                    result = await shopifyApiRequest(creds.domain, creds.clientId, creds.clientSecret, creds.version, 'PUT',
                        `custom_collections/${currentClub.shopify_collection_id}.json`, collectionData);
                } else {
                    result = await shopifyApiRequest(creds.domain, creds.clientId, creds.clientSecret, creds.version, 'POST',
                        'custom_collections.json', collectionData);
                }
                const collectionId = result.custom_collection?.id?.toString();
                if (!collectionId) throw new Error('No collection ID returned');
                await supabase.from('clubs').update({ shopify_collection_id: collectionId }).eq('id', currentClub.id);
                const idx = clubs.findIndex(c => c.id === currentClub.id);
                if (idx !== -1) clubs[idx].shopify_collection_id = collectionId;
                currentClub.shopify_collection_id = collectionId;
                renderShopifySyncStatus();
                showToast('Collection synced!');
            } catch (err) { showToast('Sync failed: ' + err.message, 'error'); }
        }

        async function syncProductToShopify(cpId) {
            const creds = getShopifyCredentials();
            if (!creds || !currentClub) return;
            const cp = currentClubProducts.find(p => p.id === cpId);
            if (!cp) return;
            const masterProduct = cp.products;
            if (!masterProduct) { showToast('Master product data missing', 'error'); return; }
            showToast(`Syncing "${cp.custom_name}"...`);
            try {
                const sizes = masterProduct.sizes?.split(',').map(s => s.trim()) || [];
                const youthSizes = sizes.filter(s => s.startsWith('Y'));
                const adultSizes = sizes.filter(s => !s.startsWith('Y') && s !== 'One Size');
                const isSinglePrice = masterProduct.fit_type === 'One Size Only';
                let variants = [];
                if (isSinglePrice) {
                    variants.push({ option1: 'One Size', price: (cp.web_price || 0).toFixed(2),
                        sku: `${masterProduct.product_code}/${currentClub.suffix}-OS`,
                        inventory_management: 'shopify', inventory_policy: 'continue',
                        weight: masterProduct.weight_grams || 400, weight_unit: 'g', taxable: false });
                } else {
                    youthSizes.forEach(size => variants.push({ option1: 'Youth', option2: size,
                        price: (cp.web_price || 0).toFixed(2), sku: `${masterProduct.product_code}/${currentClub.suffix}-${size}`,
                        inventory_management: 'shopify', inventory_policy: 'continue',
                        weight: masterProduct.weight_grams || 400, weight_unit: 'g', taxable: false }));
                    adultSizes.forEach(size => variants.push({ option1: 'Adult', option2: size,
                        price: (cp.web_price || 0).toFixed(2), sku: `${masterProduct.product_code}/${currentClub.suffix}-${size}`,
                        inventory_management: 'shopify', inventory_policy: 'continue',
                        weight: masterProduct.weight_grams || 400, weight_unit: 'g', taxable: true }));
                }
                const options = isSinglePrice ? [{ name: 'Size' }] : [{ name: 'Fit' }, { name: 'Size' }];
                const tags = [`club:${currentClub.slug || currentClub.suffix.toLowerCase()}`, masterProduct.range_name, masterProduct.category].filter(Boolean).join(',');
                const productPayload = { product: {
                    title: cp.custom_name,
                    body_html: masterProduct.description || '',
                    vendor: currentBrand.name,
                    product_type: masterProduct.category || '',
                    tags, options, variants, published: true
                }};
                if (cp.image_url) productPayload.product.images = [{ src: cp.image_url, alt: cp.custom_name }];
                let result;
                if (cp.shopify_product_id) {
                    result = await shopifyApiRequest(creds.domain, creds.clientId, creds.clientSecret, creds.version, 'PUT',
                        `products/${cp.shopify_product_id}.json`, productPayload);
                } else {
                    result = await shopifyApiRequest(creds.domain, creds.clientId, creds.clientSecret, creds.version, 'POST',
                        'products.json', productPayload);
                }
                const shopifyProduct = result.product;
                if (!shopifyProduct) throw new Error('No product returned from Shopify');
                const variantIds = shopifyProduct.variants?.map(v => ({ id: v.id, sku: v.sku, option1: v.option1, option2: v.option2 })) || [];
                if (currentClub.shopify_collection_id && shopifyProduct.id) {
                    try {
                        await shopifyApiRequest(creds.domain, creds.clientId, creds.clientSecret, creds.version, 'POST', 'collects.json',
                            { collect: { product_id: shopifyProduct.id, collection_id: parseInt(currentClub.shopify_collection_id) } });
                    } catch(e) { /* may already be in collection */ }
                }
                await supabase.from('club_products').update({
                    shopify_product_id: shopifyProduct.id.toString(),
                    shopify_variant_ids: variantIds,
                    shopify_synced_at: new Date().toISOString()
                }).eq('id', cpId);
                const idx = currentClubProducts.findIndex(p => p.id === cpId);
                if (idx !== -1) {
                    currentClubProducts[idx].shopify_product_id = shopifyProduct.id.toString();
                    currentClubProducts[idx].shopify_variant_ids = variantIds;
                }
                renderClubProducts();
                if (currentClubTab === 'shopify') renderShopifySyncStatus();
                updateOverviewStats();
                showToast(`"${cp.custom_name}" synced to Shopify!`);
            } catch (err) { showToast('Sync failed: ' + err.message, 'error'); }
        }

        async function syncAllClubProducts() {
            for (const cp of currentClubProducts) {
                await syncProductToShopify(cp.id);
            }
        }

        // =============================================
        // CLUB DETAIL: IMAGES TAB
        // =============================================
        async function loadClubDetailImages() {
            if (!currentClub) return;
            selectedClubId = currentClub.id;
            const grid = document.getElementById('club-detail-images-grid');
            const countEl = document.getElementById('club-detail-image-count');
            const emptyEl = document.getElementById('club-detail-images-empty');
            const { data } = await supabase.from('club_images')
                .select('*, products(item_name, product_code)').eq('club_id', currentClub.id);
            const images = data || [];
            if (countEl) countEl.textContent = images.length;
            if (!images.length) {
                if (grid) grid.innerHTML = '';
                if (emptyEl) emptyEl.classList.remove('hide');
            } else {
                if (emptyEl) emptyEl.classList.add('hide');
                if (grid) {
                    grid.innerHTML = images.map(img => `
                        <div class="image-item">
                            <img src="${img.public_url}" alt="${img.file_name}" loading="lazy">
                            <div class="overlay">
                                <p class="text-xs text-white text-center px-2 mb-2">${img.products?.item_name || 'Unknown'}</p>
                                <button onclick="deleteClubImageFromDetail('${img.id}')" class="text-red-400 text-xs">Delete</button>
                            </div>
                        </div>`).join('');
                }
            }
            const badge = document.getElementById('club-detail-collection-badge');
            if (badge) {
                if (currentClub.collection_image_url) {
                    badge.className = 'badge badge-success'; badge.textContent = '✓ Collection image';
                } else {
                    badge.className = 'badge badge-warning'; badge.textContent = 'No collection image';
                }
            }
        }

        function handleClubDetailDrop(e) {
            e.preventDefault(); e.currentTarget.classList.remove('drag-over');
            const files = e.dataTransfer.files;
            if (files.length > 0) handleClubDetailImageUpload({ target: { files } });
        }

        async function handleClubDetailImageUpload(event) {
            if (!currentClub) return;
            if (!currentClub.club_status) {
                showToast('Please set a Partnership Level in Club Info before uploading mock-ups', 'error');
                return;
            }
            selectedClubId = currentClub.id;
            const files = event.target.files;
            if (!files.length) return;
            const progressEl = document.getElementById('club-detail-upload-progress');
            const progressBar = document.getElementById('club-detail-upload-bar');
            const statusText = document.getElementById('club-detail-upload-text');
            const countText = document.getElementById('club-detail-upload-count');
            progressEl.classList.remove('hide');
            progressBar.style.width = '0%';
            let uploaded = 0, failed = 0;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                statusText.textContent = `Uploading ${file.name}...`;
                countText.textContent = `${i+1}/${files.length}`;
                progressBar.style.width = `${Math.round(((i+1)/files.length)*100)}%`;
                const nameWithoutExt = file.name.replace(/\.[^/.]+$/, '').toLowerCase();
                if (nameWithoutExt === 'collection-image') {
                    try {
                        const storagePath = `${currentBrand.slug}/${currentClub.suffix}/collection-image${file.name.substring(file.name.lastIndexOf('.'))}`;
                        const { error: uploadError } = await supabase.storage.from('club-images').upload(storagePath, file, { upsert: true });
                        if (!uploadError) {
                            const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(storagePath);
                            await supabase.from('clubs').update({ collection_image_url: urlData.publicUrl }).eq('id', currentClub.id);
                            const cidx = clubs.findIndex(c => c.id === currentClub.id);
                            if (cidx !== -1) { clubs[cidx].collection_image_url = urlData.publicUrl; }
                            currentClub.collection_image_url = urlData.publicUrl;
                            uploaded++;
                        } else { failed++; }
                    } catch { failed++; }
                    continue;
                }
                const productCode = nameWithoutExt.replace(/-/g, '/').toUpperCase();
                const product = products.find(p => p.product_code.toUpperCase() === productCode);
                if (!product) { showToast(`No product matching: ${nameWithoutExt}`, 'error'); failed++; continue; }
                try {
                    const storagePath = `${currentBrand.slug}/${currentClub.suffix}/${file.name}`;
                    const { error: uploadError } = await supabase.storage.from('club-images').upload(storagePath, file, { upsert: true });
                    if (uploadError) { failed++; continue; }
                    const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(storagePath);
                    await supabase.from('club_images').upsert({
                        club_id: currentClub.id, product_id: product.id,
                        file_name: file.name, storage_path: storagePath,
                        public_url: urlData.publicUrl, uploaded_by: currentUser.id
                    }, { onConflict: 'club_id,product_id' });

                    // Auto-create club product from image if not already present
                    await autoCreateClubProductFromImage(product, urlData.publicUrl);
                    uploaded++;
                } catch { failed++; }
            }
            if (uploaded > 0) {
                await supabase.from('clubs').update({ has_images: true }).eq('id', currentClub.id);
                currentClub.has_images = true;
            }
            statusText.textContent = 'Complete!'; progressBar.style.width = '100%';
            setTimeout(() => progressEl.classList.add('hide'), 1500);
            if (event.target.value !== undefined) event.target.value = '';
            loadClubDetailImages();
            // Refresh club products to show newly created ones
            await loadCurrentClubProducts();
            renderClubProducts();
            showToast(failed > 0 ? `${uploaded} uploaded, ${failed} failed` : `${uploaded} images uploaded — club products auto-created`);
        }

        // Auto-create a club product when an image is uploaded and matched to a master product
        async function autoCreateClubProductFromImage(masterProduct, imageUrl) {
            if (!currentClub || !masterProduct) return;

            // Check if club product already exists for this product
            const { data: existing } = await supabase
                .from('club_products')
                .select('id, image_urls')
                .eq('club_id', currentClub.id)
                .eq('product_id', masterProduct.id)
                .single();
            if (existing) {
                // Append new image URL to image_urls array (avoid duplicates)
                const currentUrls = Array.isArray(existing.image_urls) ? existing.image_urls : [];
                if (!currentUrls.includes(imageUrl)) currentUrls.push(imageUrl);
                await supabase.from('club_products').update({ image_urls: currentUrls }).eq('id', existing.id);
                // Update local state
                const idx = currentClubProducts.findIndex(p => p.id === existing.id);
                if (idx !== -1) currentClubProducts[idx].image_urls = currentUrls;
                return;
            }

            // Determine pricing based on club's partnership level
            const clubTierKey = currentClub.club_status || 'retail';
            const tierPrices = (masterProduct.tier_prices && typeof masterProduct.tier_prices === 'object') ? masterProduct.tier_prices : {};
            const tp = tierPrices[clubTierKey] || tierPrices['retail'] || {};
            const adultPrice = tp.adult || masterProduct.adult_partner_price || masterProduct.adult_retail_price || null;
            const youthPrice = tp.youth || masterProduct.youth_partner_price || masterProduct.youth_retail_price || null;
            const webPrice = adultPrice ? parseFloat(adultPrice) : null;

            // Build custom name using club name as prefix (placeholder replacement)
            const customName = `${currentClub.name} ${masterProduct.item_name}`;

            await supabase.from('club_products').insert({
                club_id: currentClub.id,
                product_id: masterProduct.id,
                custom_name: customName,
                image_urls: [imageUrl],
                partner_price: adultPrice,
                non_partner_price: youthPrice,
                web_price: webPrice,
                is_active: true
            });
        }

        // Sync club products from all images — called from onboarding tab
        async function syncClubProductsFromImages() {
            if (!currentClub) return;
            showToast('Scanning images and syncing club products...');

            const { data: images } = await supabase
                .from('club_images')
                .select('*, products(*)')
                .eq('club_id', currentClub.id);

            if (!images || images.length === 0) {
                showToast('No images found in the Images tab for this club', 'error');
                return;
            }

            let created = 0;
            for (const img of images) {
                if (!img.products) continue;
                await autoCreateClubProductFromImage(img.products, img.public_url);
                created++;
            }

            await loadCurrentClubProducts();
            renderClubProducts();
            showToast(`Synced ${created} product${created !== 1 ? 's' : ''} from images`);
        }

        async function deleteClubImageFromDetail(imageId) {
            const { data: image } = await supabase.from('club_images').select('storage_path').eq('id', imageId).single();
            if (!image) return;
            await supabase.storage.from('club-images').remove([image.storage_path]);
            await supabase.from('club_images').delete().eq('id', imageId);
            loadClubDetailImages();
            showToast('Image deleted');
        }

        // =============================================
        // ORDER FORMS
        // =============================================
        async function loadCurrentClubOrderForms() {
            if (!currentClub) return;
            const { data } = await supabase.from('order_forms')
                .select('*').eq('club_id', currentClub.id).order('created_at', { ascending: false });
            currentOrderForms = data || [];
        }

        function renderClubOrderForms() {
            const container = document.getElementById('club-order-forms-list');
            const emptyEl = document.getElementById('club-order-forms-empty');
            if (!currentOrderForms.length) {
                container.innerHTML = '';
                emptyEl.classList.remove('hide');
                return;
            }
            emptyEl.classList.add('hide');
            container.innerHTML = currentOrderForms.map(form => {
                const formUrl = `${window.location.origin}${window.location.pathname}?form=${form.token}`;
                return `
                <div class="order-form-card">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold">${form.title}</span>
                                <span class="badge ${form.is_active ? 'badge-success' : 'badge-danger'} text-xs">${form.is_active ? 'Active' : 'Closed'}</span>
                            </div>
                            ${form.season ? `<p class="text-gray-500 text-xs mb-1">Season: ${form.season}</p>` : ''}
                            ${form.description ? `<p class="text-gray-400 text-xs mb-2">${form.description}</p>` : ''}
                            <div class="flex items-center gap-2 bg-gray-900/50 rounded-lg px-3 py-2 mt-2">
                                <span class="text-gray-600 text-xs flex-1 font-mono truncate">${formUrl}</span>
                                <button onclick="copyFormLink('${formUrl}')" class="text-brand-400 hover:text-brand-300 text-xs whitespace-nowrap">Copy Link</button>
                                <a href="${formUrl}" target="_blank" class="text-gray-500 hover:text-white text-xs whitespace-nowrap">Preview →</a>
                            </div>
                        </div>
                        <div class="flex flex-col gap-2 flex-shrink-0">
                            <button onclick="viewFormSubmissions('${form.id}')" class="btn-primary text-xs py-1 px-3 whitespace-nowrap">View Submissions</button>
                            <button onclick="toggleFormStatus('${form.id}', ${!form.is_active})" class="btn-secondary text-xs py-1 px-3">
                                ${form.is_active ? 'Close Form' : 'Reopen'}
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        function showCreateOrderFormModal() {
            if (!currentClub) return;
            if (!currentClubProducts.length) {
                showToast('Add club products first before creating an order form', 'error');
                return;
            }
            document.getElementById('of-title').value = `${currentClub.name} Kit Order`;
            document.getElementById('of-season').value = '';
            document.getElementById('of-description').value = '';
            document.getElementById('order-form-modal').classList.remove('hide');
        }

        function hideOrderFormModal() {
            document.getElementById('order-form-modal').classList.add('hide');
        }

        function generateToken() {
            const array = new Uint8Array(24);
            crypto.getRandomValues(array);
            return Array.from(array, b => b.toString(16).padStart(2, '0')).join('');
        }

        async function createOrderForm() {
            const title = document.getElementById('of-title').value.trim();
            if (!title) { showToast('Form title is required', 'error'); return; }
            const formData = {
                club_id: currentClub.id, brand_id: currentBrand.id, title,
                token: generateToken(),
                season: document.getElementById('of-season').value.trim() || null,
                description: document.getElementById('of-description').value.trim() || null,
                is_active: true, created_by: currentUser.id
            };
            const { data, error } = await supabase.from('order_forms').insert(formData).select().single();
            if (error) { showToast(error.message, 'error'); return; }
            currentOrderForms.unshift(data);
            hideOrderFormModal();
            renderClubOrderForms();
            updateOverviewStats();
            showToast('Order form created! Share the link with the club.');
        }

        function copyFormLink(url) {
            navigator.clipboard.writeText(url).then(() => showToast('Link copied!'));
        }

        async function toggleFormStatus(formId, newStatus) {
            const { error } = await supabase.from('order_forms').update({ is_active: newStatus }).eq('id', formId);
            if (error) { showToast(error.message, 'error'); return; }
            const idx = currentOrderForms.findIndex(f => f.id === formId);
            if (idx !== -1) currentOrderForms[idx].is_active = newStatus;
            renderClubOrderForms();
            showToast(newStatus ? 'Form reopened' : 'Form closed');
        }

        // =============================================
        // SUBMISSIONS: GLOBAL VIEW + DETAIL
        // =============================================
        let currentSubmission = null;
        let currentSubmissionItems = [];

        async function viewFormSubmissions(formId) {
            showTool('order-forms');
            await loadAllSubmissions(formId);
        }

        async function loadAllSubmissions(filterFormId = null) {
            if (!currentBrand) return;
            const clubFilter = document.getElementById('global-forms-club-filter');
            if (clubFilter && clubs.length) {
                clubFilter.innerHTML = '<option value="">All Clubs</option>' +
                    clubs.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
            const { data: allForms } = await supabase.from('order_forms').select('*').eq('brand_id', currentBrand.id);
            if (!allForms?.length) {
                document.getElementById('global-submissions-list').innerHTML = '';
                document.getElementById('global-submissions-empty').classList.remove('hide');
                document.getElementById('global-submissions-count').textContent = '0';
                return;
            }
            let formIds = allForms.map(f => f.id);
            const selectedClubId_global = document.getElementById('global-forms-club-filter')?.value;
            if (selectedClubId_global) {
                formIds = allForms.filter(f => f.club_id === selectedClubId_global).map(f => f.id);
            }
            if (filterFormId) formIds = [filterFormId];
            if (!formIds.length) {
                document.getElementById('global-submissions-list').innerHTML = '<p class="text-gray-500 text-sm text-center py-8">No forms match your filter.</p>';
                document.getElementById('global-submissions-count').textContent = '0';
                return;
            }
            const { data: submissions } = await supabase.from('order_submissions')
                .select('*').in('form_id', formIds).order('submitted_at', { ascending: false });
            const statusFilter = document.getElementById('global-forms-status-filter')?.value || '';
            let filtered = submissions || [];
            if (statusFilter === 'new') filtered = filtered.filter(s => !s.shopify_draft_order_id);
            if (statusFilter === 'drafted') filtered = filtered.filter(s => !!s.shopify_draft_order_id);
            document.getElementById('global-submissions-count').textContent = filtered.length;
            const emptyEl = document.getElementById('global-submissions-empty');
            const listEl = document.getElementById('global-submissions-list');
            if (!filtered.length) {
                listEl.innerHTML = '';
                emptyEl.classList.remove('hide');
                return;
            }
            emptyEl.classList.add('hide');
            const formLookup = {};
            allForms.forEach(f => { formLookup[f.id] = f; });
            const clubLookup = {};
            clubs.forEach(c => { clubLookup[c.id] = c; });
            listEl.innerHTML = filtered.map(sub => {
                const form = formLookup[sub.form_id];
                const club = form ? clubLookup[form.club_id] : null;
                const date = new Date(sub.submitted_at).toLocaleDateString('en-GB', { day: '2-digit', month: 'short', year: 'numeric' });
                return `
                <div class="submission-card flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <div class="flex items-center gap-2 flex-wrap mb-1">
                            <span class="font-semibold">${sub.contact_name}</span>
                            ${sub.shopify_draft_order_id
                                ? '<span class="badge badge-success text-xs">Draft Order Created</span>'
                                : '<span class="badge badge-warning text-xs">Pending Review</span>'}
                        </div>
                        <div class="text-xs text-gray-500 space-x-2">
                            <span>${club?.name || 'Unknown Club'}</span>·
                            <span>${form?.title || ''}</span>·
                            <span>${date}</span>
                            ${sub.team_name ? `· <span>${sub.team_name}</span>` : ''}
                        </div>
                        ${sub.contact_email ? `<p class="text-xs text-gray-600 mt-1">${sub.contact_email}</p>` : ''}
                    </div>
                    <button onclick="openSubmission('${sub.id}')" class="btn-primary text-xs py-1 px-3 whitespace-nowrap flex-shrink-0">View</button>
                </div>`;
            }).join('');
        }

        async function openSubmission(submissionId) {
            const { data: sub } = await supabase.from('order_submissions').select('*').eq('id', submissionId).single();
            if (!sub) return;
            currentSubmission = sub;
            const { data: items } = await supabase.from('order_submission_items')
                .select('*, club_products(custom_name, products(product_code))')
                .eq('submission_id', submissionId).order('line_order');
            currentSubmissionItems = items || [];
            document.getElementById('sub-contact-info').innerHTML = [
                ['Name', sub.contact_name], ['Email', sub.contact_email], ['Phone', sub.contact_phone || '-']
            ].map(([k, v]) => `<div class="info-row"><span class="info-label">${k}</span><span class="info-value">${v}</span></div>`).join('');
            document.getElementById('sub-order-info').innerHTML = [
                ['Team', sub.team_name || '-'], ['Season', sub.season || '-'],
                ['Submitted', new Date(sub.submitted_at).toLocaleString('en-GB')], ['Notes', sub.notes || '-']
            ].map(([k, v]) => `<div class="info-row"><span class="info-label">${k}</span><span class="info-value">${v}</span></div>`).join('');
            document.getElementById('sub-items-count').textContent = currentSubmissionItems.length;
            document.getElementById('sub-items-table').innerHTML = currentSubmissionItems.map(item => `
                <tr>
                    <td>${item.club_products?.custom_name || '-'}</td>
                    <td>${item.size}</td>
                    <td class="font-semibold">${item.quantity}</td>
                    <td>${item.player_name || '-'}</td>
                    <td>${item.player_number || '-'}</td>
                    <td class="text-gray-500 text-xs">${item.notes || '-'}</td>
                </tr>`).join('');
            const draftStatusEl = document.getElementById('sub-draft-status');
            const draftLinkEl = document.getElementById('sub-draft-link');
            const draftBtn = document.getElementById('sub-create-draft-btn');
            if (sub.shopify_draft_order_id) {
                draftStatusEl.textContent = `Draft Order #${sub.shopify_draft_order_id} created`;
                draftStatusEl.className = 'text-green-400 text-sm';
                draftBtn.textContent = 'Recreate Draft Order';
                if (sub.shopify_draft_order_url) {
                    draftLinkEl.classList.remove('hide');
                    document.getElementById('sub-draft-url').href = sub.shopify_draft_order_url;
                }
            } else {
                draftStatusEl.textContent = 'No draft order yet';
                draftStatusEl.className = 'text-gray-500 text-sm';
                draftBtn.textContent = 'Create Draft Order in Shopify';
                draftLinkEl.classList.add('hide');
            }
            document.getElementById('submission-modal').classList.remove('hide');
            document.getElementById('submission-modal-inner').classList.remove('hide');
        }

        function hideSubmissionModal() {
            document.getElementById('submission-modal').classList.add('hide');
            document.getElementById('submission-modal-inner').classList.add('hide');
            currentSubmission = null;
        }

        // Close submission modal when clicking backdrop
        document.getElementById('submission-modal').addEventListener('click', function(e) {
            if (e.target === this) hideSubmissionModal();
        });

        // =============================================
        // DRAFT ORDER CREATION
        // =============================================
        async function createDraftOrderFromSubmission() {
            const creds = getShopifyCredentials();
            if (!creds || !currentSubmission) return;
            if (!currentSubmissionItems.length) { showToast('No items in this submission', 'error'); return; }
            const { data: form } = await supabase.from('order_forms').select('*, clubs(*)').eq('id', currentSubmission.form_id).single();
            if (!form) { showToast('Form not found', 'error'); return; }
            const club = form.clubs;
            const isPartner = club?.is_partner;
            showToast('Creating Shopify draft order...');
            try {
                const lineItems = [];
                for (const item of currentSubmissionItems) {
                    const { data: cp } = await supabase.from('club_products')
                        .select('*, products(*)').eq('id', item.club_product_id).single();
                    if (!cp) continue;
                    const price = isPartner
                        ? (cp.partner_price || cp.web_price || 0)
                        : (cp.non_partner_price || cp.web_price || 0);
                    const variantIds = cp.shopify_variant_ids || [];
                    let variantId = null;
                    if (variantIds.length > 0) {
                        const match = variantIds.find(v =>
                            v.option2 === item.size || v.option1 === item.size ||
                            (item.size.startsWith('Y') && v.option1 === 'Youth' && v.option2 === item.size) ||
                            (!item.size.startsWith('Y') && v.option1 === 'Adult' && v.option2 === item.size)
                        );
                        if (match) variantId = match.id;
                    }
                    const lineItem = {
                        title: cp.custom_name, quantity: item.quantity, price: price.toFixed(2), properties: []
                    };
                    if (variantId) lineItem.variant_id = variantId;
                    if (item.player_name) lineItem.properties.push({ name: 'Player Name', value: item.player_name });
                    if (item.player_number) lineItem.properties.push({ name: 'Player Number', value: item.player_number });
                    if (currentSubmission.team_name) lineItem.properties.push({ name: 'Team', value: currentSubmission.team_name });
                    lineItem.properties.push({ name: 'Size', value: item.size });
                    if (item.notes) lineItem.properties.push({ name: 'Notes', value: item.notes });
                    lineItems.push(lineItem);
                }
                if (!lineItems.length) { showToast('No line items to create. Ensure products are synced to Shopify.', 'error'); return; }
                const nameParts = currentSubmission.contact_name.split(' ');
                const draftOrderPayload = {
                    draft_order: {
                        line_items: lineItems,
                        customer: { email: currentSubmission.contact_email, first_name: nameParts[0] || '', last_name: nameParts.slice(1).join(' ') || '-' },
                        note: [`Club: ${club?.name || ''}`, `Team: ${currentSubmission.team_name || '-'}`, `Pricing: ${isPartner ? 'Partner' : 'Non-Partner'}`, currentSubmission.notes ? `Notes: ${currentSubmission.notes}` : ''].filter(Boolean).join('\n'),
                        tags: `teamwearos,club:${club?.slug || ''},${isPartner ? 'partner' : 'non-partner'}`
                    }
                };
                const result = await shopifyApiRequest(creds.domain, creds.clientId, creds.clientSecret, creds.version, 'POST', 'draft_orders.json', draftOrderPayload);
                const draftOrder = result.draft_order;
                if (!draftOrder) throw new Error('No draft order returned');
                await supabase.from('order_submissions').update({
                    shopify_draft_order_id: draftOrder.id.toString(),
                    shopify_draft_order_status: draftOrder.status,
                    shopify_draft_order_url: draftOrder.invoice_url,
                    reviewed_at: new Date().toISOString(),
                    reviewed_by: currentUser.id
                }).eq('id', currentSubmission.id);
                document.getElementById('sub-draft-status').textContent = `Draft Order #${draftOrder.id} created`;
                document.getElementById('sub-draft-status').className = 'text-green-400 text-sm';
                document.getElementById('sub-create-draft-btn').textContent = 'Recreate Draft Order';
                if (draftOrder.invoice_url) {
                    document.getElementById('sub-draft-link').classList.remove('hide');
                    document.getElementById('sub-draft-url').href = draftOrder.invoice_url;
                }
                showToast(`Draft Order #${draftOrder.id} created in Shopify!`);
            } catch (err) { showToast('Draft order failed: ' + err.message, 'error'); }
        }

        // =============================================
        // PUBLIC ORDER FORM
        // =============================================
        let publicFormData = null;
        let publicFormProducts = [];
        let publicFormRows = [];

        async function loadPublicForm(token) {
            const loadingEl = document.getElementById('pf-loading');
            const errorEl = document.getElementById('pf-error');
            const contentEl = document.getElementById('pf-content');
            try {
                const { data: form } = await supabase.from('order_forms')
                    .select('*, clubs(id, name, slug, is_partner, brand_id, brands(name))')
                    .eq('token', token).eq('is_active', true).single();
                if (!form) { loadingEl.classList.add('hide'); errorEl.classList.remove('hide'); return; }
                publicFormData = form;
                const { data: clubProds } = await supabase.from('club_products')
                    .select('*, products(fit_type, sizes)')
                    .eq('club_id', form.clubs.id).eq('is_active', true);
                publicFormProducts = clubProds || [];
                if (!publicFormProducts.length) { loadingEl.classList.add('hide'); errorEl.classList.remove('hide'); return; }
                document.getElementById('pf-club-name').textContent = form.clubs.name;
                document.getElementById('pf-brand-logo').textContent = form.clubs.brands?.name || 'TeamwearOS';
                document.getElementById('pf-form-title').textContent = form.title;
                document.getElementById('pf-form-season').textContent = form.season ? `Season: ${form.season}` : '';
                document.getElementById('pf-form-description').textContent = form.description || '';
                loadingEl.classList.add('hide');
                contentEl.classList.remove('hide');
                addPublicFormRow();
            } catch (err) {
                loadingEl.classList.add('hide');
                errorEl.classList.remove('hide');
            }
        }

        function addPublicFormRow() {
            const rowId = Date.now();
            publicFormRows.push(rowId);
            const productOptions = publicFormProducts.map(cp =>
                `<option value="${cp.id}" data-sizes="${cp.products?.sizes || ''}">${cp.custom_name}</option>`
            ).join('');
            document.getElementById('pf-items-container').insertAdjacentHTML('beforeend', `
                <div id="pf-row-${rowId}" class="player-row bg-gray-900/30 rounded-lg p-2">
                    <select id="pf-product-${rowId}" onchange="updatePublicRowSizes(${rowId})" class="px-2 py-2 rounded-lg text-sm">
                        <option value="">Product...</option>${productOptions}
                    </select>
                    <select id="pf-size-${rowId}" class="px-2 py-2 rounded-lg text-sm">
                        <option value="">Size...</option>
                    </select>
                    <input type="number" id="pf-qty-${rowId}" value="1" min="1" class="px-2 py-2 rounded-lg text-sm text-center">
                    <input type="text" id="pf-player-${rowId}" placeholder="Player name" class="px-2 py-2 rounded-lg text-sm">
                    <input type="text" id="pf-num-${rowId}" placeholder="No." class="px-2 py-2 rounded-lg text-sm">
                    <button onclick="removePublicFormRow(${rowId})" class="text-gray-600 hover:text-red-400 text-xl px-2">×</button>
                </div>`);
        }

        function removePublicFormRow(rowId) {
            document.getElementById(`pf-row-${rowId}`)?.remove();
            publicFormRows = publicFormRows.filter(id => id !== rowId);
        }

        function updatePublicRowSizes(rowId) {
            const productSelect = document.getElementById(`pf-product-${rowId}`);
            const sizeSelect = document.getElementById(`pf-size-${rowId}`);
            const selectedOpt = productSelect.options[productSelect.selectedIndex];
            const sizesStr = selectedOpt.dataset.sizes || '';
            const allSizes = sizesStr.split(',').map(s => s.trim()).filter(Boolean);
            sizeSelect.innerHTML = '<option value="">Size...</option>' +
                allSizes.map(s => `<option value="${s}">${s}</option>`).join('');
        }

        async function submitPublicOrderForm() {
            if (!publicFormData) return;
            const contactName = document.getElementById('pf-contact-name').value.trim();
            const contactEmail = document.getElementById('pf-contact-email').value.trim();
            if (!contactName) { showToast('Please enter your name', 'error'); return; }
            if (!contactEmail || !contactEmail.includes('@')) { showToast('Please enter a valid email', 'error'); return; }
            const rowsData = [];
            for (const rowId of publicFormRows) {
                const productId = document.getElementById(`pf-product-${rowId}`)?.value;
                const size = document.getElementById(`pf-size-${rowId}`)?.value;
                const qty = parseInt(document.getElementById(`pf-qty-${rowId}`)?.value) || 1;
                if (!productId || !size) continue;
                rowsData.push({
                    club_product_id: productId, size, quantity: qty,
                    player_name: document.getElementById(`pf-player-${rowId}`)?.value.trim() || null,
                    player_number: document.getElementById(`pf-num-${rowId}`)?.value.trim() || null,
                    line_order: rowsData.length + 1
                });
            }
            if (!rowsData.length) { showToast('Please add at least one item with a product and size', 'error'); return; }
            const { data: submission, error: subError } = await supabase.from('order_submissions').insert({
                form_id: publicFormData.id,
                contact_name: contactName, contact_email: contactEmail,
                contact_phone: document.getElementById('pf-contact-phone')?.value.trim() || null,
                team_name: document.getElementById('pf-team-name')?.value.trim() || null,
                notes: document.getElementById('pf-notes')?.value.trim() || null
            }).select().single();
            if (subError) { showToast('Submission failed: ' + subError.message, 'error'); return; }
            const { error: itemsError } = await supabase.from('order_submission_items')
                .insert(rowsData.map(r => ({ ...r, submission_id: submission.id })));
            if (itemsError) { showToast('Error saving items: ' + itemsError.message, 'error'); return; }
            document.getElementById('pf-content').classList.add('hide');
            document.getElementById('pf-success').classList.remove('hide');
        }

        // =============================================
        // PO TRACKER V2
        // =============================================
        let currentPos = [];
        let editingPoId = null;

        async function loadPoTracker() {
            const { data, error } = await supabase
                .from('purchase_orders')
                .select('*, clubs(name)')
                .eq('brand_id', currentBrandId)
                .order('created_at', { ascending: false });
            if (error) { showToast('Error loading POs: ' + error.message, 'error'); return; }
            currentPos = data || [];
            renderPoList();
        }

        function renderPoList() {
            const search = (document.getElementById('po-search')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('po-status-filter')?.value || '';
            const filtered = currentPos.filter(po => {
                const matchSearch = !search ||
                    (po.po_number || '').toLowerCase().includes(search) ||
                    (po.factory_name || '').toLowerCase().includes(search) ||
                    (po.clubs?.name || '').toLowerCase().includes(search);
                const matchStatus = !statusFilter || po.status === statusFilter;
                return matchSearch && matchStatus;
            });
            const el = document.getElementById('po-list');
            if (!filtered.length) {
                el.innerHTML = '<p class="text-gray-400 text-center py-12">No purchase orders match your filters.</p>';
                return;
            }
            const statusColors = { draft: 'bg-gray-500/20 text-gray-300', sent: 'bg-blue-500/20 text-blue-300', acknowledged: 'bg-cyan-500/20 text-cyan-300', in_production: 'bg-yellow-500/20 text-yellow-300', shipped: 'bg-orange-500/20 text-orange-300', delivered: 'bg-green-500/20 text-green-300', cancelled: 'bg-red-500/20 text-red-300' };
            const statusLabel = { draft: 'Draft', sent: 'Sent', acknowledged: 'Acknowledged', in_production: 'In Production', shipped: 'Shipped', delivered: 'Delivered', cancelled: 'Cancelled' };
            el.innerHTML = filtered.map(po => {
                const badge = `<span class="px-2 py-1 rounded-full text-xs font-medium ${statusColors[po.status] || 'bg-gray-500/20 text-gray-300'}">${statusLabel[po.status] || po.status}</span>`;
                const shopifyIds = po.shopify_order_ids || [];
                return `<div class="glass rounded-xl p-5 cursor-pointer hover:border-brand-500 transition" onclick="openPoDetail('${po.id}')">
                    <div class="flex justify-between items-start">
                        <div>
                            <div class="flex items-center gap-3 mb-1"><span class="font-bold text-lg">${po.po_number || 'No PO#'}</span>${badge}</div>
                            <p class="text-gray-400 text-sm">${po.factory_name || 'No factory assigned'}${po.clubs?.name ? ' · ' + po.clubs.name : ''}</p>
                        </div>
                        <div class="text-right text-sm text-gray-400">
                            ${po.expected_delivery_date ? '<p>Delivery: ' + po.expected_delivery_date + '</p>' : ''}
                            ${shopifyIds.length ? '<p>' + shopifyIds.length + ' Shopify order' + (shopifyIds.length > 1 ? 's' : '') + ' linked</p>' : ''}
                        </div>
                    </div>
                </div>`;
            }).join('');
        }

        async function openCreatePoModal() {
            editingPoId = null;
            document.getElementById('po-modal-title').textContent = 'New Purchase Order';
            document.getElementById('po-number').value = '';
            document.getElementById('po-status').value = 'draft';
            document.getElementById('po-factory').value = '';
            document.getElementById('po-expected-delivery').value = '';
            document.getElementById('po-season').value = '';
            document.getElementById('po-shopify-orders').value = '';
            document.getElementById('po-notes').value = '';
            document.getElementById('po-line-items').innerHTML = '';
            document.getElementById('po-total-display').textContent = '£0.00';
            await populatePoClubDropdown('');
            document.getElementById('po-modal').classList.remove('hide');
        }

        async function populatePoClubDropdown(selectedClubId) {
            const { data } = await supabase.from('clubs').select('id, name').eq('brand_id', currentBrandId).order('name');
            const sel = document.getElementById('po-club-id');
            sel.innerHTML = '<option value="">— No specific club —</option>';
            (data || []).forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                if (c.id === selectedClubId) opt.selected = true;
                sel.appendChild(opt);
            });
        }

        function hidePoModal() {
            document.getElementById('po-modal').classList.add('hide');
            editingPoId = null;
        }

        function addPoLineItem(desc = '', qty = 1, unitPrice = '') {
            const lineId = 'pl-' + Date.now() + '-' + Math.random().toString(36).slice(2, 6);
            const el = document.getElementById('po-line-items');
            const div = document.createElement('div');
            div.id = lineId;
            div.className = 'flex gap-2 items-center';
            div.innerHTML = `
                <input type="text" placeholder="Description" value="${desc}" class="flex-1 px-3 py-2 rounded-lg text-sm" oninput="calcPoTotal()">
                <input type="number" placeholder="Qty" value="${qty}" min="1" class="w-20 px-3 py-2 rounded-lg text-sm" oninput="calcPoTotal()">
                <input type="number" placeholder="Unit £" value="${unitPrice}" step="0.01" class="w-28 px-3 py-2 rounded-lg text-sm" oninput="calcPoTotal()">
                <button onclick="document.getElementById('${lineId}').remove(); calcPoTotal();" class="text-red-400 hover:text-red-300 text-xl px-1">&times;</button>`;
            el.appendChild(div);
            calcPoTotal();
        }

        function calcPoTotal() {
            let total = 0;
            document.querySelectorAll('#po-line-items > div').forEach(line => {
                const inputs = line.querySelectorAll('input');
                total += (parseFloat(inputs[1]?.value) || 0) * (parseFloat(inputs[2]?.value) || 0);
            });
            document.getElementById('po-total-display').textContent = '£' + total.toFixed(2);
        }

        async function savePo() {
            const poNumber = document.getElementById('po-number').value.trim();
            if (!poNumber) { showToast('PO Number is required', 'error'); return; }
            const shopifyRaw = document.getElementById('po-shopify-orders').value.trim();
            const shopifyIds = shopifyRaw ? shopifyRaw.split(',').map(s => s.trim()).filter(Boolean) : [];
            const payload = {
                brand_id: currentBrandId,
                po_number: poNumber,
                status: document.getElementById('po-status').value,
                factory_name: document.getElementById('po-factory').value.trim() || null,
                club_id: document.getElementById('po-club-id').value || null,
                expected_delivery_date: document.getElementById('po-expected-delivery').value || null,
                season: document.getElementById('po-season').value.trim() || null,
                shopify_order_ids: shopifyIds,
                notes: document.getElementById('po-notes').value.trim() || null
            };
            let poId = editingPoId;
            if (poId) {
                const { error } = await supabase.from('purchase_orders').update(payload).eq('id', poId);
                if (error) { showToast('Error updating PO: ' + error.message, 'error'); return; }
            } else {
                const { data, error } = await supabase.from('purchase_orders').insert(payload).select().single();
                if (error) { showToast('Error creating PO: ' + error.message, 'error'); return; }
                poId = data.id;
            }
            await supabase.from('po_line_items').delete().eq('po_id', poId);
            const lineData = [];
            document.querySelectorAll('#po-line-items > div').forEach((line, idx) => {
                const inputs = line.querySelectorAll('input');
                const desc = inputs[0]?.value.trim();
                if (desc) lineData.push({ po_id: poId, description: desc, quantity: parseInt(inputs[1]?.value) || 1, unit_price: parseFloat(inputs[2]?.value) || null, line_order: idx });
            });
            if (lineData.length) await supabase.from('po_line_items').insert(lineData);
            showToast(editingPoId ? 'PO updated' : 'PO created', 'success');
            hidePoModal();
            await loadPoTracker();
        }

        async function openPoDetail(poId) {
            const po = currentPos.find(p => p.id === poId);
            if (!po) return;
            const { data: lines } = await supabase.from('po_line_items').select('*').eq('po_id', poId).order('line_order');
            document.getElementById('po-detail-number').textContent = po.po_number || 'PO Detail';
            document.getElementById('po-detail-factory').textContent = po.factory_name || 'No factory assigned';
            const statusLabel = { draft: 'Draft', sent: 'Sent to Factory', acknowledged: 'Acknowledged', in_production: 'In Production', shipped: 'Shipped', delivered: 'Delivered', cancelled: 'Cancelled' };
            const shopifyIds = po.shopify_order_ids || [];
            const linesHtml = (lines || []).length
                ? `<table class="w-full text-sm mb-4"><thead><tr class="text-gray-400 text-left"><th class="py-2">Description</th><th class="py-2 text-right">Qty</th><th class="py-2 text-right">Unit £</th><th class="py-2 text-right">Line Total</th></tr></thead><tbody>${(lines || []).map(l => `<tr class="border-t border-gray-800"><td class="py-2">${l.description}</td><td class="py-2 text-right">${l.quantity}</td><td class="py-2 text-right">${l.unit_price != null ? '£' + Number(l.unit_price).toFixed(2) : '—'}</td><td class="py-2 text-right">${l.unit_price != null ? '£' + (l.quantity * l.unit_price).toFixed(2) : '—'}</td></tr>`).join('')}</tbody></table>`
                : '<p class="text-gray-500 text-sm mb-4">No line items.</p>';
            document.getElementById('po-detail-body').innerHTML = `
                <div class="grid md:grid-cols-2 gap-4 mb-4 text-sm">
                    <div><span class="text-gray-400">Status</span><p class="font-medium mt-1">${statusLabel[po.status] || po.status}</p></div>
                    <div><span class="text-gray-400">Club</span><p class="font-medium mt-1">${po.clubs?.name || '—'}</p></div>
                    <div><span class="text-gray-400">Expected Delivery</span><p class="font-medium mt-1">${po.expected_delivery_date || '—'}</p></div>
                    <div><span class="text-gray-400">Season</span><p class="font-medium mt-1">${po.season || '—'}</p></div>
                </div>
                ${shopifyIds.length ? `<div class="mb-4"><span class="text-gray-400 text-sm">Linked Shopify Orders</span><p class="font-medium mt-1">${shopifyIds.join(', ')}</p></div>` : ''}
                ${po.notes ? `<div class="mb-4"><span class="text-gray-400 text-sm">Notes</span><p class="mt-1">${po.notes}</p></div>` : ''}
                <h4 class="font-semibold text-gray-300 mb-2">Line Items</h4>${linesHtml}`;
            document.getElementById('po-detail-modal')._currentPoId = poId;
            document.getElementById('po-detail-modal').classList.remove('hide');
        }

        function hidePoDetailModal() {
            document.getElementById('po-detail-modal').classList.add('hide');
        }

        async function editCurrentPo() {
            const poId = document.getElementById('po-detail-modal')._currentPoId;
            if (!poId) return;
            hidePoDetailModal();
            const po = currentPos.find(p => p.id === poId);
            if (!po) return;
            const { data: lines } = await supabase.from('po_line_items').select('*').eq('po_id', poId).order('line_order');
            editingPoId = poId;
            document.getElementById('po-modal-title').textContent = 'Edit Purchase Order';
            document.getElementById('po-number').value = po.po_number || '';
            document.getElementById('po-status').value = po.status || 'draft';
            document.getElementById('po-factory').value = po.factory_name || '';
            document.getElementById('po-expected-delivery').value = po.expected_delivery_date || '';
            document.getElementById('po-season').value = po.season || '';
            document.getElementById('po-shopify-orders').value = (po.shopify_order_ids || []).join(', ');
            document.getElementById('po-notes').value = po.notes || '';
            document.getElementById('po-line-items').innerHTML = '';
            (lines || []).forEach(l => addPoLineItem(l.description, l.quantity, l.unit_price ?? ''));
            await populatePoClubDropdown(po.club_id);
            calcPoTotal();
            document.getElementById('po-modal').classList.remove('hide');
        }

        async function deleteCurrentPo() {
            const poId = document.getElementById('po-detail-modal')._currentPoId;
            if (!poId) return;
            if (!confirm('Delete this purchase order? This cannot be undone.')) return;
            const { error } = await supabase.from('purchase_orders').delete().eq('id', poId);
            if (error) { showToast('Error deleting PO: ' + error.message, 'error'); return; }
            showToast('PO deleted', 'success');
            hidePoDetailModal();
            await loadPoTracker();
        }

        document.getElementById('po-modal').addEventListener('click', function(e) { if (e.target === this) hidePoModal(); });
        document.getElementById('po-detail-modal').addEventListener('click', function(e) { if (e.target === this) hidePoDetailModal(); });

        // =============================================
        // SALES MODULE — STATE
        // =============================================
        let jobs = [];
        let currentJobId = null;
        let currentJob = null;
        let jobTeams = [];
        let currentDesignTask = null;
        let currentDesignVersions = [];
        let salesViewStageFilter = null;

        const JOB_STAGES = [
            { key: 'discovery',         label: 'Discovery',         colorClass: 'stage-discovery' },
            { key: 'concepts',          label: 'Concepts',          colorClass: 'stage-concepts' },
            { key: 'awaiting_approval', label: 'Awaiting Approval', colorClass: 'stage-awaiting' },
            { key: 'quote',             label: 'Quote',             colorClass: 'stage-quote' },
            { key: 'paid',              label: 'Paid',              colorClass: 'stage-paid' },
            { key: 'on_boarding',       label: 'On-Boarding',       colorClass: 'stage-onboarding' },
            { key: 'completed',         label: 'Completed',         colorClass: 'stage-completed' }
        ];

        const JOB_TYPE_LABELS = {
            new_club: 'New Club', repeat_order: 'Repeat Order',
            new_concept: 'New Concept', new_team: 'New Team'
        };
        const CLUB_TYPE_LABELS = { retail: 'Retail', partner: 'Partner', partner_plus: 'Partner+' };
        const CHANNEL_LABELS   = { direct: 'Direct', store: 'Store' };

        // =============================================
        // SALES — DATA LOADING
        // =============================================
        async function loadJobs() {
            if (!currentBrand) return;
            const { data } = await supabase
                .from('jobs')
                .select('*, clubs(id,name,sport,club_status)')
                .eq('brand_id', currentBrand.id)
                .order('created_at', { ascending: false });
            jobs = data || [];
        }

        // =============================================
        // SALES — NAVIGATION
        // =============================================
        function showSalesView(view) {
            document.getElementById('sales-home').classList.add('hide');
            document.getElementById('sales-live-view').classList.add('hide');
            document.getElementById('sales-completed-view').classList.add('hide');

            if (view === 'home') {
                document.getElementById('sales-home').classList.remove('hide');
                renderSalesRecentJobs();
                updateSalesBadges();
            } else if (view === 'live') {
                document.getElementById('sales-live-view').classList.remove('hide');
                salesViewStageFilter = null;
                renderStageNavGrid();
                renderLiveJobs();
            } else if (view === 'completed') {
                document.getElementById('sales-completed-view').classList.remove('hide');
                renderCompletedJobs();
            }
        }

        function updateSalesBadges() {
            const liveCount = jobs.filter(j => j.stage !== 'completed').length;
            const doneCount = jobs.filter(j => j.stage === 'completed').length;
            const lbEl = document.getElementById('sales-live-badge');
            const dbEl = document.getElementById('sales-done-badge');
            if (lbEl) lbEl.textContent = liveCount;
            if (dbEl) dbEl.textContent = doneCount;
            // Launchpad
            const lpLive = document.getElementById('stat-jobs-live');
            const lpDone = document.getElementById('stat-jobs-done');
            if (lpLive) lpLive.textContent = `${liveCount} live job${liveCount !== 1 ? 's' : ''}`;
            if (lpDone) lpDone.textContent = `${doneCount} completed`;
        }

        // =============================================
        // SALES — STAGE GRID
        // =============================================
        function renderStageNavGrid() {
            const grid = document.getElementById('stage-nav-grid');
            if (!grid) return;
            const liveJobs = jobs.filter(j => j.stage !== 'completed');
            grid.innerHTML = JOB_STAGES.map(s => {
                const count = liveJobs.filter(j => j.stage === s.key).length;
                const isActive = salesViewStageFilter === s.key;
                return `<div class="stage-nav-btn ${isActive ? 'active ' + s.colorClass : ''}" onclick="filterByStage('${s.key}')">
                    <span class="sn-count ${s.colorClass}">${count}</span>
                    <span class="sn-label">${s.label}</span>
                </div>`;
            }).join('') + `<div class="stage-nav-btn ${!salesViewStageFilter ? 'active' : ''}" onclick="filterByStage(null)" style="margin-left:auto">
                <span class="sn-count" style="color:#666">${liveJobs.length}</span>
                <span class="sn-label">All</span>
            </div>`;
        }

        function filterByStage(stageKey) {
            salesViewStageFilter = stageKey;
            renderStageNavGrid();
            renderLiveJobs();
        }

        // =============================================
        // SALES — JOB LISTS
        // =============================================
        function renderLiveJobs() {
            let filtered = jobs.filter(j => {
                if (j.stage === 'completed') return false;
                if (viewScope === 'mine' && currentUser && j.created_by !== currentUser.id) return false;
                return true;
            });
            if (salesViewStageFilter) filtered = filtered.filter(j => j.stage === salesViewStageFilter);
            const labelEl = document.getElementById('live-jobs-filter-label');
            if (labelEl) {
                const s = JOB_STAGES.find(s => s.key === salesViewStageFilter);
                labelEl.textContent = s ? `Filtered: ${s.label} (${filtered.length})` : `All stages (${filtered.length})`;
            }
            const container = document.getElementById('live-jobs-list');
            if (!container) return;
            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">📭</div><p>No jobs in this stage.</p></div>`;
                return;
            }
            container.innerHTML = filtered.map(j => renderJobCard(j)).join('');
        }

        function renderCompletedJobs() {
            const completed = jobs.filter(j => j.stage === 'completed' && (viewScope !== 'mine' || !currentUser || j.created_by === currentUser.id));
            const container = document.getElementById('completed-jobs-list');
            if (!container) return;
            if (completed.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">✅</div><p>No completed jobs yet.</p></div>`;
                return;
            }
            container.innerHTML = completed.map(j => renderJobCard(j)).join('');
        }

        function renderSalesRecentJobs() {
            const container = document.getElementById('sales-recent-jobs');
            if (!container) return;
            const recent = jobs.slice(0, 6);
            if (recent.length === 0) {
                container.innerHTML = `<div class="empty-state" style="padding:30px"><div class="empty-icon">💼</div><p>No jobs yet. Create your first job to get started.</p></div>`;
                return;
            }
            container.innerHTML = recent.map(j => renderJobCard(j)).join('');
        }

        function renderJobCard(job) {
            const stage = JOB_STAGES.find(s => s.key === job.stage) || JOB_STAGES[0];
            const clubName = job.clubs?.name || 'No club linked';
            const days = Math.floor((new Date() - new Date(job.created_at)) / 86400000);
            const ownerName = getUserDisplayName(job.created_by);
            return `<div class="job-card" onclick="openJobRecord('${job.id}')">
                <div class="flex items-start justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="job-number">${job.job_number || ''}</span>
                            <span class="stage-pill ${stage.colorClass}">${stage.label}</span>
                            ${job.range_approved ? '<span class="stage-pill stage-paid" style="font-size:10px">Range ✓</span>' : ''}
                        </div>
                        <p class="job-name truncate">${escHtml(job.job_name)}</p>
                        <p class="job-meta">${escHtml(clubName)} · ${JOB_TYPE_LABELS[job.job_type] || job.job_type} · ${CHANNEL_LABELS[job.channel] || job.channel}${ownerName !== '—' ? ` · <span style="color:#555">Owner: ${escHtml(ownerName)}</span>` : ''}</p>
                    </div>
                    <div class="text-right flex-shrink-0">
                        <p class="text-xs text-gray-600">${days}d ago</p>
                    </div>
                </div>
            </div>`;
        }

        // =============================================
        // SALES — NEW JOB MODAL
        // =============================================
        function openNewJobModal() {
            currentJobId = null;
            document.getElementById('job-modal-title').textContent = 'New Job';
            document.getElementById('job-id').value = '';
            document.getElementById('job-name').value = '';
            document.getElementById('job-description').value = '';
            document.getElementById('job-type').value = 'new_club';
            document.getElementById('job-club-type').value = 'retail';
            document.getElementById('job-channel').value = 'direct';
            document.getElementById('job-stage').value = 'discovery';
            // Populate club dropdown
            const sel = document.getElementById('job-club-id');
            sel.innerHTML = '<option value="">— No club linked —</option>' +
                clubs.map(c => `<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
            document.getElementById('job-modal').classList.remove('hide');
        }

        function openEditJobModal() {
            if (!currentJob) return;
            document.getElementById('job-modal-title').textContent = 'Edit Job';
            document.getElementById('job-id').value = currentJob.id;
            document.getElementById('job-name').value = currentJob.job_name || '';
            document.getElementById('job-description').value = currentJob.job_description || '';
            document.getElementById('job-type').value = currentJob.job_type || 'new_club';
            document.getElementById('job-club-type').value = currentJob.club_type || 'retail';
            document.getElementById('job-channel').value = currentJob.channel || 'direct';
            document.getElementById('job-stage').value = currentJob.stage || 'discovery';
            const sel = document.getElementById('job-club-id');
            sel.innerHTML = '<option value="">— No club linked —</option>' +
                clubs.map(c => `<option value="${c.id}" ${c.id === currentJob.club_id ? 'selected' : ''}>${escHtml(c.name)}</option>`).join('');
            document.getElementById('job-modal').classList.remove('hide');
        }

        function closeJobModal() {
            document.getElementById('job-modal').classList.add('hide');
        }

        async function saveJob() {
            const jobName = document.getElementById('job-name').value.trim();
            if (!jobName) { showToast('Job name is required', 'error'); return; }
            const jobId = document.getElementById('job-id').value;
            const clubId = document.getElementById('job-club-id').value || null;
            const payload = {
                brand_id: currentBrand.id,
                job_name: jobName,
                job_description: document.getElementById('job-description').value.trim() || null,
                job_type: document.getElementById('job-type').value,
                club_type: document.getElementById('job-club-type').value,
                channel: document.getElementById('job-channel').value,
                stage: document.getElementById('job-stage').value,
                club_id: clubId
            };

            if (jobId) {
                const { error } = await supabase.from('jobs').update(payload).eq('id', jobId);
                if (error) { showToast('Error saving job: ' + error.message, 'error'); return; }
                showToast('Job updated');
            } else {
                payload.created_by = currentUser?.id || null;
                // Get job number
                const { count } = await supabase.from('jobs').select('*', { count: 'exact', head: true }).eq('brand_id', currentBrand.id);
                payload.job_number = 'JOB-' + String((count || 0) + 1).padStart(4, '0');
                const { data, error } = await supabase.from('jobs').insert(payload).select().single();
                if (error) { showToast('Error creating job: ' + error.message, 'error'); return; }
                showToast('Job created');
                closeJobModal();
                await loadJobs();
                updateSalesBadges();
                openJobRecord(data.id);
                return;
            }

            closeJobModal();
            await loadJobs();
            updateSalesBadges();
            if (currentJobId) {
                currentJob = jobs.find(j => j.id === currentJobId);
                renderJobHeader();
            } else {
                showSalesView('home');
            }
        }

        // =============================================
        // SALES — JOB RECORD
        // =============================================
        async function openJobRecord(jobId) {
            currentJobId = jobId;
            // Push current view to navStack if not already navigating
            if (!navStack.length || navStack[navStack.length-1].type !== 'job') {
                // detect current visible tool to push as back context
                if (!document.getElementById('tool-sales').classList.contains('hide')) {
                    navStack.push({ type: 'tool', tool: 'sales', view: 'live' });
                } else if (!document.getElementById('tool-design-studio').classList.contains('hide')) {
                    navStack.push({ type: 'tool', tool: 'design-studio' });
                }
                // (other push contexts are handled by the calling function e.g. openJobFromClub)
            }
            // Load from DB fresh
            const { data: job } = await supabase
                .from('jobs')
                .select('*, clubs(*)')
                .eq('id', jobId)
                .single();
            currentJob = job;

            // Switch to job record tool
            document.getElementById('launchpad').classList.add('hide');
            document.querySelectorAll('[id^="tool-"]').forEach(el => el.classList.add('hide'));
            document.getElementById('tool-job-record').classList.remove('hide');

            renderJobHeader();
            showJobTab('overview');
            // Load activity log and populate user assignment dropdown
            await Promise.all([loadJobActivity(), loadBrandUsers()]);
            populateUserAssignDropdown('jr-assigned-user', currentJob?.assigned_user_id);
        }

        // Helper to open job record from design studio (sets right tab)
        function showJobRecord(job) {
            openJobRecord(job.id);
        }

        function closeJobRecord() {
            // If we have a nav stack entry, use goBack; otherwise default to sales
            if (navStack.length > 0) {
                goBack();
            } else {
                document.getElementById('tool-job-record').classList.add('hide');
                document.getElementById('tool-sales').classList.remove('hide');
                showSalesView('live');
            }
        }

        function renderJobHeader() {
            if (!currentJob) return;
            document.getElementById('jr-job-number').textContent = currentJob.job_number || '';
            document.getElementById('jr-job-name').textContent = currentJob.job_name || '';
            document.getElementById('jr-job-desc').textContent = currentJob.job_description || '';
            document.getElementById('jr-stage-select').value = currentJob.stage || 'discovery';
            document.getElementById('jr-type').textContent = JOB_TYPE_LABELS[currentJob.job_type] || currentJob.job_type;
            document.getElementById('jr-club-type').textContent = CLUB_TYPE_LABELS[currentJob.club_type] || currentJob.club_type;
            document.getElementById('jr-channel').textContent = CHANNEL_LABELS[currentJob.channel] || currentJob.channel;
            document.getElementById('jr-club-link').textContent = currentJob.clubs?.name || '—';
            document.getElementById('jr-created').textContent = new Date(currentJob.created_at).toLocaleDateString('en-GB');
            const days = Math.floor((new Date() - new Date(currentJob.created_at)) / 86400000);
            document.getElementById('jr-days-open').textContent = `${days} day${days !== 1 ? 's' : ''}`;
            renderJobStagePills();
            renderDesignStagePills();
        }

        const JOB_STAGE_COLORS = {
            discovery: '#9ca3af', concepts: '#60a5fa', awaiting_approval: '#a78bfa',
            quote: '#fb923c', paid: '#4ade80', on_boarding: '#2dd4bf', completed: '#f472b6'
        };

        function renderJobStagePills() {
            const container = document.getElementById('jr-stage-pills');
            if (!container) return;
            container.innerHTML = JOB_STAGES.map(s => {
                const active = (currentJob?.stage || 'discovery') === s.key;
                const c = JOB_STAGE_COLORS[s.key] || '#888';
                return `<button onclick="updateJobStage('${s.key}')" class="stage-pill-btn${active ? ' active' : ''}"
                    style="${active ? `color:${c};border-color:${c};background:${c}18` : ''}">${s.label}</button>`;
            }).join('');
        }

        const DESIGN_STAGE_LABELS = {
            not_started: 'Not Started', briefed: 'Briefed', in_progress: 'In Progress',
            in_review: 'In Review', revisions: 'Revisions', awaiting_approval: 'Awaiting Approval', complete: 'Complete'
        };
        const DESIGN_STAGE_COLORS = {
            not_started: '#555', briefed: '#9ca3af', in_progress: '#fbbf24',
            in_review: '#60a5fa', revisions: '#fb7185', awaiting_approval: '#a78bfa', complete: '#4ade80'
        };
        const DESIGN_STAGES_ORDER = ['not_started','briefed','in_progress','in_review','revisions','awaiting_approval','complete'];

        function renderDesignStagePills() {
            const container = document.getElementById('jr-design-stage-pills');
            if (!container) return;
            container.innerHTML = DESIGN_STAGES_ORDER.map(key => {
                const active = (currentJob?.design_stage || 'not_started') === key;
                const c = DESIGN_STAGE_COLORS[key] || '#888';
                return `<button onclick="updateJobDesignStage('${key}')" class="stage-pill-btn${active ? ' active' : ''}"
                    style="${active ? `color:${c};border-color:${c};background:${c}18` : ''}">${DESIGN_STAGE_LABELS[key]}</button>`;
            }).join('');
        }

        async function updateJobDesignStage(newStage) {
            if (!currentJobId) return;
            const { error } = await supabase.from('jobs').update({ design_stage: newStage }).eq('id', currentJobId);
            if (error) { showToast('Error updating design stage', 'error'); return; }
            currentJob = { ...currentJob, design_stage: newStage };
            renderDesignStagePills();
            showToast('Design stage → ' + DESIGN_STAGE_LABELS[newStage]);
        }

        async function updateJobStage(newStage) {
            if (!currentJobId) return;
            const { error } = await supabase.from('jobs').update({ stage: newStage }).eq('id', currentJobId);
            if (error) { showToast('Error updating stage: ' + error.message, 'error'); return; }
            currentJob = { ...currentJob, stage: newStage };
            renderJobHeader();
            await loadJobs();
            updateSalesBadges();
            showToast('Stage updated to ' + JOB_STAGES.find(s => s.key === newStage)?.label);
        }

        // =============================================
        // SALES — JOB TABS
        // =============================================
        function showJobTab(tab) {
            ['overview','products','club','team','design','orderform','production'].forEach(t => {
                document.getElementById(`jt-content-${t}`)?.classList.add('hide');
                document.getElementById(`jt-${t}`)?.classList.remove('active');
            });
            document.getElementById(`jt-content-${tab}`)?.classList.remove('hide');
            document.getElementById(`jt-${tab}`)?.classList.add('active');

            switch(tab) {
                case 'overview':   renderJobOverview(); break;
                case 'products':   renderJobProducts(); break;
                case 'club':       renderJobClubTab(); break;
                case 'team':       loadJobTeams(); renderJobClubTeamSection(); break;
                case 'design':     loadJobDesign(); break;
                case 'orderform':  renderJobOrderForm(); break;
                case 'production': renderJobProduction(); break;
            }
        }

        // Allow design studio to jump straight to design tab
        function switchJobTab(tab) { showJobTab(tab); }

        function renderJobOverview() {
            if (!currentJob) return;
            const details = document.getElementById('jr-overview-details');
            if (!details) return;
            const rows = [
                ['Job Name', currentJob.job_name],
                ['Job Type', JOB_TYPE_LABELS[currentJob.job_type] || currentJob.job_type],
                ['Club Type', CLUB_TYPE_LABELS[currentJob.club_type] || currentJob.club_type],
                ['Channel', CHANNEL_LABELS[currentJob.channel] || currentJob.channel],
                ['Stage', JOB_STAGES.find(s => s.key === currentJob.stage)?.label || currentJob.stage],
                ['Linked Club', currentJob.clubs?.name || 'None'],
                ['Owner', getUserDisplayName(currentJob.created_by)],
                ['Range Approved', currentJob.range_approved ? 'Yes ✓' : 'No'],
            ];
            details.innerHTML = rows.map(([k, v]) => `
                <div class="info-row"><span class="info-label">${k}</span><span class="info-value">${escHtml(v || '—')}</span></div>
            `).join('');
        }

        async function renderJobProducts() {
            if (!currentJob) return;
            const rangeApproved = document.getElementById('jr-range-approved');
            if (rangeApproved) rangeApproved.checked = currentJob.range_approved || false;

            if (!currentJob.club_id) {
                document.getElementById('jr-products-list').innerHTML = '';
                document.getElementById('jr-products-empty').classList.remove('hide');
                document.getElementById('jr-products-empty').querySelector('p').textContent = 'Link a club to this job first to manage products.';
                return;
            }

            const { data: clubProds } = await supabase
                .from('club_products')
                .select('*, products(*)')
                .eq('club_id', currentJob.club_id)
                .eq('is_active', true);

            const container = document.getElementById('jr-products-list');
            const emptyEl = document.getElementById('jr-products-empty');
            if (!clubProds || clubProds.length === 0) {
                container.innerHTML = '';
                emptyEl.classList.remove('hide');
                return;
            }
            emptyEl.classList.add('hide');
            container.innerHTML = clubProds.map(cp => {
                const shopPrice = (cp.web_price || cp.partner_price || 0).toFixed(2);
                return `<div class="glass rounded-xl p-4 flex items-center justify-between gap-4">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-sm">${escHtml(cp.custom_name)}</p>
                        <p class="text-xs text-gray-500">${escHtml(cp.products?.product_code || '')} · ${escHtml(cp.products?.item_name || '')}</p>
                    </div>
                    <div class="flex gap-6 text-right flex-shrink-0">
                        <div><p class="text-xs text-gray-600">Shop</p><p class="text-sm font-bold text-brand-400">£${shopPrice}</p></div>
                        <div><p class="text-xs text-gray-600">Partner</p><p class="text-sm font-bold">£${(cp.partner_price||0).toFixed(2)}</p></div>
                        <div><p class="text-xs text-gray-600">Direct</p><p class="text-sm font-bold">£${(cp.non_partner_price||0).toFixed(2)}</p></div>
                    </div>
                    ${cp.shopify_product_id ? '<span class="text-xs text-purple-400 flex-shrink-0">Shopify ✓</span>' : ''}
                </div>`;
            }).join('');
        }

        function showJobAddClubProductModal() {
            if (!currentJob?.club_id) { showToast('Link a club to this job first', 'error'); return; }
            // Temporarily set current club to job's club then open modal
            const club = clubs.find(c => c.id === currentJob.club_id);
            if (club) { showAddClubProductModal(club); }
        }

        async function toggleRangeApproved(checked) {
            if (!currentJobId) return;
            const { error } = await supabase.from('jobs').update({ range_approved: checked }).eq('id', currentJobId);
            if (error) { showToast('Error updating range status', 'error'); return; }
            currentJob = { ...currentJob, range_approved: checked };
            showToast(checked ? 'Range approved ✓' : 'Range approval removed');
        }

        async function renderJobClubTab() {
            if (!currentJob) return;
            const container = document.getElementById('jr-club-content');
            if (!currentJob.club_id) {
                container.innerHTML = `<div class="glass rounded-2xl p-6 text-center">
                    <div class="empty-icon mb-3 flex justify-center"><svg class="w-12 h-12 text-gray-700" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 21h19.5M9 21V5.25A2.25 2.25 0 0111.25 3h1.5A2.25 2.25 0 0115 5.25V21m-6 0h6M3.75 21V10.5A2.25 2.25 0 016 8.25h.75M20.25 21V10.5a2.25 2.25 0 00-2.25-2.25H17.25"/></svg></div>
                    <p class="text-gray-500 mb-4">No club linked to this job yet.</p>
                    <div class="flex gap-3 justify-center">
                        <button onclick="showLinkClubModal()" class="btn-secondary text-sm">Link Existing Club</button>
                        <button onclick="showCreateClubForJob()" class="btn-primary text-sm">Create New Club</button>
                    </div>
                </div>`;
                return;
            }

            // Load full club data
            const { data: club } = await supabase.from('clubs').select('*').eq('id', currentJob.club_id).single();
            if (!club) return;

            const { tierName: clubTierName, badgeClass: clubBadgeClass } = getClubTierDisplay(club);
            container.innerHTML = `<div class="glass rounded-2xl p-6">
                <div class="flex items-center justify-between mb-5">
                    <div class="flex items-center gap-3">
                        <div class="w-12 h-12 rounded-xl flex items-center justify-center text-xl font-bold" style="background:rgba(20,184,166,0.12);color:#2dd4bf">${(club.name||'').substring(0,2).toUpperCase()}</div>
                        <div>
                            <h4 class="font-bold text-lg">${escHtml(club.name)}</h4>
                            <span class="badge ${clubBadgeClass} text-xs">${escHtml(clubTierName)}</span>
                        </div>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openClubFromJob('${club.id}')" class="btn-secondary text-sm">Open Club Record</button>
                        <button onclick="showLinkClubModal()" class="btn-secondary text-sm">Change Club</button>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-4 text-sm">
                    <div class="info-row"><span class="info-label">Sport</span><span class="info-value">${escHtml(club.sport||'—')}</span></div>
                    <div class="info-row"><span class="info-label">League</span><span class="info-value">${escHtml(club.league||'—')}</span></div>
                    <div class="info-row"><span class="info-label">County</span><span class="info-value">${escHtml(club.address_county||'—')}</span></div>
                    <div class="info-row"><span class="info-label">Contact</span><span class="info-value">${escHtml(club.contact_name||'—')}</span></div>
                    <div class="info-row"><span class="info-label">Email</span><span class="info-value">${escHtml(club.contact_email||'—')}</span></div>
                    <div class="info-row"><span class="info-label">Phone</span><span class="info-value">${escHtml(club.contact_phone||'—')}</span></div>
                </div>
                ${club.pantone_main ? `<div class="mt-4 flex items-center gap-3">
                    <span class="text-xs text-gray-500">Pantone:</span>
                    <span class="pantone-swatch" style="background:${club.pantone_main}"></span>
                    ${club.pantone_secondary ? `<span class="pantone-swatch" style="background:${club.pantone_secondary}"></span>` : ''}
                    ${club.pantone_accent ? `<span class="pantone-swatch" style="background:${club.pantone_accent}"></span>` : ''}
                </div>` : ''}
                <div class="mt-5 flex gap-3">
                    <button onclick="syncClubCollectionForJob('${club.id}')" class="btn-primary text-sm">Create Shopify Collection (API)</button>
                    <button onclick="generateShopifyCSVForClub('${club.id}')" class="btn-secondary text-sm">Download Shopify CSV</button>
                </div>
            </div>`;
        }

        function showLinkClubModal() {
            const sel = document.getElementById('link-club-select');
            sel.innerHTML = '<option value="">Choose club...</option>' +
                clubs.map(c => `<option value="${c.id}">${escHtml(c.name)}</option>`).join('');
            document.getElementById('link-club-modal').classList.remove('hide');
        }

        async function linkClubToJob() {
            const clubId = document.getElementById('link-club-select').value;
            if (!clubId) { showToast('Please select a club', 'error'); return; }
            const { error } = await supabase.from('jobs').update({ club_id: clubId }).eq('id', currentJobId);
            if (error) { showToast('Error linking club', 'error'); return; }
            document.getElementById('link-club-modal').classList.add('hide');
            // Reload current job
            const { data: job } = await supabase.from('jobs').select('*, clubs(*)').eq('id', currentJobId).single();
            currentJob = job;
            renderJobHeader();
            renderJobClubTab();
            showToast('Club linked');
        }

        function showCreateClubForJob() {
            // Flag that we need to auto-link the new club back to the current job
            window._pendingJobLink = currentJobId;
            showCreateClubModal();
        }

        async function syncClubCollectionForJob(clubId) {
            // Set current club context and run Shopify sync
            const club = clubs.find(c => c.id === clubId);
            if (!club) return;
            // Temporarily expose club ID to syncClubCollection
            window._jobClubId = clubId;
            await syncClubCollection();
            window._jobClubId = null;
        }

        // =============================================
        // SALES — TEAMS
        // =============================================
        async function loadJobTeams() {
            if (!currentJobId) return;
            const { data } = await supabase.from('job_teams').select('*').eq('job_id', currentJobId).order('created_at');
            jobTeams = data || [];
            renderJobTeams();
        }

        function renderJobTeams() {
            const container = document.getElementById('jr-teams-list');
            const emptyEl = document.getElementById('jr-teams-empty');
            if (!container) return;
            if (jobTeams.length === 0) {
                container.innerHTML = '';
                emptyEl?.classList.remove('hide');
                return;
            }
            emptyEl?.classList.add('hide');
            container.innerHTML = jobTeams.map(t => `
                <div class="glass rounded-xl p-4 flex items-start justify-between gap-4">
                    <div class="flex-1">
                        <p class="font-semibold">${escHtml(t.team_name)}</p>
                        <p class="text-sm text-gray-500 mt-1">${[t.manager_name, t.manager_email, t.manager_phone].filter(Boolean).map(v => escHtml(v)).join(' · ')}</p>
                        ${t.notes ? `<p class="text-xs text-gray-600 mt-1">${escHtml(t.notes)}</p>` : ''}
                    </div>
                    <div class="flex gap-2">
                        <button onclick="openTeamModal('${t.id}')" class="text-xs btn-secondary py-1 px-3">Edit</button>
                        <button onclick="deleteTeam('${t.id}')" class="text-xs text-red-400 hover:text-red-300 py-1 px-2 rounded-lg" style="background:rgba(239,68,68,0.08)">✕</button>
                    </div>
                </div>
            `).join('');
        }

        function openTeamModal(teamId) {
            document.getElementById('team-modal-title').textContent = teamId ? 'Edit Team' : 'Add Team';
            const team = jobTeams.find(t => t.id === teamId);
            document.getElementById('team-id').value = teamId || '';
            document.getElementById('team-name').value = team?.team_name || '';
            document.getElementById('team-manager-name').value = team?.manager_name || '';
            document.getElementById('team-manager-email').value = team?.manager_email || '';
            document.getElementById('team-manager-phone').value = team?.manager_phone || '';
            document.getElementById('team-notes').value = team?.notes || '';
            document.getElementById('team-modal').classList.remove('hide');
        }

        function closeTeamModal() { document.getElementById('team-modal').classList.add('hide'); }

        async function saveTeam() {
            const name = document.getElementById('team-name').value.trim();
            if (!name) { showToast('Team name is required', 'error'); return; }
            const teamId = document.getElementById('team-id').value;
            const payload = {
                job_id: currentJobId,
                team_name: name,
                manager_name: document.getElementById('team-manager-name').value.trim() || null,
                manager_email: document.getElementById('team-manager-email').value.trim() || null,
                manager_phone: document.getElementById('team-manager-phone').value.trim() || null,
                notes: document.getElementById('team-notes').value.trim() || null
            };
            if (teamId) {
                const { error } = await supabase.from('job_teams').update(payload).eq('id', teamId);
                if (error) { showToast('Error saving team', 'error'); return; }
            } else {
                const { error } = await supabase.from('job_teams').insert(payload);
                if (error) { showToast('Error creating team', 'error'); return; }
            }
            closeTeamModal();
            await loadJobTeams();
            showToast('Team saved');
        }

        async function deleteTeam(teamId) {
            if (!confirm('Remove this team record?')) return;
            await supabase.from('job_teams').delete().eq('id', teamId);
            await loadJobTeams();
        }

        // =============================================
        // SALES — DESIGN STUDIO TAB
        // =============================================
        async function loadJobDesign() {
            if (!currentJobId) return;
            const { data: task } = await supabase
                .from('design_tasks')
                .select('*')
                .eq('job_id', currentJobId)
                .maybeSingle();
            currentDesignTask = task;

            if (task) {
                const { data: versions } = await supabase
                    .from('design_versions')
                    .select('*')
                    .eq('design_task_id', task.id)
                    .order('version_number');
                currentDesignVersions = versions || [];
            } else {
                currentDesignVersions = [];
            }
            renderDesignTab();
        }

        const DESIGN_STATUS_LABELS = {
            new: 'New', in_progress: 'In Progress', revisions: 'Revisions',
            in_review: 'In Review', awaiting_approval: 'Awaiting Approval', complete: 'Complete'
        };

        function renderDesignTab() {
            const container = document.getElementById('jr-design-content');
            if (!container) return;
            const days = currentJob ? Math.floor((new Date() - new Date(currentJob.created_at)) / 86400000) : 0;

            if (!currentDesignTask) {
                container.innerHTML = `<div class="glass rounded-2xl p-8 text-center">
                    <div class="empty-icon text-5xl mb-3">🎨</div>
                    <p class="text-gray-500 mb-4">No design brief created for this job yet.</p>
                    <button onclick="openCreateDesignTask()" class="btn-primary">Create Design Brief</button>
                </div>`;
                return;
            }

            const s = currentDesignTask.status;
            const statusClass = `design-status-${s}`;

            // Job Assets from linked club
            let assetsHtml = '';
            if (currentJob?.club_id) {
                const club = clubs.find(c => c.id === currentJob.club_id);
                if (club) {
                    const logoSrc = currentJob.logo_url_override || club.logo_url || club.club_crest_url;
                    const pm = currentJob.pantone_main || club.pantone_main || '#14b8a6';
                    const ps = currentJob.pantone_secondary || club.pantone_secondary || '#ffffff';
                    const pa = currentJob.pantone_accent || club.pantone_accent || '#000000';
                    assetsHtml = `
                    <div class="glass rounded-2xl p-5 mb-5">
                        <h4 class="font-semibold text-sm text-brand-400 mb-4">Job Assets — ${escHtml(club.name)}</h4>
                        <div class="flex flex-wrap gap-5 items-start">
                            <div>
                                <p class="text-xs text-gray-500 mb-2">Club Logo</p>
                                <div class="flex items-center gap-3">
                                    <div class="w-16 h-16 rounded-xl flex items-center justify-center text-2xl" style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08)">${logoSrc ? `<img src="${escHtml(logoSrc)}" class="w-full h-full object-contain rounded-xl">` : '🏟️'}</div>
                                    ${logoSrc ? `<a href="${escHtml(logoSrc)}" download class="text-xs btn-secondary px-3 py-1.5">Download</a>` : '<p class="text-xs text-gray-600">No logo uploaded</p>'}
                                </div>
                            </div>
                            <div>
                                <p class="text-xs text-gray-500 mb-2">Pantone Colours <span class="text-gray-700">(overrideable per job)</span></p>
                                <div class="flex gap-2 items-center mb-2">
                                    <div class="pantone-swatch" style="background:${escHtml(pm)};width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.1)"></div>
                                    <div class="pantone-swatch" style="background:${escHtml(ps)};width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.1)"></div>
                                    <div class="pantone-swatch" style="background:${escHtml(pa)};width:28px;height:28px;border-radius:6px;border:1px solid rgba(255,255,255,0.1)"></div>
                                    <button onclick="toggleJobColourOverride()" class="text-xs text-brand-400 hover:text-brand-300 ml-2">Override colours</button>
                                </div>
                                <div id="job-colour-override" class="hide">
                                    <div class="flex gap-3">
                                        <div class="flex items-center gap-1"><input type="color" value="${escHtml(pm)}" oninput="updateJobPantone('main',this.value)" class="h-7 w-9 rounded cursor-pointer" style="padding:1px;background:#111;border:1px solid #333"><span class="text-xs text-gray-500">Main</span></div>
                                        <div class="flex items-center gap-1"><input type="color" value="${escHtml(ps)}" oninput="updateJobPantone('secondary',this.value)" class="h-7 w-9 rounded cursor-pointer" style="padding:1px;background:#111;border:1px solid #333"><span class="text-xs text-gray-500">Secondary</span></div>
                                        <div class="flex items-center gap-1"><input type="color" value="${escHtml(pa)}" oninput="updateJobPantone('accent',this.value)" class="h-7 w-9 rounded cursor-pointer" style="padding:1px;background:#111;border:1px solid #333"><span class="text-xs text-gray-500">Accent</span></div>
                                        <button onclick="saveJobColours()" class="btn-primary text-xs px-3 py-1.5">Save</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
            }

            // Status action buttons
            const statusBtns = [
                { key: 'in_progress', label: '✏️ Working',         color: '#fbbf24', bg: 'rgba(251,191,36,0.12)', border: 'rgba(251,191,36,0.3)' },
                { key: 'in_review',   label: '👁️ Send For Review', color: '#60a5fa', bg: 'rgba(96,165,250,0.12)',  border: 'rgba(96,165,250,0.3)' },
                { key: 'revisions',   label: '🔄 Revisions',       color: '#fb7185', bg: 'rgba(251,113,133,0.12)', border: 'rgba(251,113,133,0.3)' },
                { key: 'complete',    label: '✅ Approved',         color: '#4ade80', bg: 'rgba(74,222,128,0.12)',  border: 'rgba(74,222,128,0.3)' }
            ].map(b => {
                const active = s === b.key;
                const btnLabel = (b.key === 'in_review' && s === 'in_review') ? '👁️ In Review' : b.label;
                return `<button onclick="updateDesignStatus('${b.key}')" class="ds-status-btn ${active ? 'active' : ''}" style="color:${b.color};background:${active ? b.bg : 'rgba(255,255,255,0.03)'};border-color:${active ? b.border : 'rgba(255,255,255,0.07)'}">${btnLabel}</button>`;
            }).join('');

            container.innerHTML = `
                ${assetsHtml}
                <div class="glass rounded-2xl p-6 mb-5">
                    <div class="flex items-start justify-between mb-4">
                        <div>
                            <h4 class="font-bold text-lg mb-1">Design Brief</h4>
                            <span class="stage-pill ${statusClass}">${DESIGN_STATUS_LABELS[s] || s}</span>
                        </div>
                        <button onclick="saveDesignTask()" class="btn-primary text-sm">Save Brief</button>
                    </div>

                    <!-- Status action buttons -->
                    <div class="flex gap-2 mb-5 flex-wrap">${statusBtns}</div>

                    <div class="grid md:grid-cols-2 gap-4 mb-4">
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Design Summary</label>
                            <textarea id="design-summary" rows="4" class="w-full px-3 py-2 rounded-lg text-sm resize-none" placeholder="Describe the design requirements...">${escHtml(currentDesignTask.design_summary || '')}</textarea>
                        </div>
                        <div>
                            <label class="text-xs text-gray-500 mb-1 block">Design Appetite</label>
                            <select id="design-appetite" class="w-full px-3 py-2 rounded-lg text-sm mb-3">
                                <option value="">Select appetite...</option>
                                <option value="minimal" ${currentDesignTask.design_appetite==='minimal'?'selected':''}>Minimal — simple, clean</option>
                                <option value="moderate" ${currentDesignTask.design_appetite==='moderate'?'selected':''}>Moderate — balanced design</option>
                                <option value="bold" ${currentDesignTask.design_appetite==='bold'?'selected':''}>Bold — striking, impactful</option>
                                <option value="bespoke" ${currentDesignTask.design_appetite==='bespoke'?'selected':''}>Bespoke — fully custom</option>
                            </select>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06)">
                                    <p class="text-xs text-gray-500">Job Type</p>
                                    <p class="font-semibold mt-0.5">${JOB_TYPE_LABELS[currentJob?.job_type] || '—'}</p>
                                </div>
                                <div class="p-3 rounded-xl" style="background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.06)">
                                    <p class="text-xs text-gray-500">Days Open</p>
                                    <p class="font-semibold mt-0.5">${days}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600">Last modified: ${new Date(currentDesignTask.updated_at).toLocaleString('en-GB')}</div>
                </div>

                <!-- Design Versions -->
                <div class="flex items-center justify-between mb-4">
                    <h4 class="font-semibold">Design Versions</h4>
                    <button onclick="addDesignVersion()" class="btn-primary text-sm flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>
                        Add Version
                    </button>
                </div>
                <div id="design-versions-list" class="space-y-3">
                    ${renderDesignVersions()}
                </div>

                <!-- Design Brief Log -->
                <div class="mt-6">
                    <h4 class="font-semibold mb-3 text-sm text-gray-400 uppercase tracking-wider">Design Log</h4>
                    <div id="design-brief-log-list" class="space-y-1">
                        ${renderDesignBriefLog()}
                    </div>
                </div>
            `;
        }

        function renderDesignVersions() {
            if (currentDesignVersions.length === 0) {
                return `<div class="empty-state" style="padding:30px"><div class="empty-icon">🖼️</div><p>No versions yet. Upload the first design version.</p></div>`;
            }
            return currentDesignVersions.map(v => {
                const statusClass = v.status === 'approved' ? 'approved' : v.status === 'rejected' ? 'rejected' : '';
                const canAnnotate = !!v.file_url;
                return `<div class="version-card ${statusClass}">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="version-label">${escHtml(v.version_label || ('V' + v.version_number))}</span>
                                ${v.status === 'approved' ? '<span class="stage-pill stage-paid">Approved ✓</span>' : ''}
                                ${v.status === 'rejected' ? '<span style="background:rgba(239,68,68,0.1);color:#f87171;font-size:11px;padding:3px 10px;border-radius:20px">Declined</span>' : ''}
                            </div>
                            ${v.notes ? `<p class="text-sm text-gray-400">${escHtml(v.notes)}</p>` : ''}
                            <p class="text-xs text-gray-600 mt-0.5">${new Date(v.created_at).toLocaleDateString('en-GB')}</p>
                        </div>
                        <div class="flex gap-2 flex-shrink-0 flex-wrap justify-end">
                            ${canAnnotate ? `<button onclick="openAnnotationModal('${v.id}')" class="text-xs px-3 py-1.5 rounded-lg font-semibold" style="background:rgba(96,165,250,0.1);color:#60a5fa;border:1px solid rgba(96,165,250,0.2)">Annotate</button>` : ''}
                            ${v.status === 'pending' ? `
                                <button onclick="approveDesignVersion('${v.id}')" class="text-xs px-3 py-1.5 rounded-lg font-semibold" style="background:rgba(34,197,94,0.1);color:#4ade80;border:1px solid rgba(34,197,94,0.2)">Approve</button>
                                <button onclick="declineVersion('${v.id}')" class="text-xs px-3 py-1.5 rounded-lg font-semibold" style="background:rgba(239,68,68,0.1);color:#f87171;border:1px solid rgba(239,68,68,0.2)">Decline</button>
                            ` : ''}
                            ${v.status === 'approved' ? `<button onclick="unapproveDesignVersion('${v.id}')" class="text-xs px-2 py-1.5 text-gray-500 hover:text-gray-300 btn-secondary">Unset</button>` : ''}
                            ${v.status === 'rejected' ? `<button onclick="unapproveDesignVersion('${v.id}')" class="text-xs px-2 py-1.5 text-gray-500 hover:text-gray-300 btn-secondary">Reset</button>` : ''}
                        </div>
                    </div>
                    ${v.file_url
                        ? `<div class="mt-3 cursor-pointer" onclick="openAnnotationModal('${v.id}')">
                               <img src="${escHtml(v.file_url)}" class="rounded-lg max-h-64 object-contain w-full" alt="V${v.version_number}" style="border:1px solid rgba(255,255,255,0.08)">
                               <p class="text-xs text-gray-600 mt-1">Click image to annotate</p>
                           </div>`
                        : `<div class="mt-3 p-4 rounded-xl text-center" style="background:rgba(255,255,255,0.02);border:1px dashed rgba(255,255,255,0.08)">
                               <p class="text-xs text-gray-600 mb-2">No image uploaded</p>
                               <button onclick="uploadVersionFileFor('${v.id}')" class="text-xs btn-secondary px-3 py-1.5">Upload Image</button>
                           </div>`}
                </div>`;
            }).join('');
        }

        async function declineVersion(versionId) {
            await supabase.from('design_versions').update({ status: 'rejected' }).eq('id', versionId);
            if (currentBrand && currentJobId) {
                const v = currentDesignVersions.find(x => x.id === versionId);
                await supabase.from('design_feed').insert({
                    brand_id: currentBrand.id, job_id: currentJobId, version_id: versionId,
                    activity_type: 'declined', message: `${v?.version_label||'Version'} declined`,
                    created_by: currentUser?.id
                });
            }
            await loadJobDesign();
            showToast('Version declined');
        }

        let _uploadingForVersionId = null;
        // Upload image for a specific existing version
        function uploadVersionFileFor(versionId) {
            _uploadingForVersionId = versionId;
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*,.pdf';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const v = currentDesignVersions.find(x => x.id === versionId);
                if (!v) return;
                const suffix = currentClub?.suffix || 'job';
                const ext = file.name.substring(file.name.lastIndexOf('.'));
                const sp = `${currentBrand?.slug||'brand'}/${suffix}/design/v${v.version_number}_${Date.now()}${ext}`;
                showToast('Uploading…');
                const { error: upErr } = await supabase.storage.from('club-images').upload(sp, file, { upsert: true });
                if (upErr) { showToast('Upload failed', 'error'); return; }
                const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(sp);
                await supabase.from('design_versions').update({ file_url: urlData.publicUrl, storage_path: sp }).eq('id', versionId);
                await loadJobDesign();
                showToast('Image uploaded');
            };
            input.click();
        }

        function openCreateDesignTask() {
            currentDesignTask = { design_summary: '', design_appetite: '', status: 'new', job_id: currentJobId };
            renderDesignTab();
        }

        async function saveDesignTask() {
            if (!currentJobId) return;
            const summary = document.getElementById('design-summary')?.value.trim();
            const appetite = document.getElementById('design-appetite')?.value;
            if (currentDesignTask?.id) {
                const { error } = await supabase.from('design_tasks').update({ design_summary: summary, design_appetite: appetite }).eq('id', currentDesignTask.id);
                if (error) { showToast('Error saving brief', 'error'); return; }
            } else {
                const { data, error } = await supabase.from('design_tasks').insert({
                    job_id: currentJobId, design_summary: summary, design_appetite: appetite, status: 'new'
                }).select().single();
                if (error) { showToast('Error creating brief', 'error'); return; }
                currentDesignTask = data;
            }
            await loadJobDesign();
            showToast('Design brief saved');
        }

        async function updateDesignStatus(status) {
            if (!currentDesignTask?.id) return;
            const oldStatus = currentDesignTask.status;
            const { error } = await supabase.from('design_tasks').update({ status }).eq('id', currentDesignTask.id);
            if (error) { showToast('Error updating status', 'error'); return; }
            // Log the change
            const userName = currentUserProfile?.email?.split('@')[0] || 'Unknown';
            await supabase.from('design_brief_log').insert({
                design_task_id: currentDesignTask.id,
                user_id: currentUser?.id,
                user_name: userName,
                old_status: oldStatus,
                new_status: status
            });
            currentDesignTask.status = status;
            // Reload log entries
            await loadDesignBriefLog();
            renderDesignTab();
            showToast(`Status → ${DESIGN_STATUS_LABELS[status]}`);
        }

        function addDesignVersion() {
            if (!currentDesignTask?.id) { showToast('Save design brief first', 'error'); return; }
            showUploadVersionModal();
        }

        // =============================================
        // DESIGN VERSION UPLOAD MODAL
        // =============================================
        let _pendingVersionFile = null;

        function showUploadVersionModal() {
            _pendingVersionFile = null;
            document.getElementById('version-file-input').value = '';
            document.getElementById('version-notes').value = '';
            document.getElementById('version-file-label').textContent = 'Click to select image (PNG, JPG, PDF)';
            document.getElementById('version-file-preview').classList.add('hide');
            document.getElementById('upload-version-modal').classList.remove('hide');
        }

        function hideUploadVersionModal() {
            document.getElementById('upload-version-modal').classList.add('hide');
            _pendingVersionFile = null;
        }

        function previewVersionFile(event) {
            const file = event.target.files[0];
            if (!file) return;
            _pendingVersionFile = file;
            document.getElementById('version-file-label').textContent = file.name;
            const preview = document.getElementById('version-file-preview');
            const img = document.getElementById('version-file-preview-img');
            if (file.type.startsWith('image/')) {
                img.src = URL.createObjectURL(file);
                preview.classList.remove('hide');
            }
        }

        async function uploadDesignVersion() {
            if (!currentDesignTask?.id) return;
            const btn = document.getElementById('upload-version-btn');
            const notes = document.getElementById('version-notes').value.trim();
            const nextNum = (currentDesignVersions.length || 0) + 1;

            btn.disabled = true;
            btn.textContent = 'Uploading…';

            let fileUrl = null, storagePath = null;

            if (_pendingVersionFile) {
                const suffix = currentClub?.suffix || currentJob?.id?.substring(0,6) || 'job';
                const ext = _pendingVersionFile.name.substring(_pendingVersionFile.name.lastIndexOf('.'));
                storagePath = `${currentBrand?.slug || 'brand'}/${suffix}/design/v${nextNum}_${Date.now()}${ext}`;
                const { error: upErr } = await supabase.storage
                    .from('club-images')
                    .upload(storagePath, _pendingVersionFile, { upsert: true });
                if (upErr) {
                    showToast('Upload failed: ' + upErr.message, 'error');
                    btn.disabled = false; btn.textContent = 'Upload Version';
                    return;
                }
                const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(storagePath);
                fileUrl = urlData.publicUrl;
            }

            const { data, error } = await supabase.from('design_versions').insert({
                design_task_id: currentDesignTask.id,
                version_number: nextNum,
                version_label: `V${nextNum}`,
                notes: notes || null,
                status: 'pending',
                file_url: fileUrl,
                storage_path: storagePath
            }).select().single();

            btn.disabled = false; btn.textContent = 'Upload Version';
            if (error) { showToast('Error adding version', 'error'); return; }

            currentDesignVersions.push(data);
            const vList = document.getElementById('design-versions-list');
            if (vList) vList.innerHTML = renderDesignVersions();
            hideUploadVersionModal();

            // Log to design feed
            if (currentBrand && currentJobId) {
                await supabase.from('design_feed').insert({
                    brand_id: currentBrand.id,
                    job_id: currentJobId,
                    version_id: data.id,
                    activity_type: 'upload',
                    message: `V${nextNum} uploaded${notes ? ': ' + notes : ''}`,
                    created_by: currentUser?.id
                });
            }
            showToast(`V${nextNum} uploaded`);
        }

        // =============================================
        // DESIGN ANNOTATION TOOL
        // =============================================
        let currentAnnotatingVersionId = null;
        let currentAnnotations = []; // [{id?, marker_label, x_percent, y_percent, comment}]
        const ANN_COLOURS = ['#ec4899','#3b82f6','#f59e0b','#10b981','#8b5cf6','#ef4444','#06b6d4','#84cc16'];
        const ANN_LETTERS = ['A','B','C','D','E','F','G','H'];

        async function openAnnotationModal(versionId) {
            currentAnnotatingVersionId = versionId;
            const v = currentDesignVersions.find(x => x.id === versionId);
            if (!v) return;
            if (!v.file_url) { showToast('No image uploaded for this version yet', 'error'); return; }

            // Load existing annotations
            const { data: existing } = await supabase.from('design_annotations')
                .select('*').eq('version_id', versionId).order('created_at');
            currentAnnotations = (existing || []).map(a => ({
                id: a.id, marker_label: a.marker_label,
                x_percent: Number(a.x_percent), y_percent: Number(a.y_percent), comment: a.comment || ''
            }));

            // Populate modal
            document.getElementById('ann-version-label').textContent = v.version_label || `V${v.version_number}`;
            document.getElementById('ann-img').src = v.file_url;
            document.getElementById('annotation-modal').classList.remove('hide');

            // Wait for image to load then render markers
            document.getElementById('ann-img').onload = () => renderAnnotationMarkers();
            if (document.getElementById('ann-img').complete) renderAnnotationMarkers();
            renderAnnotationComments();
        }

        function closeAnnotationModal() {
            document.getElementById('annotation-modal').classList.add('hide');
            currentAnnotatingVersionId = null;
            currentAnnotations = [];
        }

        function placeAnnotationMarker(event) {
            const overlay = document.getElementById('ann-overlay');
            const rect = overlay.getBoundingClientRect();
            const x = ((event.clientX - rect.left) / rect.width) * 100;
            const y = ((event.clientY - rect.top) / rect.height) * 100;
            const label = ANN_LETTERS[currentAnnotations.length % ANN_LETTERS.length];
            currentAnnotations.push({ marker_label: label, x_percent: x, y_percent: y, comment: '' });
            renderAnnotationMarkers();
            renderAnnotationComments();
            // Focus the new comment input
            setTimeout(() => {
                const inputs = document.querySelectorAll('#ann-comments-list .ann-comment-input');
                if (inputs.length > 0) inputs[inputs.length - 1].focus();
            }, 50);
        }

        function renderAnnotationMarkers() {
            const container = document.getElementById('ann-img-container');
            // Remove existing pins
            container.querySelectorAll('.ann-pin').forEach(el => el.remove());
            currentAnnotations.forEach((a, i) => {
                const colour = ANN_COLOURS[i % ANN_COLOURS.length];
                const pin = document.createElement('div');
                pin.className = 'ann-pin';
                pin.style.left = a.x_percent + '%';
                pin.style.top = a.y_percent + '%';
                pin.innerHTML = `<div class="ann-pin-bubble" style="background:${colour}">${escHtml(a.marker_label)}</div>
                    <div class="ann-pin-arrow" style="border-top-color:${colour}"></div>`;
                container.appendChild(pin);
            });
        }

        function renderAnnotationComments() {
            const container = document.getElementById('ann-comments-list');
            if (!container) return;
            if (currentAnnotations.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">Click on the image to place a marker</p>';
                return;
            }
            container.innerHTML = currentAnnotations.map((a, i) => {
                const colour = ANN_COLOURS[i % ANN_COLOURS.length];
                return `<div class="glass rounded-xl p-3">
                    <div class="flex items-center justify-between mb-2">
                        <div class="flex items-center gap-2">
                            <div class="w-6 h-6 rounded-full flex items-center justify-center text-xs font-bold text-white flex-shrink-0" style="background:${colour}">${escHtml(a.marker_label)}</div>
                            <span class="text-xs text-gray-500">Marker ${a.marker_label}</span>
                        </div>
                        <button onclick="removeAnnotation(${i})" class="text-gray-600 hover:text-red-400 text-sm transition">✕</button>
                    </div>
                    <textarea class="ann-comment-input w-full px-2 py-1.5 rounded-lg text-sm resize-none" rows="2"
                        placeholder="Add comment…" oninput="updateAnnotationComment(${i},this.value)"
                        style="background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);color:#ddd">${escHtml(a.comment)}</textarea>
                </div>`;
            }).join('');
        }

        function updateAnnotationComment(index, value) {
            if (currentAnnotations[index]) currentAnnotations[index].comment = value;
        }

        function removeAnnotation(index) {
            currentAnnotations.splice(index, 1);
            // Re-label remaining
            currentAnnotations.forEach((a, i) => { a.marker_label = ANN_LETTERS[i % ANN_LETTERS.length]; });
            renderAnnotationMarkers();
            renderAnnotationComments();
        }

        function clearAllAnnotations() {
            currentAnnotations = [];
            renderAnnotationMarkers();
            renderAnnotationComments();
        }

        async function saveAnnotations() {
            if (!currentAnnotatingVersionId) return;
            // Delete existing annotations for this version
            await supabase.from('design_annotations').delete().eq('version_id', currentAnnotatingVersionId);
            // Insert new ones
            if (currentAnnotations.length > 0) {
                const rows = currentAnnotations.map(a => ({
                    version_id: currentAnnotatingVersionId,
                    marker_label: a.marker_label,
                    x_percent: a.x_percent,
                    y_percent: a.y_percent,
                    comment: a.comment || null,
                    created_by: currentUser?.id
                }));
                await supabase.from('design_annotations').insert(rows);
            }
            // Log to feed
            if (currentBrand && currentJobId && currentAnnotations.length > 0) {
                await supabase.from('design_feed').insert({
                    brand_id: currentBrand.id,
                    job_id: currentJobId,
                    version_id: currentAnnotatingVersionId,
                    activity_type: 'annotation',
                    message: `${currentAnnotations.length} annotation${currentAnnotations.length !== 1 ? 's' : ''} added`,
                    created_by: currentUser?.id
                });
            }
            showToast('Annotations saved');
            closeAnnotationModal();
        }

        async function approveAnnotatedVersion() {
            if (!currentAnnotatingVersionId) return;
            await saveAnnotations();
            await approveDesignVersion(currentAnnotatingVersionId);
        }

        async function declineAnnotatedVersion() {
            if (!currentAnnotatingVersionId) return;
            await saveAnnotations();
            await supabase.from('design_versions').update({ status: 'rejected' }).eq('id', currentAnnotatingVersionId);
            // Log to feed
            if (currentBrand && currentJobId) {
                const v = currentDesignVersions.find(x => x.id === currentAnnotatingVersionId);
                await supabase.from('design_feed').insert({
                    brand_id: currentBrand.id,
                    job_id: currentJobId,
                    version_id: currentAnnotatingVersionId,
                    activity_type: 'declined',
                    message: `${v?.version_label||'Version'} declined`,
                    created_by: currentUser?.id
                });
            }
            closeAnnotationModal();
            await loadJobDesign();
            showToast('Version declined');
        }

        async function approveDesignVersion(versionId) {
            const oldStatus = currentDesignTask.status;
            // Un-approve all others first
            await supabase.from('design_versions').update({ status: 'pending' }).eq('design_task_id', currentDesignTask.id);
            const { error } = await supabase.from('design_versions').update({ status: 'approved', approved_at: new Date().toISOString() }).eq('id', versionId);
            if (error) { showToast('Error approving version', 'error'); return; }
            // Also update design task to complete
            await supabase.from('design_tasks').update({ status: 'complete' }).eq('id', currentDesignTask.id);
            // Log
            const userName = currentUserProfile?.email?.split('@')[0] || 'Unknown';
            await supabase.from('design_brief_log').insert({
                design_task_id: currentDesignTask.id,
                user_id: currentUser?.id,
                user_name: userName,
                old_status: oldStatus,
                new_status: 'complete'
            });
            await loadJobDesign();
            showToast('Version approved — Design marked complete');
        }

        async function unapproveDesignVersion(versionId) {
            await supabase.from('design_versions').update({ status: 'pending', approved_at: null }).eq('id', versionId);
            await loadJobDesign();
        }

        async function editVersionNotes(versionId) {
            const v = currentDesignVersions.find(v => v.id === versionId);
            const notes = prompt('Edit notes:', v?.notes || '');
            if (notes === null) return;
            await supabase.from('design_versions').update({ notes: notes.trim() || null }).eq('id', versionId);
            const vList = document.getElementById('design-versions-list');
            const idx = currentDesignVersions.findIndex(v => v.id === versionId);
            if (idx >= 0) currentDesignVersions[idx].notes = notes.trim() || null;
            if (vList) vList.innerHTML = renderDesignVersions();
        }

        // =============================================
        // DESIGN STUDIO — PIPELINE LAUNCHPAD
        // =============================================
        let designStudioFilter = 'all';
        let designStageFilter = 'all';
        let allDesignTasks = [];
        let designBriefLog = [];

        async function loadDesignStudio() {
            if (!currentBrand) return;
            // Load all design_tasks for this brand with job and club info
            const { data } = await supabase
                .from('design_tasks')
                .select('*, jobs(id, job_name, job_number, club_id, stage, assigned_user_id, clubs(name))')
                .eq('jobs.brand_id', currentBrand.id)
                .order('updated_at', { ascending: false });
            allDesignTasks = (data || []).filter(dt => dt.jobs);
            renderDesignStudio();
            loadDesignFeed();
        }

        // =============================================
        // DESIGN ACTIVITY FEED
        // =============================================
        let designFeedDismissed = new Set(JSON.parse(localStorage.getItem('ds_dismissed') || '[]'));

        function saveDesignFeedDismissed() {
            localStorage.setItem('ds_dismissed', JSON.stringify([...designFeedDismissed]));
        }

        async function loadDesignFeed() {
            if (!currentBrand) return;
            const container = document.getElementById('ds-feed-list');
            if (!container) return;
            // Fetch recent activity (last 50)
            const { data } = await supabase
                .from('design_feed')
                .select('*, jobs(job_name, job_number)')
                .eq('brand_id', currentBrand.id)
                .order('created_at', { ascending: false })
                .limit(50);
            const items = (data || []).filter(item => !designFeedDismissed.has(item.id));
            renderDesignFeed(items);
        }

        function renderDesignFeed(items) {
            const container = document.getElementById('ds-feed-list');
            if (!container) return;
            if (items.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-600 text-center py-4">No recent activity</p>';
                return;
            }
            const icons = { upload: '🖼️', annotation: '📌', approved: '✅', declined: '❌', status_change: '🔄', comment: '💬' };
            container.innerHTML = items.map(item => {
                const timeAgo = formatTimeAgo(item.created_at);
                const jobName = item.jobs?.job_name || 'Unknown job';
                const jobNum  = item.jobs?.job_number || '';
                return `<div class="feed-item" id="feed-${item.id}">
                    <div class="flex items-start gap-2">
                        <span class="text-base flex-shrink-0 mt-0.5">${icons[item.activity_type] || '📋'}</span>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm leading-snug">${escHtml(item.message || item.activity_type)}</p>
                            <button onclick="openJobFromFeed('${item.jobs?.id||''}')" class="text-xs text-brand-400 hover:text-brand-300 mt-0.5 truncate max-w-full block text-left transition">${escHtml(jobNum ? jobNum + ' · ' + jobName : jobName)}</button>
                            <p class="text-xs text-gray-600 mt-0.5">${timeAgo}</p>
                        </div>
                        <button onclick="dismissFeedItem('${item.id}')" class="text-gray-600 hover:text-brand-400 transition flex-shrink-0 text-lg leading-none" title="Dismiss">👍</button>
                    </div>
                </div>`;
            }).join('');
        }

        function dismissFeedItem(itemId) {
            designFeedDismissed.add(itemId);
            saveDesignFeedDismissed();
            const el = document.getElementById(`feed-${itemId}`);
            if (el) el.remove();
            // Show empty state if no items left
            const container = document.getElementById('ds-feed-list');
            if (container && container.children.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-600 text-center py-4">No recent activity</p>';
            }
        }

        function openJobFromFeed(jobId) {
            if (!jobId) return;
            pushNav({ type: 'tool', tool: 'design-studio' });
            openJobRecord(jobId).then(() => showJobTab('design'));
        }

        function refreshDesignFeed() {
            loadDesignFeed();
        }

        function formatTimeAgo(dateStr) {
            const secs = Math.floor((Date.now() - new Date(dateStr)) / 1000);
            if (secs < 60) return 'Just now';
            if (secs < 3600) return `${Math.floor(secs/60)}m ago`;
            if (secs < 86400) return `${Math.floor(secs/3600)}h ago`;
            return `${Math.floor(secs/86400)}d ago`;
        }

        function setDesignFilter(f) {
            designStudioFilter = f;
            document.getElementById('ds-filter-mine').style.cssText = f === 'mine'
                ? 'background:rgba(236,72,153,0.15);color:#f472b6;border:1px solid rgba(236,72,153,0.3)'
                : 'background:rgba(255,255,255,0.05);color:#888;border:1px solid rgba(255,255,255,0.08)';
            document.getElementById('ds-filter-all').style.cssText = f === 'all'
                ? 'background:rgba(236,72,153,0.15);color:#f472b6;border:1px solid rgba(236,72,153,0.3)'
                : 'background:rgba(255,255,255,0.05);color:#888;border:1px solid rgba(255,255,255,0.08)';
            renderDesignStudio();
        }

        function filterDesignByStage(stage) {
            designStageFilter = stage;
            document.querySelectorAll('.ds-filter-chip').forEach(c => c.classList.remove('active'));
            const activeCard = document.getElementById(`ds-stage-${stage}`);
            if (activeCard) activeCard.classList.add('active');
            renderDesignStudio();
        }

        function renderDesignStudio() {
            let tasks = allDesignTasks;
            if (designStudioFilter === 'mine' && currentUser) {
                tasks = tasks.filter(dt => dt.jobs?.assigned_user_id === currentUser.id);
            }
            // Update stage counts (always from full filtered set)
            const stageCounts = { all: tasks.length };
            ['new','in_progress','revisions','in_review','awaiting_approval','complete'].forEach(s => {
                stageCounts[s] = tasks.filter(dt => dt.status === s).length;
            });
            Object.entries(stageCounts).forEach(([s, c]) => {
                const el = document.getElementById(`ds-count-${s}`);
                if (el) el.textContent = c;
            });

            // Filter by selected stage
            if (designStageFilter !== 'all') {
                tasks = tasks.filter(dt => dt.status === designStageFilter);
            }

            const container = document.getElementById('ds-jobs-list');
            const empty = document.getElementById('ds-jobs-empty');
            if (!tasks.length) {
                container.innerHTML = '';
                empty.classList.remove('hide');
                return;
            }
            empty.classList.add('hide');
            const statusColour = { new:'#2dd4bf', in_progress:'#fbbf24', revisions:'#fb7185', in_review:'#60a5fa', awaiting_approval:'#a78bfa', complete:'#4ade80' };
            container.innerHTML = tasks.map(dt => {
                const job = dt.jobs;
                const club = job?.clubs;
                const days = Math.floor((new Date() - new Date(dt.updated_at)) / 86400000);
                const col = statusColour[dt.status] || '#888';
                return `<div class="design-job-card" onclick="openJobFromDesignStudio('${job.id}')">
                    <div class="flex items-start justify-between gap-4">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-xs font-mono text-gray-500">${escHtml(job.job_number || '')}</span>
                                <span class="text-sm font-semibold">${escHtml(job.job_name)}</span>
                            </div>
                            ${club ? `<p class="text-xs text-gray-500 mb-2">🏟️ ${escHtml(club.name)}</p>` : ''}
                            <span class="stage-pill design-status-${dt.status}">${DESIGN_STATUS_LABELS[dt.status] || dt.status}</span>
                        </div>
                        <div class="text-right flex-shrink-0">
                            <p class="text-xs text-gray-600">${days === 0 ? 'Today' : `${days}d ago`}</p>
                            <p class="text-xs text-gray-600 mt-1">${(dt.design_summary || '').substring(0,40)}${dt.design_summary?.length > 40 ? '…' : ''}</p>
                        </div>
                    </div>
                </div>`;
            }).join('');

            // Update launchpad badge stats
            const el_active = document.getElementById('stat-design-active');
            const el_review = document.getElementById('stat-design-review');
            if (el_active) el_active.textContent = `${stageCounts.in_progress || 0} active`;
            if (el_review) el_review.textContent = `${stageCounts.in_review || 0} in review`;
        }

        async function openJobFromDesignStudio(jobId) {
            const job = jobs.find(j => j.id === jobId);
            if (!job) {
                // Load job and navigate
                const { data } = await supabase.from('jobs').select('*').eq('id', jobId).single();
                if (data) { showJobRecord(data); switchJobTab('design'); }
                return;
            }
            showJobRecord(job);
            switchJobTab('design');
        }

        // =============================================
        // DESIGN BRIEF LOG
        // =============================================
        async function loadDesignBriefLog() {
            if (!currentDesignTask?.id) { designBriefLog = []; return; }
            const { data } = await supabase.from('design_brief_log')
                .select('*').eq('design_task_id', currentDesignTask.id).order('created_at');
            designBriefLog = data || [];
        }

        function renderDesignBriefLog() {
            if (!designBriefLog.length) return '<p class="text-xs text-gray-700">No status changes logged yet.</p>';
            const colours = { new:'#9ca3af', in_progress:'#fbbf24', revisions:'#fb7185', in_review:'#60a5fa', awaiting_approval:'#a78bfa', complete:'#4ade80' };
            return designBriefLog.map(entry => {
                const oldLabel = DESIGN_STATUS_LABELS[entry.old_status] || entry.old_status || '—';
                const newLabel = DESIGN_STATUS_LABELS[entry.new_status] || entry.new_status;
                const col = colours[entry.new_status] || '#888';
                const ts = new Date(entry.created_at).toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
                return `<div class="flex items-center gap-3 py-2 border-b border-gray-800 last:border-0">
                    <div class="w-2 h-2 rounded-full flex-shrink-0" style="background:${col}"></div>
                    <p class="text-xs text-gray-400 flex-1"><span class="font-semibold text-gray-300">${escHtml(entry.user_name)}</span> changed status from <span class="text-gray-500">${escHtml(oldLabel)}</span> → <span style="color:${col}">${escHtml(newLabel)}</span></p>
                    <span class="text-xs text-gray-700 flex-shrink-0">${ts}</span>
                </div>`;
            }).join('');
        }

        // =============================================
        // DESIGN STUDIO — JOB COLOUR OVERRIDES
        // =============================================
        function toggleJobColourOverride() {
            const el = document.getElementById('job-colour-override');
            if (el) el.classList.toggle('hide');
        }

        function updateJobPantone(field, value) {
            if (!currentJob) return;
            currentJob[`pantone_${field}`] = value;
        }

        async function saveJobColours() {
            if (!currentJob?.id) return;
            const { error } = await supabase.from('jobs').update({
                pantone_main: currentJob.pantone_main,
                pantone_secondary: currentJob.pantone_secondary,
                pantone_accent: currentJob.pantone_accent
            }).eq('id', currentJob.id);
            if (error) { showToast('Error saving colours', 'error'); return; }
            renderDesignTab();
            showToast('Job colours saved');
        }

        // =============================================
        // CLUB TEAMS
        // =============================================
        let currentClubTeams = [];

        async function loadClubTeams() {
            if (!currentClub) return;
            const { data } = await supabase.from('club_teams')
                .select('*').eq('club_id', currentClub.id).order('team_name');
            currentClubTeams = data || [];
        }

        function renderClubTeams() {
            const container = document.getElementById('club-teams-list');
            const empty = document.getElementById('club-teams-empty');
            if (!container) return;
            if (!currentClubTeams.length) {
                container.innerHTML = '';
                empty.classList.remove('hide');
                return;
            }
            empty.classList.add('hide');
            container.innerHTML = currentClubTeams.map(t => `
                <div class="club-team-card">
                    <div class="flex items-start justify-between gap-3">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="font-semibold text-sm">👕 ${escHtml(t.team_name)}</span>
                                ${t.age_group ? `<span class="text-xs px-2 py-0.5 rounded-full" style="background:rgba(20,184,166,0.1);color:#2dd4bf">${escHtml(t.age_group)}</span>` : ''}
                                ${t.gender ? `<span class="text-xs text-gray-600">${escHtml(t.gender)}</span>` : ''}
                            </div>
                            ${t.coach_name ? `<p class="text-xs text-gray-400">Coach: ${escHtml(t.coach_name)}${t.coach_email ? ` · <a href="mailto:${escHtml(t.coach_email)}" class="text-brand-400 hover:underline">${escHtml(t.coach_email)}</a>` : ''}${t.coach_phone ? ` · ${escHtml(t.coach_phone)}` : ''}</p>` : ''}
                            ${t.notes ? `<p class="text-xs text-gray-600 mt-1">${escHtml(t.notes)}</p>` : ''}
                        </div>
                        <div class="flex gap-2 flex-shrink-0">
                            <button onclick="openClubTeamModal('${t.id}')" class="text-xs btn-secondary px-3 py-1.5">Edit</button>
                            <button onclick="deleteClubTeam('${t.id}')" class="text-xs text-red-400 hover:text-red-300 px-2 py-1.5">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function openClubTeamModal(teamId) {
            const team = teamId ? currentClubTeams.find(t => t.id === teamId) : null;
            document.getElementById('club-team-modal-title').textContent = team ? 'Edit Team' : 'Add Team';
            document.getElementById('edit-club-team-id').value = team?.id || '';
            document.getElementById('ct-name').value = team?.team_name || '';
            document.getElementById('ct-age-group').value = team?.age_group || '';
            document.getElementById('ct-gender').value = team?.gender || '';
            document.getElementById('ct-coach-name').value = team?.coach_name || '';
            document.getElementById('ct-coach-email').value = team?.coach_email || '';
            document.getElementById('ct-coach-phone').value = team?.coach_phone || '';
            document.getElementById('ct-notes').value = team?.notes || '';
            document.getElementById('club-team-modal').classList.remove('hide');
        }

        function closeClubTeamModal() {
            document.getElementById('club-team-modal').classList.add('hide');
        }

        async function saveClubTeam() {
            const teamId = document.getElementById('edit-club-team-id').value;
            const name = document.getElementById('ct-name').value.trim();
            if (!name) { showToast('Team name is required', 'error'); return; }
            const payload = {
                club_id: currentClub.id,
                brand_id: currentBrand.id,
                team_name: name,
                age_group: document.getElementById('ct-age-group').value.trim() || null,
                gender: document.getElementById('ct-gender').value || null,
                coach_name: document.getElementById('ct-coach-name').value.trim() || null,
                coach_email: document.getElementById('ct-coach-email').value.trim() || null,
                coach_phone: document.getElementById('ct-coach-phone').value.trim() || null,
                notes: document.getElementById('ct-notes').value.trim() || null
            };
            let result;
            if (teamId) {
                result = await supabase.from('club_teams').update(payload).eq('id', teamId).select().single();
                if (result.data) { const idx = currentClubTeams.findIndex(t => t.id === teamId); if (idx >= 0) currentClubTeams[idx] = result.data; }
            } else {
                result = await supabase.from('club_teams').insert(payload).select().single();
                if (result.data) currentClubTeams.push(result.data);
            }
            if (result.error) { showToast(result.error.message, 'error'); return; }
            closeClubTeamModal();
            renderClubTeams();
            showToast(teamId ? 'Team updated' : 'Team added');
        }

        async function deleteClubTeam(teamId) {
            if (!confirm('Delete this team?')) return;
            await supabase.from('club_teams').delete().eq('id', teamId);
            currentClubTeams = currentClubTeams.filter(t => t.id !== teamId);
            renderClubTeams();
            showToast('Team removed');
        }

        // =============================================
        // JOB RECORD — CLUB TEAM SECTION
        // =============================================
        async function renderJobClubTeamSection() {
            const container = document.getElementById('jr-club-team-section');
            if (!container || !currentJob?.club_id) return;
            const { data: teams } = await supabase.from('club_teams').select('*').eq('club_id', currentJob.club_id).order('team_name');
            if (!teams?.length) {
                container.innerHTML = '<p class="text-gray-600 text-sm">No teams set up for this club yet. Add teams in the club record.</p>';
                return;
            }
            const current = currentJob.club_team_id;
            container.innerHTML = `
                <p class="text-xs text-gray-500 mb-2">Select which team this job is for:</p>
                <div class="flex flex-wrap gap-2 mb-3">
                    ${teams.map(t => `<button onclick="setJobClubTeam('${t.id}')" class="text-xs px-3 py-2 rounded-lg font-medium transition ${current === t.id ? 'btn-primary' : 'btn-secondary'}">${escHtml(t.team_name)}${t.age_group ? ` (${escHtml(t.age_group)})` : ''}</button>`).join('')}
                </div>
                ${current ? (() => {
                    const t = teams.find(x => x.id === current);
                    if (!t) return '';
                    return `<div class="p-3 rounded-xl" style="background:rgba(20,184,166,0.06);border:1px solid rgba(20,184,166,0.2)">
                        <p class="text-xs text-brand-400 font-semibold mb-1">Selected: ${escHtml(t.team_name)}</p>
                        ${t.coach_name ? `<p class="text-xs text-gray-400">Coach: ${escHtml(t.coach_name)}${t.coach_email ? ` · ${escHtml(t.coach_email)}` : ''}</p>` : ''}
                    </div>`;
                })() : ''}
            `;
        }

        async function setJobClubTeam(teamId) {
            if (!currentJob?.id) return;
            const newTeamId = currentJob.club_team_id === teamId ? null : teamId; // toggle
            await supabase.from('jobs').update({ club_team_id: newTeamId }).eq('id', currentJob.id);
            currentJob.club_team_id = newTeamId;
            renderJobClubTeamSection();
            showToast(newTeamId ? 'Club team linked' : 'Club team unlinked');
        }

        // =============================================
        // JOB ACTIVITY LOG
        // =============================================
        let jobActivityLog = [];

        async function loadJobActivity() {
            if (!currentJobId) return;
            const { data } = await supabase.from('job_activity')
                .select('*').eq('job_id', currentJobId).order('created_at', { ascending: false });
            jobActivityLog = data || [];
            renderJobActivity();
        }

        function renderJobActivity() {
            const container = document.getElementById('jr-activity-log');
            if (!container) return;
            if (!jobActivityLog.length) {
                container.innerHTML = '<p class="text-xs text-gray-700 py-4 text-center">No activity yet.</p>';
                return;
            }
            container.innerHTML = jobActivityLog.map(entry => {
                const initial = (entry.user_name || '?').charAt(0).toUpperCase();
                const ts = new Date(entry.created_at).toLocaleString('en-GB', { day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit' });
                const typeColour = { status_change: '#a78bfa', assignment: '#60a5fa', system: '#9ca3af', note: '#2dd4bf' };
                const col = typeColour[entry.activity_type] || '#2dd4bf';
                return `<div class="activity-entry">
                    <div class="activity-avatar" style="background:${col}18;color:${col}">${initial}</div>
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-semibold text-gray-300">${escHtml(entry.user_name)}</p>
                        <p class="text-xs text-gray-400 mt-0.5">${escHtml(entry.message)}</p>
                        <p class="text-xs text-gray-700 mt-0.5">${ts}</p>
                    </div>
                </div>`;
            }).join('');
        }

        async function addJobActivity(message, type) {
            const input = document.getElementById('jr-activity-input');
            const msg = message || input?.value?.trim();
            if (!msg) return;
            const userName = currentUserProfile?.email?.split('@')[0] || 'Unknown';
            const { data, error } = await supabase.from('job_activity').insert({
                job_id: currentJobId,
                brand_id: currentBrand.id,
                user_id: currentUser?.id,
                user_name: userName,
                message: msg,
                activity_type: type || 'note'
            }).select().single();
            if (error) { showToast('Error adding activity', 'error'); return; }
            jobActivityLog.unshift(data);
            if (input) input.value = '';
            renderJobActivity();
        }

        // =============================================
        // PROFILE SETTINGS
        // =============================================
        function showProfileSettings() {
            document.getElementById('profile-email-display').textContent = currentUser?.email || '';
            document.getElementById('scope-all').checked = viewScope !== 'mine';
            document.getElementById('scope-mine').checked = viewScope === 'mine';
            document.getElementById('profile-settings-modal').classList.remove('hide');
        }

        function hideProfileSettings() {
            document.getElementById('profile-settings-modal').classList.add('hide');
        }

        function updateViewScope(scope) {
            viewScope = scope;
            localStorage.setItem('teamwear_view_scope', scope);
            renderClubsEnhanced();
            renderLiveJobs();
            renderCompletedJobs();
        }

        function getUserDisplayName(userId) {
            if (!userId) return '—';
            if (userId === currentUser?.id) {
                const name = currentUser.email?.split('@')[0] || 'me';
                return name + ' (you)';
            }
            const u = brandUsers.find(u => u.id === userId);
            return u ? u.email.split('@')[0] : '—';
        }

        // =============================================
        // USER ASSIGNMENT
        // =============================================
        let brandUsers = [];

        async function loadBrandUsers() {
            if (!currentBrand) return;
            const { data } = await supabase.from('user_profiles').select('id, email').eq('brand_id', currentBrand.id).order('email');
            brandUsers = data || [];
        }

        function populateUserAssignDropdown(selectId, currentAssignedId) {
            const el = document.getElementById(selectId);
            if (!el) return;
            el.innerHTML = '<option value="">Unassigned</option>' +
                brandUsers.map(u => `<option value="${u.id}" ${u.id === currentAssignedId ? 'selected' : ''}>${escHtml(u.email.split('@')[0])}</option>`).join('');
        }

        async function saveJobAssignment(userId) {
            if (!currentJobId) return;
            await supabase.from('jobs').update({ assigned_user_id: userId || null }).eq('id', currentJobId);
            if (currentJob) currentJob.assigned_user_id = userId || null;
            showToast('Assignment saved');
        }

        async function saveClubAssignment(userId) {
            if (!currentClub?.id) return;
            await supabase.from('clubs').update({ assigned_user_id: userId || null }).eq('id', currentClub.id);
            if (currentClub) currentClub.assigned_user_id = userId || null;
            showToast('Assignment saved');
        }

        // =============================================
        // CLUB LOGO UPLOAD
        // =============================================
        function previewClubLogo(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = e => {
                const preview = document.getElementById('club-logo-preview');
                if (preview) preview.innerHTML = `<img src="${e.target.result}" class="w-full h-full object-contain rounded-xl">`;
            };
            reader.readAsDataURL(file);
        }

        async function uploadClubLogoInline(event) {
            const file = event.target.files[0];
            if (!file || !currentClub || !currentBrand) return;
            const ext = file.name.substring(file.name.lastIndexOf('.'));
            const storagePath = `${currentBrand.slug}/${currentClub.suffix}/logo${ext}`;
            const { error } = await supabase.storage.from('club-images').upload(storagePath, file, { upsert: true });
            if (error) { showToast('Upload failed: ' + error.message, 'error'); return; }
            const { data: urlData } = supabase.storage.from('club-images').getPublicUrl(storagePath);
            const logoUrl = urlData.publicUrl;
            await supabase.from('clubs').update({ logo_url: logoUrl }).eq('id', currentClub.id);
            currentClub.logo_url = logoUrl;
            const clubIdx = clubs.findIndex(c => c.id === currentClub.id);
            if (clubIdx >= 0) clubs[clubIdx].logo_url = logoUrl;
            // Update display
            const crestEl = document.getElementById('club-crest-display');
            if (crestEl) crestEl.innerHTML = `<img src="${escHtml(logoUrl)}" class="w-full h-full object-contain rounded-xl">`;
            const dlBtn = document.getElementById('club-logo-download-btn');
            if (dlBtn) dlBtn.classList.remove('hide');
            showToast('Logo uploaded');
        }

        function downloadClubLogo() {
            if (!currentClub?.logo_url) return;
            const a = document.createElement('a');
            a.href = currentClub.logo_url;
            a.download = `${currentClub.suffix}-logo`;
            a.target = '_blank';
            a.click();
        }

        // =============================================
        // USER FEATURE PERMISSIONS
        // =============================================
        let userFeaturePermissions = {}; // { userId: { feature: enabled } }

        async function loadUserFeaturePermissions() {
            if (!currentBrand) return;
            const { data } = await supabase.from('user_feature_permissions')
                .select('*').eq('brand_id', currentBrand.id);
            userFeaturePermissions = {};
            (data || []).forEach(p => {
                if (!userFeaturePermissions[p.user_id]) userFeaturePermissions[p.user_id] = {};
                userFeaturePermissions[p.user_id][p.feature] = p.enabled;
            });
        }

        async function saveUserFeaturePermission(userId, feature, enabled) {
            await supabase.from('user_feature_permissions').upsert(
                { brand_id: currentBrand.id, user_id: userId, feature, enabled, updated_at: new Date().toISOString() },
                { onConflict: 'brand_id,user_id,feature' }
            );
            if (!userFeaturePermissions[userId]) userFeaturePermissions[userId] = {};
            userFeaturePermissions[userId][feature] = enabled;
        }

        async function applyUserFeaturePermissions() {
            if (!currentUser || isSuperAdmin) return; // super admins see everything
            const perms = userFeaturePermissions[currentUser.id];
            if (!perms) return; // no restrictions set = all access
            Object.entries(perms).forEach(([feature, enabled]) => {
                if (!enabled) {
                    // Hide the feature card
                    const featureMap = {
                        'prospecting': 'fc-prospecting', 'sales': 'fc-sales', 'clubs': 'fc-clubs',
                        'production': 'fc-production', 'design_studio': 'fc-design',
                        'store_generator': 'fc-store', 'products': 'fc-products'
                    };
                    const cardId = featureMap[feature];
                    if (cardId) {
                        const card = document.getElementById(cardId);
                        if (card) { card.style.display = 'none'; }
                    }
                }
            });
        }

        // =============================================
        // SALES — ORDER FORM TAB (in Job Record)
        // =============================================
        async function renderJobOrderForm() {
            const container = document.getElementById('jr-orderform-content');
            if (!container || !currentJob?.club_id) {
                container.innerHTML = `<div class="glass rounded-2xl p-6 text-center"><div class="empty-icon text-5xl mb-3">📝</div><p class="text-gray-500">Link a club to this job to create order forms.</p></div>`;
                return;
            }
            // Load order forms for the linked club
            const { data: forms } = await supabase.from('order_forms').select('*').eq('club_id', currentJob.club_id).order('created_at', { ascending: false });
            if (!forms || forms.length === 0) {
                container.innerHTML = `<div class="glass rounded-2xl p-6 text-center">
                    <div class="empty-icon text-5xl mb-3">📝</div>
                    <p class="text-gray-500 mb-4">No order forms yet for this club.</p>
                    <button onclick="createOrderFormForJob()" class="btn-primary text-sm">Create Order Form</button>
                </div>`;
                return;
            }
            const baseUrl = window.location.origin + window.location.pathname;
            container.innerHTML = `<div class="flex items-center justify-between mb-4">
                <h4 class="font-semibold">Order Forms for ${escHtml(currentJob.clubs?.name || '')}</h4>
                <button onclick="createOrderFormForJob()" class="btn-primary text-sm">New Form</button>
            </div>` +
            forms.map(f => `<div class="glass rounded-xl p-4 mb-3">
                <div class="flex items-start justify-between gap-3">
                    <div>
                        <p class="font-semibold">${escHtml(f.title)}</p>
                        <p class="text-xs text-gray-500 mt-0.5">${f.season || ''} ${f.is_active ? '<span style="color:#4ade80">● Active</span>' : '<span style="color:#555">● Closed</span>'}</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="copyFormLink('${baseUrl}?form=${f.token}')" class="text-xs btn-secondary py-1 px-3">Copy Link</button>
                        <a href="${baseUrl}?form=${f.token}" target="_blank" class="text-xs btn-secondary py-1 px-3">Preview</a>
                        <button onclick="viewFormSubmissions('${f.id}')" class="text-xs btn-primary py-1 px-3">Submissions</button>
                    </div>
                </div>
            </div>`).join('');
        }

        async function createOrderFormForJob() {
            if (!currentJob?.club_id) { showToast('Link a club first', 'error'); return; }
            // Open the existing order form modal but with job's club pre-set
            const clubObj = clubs.find(c => c.id === currentJob.club_id);
            if (clubObj) {
                // Set up the club context and open modal
                window._currentClub = clubObj;
                showCreateOrderFormModal();
            }
        }

        // =============================================
        // SALES — PRODUCTION TAB
        // =============================================
        async function renderJobProduction() {
            document.getElementById('jr-po-number').value = currentJob?.po_number || '';
        }

        async function generateProductionWorksheet() {
            if (!currentJob) return;
            showToast('Production worksheet generation coming soon', 'info');
        }

        // =============================================
        // FEATURE TOGGLES
        // =============================================
        const FEATURES = [
            { key: 'prospecting', label: 'Prospecting', icon: '🎯', desc: 'Lead tracking and early pipeline management' },
            { key: 'sales', label: 'Sales', icon: '💼', desc: 'Job management, design briefs and order pipeline' },
            { key: 'clubs', label: 'Clubs', icon: '🏟️', desc: 'Club management, products and order forms' },
            { key: 'production', label: 'Production', icon: '🚚', desc: 'PO tracking and factory management' },
            { key: 'design_studio', label: 'Design Studio', icon: '🎨', desc: 'Mockup image uploads' },
            { key: 'store_generator', label: 'Store Generator', icon: '🏪', desc: 'Shopify CSV and store sync' },
            { key: 'products', label: 'Product Database', icon: '📦', desc: 'Master product catalogue and pricing structure' }
        ];

        async function loadFeatureToggles() {
            if (!currentBrand) return;
            const { data } = await supabase
                .from('feature_toggles')
                .select('*')
                .eq('brand_id', currentBrand.id);
            featureToggles = {};
            (data || []).forEach(ft => { featureToggles[ft.feature] = ft.enabled; });
        }

        async function saveFeatureToggle(feature, enabled) {
            if (!currentBrand) return;
            const { error } = await supabase
                .from('feature_toggles')
                .upsert({ brand_id: currentBrand.id, feature, enabled, updated_at: new Date().toISOString() },
                    { onConflict: 'brand_id,feature' });
            if (error) { showToast('Error saving toggle: ' + error.message, 'error'); return; }
            featureToggles[feature] = enabled;
            applyFeatureToggles();
            showToast(`${FEATURES.find(f=>f.key===feature)?.label} ${enabled ? 'enabled' : 'disabled'}`);
        }

        function renderFeatureToggles() {
            const container = document.getElementById('feature-toggles-list');
            if (!container) return;
            container.innerHTML = FEATURES.map(f => {
                const enabled = featureToggles[f.key] !== false;
                return `<div class="flex items-center justify-between p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05)">
                    <div class="flex items-center gap-3">
                        <span class="text-xl">${f.icon}</span>
                        <div>
                            <p class="text-sm font-semibold">${f.label}</p>
                            <p class="text-xs text-gray-500">${f.desc}</p>
                        </div>
                    </div>
                    <label class="toggle-switch">
                        <input type="checkbox" ${enabled ? 'checked' : ''} onchange="saveFeatureToggle('${f.key}', this.checked)">
                        <span class="toggle-slider"></span>
                    </label>
                </div>`;
            }).join('');
        }

        // =============================================
        // PROSPECTING — DATA LOADING
        // =============================================
        async function loadLeads() {
            if (!currentBrand) return;
            const { data } = await supabase
                .from('leads')
                .select('*, kanban_stages(id,name,color,position)')
                .eq('brand_id', currentBrand.id)
                .order('created_at', { ascending: false });
            leads = data || [];
        }

        async function loadKanbanStages() {
            if (!currentBrand) return;
            const { data } = await supabase
                .from('kanban_stages')
                .select('*')
                .eq('brand_id', currentBrand.id)
                .order('position');
            kanbanStages = data || [];
            // If no stages exist, seed defaults
            if (kanbanStages.length === 0) {
                await seedDefaultStages();
            }
        }

        async function seedDefaultStages() {
            if (!currentBrand) return;
            const defaults = [
                { brand_id: currentBrand.id, name: 'Initial Contact', color: '#14b8a6', position: 0 },
                { brand_id: currentBrand.id, name: 'Proposal Sent', color: '#8b5cf6', position: 1 },
                { brand_id: currentBrand.id, name: 'Decision Pending', color: '#f97316', position: 2 }
            ];
            const { data } = await supabase.from('kanban_stages').insert(defaults).select();
            kanbanStages = data || [];
        }

        // =============================================
        // PROSPECTING — NAVIGATION
        // =============================================
        function showProspectView(view) {
            document.getElementById('prospect-home').classList.add('hide');
            document.getElementById('prospect-not-contacted').classList.add('hide');
            document.getElementById('prospect-in-discussion').classList.add('hide');

            if (view === 'home') {
                document.getElementById('prospect-home').classList.remove('hide');
                updateStats();
            } else if (view === 'not-contacted') {
                document.getElementById('prospect-not-contacted').classList.remove('hide');
                renderNotContacted();
                populateCountyFilter();
            } else if (view === 'in-discussion') {
                document.getElementById('prospect-in-discussion').classList.remove('hide');
                renderKanban();
            }
        }

        // =============================================
        // PROSPECTING — NOT CONTACTED LIST
        // =============================================
        function renderNotContacted() {
            const search = (document.getElementById('nc-search')?.value || '').toLowerCase();
            const sportFilter = document.getElementById('nc-filter-sport')?.value || '';
            const countyFilter = document.getElementById('nc-filter-county')?.value || '';

            let filtered = leads.filter(l => l.status === 'not_contacted');
            if (search) filtered = filtered.filter(l =>
                l.lead_name?.toLowerCase().includes(search) ||
                l.club_name?.toLowerCase().includes(search) ||
                l.county?.toLowerCase().includes(search) ||
                l.location?.toLowerCase().includes(search)
            );
            if (sportFilter) filtered = filtered.filter(l => l.sport === sportFilter);
            if (countyFilter) filtered = filtered.filter(l => l.county === countyFilter);

            const countEl = document.getElementById('nc-list-count');
            if (countEl) countEl.textContent = filtered.length;

            const container = document.getElementById('nc-list');
            if (!container) return;

            if (filtered.length === 0) {
                container.innerHTML = `<div class="empty-state"><div class="empty-icon">📋</div><p>No leads found. Add your first lead to get started.</p></div>`;
                return;
            }

            container.innerHTML = filtered.map(lead => `
                <div class="lead-row" onclick="openLeadModal('${lead.id}')">
                    <div class="flex-1 min-w-0">
                        <p class="font-semibold text-sm truncate">${escHtml(lead.lead_name)}</p>
                        <p class="text-xs text-gray-500 truncate">${escHtml(lead.club_name)}${lead.location ? ' · ' + escHtml(lead.location) : ''}</p>
                    </div>
                    <div class="flex items-center gap-2 flex-shrink-0">
                        ${lead.sport ? `<span class="lead-sport-badge">${escHtml(lead.sport)}</span>` : ''}
                        ${lead.county ? `<span class="lead-county-badge">${escHtml(lead.county)}</span>` : ''}
                        ${lead.amount_of_teams ? `<span class="text-xs text-gray-600">${lead.amount_of_teams} team${lead.amount_of_teams !== 1 ? 's' : ''}</span>` : ''}
                    </div>
                    <div class="flex gap-2 flex-shrink-0">
                        <button onclick="event.stopPropagation();moveLeadToDiscussion('${lead.id}')"
                            class="text-xs px-3 py-1.5 rounded-lg font-semibold transition"
                            style="background:rgba(139,92,246,0.1);color:#a78bfa;border:1px solid rgba(139,92,246,0.2)"
                            title="Move to In Discussion">
                            Move to Discussion →
                        </button>
                        <button onclick="event.stopPropagation();archiveLeadById('${lead.id}','not_interested')"
                            class="text-xs px-2 py-1.5 rounded-lg transition"
                            style="background:rgba(255,255,255,0.04);color:#666"
                            title="Archive as Not Interested">
                            Archive
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function populateCountyFilter() {
            const sel = document.getElementById('nc-filter-county');
            if (!sel) return;
            const counties = [...new Set(leads.filter(l => l.county).map(l => l.county))].sort();
            const current = sel.value;
            sel.innerHTML = '<option value="">All Counties</option>' +
                counties.map(c => `<option value="${escHtml(c)}" ${c === current ? 'selected' : ''}>${escHtml(c)}</option>`).join('');
        }

        async function moveLeadToDiscussion(leadId) {
            const defaultStage = kanbanStages[0];
            const updates = { status: 'in_discussion', kanban_stage_id: defaultStage?.id || null };
            const { error } = await supabase.from('leads').update(updates).eq('id', leadId);
            if (error) { showToast('Error moving lead: ' + error.message, 'error'); return; }
            await loadLeads();
            renderNotContacted();
            updateStats();
            showToast('Lead moved to In Discussion');
        }

        async function archiveLeadById(leadId, reason) {
            if (!confirm('Archive this lead as "Not Interested"?')) return;
            const { error } = await supabase.from('leads')
                .update({ status: 'archived', archived_reason: reason })
                .eq('id', leadId);
            if (error) { showToast('Error archiving lead: ' + error.message, 'error'); return; }
            await loadLeads();
            renderNotContacted();
            updateStats();
            showToast('Lead archived');
        }

        // =============================================
        // PROSPECTING — KANBAN BOARD
        // =============================================
        function renderKanban() {
            const board = document.getElementById('kanban-board');
            if (!board) return;

            const idLeads = leads.filter(l => l.status === 'in_discussion');
            const countEl = document.getElementById('id-board-count');
            if (countEl) countEl.textContent = idLeads.length;

            if (kanbanStages.length === 0) {
                board.innerHTML = `<div class="empty-state w-full"><div class="empty-icon">🏗️</div><p>No stages configured. Click "Configure Stages" to get started.</p></div>`;
                return;
            }

            board.innerHTML = kanbanStages.map(stage => {
                const stageLeads = idLeads
                    .filter(l => l.kanban_stage_id === stage.id)
                    .sort((a, b) => (a.kanban_order || 0) - (b.kanban_order || 0));

                const cards = stageLeads.map(lead => `
                    <div class="kanban-card"
                        draggable="true"
                        ondragstart="onKanbanDragStart(event,'${lead.id}')"
                        ondragend="onKanbanDragEnd(event)"
                        onclick="openLeadModal('${lead.id}')">
                        <div class="kanban-card-title">${escHtml(lead.lead_name)}</div>
                        <div class="kanban-card-club">${escHtml(lead.club_name)}</div>
                        <div class="kanban-card-meta">
                            ${lead.sport ? `<span class="lead-sport-badge">${escHtml(lead.sport)}</span>` : ''}
                            ${lead.county ? `<span class="lead-county-badge">${escHtml(lead.county)}</span>` : ''}
                        </div>
                    </div>
                `).join('');

                return `
                    <div class="kanban-column"
                        ondragover="onKanbanDragOver(event)"
                        ondrop="onKanbanDrop(event,'${stage.id}')"
                        ondragleave="onKanbanDragLeave(event)">
                        <div class="kanban-col-header">
                            <span class="kanban-col-title" style="color:${stage.color}">${escHtml(stage.name)}</span>
                            <span class="kanban-count">${stageLeads.length}</span>
                        </div>
                        ${cards || `<div style="color:#444;font-size:13px;padding:8px 0;text-align:center">Drop leads here</div>`}
                    </div>
                `;
            }).join('');
        }

        // Drag & drop handlers
        function onKanbanDragStart(event, leadId) {
            dragLeadId = leadId;
            event.currentTarget.classList.add('dragging');
            event.dataTransfer.effectAllowed = 'move';
        }
        function onKanbanDragEnd(event) {
            event.currentTarget.classList.remove('dragging');
            dragLeadId = null;
        }
        function onKanbanDragOver(event) {
            event.preventDefault();
            event.dataTransfer.dropEffect = 'move';
            event.currentTarget.classList.add('drag-over');
        }
        function onKanbanDragLeave(event) {
            event.currentTarget.classList.remove('drag-over');
        }
        async function onKanbanDrop(event, stageId) {
            event.preventDefault();
            event.currentTarget.classList.remove('drag-over');
            if (!dragLeadId) return;
            const { error } = await supabase.from('leads')
                .update({ kanban_stage_id: stageId })
                .eq('id', dragLeadId);
            if (error) { showToast('Error moving card: ' + error.message, 'error'); return; }
            await loadLeads();
            renderKanban();
            dragLeadId = null;
        }

        // =============================================
        // PROSPECTING — KANBAN STAGE CONFIG
        // =============================================
        function openStageConfig() {
            renderStagesList();
            document.getElementById('stage-config-modal').classList.remove('hide');
        }
        function closeStageConfig() {
            document.getElementById('stage-config-modal').classList.add('hide');
            renderKanban();
        }

        function renderStagesList() {
            const container = document.getElementById('stages-list');
            if (!container) return;
            if (kanbanStages.length === 0) {
                container.innerHTML = '<p class="text-gray-500 text-sm text-center py-4">No stages yet. Add your first stage below.</p>';
            } else {
                container.innerHTML = kanbanStages.map(stage => `
                    <div class="flex items-center gap-3 p-3 rounded-xl" style="background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.05)">
                        <span class="w-3 h-3 rounded-full flex-shrink-0" style="background:${stage.color}"></span>
                        <span class="flex-1 text-sm font-medium">${escHtml(stage.name)}</span>
                        <span class="text-xs text-gray-600">${leads.filter(l=>l.kanban_stage_id===stage.id).length} leads</span>
                        <button onclick="deleteStage('${stage.id}')" class="text-red-500 hover:text-red-400 text-xs px-2 py-1 rounded" style="background:rgba(239,68,68,0.08)">Remove</button>
                    </div>
                `).join('');
            }
            // Show/hide Add Stage button based on count
            const addBtn = document.getElementById('add-stage-btn');
            if (addBtn) addBtn.style.display = kanbanStages.length >= 3 ? 'none' : '';
            document.getElementById('add-stage-form')?.classList.add('hide');
        }

        function showAddStageForm() {
            if (kanbanStages.length >= 3) { showToast('Maximum 3 stages allowed', 'error'); return; }
            document.getElementById('add-stage-form').classList.remove('hide');
            document.getElementById('add-stage-btn').style.display = 'none';
            document.getElementById('new-stage-name').value = '';
            document.getElementById('new-stage-color').value = '#14b8a6';
        }

        async function saveNewStage() {
            const name = document.getElementById('new-stage-name').value.trim();
            const color = document.getElementById('new-stage-color').value;
            if (!name) { showToast('Stage name is required', 'error'); return; }
            if (kanbanStages.length >= 3) { showToast('Maximum 3 stages allowed', 'error'); return; }
            const { data, error } = await supabase.from('kanban_stages').insert({
                brand_id: currentBrand.id, name, color, position: kanbanStages.length
            }).select().single();
            if (error) { showToast('Error creating stage: ' + error.message, 'error'); return; }
            kanbanStages.push(data);
            renderStagesList();
            populateStageDropdown();
            showToast('Stage added');
        }

        async function deleteStage(stageId) {
            const stageLeadsCount = leads.filter(l => l.kanban_stage_id === stageId).length;
            const msg = stageLeadsCount > 0
                ? `This stage has ${stageLeadsCount} lead(s). Leads will be unassigned. Continue?`
                : 'Delete this stage?';
            if (!confirm(msg)) return;
            const { error } = await supabase.from('kanban_stages').delete().eq('id', stageId);
            if (error) { showToast('Error deleting stage: ' + error.message, 'error'); return; }
            kanbanStages = kanbanStages.filter(s => s.id !== stageId);
            await loadLeads();
            renderStagesList();
            populateStageDropdown();
            showToast('Stage removed');
        }

        function populateStageDropdown() {
            const sel = document.getElementById('lead-stage');
            if (!sel) return;
            sel.innerHTML = '<option value="">Select stage...</option>' +
                kanbanStages.map(s => `<option value="${s.id}">${escHtml(s.name)}</option>`).join('');
        }

        function toggleKanbanStageField() {
            const status = document.getElementById('lead-status')?.value;
            const stageField = document.getElementById('lead-stage-field');
            if (stageField) {
                stageField.style.display = status === 'in_discussion' ? '' : 'none';
            }
        }

        // =============================================
        // PROSPECTING — LEAD MODAL (CRUD)
        // =============================================
        async function openLeadModal(leadId, defaultStatus = 'not_contacted') {
            currentLeadId = leadId;
            editingLeadContacts = [];
            currentLeadContacts = [];

            populateStageDropdown();

            const modal = document.getElementById('lead-modal');
            const title = document.getElementById('lead-modal-title');
            const dangerActions = document.getElementById('lead-danger-actions');

            if (leadId) {
                // Edit mode
                const lead = leads.find(l => l.id === leadId);
                if (!lead) return;
                title.textContent = lead.lead_name || 'Edit Lead';
                document.getElementById('lead-id').value = lead.id;
                document.getElementById('lead-name').value = lead.lead_name || '';
                document.getElementById('lead-club-name').value = lead.club_name || '';
                document.getElementById('lead-sport').value = lead.sport || '';
                document.getElementById('lead-sport-level').value = lead.sport_level || '';
                document.getElementById('lead-county').value = lead.county || '';
                document.getElementById('lead-location').value = lead.location || '';
                document.getElementById('lead-teams').value = lead.amount_of_teams || '';
                document.getElementById('lead-notes').value = lead.notes || '';
                document.getElementById('lead-status').value = lead.status || 'not_contacted';
                document.getElementById('lead-stage').value = lead.kanban_stage_id || '';
                dangerActions.style.removeProperty('display');

                // Load contacts
                const { data: contacts } = await supabase
                    .from('lead_contacts')
                    .select('*')
                    .eq('lead_id', leadId)
                    .order('is_primary', { ascending: false });
                currentLeadContacts = contacts || [];
                editingLeadContacts = JSON.parse(JSON.stringify(currentLeadContacts));
            } else {
                // Create mode
                title.textContent = 'New Lead';
                document.getElementById('lead-id').value = '';
                document.getElementById('lead-name').value = '';
                document.getElementById('lead-club-name').value = '';
                document.getElementById('lead-sport').value = '';
                document.getElementById('lead-sport-level').value = '';
                document.getElementById('lead-county').value = '';
                document.getElementById('lead-location').value = '';
                document.getElementById('lead-teams').value = '';
                document.getElementById('lead-notes').value = '';
                document.getElementById('lead-status').value = defaultStatus;
                document.getElementById('lead-stage').value = defaultStatus === 'in_discussion' ? (kanbanStages[0]?.id || '') : '';
                dangerActions.style.display = 'none';
            }

            toggleKanbanStageField();
            renderContactsList();
            document.getElementById('add-contact-form').classList.add('hide');
            modal.classList.remove('hide');
        }

        function closeLeadModal() {
            document.getElementById('lead-modal').classList.add('hide');
            currentLeadId = null;
            editingLeadContacts = [];
        }

        function renderContactsList() {
            const container = document.getElementById('lead-contacts-list');
            if (!container) return;
            if (editingLeadContacts.length === 0) {
                container.innerHTML = '<p class="text-xs text-gray-600 mb-2">No contacts added yet.</p>';
                return;
            }
            container.innerHTML = editingLeadContacts.map((c, i) => `
                <div class="contact-card">
                    ${c.is_primary ? '<span class="absolute top-2 right-2 text-xs px-2 py-0.5 rounded" style="background:rgba(20,184,166,0.1);color:#2dd4bf">Primary</span>' : ''}
                    <div class="contact-name">${escHtml((c.first_name || '') + ' ' + (c.last_name || '')).trim() || 'Unnamed contact'}</div>
                    <div class="contact-details">
                        ${c.role ? `<span>${escHtml(c.role)}</span>` : ''}
                        ${c.email ? `<span> · ${escHtml(c.email)}</span>` : ''}
                        ${c.phone ? `<span> · ${escHtml(c.phone)}</span>` : ''}
                    </div>
                    ${!c.id ? `<button onclick="removeNewContact(${i})" class="absolute top-2 right-10 text-xs text-red-400 hover:text-red-300">Remove</button>` :
                               `<button onclick="deleteContact('${c.id}',${i})" class="absolute top-2 right-10 text-xs text-red-400 hover:text-red-300">Remove</button>`}
                </div>
            `).join('');
        }

        function showAddContactForm() {
            document.getElementById('add-contact-form').classList.remove('hide');
        }

        function saveContact() {
            const firstName = document.getElementById('contact-first-name').value.trim();
            const lastName = document.getElementById('contact-last-name').value.trim();
            const email = document.getElementById('contact-email').value.trim();
            const phone = document.getElementById('contact-phone').value.trim();
            const role = document.getElementById('contact-role').value.trim();
            const isPrimary = document.getElementById('contact-primary').checked;
            if (!firstName && !lastName && !email) { showToast('Please fill in at least a name or email', 'error'); return; }
            if (isPrimary) {
                editingLeadContacts.forEach(c => c.is_primary = false);
            }
            editingLeadContacts.push({ first_name: firstName, last_name: lastName, email, phone, role, is_primary: isPrimary });
            renderContactsList();
            document.getElementById('add-contact-form').classList.add('hide');
            // Clear form
            ['contact-first-name','contact-last-name','contact-email','contact-phone','contact-role'].forEach(id => {
                document.getElementById(id).value = '';
            });
            document.getElementById('contact-primary').checked = false;
        }

        function removeNewContact(index) {
            editingLeadContacts.splice(index, 1);
            renderContactsList();
        }

        async function deleteContact(contactId, index) {
            if (!confirm('Remove this contact?')) return;
            if (contactId && contactId !== 'undefined') {
                const { error } = await supabase.from('lead_contacts').delete().eq('id', contactId);
                if (error) { showToast('Error removing contact', 'error'); return; }
            }
            editingLeadContacts.splice(index, 1);
            renderContactsList();
        }

        async function saveLead() {
            const leadName = document.getElementById('lead-name').value.trim();
            const clubName = document.getElementById('lead-club-name').value.trim();
            if (!leadName) { showToast('Lead name is required', 'error'); return; }
            if (!clubName) { showToast('Club name is required', 'error'); return; }

            const status = document.getElementById('lead-status').value;
            const stageId = document.getElementById('lead-stage').value || null;
            const payload = {
                brand_id: currentBrand.id,
                lead_name: leadName,
                club_name: clubName,
                sport: document.getElementById('lead-sport').value || null,
                sport_level: document.getElementById('lead-sport-level').value || null,
                county: document.getElementById('lead-county').value.trim() || null,
                location: document.getElementById('lead-location').value.trim() || null,
                amount_of_teams: parseInt(document.getElementById('lead-teams').value) || null,
                notes: document.getElementById('lead-notes').value.trim() || null,
                status,
                kanban_stage_id: status === 'in_discussion' ? stageId : null
            };

            let leadId = currentLeadId;
            if (leadId) {
                const { error } = await supabase.from('leads').update(payload).eq('id', leadId);
                if (error) { showToast('Error saving lead: ' + error.message, 'error'); return; }
            } else {
                const { data, error } = await supabase.from('leads').insert(payload).select().single();
                if (error) { showToast('Error creating lead: ' + error.message, 'error'); return; }
                leadId = data.id;
            }

            // Save new contacts (those without an id)
            const newContacts = editingLeadContacts.filter(c => !c.id);
            if (newContacts.length > 0) {
                const toInsert = newContacts.map(c => ({ ...c, lead_id: leadId }));
                await supabase.from('lead_contacts').insert(toInsert);
            }

            await loadLeads();
            updateStats();
            closeLeadModal();

            // Refresh current view
            const ncVisible = !document.getElementById('prospect-not-contacted').classList.contains('hide');
            const idVisible = !document.getElementById('prospect-in-discussion').classList.contains('hide');
            if (ncVisible) renderNotContacted();
            if (idVisible) renderKanban();

            showToast(currentLeadId ? 'Lead updated' : 'Lead created');
        }

        async function archiveLead(reason) {
            if (!currentLeadId) return;
            if (!confirm('Archive this lead?')) return;
            const { error } = await supabase.from('leads')
                .update({ status: 'archived', archived_reason: reason })
                .eq('id', currentLeadId);
            if (error) { showToast('Error archiving lead: ' + error.message, 'error'); return; }
            await loadLeads();
            updateStats();
            closeLeadModal();
            renderNotContacted();
            showToast('Lead archived');
        }

        async function deleteLead() {
            if (!currentLeadId) return;
            if (!confirm('Permanently delete this lead? This cannot be undone.')) return;
            await supabase.from('lead_contacts').delete().eq('lead_id', currentLeadId);
            const { error } = await supabase.from('leads').delete().eq('id', currentLeadId);
            if (error) { showToast('Error deleting lead: ' + error.message, 'error'); return; }
            await loadLeads();
            updateStats();
            closeLeadModal();
            renderNotContacted();
            renderKanban();
            showToast('Lead deleted');
        }

        // =============================================
        // PROSPECTING — CSV IMPORT / EXPORT
        // =============================================
        function exportLeadsCSV(statusFilter) {
            let toExport = leads;
            if (statusFilter) toExport = leads.filter(l => l.status === statusFilter);

            const headers = ['lead_name','club_name','sport','sport_level','county','location','amount_of_teams','notes','status'];
            const rows = toExport.map(l => headers.map(h => {
                const val = l[h] ?? '';
                return `"${String(val).replace(/"/g,'""')}"`;
            }));

            const csv = [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `leads_${statusFilter || 'all'}_${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function handleLeadsCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: async (results) => {
                    const statusEl = document.getElementById('leads-import-status');
                    statusEl.classList.remove('hide');
                    statusEl.textContent = `Importing ${results.data.length} leads...`;

                    let successCount = 0, errorCount = 0;
                    for (const row of results.data) {
                        const payload = {
                            brand_id: currentBrand.id,
                            lead_name: row.lead_name?.trim() || row.club_name?.trim() || 'Unnamed Lead',
                            club_name: row.club_name?.trim() || 'Unknown Club',
                            sport: row.sport?.trim() || null,
                            sport_level: row.sport_level?.trim() || null,
                            county: row.county?.trim() || null,
                            location: row.location?.trim() || null,
                            amount_of_teams: parseInt(row.amount_of_teams) || null,
                            notes: row.notes?.trim() || null,
                            status: 'not_contacted'
                        };
                        const { error } = await supabase.from('leads').insert(payload);
                        if (error) errorCount++;
                        else successCount++;
                    }

                    await loadLeads();
                    updateStats();
                    statusEl.textContent = `Imported ${successCount} leads${errorCount > 0 ? `, ${errorCount} errors` : ''}`;

                    setTimeout(() => {
                        document.getElementById('leads-csv-import-modal').classList.add('hide');
                        statusEl.classList.add('hide');
                        renderNotContacted();
                    }, 2000);
                }
            });
        }

        // =============================================
        // UTILITY
        // =============================================
        function escHtml(str) {
            if (!str) return '';
            return String(str)
                .replace(/&/g,'&amp;')
                .replace(/</g,'&lt;')
                .replace(/>/g,'&gt;')
                .replace(/"/g,'&quot;')
                .replace(/'/g,'&#39;');
        }

        // Modal close on backdrop click
        document.getElementById('lead-modal').addEventListener('click', function(e) {
            if (e.target === this) closeLeadModal();
        });
        document.getElementById('stage-config-modal').addEventListener('click', function(e) {
            if (e.target === this) closeStageConfig();
        });
        document.getElementById('leads-csv-import-modal').addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hide');
        });
        document.getElementById('job-modal').addEventListener('click', function(e) {
            if (e.target === this) closeJobModal();
        });
        document.getElementById('team-modal').addEventListener('click', function(e) {
            if (e.target === this) closeTeamModal();
        });
        document.getElementById('link-club-modal').addEventListener('click', function(e) {
            if (e.target === this) this.classList.add('hide');
        });

        init();
    </script>
</body>
</html>
